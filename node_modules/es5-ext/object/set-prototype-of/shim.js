/* eslint no-proto: "off" */

// Big thanks to @WebReflection for sorting this out
// https://gist.github.com/WebReflection/5593554

"use strict";

var isObject        = require("../is-object")
  , value           = require("../valid-value")
  , objIsPrototypeOf = Object.prototype.isPrototypeOf
  , defineProperty  = Object.defineProperty
  , nullDesc        = ***REMOVED***
	configurable: true,
	enumerable: false,
	writable: true,
	value: undefined
***REMOVED***
  , validate;

validate = function (obj, prototype) ***REMOVED***
	value(obj);
	if (prototype === null || isObject(prototype)) return obj;
	throw new TypeError("Prototype must be null or an object");
***REMOVED***;

module.exports = (function (status) ***REMOVED***
	var fn, set;
	if (!status) return null;
	if (status.level === 2) ***REMOVED***
		if (status.set) ***REMOVED***
			set = status.set;
			fn = function (obj, prototype) ***REMOVED***
				set.call(validate(obj, prototype), prototype);
				return obj;
			***REMOVED***;
		***REMOVED*** else ***REMOVED***
			fn = function (obj, prototype) ***REMOVED***
				validate(obj, prototype).__proto__ = prototype;
				return obj;
			***REMOVED***;
		***REMOVED***
	***REMOVED*** else ***REMOVED***
		fn = function self(obj, prototype) ***REMOVED***
			var isNullBase;
			validate(obj, prototype);
			isNullBase = objIsPrototypeOf.call(self.nullPolyfill, obj);
			if (isNullBase) delete self.nullPolyfill.__proto__;
			if (prototype === null) prototype = self.nullPolyfill;
			obj.__proto__ = prototype;
			if (isNullBase) defineProperty(self.nullPolyfill, "__proto__", nullDesc);
			return obj;
		***REMOVED***;
	***REMOVED***
	return Object.defineProperty(fn, "level", ***REMOVED***
		configurable: false,
		enumerable: false,
		writable: false,
		value: status.level
	***REMOVED***);
***REMOVED***(
	(function () ***REMOVED***
		var tmpObj1 = Object.create(null)
		  , tmpObj2 = ***REMOVED******REMOVED***
		  , set
		  , desc = Object.getOwnPropertyDescriptor(Object.prototype, "__proto__");

		if (desc) ***REMOVED***
			try ***REMOVED***
				set = desc.set; // Opera crashes at this point
				set.call(tmpObj1, tmpObj2);
			***REMOVED*** catch (ignore) ***REMOVED******REMOVED***
			if (Object.getPrototypeOf(tmpObj1) === tmpObj2) return ***REMOVED*** set: set, level: 2 ***REMOVED***;
		***REMOVED***

		tmpObj1.__proto__ = tmpObj2;
		if (Object.getPrototypeOf(tmpObj1) === tmpObj2) return ***REMOVED*** level: 2 ***REMOVED***;

		tmpObj1 = ***REMOVED******REMOVED***;
		tmpObj1.__proto__ = tmpObj2;
		if (Object.getPrototypeOf(tmpObj1) === tmpObj2) return ***REMOVED*** level: 1 ***REMOVED***;

		return false;
	***REMOVED***)()
));

require("../create");
