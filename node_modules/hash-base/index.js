'use strict'
var Transform = require('stream').Transform
var inherits = require('inherits')

function HashBase (blockSize) ***REMOVED***
  Transform.call(this)

  this._block = new Buffer(blockSize)
  this._blockSize = blockSize
  this._blockOffset = 0
  this._length = [0, 0, 0, 0]

  this._finalized = false
***REMOVED***

inherits(HashBase, Transform)

HashBase.prototype._transform = function (chunk, encoding, callback) ***REMOVED***
  var error = null
  try ***REMOVED***
    if (encoding !== 'buffer') chunk = new Buffer(chunk, encoding)
    this.update(chunk)
  ***REMOVED*** catch (err) ***REMOVED***
    error = err
  ***REMOVED***

  callback(error)
***REMOVED***

HashBase.prototype._flush = function (callback) ***REMOVED***
  var error = null
  try ***REMOVED***
    this.push(this._digest())
  ***REMOVED*** catch (err) ***REMOVED***
    error = err
  ***REMOVED***

  callback(error)
***REMOVED***

HashBase.prototype.update = function (data, encoding) ***REMOVED***
  if (!Buffer.isBuffer(data) && typeof data !== 'string') throw new TypeError('Data must be a string or a buffer')
  if (this._finalized) throw new Error('Digest already called')
  if (!Buffer.isBuffer(data)) data = new Buffer(data, encoding || 'binary')

  // consume data
  var block = this._block
  var offset = 0
  while (this._blockOffset + data.length - offset >= this._blockSize) ***REMOVED***
    for (var i = this._blockOffset; i < this._blockSize;) block[i++] = data[offset++]
    this._update()
    this._blockOffset = 0
  ***REMOVED***
  while (offset < data.length) block[this._blockOffset++] = data[offset++]

  // update length
  for (var j = 0, carry = data.length * 8; carry > 0; ++j) ***REMOVED***
    this._length[j] += carry
    carry = (this._length[j] / 0x0100000000) | 0
    if (carry > 0) this._length[j] -= 0x0100000000 * carry
  ***REMOVED***

  return this
***REMOVED***

HashBase.prototype._update = function (data) ***REMOVED***
  throw new Error('_update is not implemented')
***REMOVED***

HashBase.prototype.digest = function (encoding) ***REMOVED***
  if (this._finalized) throw new Error('Digest already called')
  this._finalized = true

  var digest = this._digest()
  if (encoding !== undefined) digest = digest.toString(encoding)
  return digest
***REMOVED***

HashBase.prototype._digest = function () ***REMOVED***
  throw new Error('_digest is not implemented')
***REMOVED***

module.exports = HashBase
