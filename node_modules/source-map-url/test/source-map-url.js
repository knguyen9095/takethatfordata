// Copyright 2014 Simon Lydell
// X11 (“MIT”) Licensed. (See LICENSE.)

var expect = require("expect.js")

var sourceMappingURL = require("../")

var comments = ***REMOVED***

  universal: [
    "/*# sourceMappingURL=foo.js.map */"
  ],

  js: [
    "//# sourceMappingURL=foo.js.map"
  ],

  block: [
    "/*",
    "# sourceMappingURL=foo.js.map",
    "*/"
  ],

  mix: [
    "/*",
    "//# sourceMappingURL=foo.js.map",
    "*/"
  ]

***REMOVED***

var nonTrailingComments = ***REMOVED***

  jsLeading: ***REMOVED***
    contents: [
      "//# sourceMappingURL=foo.js.map",
      "(function()***REMOVED******REMOVED***)"
    ],
    solution: [
      "(function()***REMOVED******REMOVED***)"
    ]
  ***REMOVED***,

  mixEmbedded: ***REMOVED***
    contents: [
      "/*! Library Name v1.0.0",
      "//# sourceMappingURL=foo.js.map",
      "*/",
      "(function()***REMOVED******REMOVED***)"
    ],
    solution: [
      "/*! Library Name v1.0.0",
      "*/",
      "(function()***REMOVED******REMOVED***)"
    ]
  ***REMOVED***

***REMOVED***

function forEachComment(fn) ***REMOVED***
  forOf(comments, function(name, comment) ***REMOVED***
    var description = "the '" + name + "' syntax with "
    fn(comment.join("\n"),   description + "regular newlines")
    fn(comment.join("\r\n"), description + "Windows newlines")
  ***REMOVED***)
***REMOVED***

function forEachNonTrailingComment(fn) ***REMOVED***
  forOf(nonTrailingComments, function(name, comment) ***REMOVED***

    var description = "the '" + name + "' syntax with "

    fn(***REMOVED***
      contents: comment.contents.join("\n"),
      solution: comment.solution.join("\n")
    ***REMOVED***, description + "regular newlines")

    fn(***REMOVED***
      contents: comment.contents.join("\r\n"),
      solution: comment.solution.join("\r\n")
    ***REMOVED***, description + "Windows newlines")
  ***REMOVED***)
***REMOVED***

function forOf(obj, fn) ***REMOVED***
  for (var key in obj) ***REMOVED***
    if (Object.prototype.hasOwnProperty.call(obj, key)) ***REMOVED***
      fn(key, obj[key])
    ***REMOVED***
  ***REMOVED***
***REMOVED***


describe("sourceMappingURL", function() ***REMOVED***

  describe(".getFrom", function() ***REMOVED***

    forEachComment(function(comment, description) ***REMOVED***

      it("gets the url from " + description, function() ***REMOVED***
        expect(sourceMappingURL.getFrom("code\n" + comment))
          .to.equal("foo.js.map")

        expect(sourceMappingURL.getFrom("code" + comment))
          .to.equal("foo.js.map")

        expect(sourceMappingURL.getFrom(comment))
          .to.equal("foo.js.map")
      ***REMOVED***)

    ***REMOVED***)

    forEachNonTrailingComment(function(comment, description) ***REMOVED***

      it("gets the url from " + description, function() ***REMOVED***
        expect(sourceMappingURL.getFrom("code\n" + comment.contents))
          .to.equal("foo.js.map")

        expect(sourceMappingURL.getFrom("code" + comment.contents))
          .to.equal("foo.js.map")

        expect(sourceMappingURL.getFrom(comment.contents))
          .to.equal("foo.js.map")
      ***REMOVED***)

    ***REMOVED***)


    it("returns null if no comment", function() ***REMOVED***
      expect(sourceMappingURL.getFrom("code"))
        .to.equal(null)
    ***REMOVED***)


    it("can return an empty string as url", function() ***REMOVED***
      expect(sourceMappingURL.getFrom("/*# sourceMappingURL= */"))
        .to.equal("")
    ***REMOVED***)


    it("is detachable", function() ***REMOVED***
      var get = sourceMappingURL.getFrom
      expect(get("/*# sourceMappingURL=foo */"))
        .to.equal("foo")
    ***REMOVED***)

  ***REMOVED***)


  describe(".existsIn", function() ***REMOVED***

    forEachComment(function(comment, description) ***REMOVED***

      it("returns true for " + description, function() ***REMOVED***
        expect(sourceMappingURL.existsIn("code\n" + comment))
          .to.equal(true)

        expect(sourceMappingURL.existsIn("code" + comment))
          .to.equal(true)

        expect(sourceMappingURL.existsIn(comment))
          .to.equal(true)
      ***REMOVED***)

    ***REMOVED***)

    forEachNonTrailingComment(function(comment, description) ***REMOVED***

      it("returns true for " + description, function() ***REMOVED***
        expect(sourceMappingURL.existsIn("code\n" + comment.contents))
          .to.equal(true)

        expect(sourceMappingURL.existsIn("code" + comment.contents))
          .to.equal(true)

        expect(sourceMappingURL.existsIn(comment.contents))
          .to.equal(true)
      ***REMOVED***)

    ***REMOVED***)


    it("returns false if no comment", function() ***REMOVED***
      expect(sourceMappingURL.existsIn("code"))
        .to.equal(false)
    ***REMOVED***)


    it("is detachable", function() ***REMOVED***
      var has = sourceMappingURL.existsIn
      expect(has("/*# sourceMappingURL=foo */"))
        .to.equal(true)
    ***REMOVED***)

  ***REMOVED***)


  describe(".removeFrom", function() ***REMOVED***

    forEachComment(function(comment, description) ***REMOVED***

      it("removes the comment for " + description, function() ***REMOVED***
        expect(sourceMappingURL.removeFrom("code\n" + comment))
          .to.equal("code\n")

        expect(sourceMappingURL.removeFrom("code" + comment))
          .to.equal("code")

        expect(sourceMappingURL.removeFrom(comment))
          .to.equal("")
      ***REMOVED***)

    ***REMOVED***)

    forEachNonTrailingComment(function(comment, description) ***REMOVED***

      it("removes the comment for " + description, function() ***REMOVED***
        expect(sourceMappingURL.removeFrom("code\n" + comment.contents))
          .to.equal("code\n" + comment.solution)

        expect(sourceMappingURL.removeFrom("code" + comment.contents))
          .to.equal("code" + comment.solution)

        expect(sourceMappingURL.removeFrom(comment.contents))
          .to.equal(comment.solution)
      ***REMOVED***)

    ***REMOVED***)


    it("does nothing if no comment", function() ***REMOVED***
      expect(sourceMappingURL.removeFrom("code\n"))
        .to.equal("code\n")
    ***REMOVED***)


    it("is detachable", function() ***REMOVED***
      var remove = sourceMappingURL.removeFrom
      expect(remove("/*# sourceMappingURL=foo */"))
        .to.equal("")
    ***REMOVED***)

  ***REMOVED***)


  describe(".insertBefore", function() ***REMOVED***

    forEachComment(function(comment, description) ***REMOVED***

      it("inserts a string before the comment for " + description, function() ***REMOVED***
        expect(sourceMappingURL.insertBefore("code\n" + comment, "more code\n"))
          .to.equal("code\nmore code\n" + comment)

        expect(sourceMappingURL.insertBefore("code" + comment, "\nmore code"))
          .to.equal("code\nmore code" + comment)

        expect(sourceMappingURL.insertBefore(comment, "some code"))
          .to.equal("some code" + comment)
      ***REMOVED***)

    ***REMOVED***)


    it("inserts a string before an embedded comment", function() ***REMOVED***
      expect(sourceMappingURL.insertBefore("/*! Library Name v1.0.0\n" +
        "//# sourceMappingURL=foo.js.map\n*/\n(function()***REMOVED******REMOVED***)", "code\n"))
        .to.equal("/*! Library Name v1.0.0\ncode\n" +
          "//# sourceMappingURL=foo.js.map\n*/\n(function()***REMOVED******REMOVED***)")
    ***REMOVED***)


    it("inserts a string before a leading comment", function() ***REMOVED***
      expect(sourceMappingURL.insertBefore("//# sourceMappingURL=foo.js.map\n" +
        "(function()***REMOVED******REMOVED***)", "code\n"))
        .to.equal("code\n//# sourceMappingURL=foo.js.map\n" +
          "(function()***REMOVED******REMOVED***)")
    ***REMOVED***)


    it("appends if no comment", function() ***REMOVED***
      expect(sourceMappingURL.insertBefore("code", "\nmore code"))
        .to.equal("code\nmore code")
    ***REMOVED***)


    it("is detachable", function() ***REMOVED***
      var insertBefore = sourceMappingURL.insertBefore
      expect(insertBefore("/*# sourceMappingURL=foo */", "bar"))
        .to.equal("bar/*# sourceMappingURL=foo */")
    ***REMOVED***)

  ***REMOVED***)


  describe(".regex", function() ***REMOVED***

    it("includes ._innerRegex", function() ***REMOVED***
      expect(sourceMappingURL.regex.source)
        .to.contain(sourceMappingURL._innerRegex.source)
    ***REMOVED***)


    var match = function(code) ***REMOVED***
      expect(code)
        .to.match(sourceMappingURL.regex)
    ***REMOVED***

    var noMatch = function(code) ***REMOVED***
      expect(code)
        .not.to.match(sourceMappingURL.regex)
    ***REMOVED***


    forEachComment(function(comment, description) ***REMOVED***

      it("matches " + description, function() ***REMOVED***
        match("code\n" + comment)
        match("code" + comment)
        match(comment)
      ***REMOVED***)


      it("matches " + description + ", with trailing whitespace", function() ***REMOVED***
        match(comment + "  ")
        match(comment + "\n")
        match(comment + "\n\n\t\n    \t  ")
      ***REMOVED***)

    ***REMOVED***)


    it("does not match some cases that are easy to mess up", function() ***REMOVED***
      noMatch(
        "/* # sourceMappingURL=foo */"
      )

      noMatch(
        "// # sourceMappingURL=foo"
      )
    ***REMOVED***)


    it("is liberal regarding inner whitespace", function() ***REMOVED***
      match(
        "/*# sourceMappingURL=foo*/"
      )

      match(
        "/*# sourceMappingURL=foo    */"
      )

      match(
        "/*# sourceMappingURL=foo   \t\n" +
        "*/"
      )

      match(
        "/*    \n" +
        "# sourceMappingURL=foo\n" +
        "*/"
      )

      match(
        "/*\n" +
        "# sourceMappingURL=foo\n" +
        "     */"
      )

      match(
        "/*\n" +
        "# sourceMappingURL=foo\n" +
        "\n" +
        "\t\n" +
        "*/"
      )
    ***REMOVED***)

  ***REMOVED***)


  describe("._innerRegex", function() ***REMOVED***

    it("matches the contents of sourceMappingURL comments", function() ***REMOVED***
      expect("# sourceMappingURL=http://www.example.com/foo/bar.js.map")
        .to.match(sourceMappingURL._innerRegex)
    ***REMOVED***)


    it("captures the url in the first capture group", function() ***REMOVED***
      expect(sourceMappingURL._innerRegex.exec("# sourceMappingURL=foo")[1])
        .to.equal("foo")
    ***REMOVED***)


    it("supports the legacy syntax", function() ***REMOVED***
      expect("@ sourceMappingURL=http://www.example.com/foo/bar.js.map")
        .to.match(sourceMappingURL._innerRegex)
    ***REMOVED***)

  ***REMOVED***)

***REMOVED***)
