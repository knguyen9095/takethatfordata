'use strict'

var assert = require('assert')
var stubs = require('./')
var tess = require('tess')

tess('init', function(it) ***REMOVED***
  it('is a function', function() ***REMOVED***
    assert.equal(typeof stubs, 'function')
  ***REMOVED***)

  it('throws without obj || method', function() ***REMOVED***
    assert.throws(function() ***REMOVED***
      stubs()
    ***REMOVED***, /must provide/)

    assert.throws(function() ***REMOVED***
      stubs(***REMOVED******REMOVED***)
    ***REMOVED***, /must provide/)
  ***REMOVED***)
***REMOVED***)

tess('stubs', function(it) ***REMOVED***
  it('stubs a method with a noop', function() ***REMOVED***
    var originalCalled = false

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      originalCalled = true
    ***REMOVED***

    stubs(obj, 'method')

    obj.method()

    assert(!originalCalled)
  ***REMOVED***)

  it('accepts an override', function() ***REMOVED***
    var originalCalled = false

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      originalCalled = true
    ***REMOVED***

    var replacementCalled = false
    stubs(obj, 'method', function() ***REMOVED***
      replacementCalled = true
    ***REMOVED***)

    obj.method()
    assert(!originalCalled)
    assert(replacementCalled)
  ***REMOVED***)

  it('returns value of overridden method call', function() ***REMOVED***
    var overriddenUniqueVal = ***REMOVED******REMOVED***

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED******REMOVED***

    stubs(obj, 'method', ***REMOVED*** callthrough: true ***REMOVED***, function() ***REMOVED***
      return overriddenUniqueVal
    ***REMOVED***)

    assert.strictEqual(obj.method(), overriddenUniqueVal)
  ***REMOVED***)

  it('calls through to original method', function() ***REMOVED***
    var originalCalled = false

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      originalCalled = true
    ***REMOVED***

    var replacementCalled = false
    stubs(obj, 'method', ***REMOVED*** callthrough: true ***REMOVED***, function() ***REMOVED***
      replacementCalled = true
    ***REMOVED***)

    obj.method()
    assert(originalCalled)
    assert(replacementCalled)
  ***REMOVED***)

  it('returns value of original method call', function() ***REMOVED***
    var uniqueVal = Date.now()

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      return uniqueVal
    ***REMOVED***

    stubs(obj, 'method', ***REMOVED*** callthrough: true ***REMOVED***, function() ***REMOVED******REMOVED***)

    assert.equal(obj.method(), uniqueVal)
  ***REMOVED***)

  it('returns calls override and returns original value', function() ***REMOVED***
    var uniqueVal = ***REMOVED******REMOVED***
    var overrideWasCalled = false

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      return uniqueVal
    ***REMOVED***

    stubs(obj, 'method', ***REMOVED*** callthrough: true ***REMOVED***, function() ***REMOVED***
      // does not return anything
      overrideWasCalled = true
    ***REMOVED***)

    assert.strictEqual(obj.method(), uniqueVal)
    assert.strictEqual(overrideWasCalled, true)
  ***REMOVED***)

  it('returns value of overridden method call', function() ***REMOVED***
    var uniqueVal = ***REMOVED******REMOVED***
    var overriddenUniqueVal = ***REMOVED******REMOVED***

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      return uniqueVal
    ***REMOVED***

    stubs(obj, 'method', ***REMOVED*** callthrough: true ***REMOVED***, function() ***REMOVED***
      return overriddenUniqueVal
    ***REMOVED***)

    assert.strictEqual(obj.method(), overriddenUniqueVal)
  ***REMOVED***)

  it('stops calling stub after n calls', function() ***REMOVED***
    var timesToCall = 5
    var timesCalled = 0

    var obj = ***REMOVED******REMOVED***
    obj.method = function() ***REMOVED***
      assert.equal(timesCalled, timesToCall)
    ***REMOVED***

    stubs(obj, 'method', ***REMOVED*** calls: timesToCall ***REMOVED***, function() ***REMOVED***
      timesCalled++
    ***REMOVED***)

    obj.method() // 1 (stub)
    obj.method() // 2 (stub)
    obj.method() // 3 (stub)
    obj.method() // 4 (stub)
    obj.method() // 5 (stub)
    obj.method() // 6 (original)
  ***REMOVED***)

  it('calls stub in original context of obj', function() ***REMOVED***
    var secret = 'brownies'

    function Class() ***REMOVED***
      this.method = function() ***REMOVED******REMOVED***
      this.secret = secret
    ***REMOVED***

    var cl = new Class()

    stubs(cl, 'method', function() ***REMOVED***
      assert.equal(this.secret, secret)
    ***REMOVED***)

    cl.method()
  ***REMOVED***)
***REMOVED***)
