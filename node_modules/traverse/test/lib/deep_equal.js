var traverse = require('../../');

module.exports = function (a, b) ***REMOVED***
    if (arguments.length !== 2) ***REMOVED***
        throw new Error(
            'deepEqual requires exactly two objects to compare against'
        );
    ***REMOVED***
    
    var equal = true;
    var node = b;
    
    traverse(a).forEach(function (y) ***REMOVED***
        var notEqual = (function () ***REMOVED***
            equal = false;
            //this.stop();
            return undefined;
        ***REMOVED***).bind(this);
        
        //if (node === undefined || node === null) return notEqual();
        
        if (!this.isRoot) ***REMOVED***
        /*
            if (!Object.hasOwnProperty.call(node, this.key)) ***REMOVED***
                return notEqual();
            ***REMOVED***
        */
            if (typeof node !== 'object') return notEqual();
            node = node[this.key];
        ***REMOVED***
        
        var x = node;
        
        this.post(function () ***REMOVED***
            node = x;
        ***REMOVED***);
        
        var toS = function (o) ***REMOVED***
            return Object.prototype.toString.call(o);
        ***REMOVED***;
        
        if (this.circular) ***REMOVED***
            if (traverse(b).get(this.circular.path) !== x) notEqual();
        ***REMOVED***
        else if (typeof x !== typeof y) ***REMOVED***
            notEqual();
        ***REMOVED***
        else if (x === null || y === null || x === undefined || y === undefined) ***REMOVED***
            if (x !== y) notEqual();
        ***REMOVED***
        else if (x.__proto__ !== y.__proto__) ***REMOVED***
            notEqual();
        ***REMOVED***
        else if (x === y) ***REMOVED***
            // nop
        ***REMOVED***
        else if (typeof x === 'function') ***REMOVED***
            if (x instanceof RegExp) ***REMOVED***
                // both regexps on account of the __proto__ check
                if (x.toString() != y.toString()) notEqual();
            ***REMOVED***
            else if (x !== y) notEqual();
        ***REMOVED***
        else if (typeof x === 'object') ***REMOVED***
            if (toS(y) === '[object Arguments]'
            || toS(x) === '[object Arguments]') ***REMOVED***
                if (toS(x) !== toS(y)) ***REMOVED***
                    notEqual();
                ***REMOVED***
            ***REMOVED***
            else if (toS(y) === '[object RegExp]'
            || toS(x) === '[object RegExp]') ***REMOVED***
                if (!x || !y || x.toString() !== y.toString()) notEqual();
            ***REMOVED***
            else if (x instanceof Date || y instanceof Date) ***REMOVED***
                if (!(x instanceof Date) || !(y instanceof Date)
                || x.getTime() !== y.getTime()) ***REMOVED***
                    notEqual();
                ***REMOVED***
            ***REMOVED***
            else ***REMOVED***
                var kx = Object.keys(x);
                var ky = Object.keys(y);
                if (kx.length !== ky.length) return notEqual();
                for (var i = 0; i < kx.length; i++) ***REMOVED***
                    var k = kx[i];
                    if (!Object.hasOwnProperty.call(y, k)) ***REMOVED***
                        notEqual();
                    ***REMOVED***
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***
    ***REMOVED***);
    
    return equal;
***REMOVED***;
