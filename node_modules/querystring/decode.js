// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

'use strict';

// If obj.hasOwnProperty has been overridden, then calling
// obj.hasOwnProperty(prop) will break.
// See: https://github.com/joyent/node/issues/1707
function hasOwnProperty(obj, prop) ***REMOVED***
  return Object.prototype.hasOwnProperty.call(obj, prop);
***REMOVED***

module.exports = function(qs, sep, eq, options) ***REMOVED***
  sep = sep || '&';
  eq = eq || '=';
  var obj = ***REMOVED******REMOVED***;

  if (typeof qs !== 'string' || qs.length === 0) ***REMOVED***
    return obj;
  ***REMOVED***

  var regexp = /\+/g;
  qs = qs.split(sep);

  var maxKeys = 1000;
  if (options && typeof options.maxKeys === 'number') ***REMOVED***
    maxKeys = options.maxKeys;
  ***REMOVED***

  var len = qs.length;
  // maxKeys <= 0 means that we should not limit keys count
  if (maxKeys > 0 && len > maxKeys) ***REMOVED***
    len = maxKeys;
  ***REMOVED***

  for (var i = 0; i < len; ++i) ***REMOVED***
    var x = qs[i].replace(regexp, '%20'),
        idx = x.indexOf(eq),
        kstr, vstr, k, v;

    if (idx >= 0) ***REMOVED***
      kstr = x.substr(0, idx);
      vstr = x.substr(idx + 1);
    ***REMOVED*** else ***REMOVED***
      kstr = x;
      vstr = '';
    ***REMOVED***

    k = decodeURIComponent(kstr);
    v = decodeURIComponent(vstr);

    if (!hasOwnProperty(obj, k)) ***REMOVED***
      obj[k] = v;
    ***REMOVED*** else if (Array.isArray(obj[k])) ***REMOVED***
      obj[k].push(v);
    ***REMOVED*** else ***REMOVED***
      obj[k] = [obj[k], v];
    ***REMOVED***
  ***REMOVED***

  return obj;
***REMOVED***;
