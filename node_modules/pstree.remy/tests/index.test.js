const tap = require('tap');
const test = tap.test;
const readFile = require('fs').readFileSync;
const spawn = require('child_process').spawn;
const pstree = require('../');
const ***REMOVED*** tree, pidsForTree, getStat ***REMOVED*** = require('../lib/utils');

tap.test('reads from /proc', async t => ***REMOVED***
  const ps = await getStat();
  t.ok(ps.split('\n').length > 1);
***REMOVED***);

test('tree for live env', async t => ***REMOVED***
  const pid = 4079;
  const fixture = readFile(__dirname + '/fixtures/out2', 'utf8');
  const ps = await tree(fixture);
  t.deepEqual(pidsForTree(ps, pid).map(_ => _.PID), ['4080']);
***REMOVED***);

test('can read full child process tree', t => ***REMOVED***
  const sub = spawn(
    'sh',
    [
      '-c',
      `node -e "setInterval(() => ***REMOVED***
        console.log(process.pid, 'is alive')
      ***REMOVED***, 200);"`,
    ],
    ***REMOVED***
      stdio: 'pipe',
    ***REMOVED***
  );

  console.log('parent at %s', sub.pid);

  setTimeout(() => ***REMOVED***
    const pid = sub.pid;
    pstree(pid, (error, children) => ***REMOVED***
      children.concat(***REMOVED*** PID: pid ***REMOVED***).forEach(p => ***REMOVED***
        spawn('kill', ['-s', 'SIGTERM', p.PID]);
      ***REMOVED***);
      t.equal(children.length, 1);
      t.end();
    ***REMOVED***);
  ***REMOVED***, 500);
***REMOVED***);
