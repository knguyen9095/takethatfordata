'use strict';

var brackets = require('expand-brackets');

/**
 * Extglob compilers
 */

module.exports = function(extglob) ***REMOVED***
  function star() ***REMOVED***
    if (typeof extglob.options.star === 'function') ***REMOVED***
      return extglob.options.star.apply(this, arguments);
    ***REMOVED***
    if (typeof extglob.options.star === 'string') ***REMOVED***
      return extglob.options.star;
    ***REMOVED***
    return '.*?';
  ***REMOVED***

  /**
   * Use `expand-brackets` compilers
   */

  extglob.use(brackets.compilers);
  extglob.compiler

    /**
     * Escaped: "\\*"
     */

    .set('escape', function(node) ***REMOVED***
      return this.emit(node.val, node);
    ***REMOVED***)

    /**
     * Dot: "."
     */

    .set('dot', function(node) ***REMOVED***
      return this.emit('\\' + node.val, node);
    ***REMOVED***)

    /**
     * Question mark: "?"
     */

    .set('qmark', function(node) ***REMOVED***
      var val = '[^\\\\/.]';
      var prev = this.prev();

      if (node.parsed.slice(-1) === '(') ***REMOVED***
        var ch = node.rest.charAt(0);
        if (ch !== '!' && ch !== '=' && ch !== ':') ***REMOVED***
          return this.emit(val, node);
        ***REMOVED***
        return this.emit(node.val, node);
      ***REMOVED***

      if (prev.type === 'text' && prev.val) ***REMOVED***
        return this.emit(val, node);
      ***REMOVED***

      if (node.val.length > 1) ***REMOVED***
        val += '***REMOVED***' + node.val.length + '***REMOVED***';
      ***REMOVED***
      return this.emit(val, node);
    ***REMOVED***)

    /**
     * Plus: "+"
     */

    .set('plus', function(node) ***REMOVED***
      var prev = node.parsed.slice(-1);
      if (prev === ']' || prev === ')') ***REMOVED***
        return this.emit(node.val, node);
      ***REMOVED***
      var ch = this.output.slice(-1);
      if (!this.output || (/[?*+]/.test(ch) && node.parent.type !== 'bracket')) ***REMOVED***
        return this.emit('\\+', node);
      ***REMOVED***
      if (/\w/.test(ch) && !node.inside) ***REMOVED***
        return this.emit('+\\+?', node);
      ***REMOVED***
      return this.emit('+', node);
    ***REMOVED***)

    /**
     * Star: "*"
     */

    .set('star', function(node) ***REMOVED***
      var prev = this.prev();
      var prefix = prev.type !== 'text' && prev.type !== 'escape'
        ? '(?!\\.)'
        : '';

      return this.emit(prefix + star.call(this, node), node);
    ***REMOVED***)

    /**
     * Parens
     */

    .set('paren', function(node) ***REMOVED***
      return this.mapVisit(node.nodes);
    ***REMOVED***)
    .set('paren.open', function(node) ***REMOVED***
      var capture = this.options.capture ? '(' : '';

      switch (node.parent.prefix) ***REMOVED***
        case '!':
        case '^':
          return this.emit(capture + '(?:(?!(?:', node);
        case '*':
        case '+':
        case '?':
        case '@':
          return this.emit(capture + '(?:', node);
        default: ***REMOVED***
          var val = node.val;
          if (this.options.bash === true) ***REMOVED***
            val = '\\' + val;
          ***REMOVED*** else if (!this.options.capture && val === '(' && node.parent.rest[0] !== '?') ***REMOVED***
            val += '?:';
          ***REMOVED***

          return this.emit(val, node);
        ***REMOVED***
      ***REMOVED***
    ***REMOVED***)
    .set('paren.close', function(node) ***REMOVED***
      var capture = this.options.capture ? ')' : '';

      switch (node.prefix) ***REMOVED***
        case '!':
        case '^':
          var prefix = /^(\)|$)/.test(node.rest) ? '$' : '';
          var str = star.call(this, node);

          // if the extglob has a slash explicitly defined, we know the user wants
          // to match slashes, so we need to ensure the "star" regex allows for it
          if (node.parent.hasSlash && !this.options.star && this.options.slash !== false) ***REMOVED***
            str = '.*?';
          ***REMOVED***

          return this.emit(prefix + ('))' + str + ')') + capture, node);
        case '*':
        case '+':
        case '?':
          return this.emit(')' + node.prefix + capture, node);
        case '@':
          return this.emit(')' + capture, node);
        default: ***REMOVED***
          var val = (this.options.bash === true ? '\\' : '') + ')';
          return this.emit(val, node);
        ***REMOVED***
      ***REMOVED***
    ***REMOVED***)

    /**
     * Text
     */

    .set('text', function(node) ***REMOVED***
      var val = node.val.replace(/[\[\]]/g, '\\$&');
      return this.emit(val, node);
    ***REMOVED***);
***REMOVED***;
