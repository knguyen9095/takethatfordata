'use strict';

var nanomatch = require('nanomatch');
var extglob = require('extglob');

module.exports = function(snapdragon) ***REMOVED***
  var compilers = snapdragon.compiler.compilers;
  var opts = snapdragon.options;

  // register nanomatch compilers
  snapdragon.use(nanomatch.compilers);

  // get references to some specific nanomatch compilers before they
  // are overridden by the extglob and/or custom compilers
  var escape = compilers.escape;
  var qmark = compilers.qmark;
  var slash = compilers.slash;
  var star = compilers.star;
  var text = compilers.text;
  var plus = compilers.plus;
  var dot = compilers.dot;

  // register extglob compilers or escape exglobs if disabled
  if (opts.extglob === false || opts.noext === true) ***REMOVED***
    snapdragon.compiler.use(escapeExtglobs);
  ***REMOVED*** else ***REMOVED***
    snapdragon.use(extglob.compilers);
  ***REMOVED***

  snapdragon.use(function() ***REMOVED***
    this.options.star = this.options.star || function(/*node*/) ***REMOVED***
      return '[^/]*?';
    ***REMOVED***;
  ***REMOVED***);

  // custom micromatch compilers
  snapdragon.compiler

    // reset referenced compiler
    .set('dot', dot)
    .set('escape', escape)
    .set('plus', plus)
    .set('slash', slash)
    .set('qmark', qmark)
    .set('star', star)
    .set('text', text);
***REMOVED***;

function escapeExtglobs(compiler) ***REMOVED***
  compiler.set('paren', function(node) ***REMOVED***
    var val = '';
    visit(node, function(tok) ***REMOVED***
      if (tok.val) val += '\\' + tok.val;
    ***REMOVED***);
    return this.emit(val, node);
  ***REMOVED***);

  /**
   * Visit `node` with the given `fn`
   */

  function visit(node, fn) ***REMOVED***
    return node.nodes ? mapVisit(node.nodes, fn) : fn(node);
  ***REMOVED***

  /**
   * Map visit over array of `nodes`.
   */

  function mapVisit(nodes, fn) ***REMOVED***
    var len = nodes.length;
    var idx = -1;
    while (++idx < len) ***REMOVED***
      visit(nodes[idx], fn);
    ***REMOVED***
  ***REMOVED***
***REMOVED***
