#!/usr/bin/env node
const touch = require("../index.js")

const usage = code => ***REMOVED***
  console[code ? 'error' : 'log'](
    'usage:\n' +
    'touch [-acfm] [-r file] [-t [[CC]YY]MMDDhhmm[.SS]] file ...'
  )
  process.exit(code)
***REMOVED***

const singleFlags = ***REMOVED***
  a: 'atime',
  m: 'mtime',
  c: 'nocreate',
  f: 'force'
***REMOVED***

const singleOpts = ***REMOVED***
  r: 'ref',
  t: 'time'
***REMOVED***

const files = []
const args = process.argv.slice(2)
const options = ***REMOVED******REMOVED***
for (let i = 0; i < args.length; i++) ***REMOVED***
  const arg = args[i]
  if (!arg.match(/^-/)) ***REMOVED***
    files.push(arg)
    continue
  ***REMOVED***

  // expand shorthands
  if (arg.charAt(1) !== '-') ***REMOVED***
    const expand = []
    for (let f = 1; f < arg.length; f++) ***REMOVED***
      const fc = arg.charAt(f)
      const sf = singleFlags[fc]
      const so = singleOpts[fc]
      if (sf)
        expand.push('--' + sf)
      else if (so) ***REMOVED***
        const soslice = arg.slice(f + 1)
        const soval = soslice.charAt(0) === '=' ? soslice : '=' + soslice
        expand.push('--' + so + soval)
        f = arg.length
      ***REMOVED*** else if (arg !== '-' + fc)
        expand.push('-' + fc)
    ***REMOVED***
    if (expand.length) ***REMOVED***
      args.splice.apply(args, [i, 1].concat(expand))
      i--
      continue
    ***REMOVED***
  ***REMOVED***

  const argsplit = arg.split('=')
  const key = argsplit.shift().replace(/^\-\-/, '')
  const val = argsplit.length ? argsplit.join('=') : null

  switch (key) ***REMOVED***
    case 'time':
      const timestr = val || args[++i]
      // [-t [[CC]YY]MMDDhhmm[.SS]]
      const parsedtime = timestr.match(
        /^(([0-9]***REMOVED***2***REMOVED***)?([0-9]***REMOVED***2***REMOVED***))?([0-9]***REMOVED***2***REMOVED***)([0-9]***REMOVED***2***REMOVED***)([0-9]***REMOVED***2***REMOVED***)([0-9]***REMOVED***2***REMOVED***)(\.([0-9]***REMOVED***2***REMOVED***))?$/
      )
      if (!parsedtime) ***REMOVED***
        console.error('touch: out of range or illegal ' +
                      'time specification: ' +
                      '[[CC]YY]MMDDhhmm[.SS]')
        process.exit(1)
      ***REMOVED*** else ***REMOVED***
        const y = +parsedtime[1]
        const year = parsedtime[2] ? y
          : y <= 68 ? 2000 + y
          : 1900 + y

        const MM = +parsedtime[4] - 1
        const dd = +parsedtime[5]
        const hh = +parsedtime[6]
        const mm = +parsedtime[7]
        const ss = +parsedtime[8]

        options.time = new Date(Date.UTC(year, MM, dd, hh, mm, ss))
      ***REMOVED***
      continue

    case 'ref':
      options.ref = val || args[++i]
      continue

    case 'mtime':
    case 'nocreate':
    case 'atime':
    case 'force':
      options[key] = true
      continue

    default:
      console.error('touch: illegal option -- ' + arg)
      usage(1)
  ***REMOVED***
***REMOVED***

if (!files.length)
  usage()

process.exitCode = 0
Promise.all(files.map(f => touch(f, options)))
  .catch(er => process.exitCode = 1)
