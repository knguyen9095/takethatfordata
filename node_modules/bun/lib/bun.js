var stream = require("readable-stream");

var BunWrapper = function BunWrapper(options) ***REMOVED***
  options = options || ***REMOVED******REMOVED***;

  if (Array.isArray(options)) ***REMOVED***
    options = ***REMOVED***streams: options***REMOVED***;
  ***REMOVED***

  options.objectMode = true;

  stream.Duplex.call(this, options);

  var self = this;

  // grab a copy of the streams array
  this._streams = (options.streams || []).slice();

  // we need at least one stream to do things
  if (this._streams.length === 0) ***REMOVED***
    this._streams.push(new stream.PassThrough(***REMOVED***objectMode: true***REMOVED***));
  ***REMOVED***

  // default: true
  this._bubbleErrors = (typeof options.bubbleErrors === "undefined") || !!options.bubbleErrors;

  // error bubbling! yay!
  if (this._bubbleErrors) ***REMOVED***
    for (var i=0;i<this._streams.length;++i) ***REMOVED***
      this._streams[i].on("error", function(e) ***REMOVED***
        return self.emit("error", e);
      ***REMOVED***);
    ***REMOVED***
  ***REMOVED***

  // 0 -> 1, 1 -> 2, ..., n-1 -> n
  for (var i=0;i<this._streams.length-1;++i) ***REMOVED***
    this._streams[i].pipe(this._streams[i+1]);
  ***REMOVED***

  // these might actually be the same. that's ok.
  this._first = this._streams[0];
  this._last  = this._streams[this._streams.length-1];

  // .on("data") is supported again in 0.11 and has always worked in 0.10
  this._last.on("data", function(e) ***REMOVED***
    if (!self.push(e)) ***REMOVED***
      self._last.pause();
    ***REMOVED***
  ***REMOVED***);

  // this is the readable side of our pipe ending
  this._last.on("end", function() ***REMOVED***
    self.push(null);
  ***REMOVED***);

  // and here's the writable side finishing
  this._first.on("finish", function() ***REMOVED***
    self.end();
  ***REMOVED***);

  // proxy through the .end() action
  this.on("finish", function() ***REMOVED***
    self._first.end();
  ***REMOVED***);
***REMOVED***;
BunWrapper.prototype = Object.create(stream.Duplex.prototype, ***REMOVED***constructor: ***REMOVED***value: BunWrapper***REMOVED******REMOVED***);

BunWrapper.prototype._write = function _write(input, encoding, done) ***REMOVED***
  this._first.write(input, done);
***REMOVED***;

BunWrapper.prototype._read = function _read(n) ***REMOVED***
  this._last.resume();
***REMOVED***;

// factory function
var bun = module.exports = function bun(options, streams) ***REMOVED***
  if (Array.isArray(options)) ***REMOVED***
    var tmp = streams;
    streams = options;
    options = tmp;
  ***REMOVED***

  options = options || ***REMOVED******REMOVED***;

  options.streams = options.streams || streams;

  return new BunWrapper(options);
***REMOVED***;

bun.BunWrapper = BunWrapper;
