"use strict";
module.exports = verifier;

var Enum      = require("./enum"),
    util      = require("./util");

function invalid(field, expected) ***REMOVED***
    return field.name + ": " + expected + (field.repeated && expected !== "array" ? "[]" : field.map && expected !== "object" ? "***REMOVED***k:"+field.keyType+"***REMOVED***" : "") + " expected";
***REMOVED***

/**
 * Generates a partial value verifier.
 * @param ***REMOVED***Codegen***REMOVED*** gen Codegen instance
 * @param ***REMOVED***Field***REMOVED*** field Reflected field
 * @param ***REMOVED***number***REMOVED*** fieldIndex Field index
 * @param ***REMOVED***string***REMOVED*** ref Variable reference
 * @returns ***REMOVED***Codegen***REMOVED*** Codegen instance
 * @ignore
 */
function genVerifyValue(gen, field, fieldIndex, ref) ***REMOVED***
    /* eslint-disable no-unexpected-multiline */
    if (field.resolvedType) ***REMOVED***
        if (field.resolvedType instanceof Enum) ***REMOVED*** gen
            ("switch(%s)***REMOVED***", ref)
                ("default:")
                    ("return%j", invalid(field, "enum value"));
            for (var keys = Object.keys(field.resolvedType.values), j = 0; j < keys.length; ++j) gen
                ("case %i:", field.resolvedType.values[keys[j]]);
            gen
                    ("break")
            ("***REMOVED***");
        ***REMOVED*** else ***REMOVED***
            gen
            ("***REMOVED***")
                ("var e=types[%i].verify(%s);", fieldIndex, ref)
                ("if(e)")
                    ("return%j+e", field.name + ".")
            ("***REMOVED***");
        ***REMOVED***
    ***REMOVED*** else ***REMOVED***
        switch (field.type) ***REMOVED***
            case "int32":
            case "uint32":
            case "sint32":
            case "fixed32":
            case "sfixed32": gen
                ("if(!util.isInteger(%s))", ref)
                    ("return%j", invalid(field, "integer"));
                break;
            case "int64":
            case "uint64":
            case "sint64":
            case "fixed64":
            case "sfixed64": gen
                ("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))", ref, ref, ref, ref)
                    ("return%j", invalid(field, "integer|Long"));
                break;
            case "float":
            case "double": gen
                ("if(typeof %s!==\"number\")", ref)
                    ("return%j", invalid(field, "number"));
                break;
            case "bool": gen
                ("if(typeof %s!==\"boolean\")", ref)
                    ("return%j", invalid(field, "boolean"));
                break;
            case "string": gen
                ("if(!util.isString(%s))", ref)
                    ("return%j", invalid(field, "string"));
                break;
            case "bytes": gen
                ("if(!(%s&&typeof %s.length===\"number\"||util.isString(%s)))", ref, ref, ref)
                    ("return%j", invalid(field, "buffer"));
                break;
        ***REMOVED***
    ***REMOVED***
    return gen;
    /* eslint-enable no-unexpected-multiline */
***REMOVED***

/**
 * Generates a partial key verifier.
 * @param ***REMOVED***Codegen***REMOVED*** gen Codegen instance
 * @param ***REMOVED***Field***REMOVED*** field Reflected field
 * @param ***REMOVED***string***REMOVED*** ref Variable reference
 * @returns ***REMOVED***Codegen***REMOVED*** Codegen instance
 * @ignore
 */
function genVerifyKey(gen, field, ref) ***REMOVED***
    /* eslint-disable no-unexpected-multiline */
    switch (field.keyType) ***REMOVED***
        case "int32":
        case "uint32":
        case "sint32":
        case "fixed32":
        case "sfixed32": gen
            ("if(!util.key32Re.test(%s))", ref)
                ("return%j", invalid(field, "integer key"));
            break;
        case "int64":
        case "uint64":
        case "sint64":
        case "fixed64":
        case "sfixed64": gen
            ("if(!util.key64Re.test(%s))", ref) // see comment above: x is ok, d is not
                ("return%j", invalid(field, "integer|Long key"));
            break;
        case "bool": gen
            ("if(!util.key2Re.test(%s))", ref)
                ("return%j", invalid(field, "boolean key"));
            break;
    ***REMOVED***
    return gen;
    /* eslint-enable no-unexpected-multiline */
***REMOVED***

/**
 * Generates a verifier specific to the specified message type.
 * @param ***REMOVED***Type***REMOVED*** mtype Message type
 * @returns ***REMOVED***Codegen***REMOVED*** Codegen instance
 */
function verifier(mtype) ***REMOVED***
    /* eslint-disable no-unexpected-multiline */

    var gen = util.codegen(["m"], mtype.name + "$verify")
    ("if(typeof m!==\"object\"||m===null)")
        ("return%j", "object expected");
    var oneofs = mtype.oneofsArray,
        seenFirstField = ***REMOVED******REMOVED***;
    if (oneofs.length) gen
    ("var p=***REMOVED******REMOVED***");

    for (var i = 0; i < /* initializes */ mtype.fieldsArray.length; ++i) ***REMOVED***
        var field = mtype._fieldsArray[i].resolve(),
            ref   = "m" + util.safeProp(field.name);

        if (field.optional) gen
        ("if(%s!=null&&m.hasOwnProperty(%j))***REMOVED***", ref, field.name); // !== undefined && !== null

        // map fields
        if (field.map) ***REMOVED*** gen
            ("if(!util.isObject(%s))", ref)
                ("return%j", invalid(field, "object"))
            ("var k=Object.keys(%s)", ref)
            ("for(var i=0;i<k.length;++i)***REMOVED***");
                genVerifyKey(gen, field, "k[i]");
                genVerifyValue(gen, field, i, ref + "[k[i]]")
            ("***REMOVED***");

        // repeated fields
        ***REMOVED*** else if (field.repeated) ***REMOVED*** gen
            ("if(!Array.isArray(%s))", ref)
                ("return%j", invalid(field, "array"))
            ("for(var i=0;i<%s.length;++i)***REMOVED***", ref);
                genVerifyValue(gen, field, i, ref + "[i]")
            ("***REMOVED***");

        // required or present fields
        ***REMOVED*** else ***REMOVED***
            if (field.partOf) ***REMOVED***
                var oneofProp = util.safeProp(field.partOf.name);
                if (seenFirstField[field.partOf.name] === 1) gen
            ("if(p%s===1)", oneofProp)
                ("return%j", field.partOf.name + ": multiple values");
                seenFirstField[field.partOf.name] = 1;
                gen
            ("p%s=1", oneofProp);
            ***REMOVED***
            genVerifyValue(gen, field, i, ref);
        ***REMOVED***
        if (field.optional) gen
        ("***REMOVED***");
    ***REMOVED***
    return gen
    ("return null");
    /* eslint-enable no-unexpected-multiline */
***REMOVED***