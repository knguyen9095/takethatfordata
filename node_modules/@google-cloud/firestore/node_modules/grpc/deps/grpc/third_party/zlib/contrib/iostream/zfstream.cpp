
#include "zfstream.h"

gzfilebuf::gzfilebuf() :
  file(NULL),
  mode(0),
  own_file_descriptor(0)
***REMOVED*** ***REMOVED***

gzfilebuf::~gzfilebuf() ***REMOVED***

  sync();
  if ( own_file_descriptor )
    close();

***REMOVED***

gzfilebuf *gzfilebuf::open( const char *name,
                            int io_mode ) ***REMOVED***

  if ( is_open() )
    return NULL;

  char char_mode[10];
  char *p = char_mode;

  if ( io_mode & ios::in ) ***REMOVED***
    mode = ios::in;
    *p++ = 'r';
  ***REMOVED*** else if ( io_mode & ios::app ) ***REMOVED***
    mode = ios::app;
    *p++ = 'a';
  ***REMOVED*** else ***REMOVED***
    mode = ios::out;
    *p++ = 'w';
  ***REMOVED***

  if ( io_mode & ios::binary ) ***REMOVED***
    mode |= ios::binary;
    *p++ = 'b';
  ***REMOVED***

  // Hard code the compression level
  if ( io_mode & (ios::out|ios::app )) ***REMOVED***
    *p++ = '9';
  ***REMOVED***

  // Put the end-of-string indicator
  *p = '\0';

  if ( (file = gzopen(name, char_mode)) == NULL )
    return NULL;

  own_file_descriptor = 1;

  return this;

***REMOVED***

gzfilebuf *gzfilebuf::attach( int file_descriptor,
                              int io_mode ) ***REMOVED***

  if ( is_open() )
    return NULL;

  char char_mode[10];
  char *p = char_mode;

  if ( io_mode & ios::in ) ***REMOVED***
    mode = ios::in;
    *p++ = 'r';
  ***REMOVED*** else if ( io_mode & ios::app ) ***REMOVED***
    mode = ios::app;
    *p++ = 'a';
  ***REMOVED*** else ***REMOVED***
    mode = ios::out;
    *p++ = 'w';
  ***REMOVED***

  if ( io_mode & ios::binary ) ***REMOVED***
    mode |= ios::binary;
    *p++ = 'b';
  ***REMOVED***

  // Hard code the compression level
  if ( io_mode & (ios::out|ios::app )) ***REMOVED***
    *p++ = '9';
  ***REMOVED***

  // Put the end-of-string indicator
  *p = '\0';

  if ( (file = gzdopen(file_descriptor, char_mode)) == NULL )
    return NULL;

  own_file_descriptor = 0;

  return this;

***REMOVED***

gzfilebuf *gzfilebuf::close() ***REMOVED***

  if ( is_open() ) ***REMOVED***

    sync();
    gzclose( file );
    file = NULL;

  ***REMOVED***

  return this;

***REMOVED***

int gzfilebuf::setcompressionlevel( int comp_level ) ***REMOVED***

  return gzsetparams(file, comp_level, -2);

***REMOVED***

int gzfilebuf::setcompressionstrategy( int comp_strategy ) ***REMOVED***

  return gzsetparams(file, -2, comp_strategy);

***REMOVED***


streampos gzfilebuf::seekoff( streamoff off, ios::seek_dir dir, int which ) ***REMOVED***

  return streampos(EOF);

***REMOVED***

int gzfilebuf::underflow() ***REMOVED***

  // If the file hasn't been opened for reading, error.
  if ( !is_open() || !(mode & ios::in) )
    return EOF;

  // if a buffer doesn't exists, allocate one.
  if ( !base() ) ***REMOVED***

    if ( (allocate()) == EOF )
      return EOF;
    setp(0,0);

  ***REMOVED*** else ***REMOVED***

    if ( in_avail() )
      return (unsigned char) *gptr();

    if ( out_waiting() ) ***REMOVED***
      if ( flushbuf() == EOF )
        return EOF;
    ***REMOVED***

  ***REMOVED***

  // Attempt to fill the buffer.

  int result = fillbuf();
  if ( result == EOF ) ***REMOVED***
    // disable get area
    setg(0,0,0);
    return EOF;
  ***REMOVED***

  return (unsigned char) *gptr();

***REMOVED***

int gzfilebuf::overflow( int c ) ***REMOVED***

  if ( !is_open() || !(mode & ios::out) )
    return EOF;

  if ( !base() ) ***REMOVED***
    if ( allocate() == EOF )
      return EOF;
    setg(0,0,0);
  ***REMOVED*** else ***REMOVED***
    if (in_avail()) ***REMOVED***
        return EOF;
    ***REMOVED***
    if (out_waiting()) ***REMOVED***
      if (flushbuf() == EOF)
        return EOF;
    ***REMOVED***
  ***REMOVED***

  int bl = blen();
  setp( base(), base() + bl);

  if ( c != EOF ) ***REMOVED***

    *pptr() = c;
    pbump(1);

  ***REMOVED***

  return 0;

***REMOVED***

int gzfilebuf::sync() ***REMOVED***

  if ( !is_open() )
    return EOF;

  if ( out_waiting() )
    return flushbuf();

  return 0;

***REMOVED***

int gzfilebuf::flushbuf() ***REMOVED***

  int n;
  char *q;

  q = pbase();
  n = pptr() - q;

  if ( gzwrite( file, q, n) < n )
    return EOF;

  setp(0,0);

  return 0;

***REMOVED***

int gzfilebuf::fillbuf() ***REMOVED***

  int required;
  char *p;

  p = base();

  required = blen();

  int t = gzread( file, p, required );

  if ( t <= 0) return EOF;

  setg( base(), base(), base()+t);

  return t;

***REMOVED***

gzfilestream_common::gzfilestream_common() :
  ios( gzfilestream_common::rdbuf() )
***REMOVED*** ***REMOVED***

gzfilestream_common::~gzfilestream_common()
***REMOVED*** ***REMOVED***

void gzfilestream_common::attach( int fd, int io_mode ) ***REMOVED***

  if ( !buffer.attach( fd, io_mode) )
    clear( ios::failbit | ios::badbit );
  else
    clear();

***REMOVED***

void gzfilestream_common::open( const char *name, int io_mode ) ***REMOVED***

  if ( !buffer.open( name, io_mode ) )
    clear( ios::failbit | ios::badbit );
  else
    clear();

***REMOVED***

void gzfilestream_common::close() ***REMOVED***

  if ( !buffer.close() )
    clear( ios::failbit | ios::badbit );

***REMOVED***

gzfilebuf *gzfilestream_common::rdbuf()
***REMOVED***
  return &buffer;
***REMOVED***

gzifstream::gzifstream() :
  ios( gzfilestream_common::rdbuf() )
***REMOVED***
  clear( ios::badbit );
***REMOVED***

gzifstream::gzifstream( const char *name, int io_mode ) :
  ios( gzfilestream_common::rdbuf() )
***REMOVED***
  gzfilestream_common::open( name, io_mode );
***REMOVED***

gzifstream::gzifstream( int fd, int io_mode ) :
  ios( gzfilestream_common::rdbuf() )
***REMOVED***
  gzfilestream_common::attach( fd, io_mode );
***REMOVED***

gzifstream::~gzifstream() ***REMOVED*** ***REMOVED***

gzofstream::gzofstream() :
  ios( gzfilestream_common::rdbuf() )
***REMOVED***
  clear( ios::badbit );
***REMOVED***

gzofstream::gzofstream( const char *name, int io_mode ) :
  ios( gzfilestream_common::rdbuf() )
***REMOVED***
  gzfilestream_common::open( name, io_mode );
***REMOVED***

gzofstream::gzofstream( int fd, int io_mode ) :
  ios( gzfilestream_common::rdbuf() )
***REMOVED***
  gzfilestream_common::attach( fd, io_mode );
***REMOVED***

gzofstream::~gzofstream() ***REMOVED*** ***REMOVED***
