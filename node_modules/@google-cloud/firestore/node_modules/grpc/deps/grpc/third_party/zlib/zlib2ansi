#!/usr/bin/perl

# Transform K&R C function definitions into ANSI equivalent.
#
# Author: Paul Marquess
# Version: 1.0
# Date: 3 October 2006

# TODO
#
# Asumes no function pointer parameters. unless they are typedefed.
# Assumes no literal strings that look like function definitions
# Assumes functions start at the beginning of a line

use strict;
use warnings;

local $/;
$_ = <>;

my $sp = qr***REMOVED*** \s* (?: /\* .*? \*/ )? \s* ***REMOVED***x; # assume no nested comments

my $d1    = qr***REMOVED*** $sp (?: [\w\*\s]+ $sp)* $sp \w+ $sp [\[\]\s]* $sp ***REMOVED***x ;
my $decl  = qr***REMOVED*** $sp (?: \w+ $sp )+ $d1 ***REMOVED***xo ;
my $dList = qr***REMOVED*** $sp $decl (?: $sp , $d1 )* $sp ; $sp ***REMOVED***xo ;


while (s/^
            (                  # Start $1
                (              #   Start $2
                    .*?        #     Minimal eat content
                    ( ^ \w [\w\s\*]+ )    #     $3 -- function name
                    \s*        #     optional whitespace
                )              # $2 - Matched up to before parameter list

                \( \s*         # Literal "(" + optional whitespace
                ( [^\)]+ )     # $4 - one or more anythings except ")"
                \s* \)         # optional whitespace surrounding a Literal ")"

                ( (?: $dList )+ ) # $5

                $sp ^ ***REMOVED***        # literal "***REMOVED***" at start of line
            )                  # Remember to $1
        //xsom
      )
***REMOVED***
    my $all = $1 ;
    my $prefix = $2;
    my $param_list = $4 ;
    my $params = $5;

    StripComments($params);
    StripComments($param_list);
    $param_list =~ s/^\s+//;
    $param_list =~ s/\s+$//;

    my $i = 0 ;
    my %pList = map ***REMOVED*** $_ => $i++ ***REMOVED***
                split /\s*,\s*/, $param_list;
    my $pMatch = '(\b' . join('|', keys %pList) . '\b)\W*$' ;

    my @params = split /\s*;\s*/, $params;
    my @outParams = ();
    foreach my $p (@params)
    ***REMOVED***
        if ($p =~ /,/)
        ***REMOVED***
            my @bits = split /\s*,\s*/, $p;
            my $first = shift @bits;
            $first =~ s/^\s*//;
            push @outParams, $first;
            $first =~ /^(\w+\s*)/;
            my $type = $1 ;
            push @outParams, map ***REMOVED*** $type . $_ ***REMOVED*** @bits;
        ***REMOVED***
        else
        ***REMOVED***
            $p =~ s/^\s+//;
            push @outParams, $p;
        ***REMOVED***
    ***REMOVED***


    my %tmp = map ***REMOVED*** /$pMatch/;  $_ => $pList***REMOVED***$1***REMOVED***  ***REMOVED***
              @outParams ;

    @outParams = map  ***REMOVED*** "    $_" ***REMOVED***
                 sort ***REMOVED*** $tmp***REMOVED***$a***REMOVED*** <=> $tmp***REMOVED***$b***REMOVED*** ***REMOVED***
                 @outParams ;

    print $prefix ;
    print "(\n" . join(",\n", @outParams) . ")\n";
    print "***REMOVED***" ;

***REMOVED***

# Output any trailing code.
print ;
exit 0;


sub StripComments
***REMOVED***

  no warnings;

  # Strip C & C++ coments
  # From the perlfaq
  $_[0] =~

    s***REMOVED***
       /\*         ##  Start of /* ... */ comment
       [^*]*\*+    ##  Non-* followed by 1-or-more *'s
       (
         [^/*][^*]*\*+
       )*          ##  0-or-more things which don't start with /
                   ##    but do end with '*'
       /           ##  End of /* ... */ comment

     |         ##     OR  C++ Comment
       //          ## Start of C++ comment //
       [^\n]*      ## followed by 0-or-more non end of line characters

     |         ##     OR  various things which aren't comments:

       (
         "           ##  Start of " ... " string
         (
           \\.           ##  Escaped char
         |               ##    OR
           [^"\\]        ##  Non "\
         )*
         "           ##  End of " ... " string

       |         ##     OR

         '           ##  Start of ' ... ' string
         (
           \\.           ##  Escaped char
         |               ##    OR
           [^'\\]        ##  Non '\
         )*
         '           ##  End of ' ... ' string

       |         ##     OR

         .           ##  Anything other char
         [^/"'\\]*   ##  Chars which doesn't start a comment, string or escape
       )
     ***REMOVED******REMOVED***$2***REMOVED***gxs;

***REMOVED***
