// Copyright (c) 2016, Google Inc.
//
// Permission to use, copy, modify, and/or distribute this software for any
// purpose with or without fee is hereby granted, provided that the above
// copyright notice and this permission notice appear in all copies.
//
// THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
// WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
// MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
// SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
// WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
// OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
// CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

package runner

import (
	"bytes"
	"crypto/ecdsa"
	"crypto/elliptic"
	"crypto/rand"
	"crypto/x509"
	"crypto/x509/pkix"
	"encoding/base64"
	"encoding/json"
	"encoding/pem"
	"errors"
	"flag"
	"fmt"
	"io"
	"io/ioutil"
	"math/big"
	"net"
	"os"
	"os/exec"
	"path"
	"path/filepath"
	"runtime"
	"strconv"
	"strings"
	"sync"
	"syscall"
	"time"
)

var (
	useValgrind        = flag.Bool("valgrind", false, "If true, run code under valgrind")
	useGDB             = flag.Bool("gdb", false, "If true, run BoringSSL code under gdb")
	useLLDB            = flag.Bool("lldb", false, "If true, run BoringSSL code under lldb")
	flagDebug          = flag.Bool("debug", false, "Hexdump the contents of the connection")
	mallocTest         = flag.Int64("malloc-test", -1, "If non-negative, run each test with each malloc in turn failing from the given number onwards.")
	mallocTestDebug    = flag.Bool("malloc-test-debug", false, "If true, ask bssl_shim to abort rather than fail a malloc. This can be used with a specific value for --malloc-test to identity the malloc failing that is causing problems.")
	jsonOutput         = flag.String("json-output", "", "The file to output JSON results to.")
	pipe               = flag.Bool("pipe", false, "If true, print status output suitable for piping into another program.")
	testToRun          = flag.String("test", "", "The pattern to filter tests to run, or empty to run all tests")
	numWorkers         = flag.Int("num-workers", runtime.NumCPU(), "The number of workers to run in parallel.")
	shimPath           = flag.String("shim-path", "../../../build/ssl/test/bssl_shim", "The location of the shim binary.")
	resourceDir        = flag.String("resource-dir", ".", "The directory in which to find certificate and key files.")
	fuzzer             = flag.Bool("fuzzer", false, "If true, tests against a BoringSSL built in fuzzer mode.")
	transcriptDir      = flag.String("transcript-dir", "", "The directory in which to write transcripts.")
	idleTimeout        = flag.Duration("idle-timeout", 15*time.Second, "The number of seconds to wait for a read or write to bssl_shim.")
	deterministic      = flag.Bool("deterministic", false, "If true, uses a deterministic PRNG in the runner.")
	allowUnimplemented = flag.Bool("allow-unimplemented", false, "If true, report pass even if some tests are unimplemented.")
	looseErrors        = flag.Bool("loose-errors", false, "If true, allow shims to report an untranslated error code.")
	shimConfigFile     = flag.String("shim-config", "", "A config file to use to configure the tests for this shim.")
	includeDisabled    = flag.Bool("include-disabled", false, "If true, also runs disabled tests.")
	repeatUntilFailure = flag.Bool("repeat-until-failure", false, "If true, the first selected test will be run repeatedly until failure.")
)

// ShimConfigurations is used with the “json” package and represents a shim
// config file.
type ShimConfiguration struct ***REMOVED***
	// DisabledTests maps from a glob-based pattern to a freeform string.
	// The glob pattern is used to exclude tests from being run and the
	// freeform string is unparsed but expected to explain why the test is
	// disabled.
	DisabledTests map[string]string

	// ErrorMap maps from expected error strings to the correct error
	// string for the shim in question. For example, it might map
	// “:NO_SHARED_CIPHER:” (a BoringSSL error string) to something
	// like “SSL_ERROR_NO_CYPHER_OVERLAP”.
	ErrorMap map[string]string
***REMOVED***

var shimConfig ShimConfiguration

type testCert int

const (
	testCertRSA testCert = iota
	testCertRSA1024
	testCertRSAChain
	testCertECDSAP256
	testCertECDSAP384
	testCertECDSAP521
)

const (
	rsaCertificateFile       = "cert.pem"
	rsa1024CertificateFile   = "rsa_1024_cert.pem"
	rsaChainCertificateFile  = "rsa_chain_cert.pem"
	ecdsaP256CertificateFile = "ecdsa_p256_cert.pem"
	ecdsaP384CertificateFile = "ecdsa_p384_cert.pem"
	ecdsaP521CertificateFile = "ecdsa_p521_cert.pem"
)

const (
	rsaKeyFile       = "key.pem"
	rsa1024KeyFile   = "rsa_1024_key.pem"
	rsaChainKeyFile  = "rsa_chain_key.pem"
	ecdsaP256KeyFile = "ecdsa_p256_key.pem"
	ecdsaP384KeyFile = "ecdsa_p384_key.pem"
	ecdsaP521KeyFile = "ecdsa_p521_key.pem"
	channelIDKeyFile = "channel_id_key.pem"
)

var (
	rsaCertificate       Certificate
	rsa1024Certificate   Certificate
	rsaChainCertificate  Certificate
	ecdsaP256Certificate Certificate
	ecdsaP384Certificate Certificate
	ecdsaP521Certificate Certificate
)

var testCerts = []struct ***REMOVED***
	id                testCert
	certFile, keyFile string
	cert              *Certificate
***REMOVED******REMOVED***
	***REMOVED***
		id:       testCertRSA,
		certFile: rsaCertificateFile,
		keyFile:  rsaKeyFile,
		cert:     &rsaCertificate,
	***REMOVED***,
	***REMOVED***
		id:       testCertRSA1024,
		certFile: rsa1024CertificateFile,
		keyFile:  rsa1024KeyFile,
		cert:     &rsa1024Certificate,
	***REMOVED***,
	***REMOVED***
		id:       testCertRSAChain,
		certFile: rsaChainCertificateFile,
		keyFile:  rsaChainKeyFile,
		cert:     &rsaChainCertificate,
	***REMOVED***,
	***REMOVED***
		id:       testCertECDSAP256,
		certFile: ecdsaP256CertificateFile,
		keyFile:  ecdsaP256KeyFile,
		cert:     &ecdsaP256Certificate,
	***REMOVED***,
	***REMOVED***
		id:       testCertECDSAP384,
		certFile: ecdsaP384CertificateFile,
		keyFile:  ecdsaP384KeyFile,
		cert:     &ecdsaP384Certificate,
	***REMOVED***,
	***REMOVED***
		id:       testCertECDSAP521,
		certFile: ecdsaP521CertificateFile,
		keyFile:  ecdsaP521KeyFile,
		cert:     &ecdsaP521Certificate,
	***REMOVED***,
***REMOVED***

var channelIDKey *ecdsa.PrivateKey
var channelIDBytes []byte

var testOCSPResponse = []byte***REMOVED***1, 2, 3, 4***REMOVED***
var testSCTList = []byte***REMOVED***0, 6, 0, 4, 5, 6, 7, 8***REMOVED***

var testOCSPExtension = append([]byte***REMOVED***byte(extensionStatusRequest) >> 8, byte(extensionStatusRequest), 0, 8, statusTypeOCSP, 0, 0, 4***REMOVED***, testOCSPResponse...)
var testSCTExtension = append([]byte***REMOVED***byte(extensionSignedCertificateTimestamp) >> 8, byte(extensionSignedCertificateTimestamp), 0, byte(len(testSCTList))***REMOVED***, testSCTList...)

func initCertificates() ***REMOVED***
	for i := range testCerts ***REMOVED***
		cert, err := LoadX509KeyPair(path.Join(*resourceDir, testCerts[i].certFile), path.Join(*resourceDir, testCerts[i].keyFile))
		if err != nil ***REMOVED***
			panic(err)
		***REMOVED***
		cert.OCSPStaple = testOCSPResponse
		cert.SignedCertificateTimestampList = testSCTList
		*testCerts[i].cert = cert
	***REMOVED***

	channelIDPEMBlock, err := ioutil.ReadFile(path.Join(*resourceDir, channelIDKeyFile))
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***
	channelIDDERBlock, _ := pem.Decode(channelIDPEMBlock)
	if channelIDDERBlock.Type != "EC PRIVATE KEY" ***REMOVED***
		panic("bad key type")
	***REMOVED***
	channelIDKey, err = x509.ParseECPrivateKey(channelIDDERBlock.Bytes)
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***
	if channelIDKey.Curve != elliptic.P256() ***REMOVED***
		panic("bad curve")
	***REMOVED***

	channelIDBytes = make([]byte, 64)
	writeIntPadded(channelIDBytes[:32], channelIDKey.X)
	writeIntPadded(channelIDBytes[32:], channelIDKey.Y)
***REMOVED***

func getRunnerCertificate(t testCert) Certificate ***REMOVED***
	for _, cert := range testCerts ***REMOVED***
		if cert.id == t ***REMOVED***
			return *cert.cert
		***REMOVED***
	***REMOVED***
	panic("Unknown test certificate")
***REMOVED***

func getShimCertificate(t testCert) string ***REMOVED***
	for _, cert := range testCerts ***REMOVED***
		if cert.id == t ***REMOVED***
			return cert.certFile
		***REMOVED***
	***REMOVED***
	panic("Unknown test certificate")
***REMOVED***

func getShimKey(t testCert) string ***REMOVED***
	for _, cert := range testCerts ***REMOVED***
		if cert.id == t ***REMOVED***
			return cert.keyFile
		***REMOVED***
	***REMOVED***
	panic("Unknown test certificate")
***REMOVED***

type testType int

const (
	clientTest testType = iota
	serverTest
)

type protocol int

const (
	tls protocol = iota
	dtls
)

const (
	alpn = 1
	npn  = 2
)

type testCase struct ***REMOVED***
	testType      testType
	protocol      protocol
	name          string
	config        Config
	shouldFail    bool
	expectedError string
	// expectedLocalError, if not empty, contains a substring that must be
	// found in the local error.
	expectedLocalError string
	// expectedVersion, if non-zero, specifies the TLS version that must be
	// negotiated.
	expectedVersion uint16
	// expectedResumeVersion, if non-zero, specifies the TLS version that
	// must be negotiated on resumption. If zero, expectedVersion is used.
	expectedResumeVersion uint16
	// expectedCipher, if non-zero, specifies the TLS cipher suite that
	// should be negotiated.
	expectedCipher uint16
	// expectChannelID controls whether the connection should have
	// negotiated a Channel ID with channelIDKey.
	expectChannelID bool
	// expectedNextProto controls whether the connection should
	// negotiate a next protocol via NPN or ALPN.
	expectedNextProto string
	// expectNoNextProto, if true, means that no next protocol should be
	// negotiated.
	expectNoNextProto bool
	// expectedNextProtoType, if non-zero, is the expected next
	// protocol negotiation mechanism.
	expectedNextProtoType int
	// expectedSRTPProtectionProfile is the DTLS-SRTP profile that
	// should be negotiated. If zero, none should be negotiated.
	expectedSRTPProtectionProfile uint16
	// expectedOCSPResponse, if not nil, is the expected OCSP response to be received.
	expectedOCSPResponse []uint8
	// expectedSCTList, if not nil, is the expected SCT list to be received.
	expectedSCTList []uint8
	// expectedPeerSignatureAlgorithm, if not zero, is the signature
	// algorithm that the peer should have used in the handshake.
	expectedPeerSignatureAlgorithm signatureAlgorithm
	// expectedCurveID, if not zero, is the curve that the handshake should
	// have used.
	expectedCurveID CurveID
	// messageLen is the length, in bytes, of the test message that will be
	// sent.
	messageLen int
	// messageCount is the number of test messages that will be sent.
	messageCount int
	// certFile is the path to the certificate to use for the server.
	certFile string
	// keyFile is the path to the private key to use for the server.
	keyFile string
	// resumeSession controls whether a second connection should be tested
	// which attempts to resume the first session.
	resumeSession bool
	// resumeRenewedSession controls whether a third connection should be
	// tested which attempts to resume the second connection's session.
	resumeRenewedSession bool
	// expectResumeRejected, if true, specifies that the attempted
	// resumption must be rejected by the client. This is only valid for a
	// serverTest.
	expectResumeRejected bool
	// resumeConfig, if not nil, points to a Config to be used on
	// resumption. Unless newSessionsOnResume is set,
	// SessionTicketKey, ServerSessionCache, and
	// ClientSessionCache are copied from the initial connection's
	// config. If nil, the initial connection's config is used.
	resumeConfig *Config
	// newSessionsOnResume, if true, will cause resumeConfig to
	// use a different session resumption context.
	newSessionsOnResume bool
	// noSessionCache, if true, will cause the server to run without a
	// session cache.
	noSessionCache bool
	// sendPrefix sends a prefix on the socket before actually performing a
	// handshake.
	sendPrefix string
	// shimWritesFirst controls whether the shim sends an initial "hello"
	// message before doing a roundtrip with the runner.
	shimWritesFirst bool
	// shimShutsDown, if true, runs a test where the shim shuts down the
	// connection immediately after the handshake rather than echoing
	// messages from the runner.
	shimShutsDown bool
	// renegotiate indicates the number of times the connection should be
	// renegotiated during the exchange.
	renegotiate int
	// sendHalfHelloRequest, if true, causes the server to send half a
	// HelloRequest when the handshake completes.
	sendHalfHelloRequest bool
	// renegotiateCiphers is a list of ciphersuite ids that will be
	// switched in just before renegotiation.
	renegotiateCiphers []uint16
	// replayWrites, if true, configures the underlying transport
	// to replay every write it makes in DTLS tests.
	replayWrites bool
	// damageFirstWrite, if true, configures the underlying transport to
	// damage the final byte of the first application data write.
	damageFirstWrite bool
	// exportKeyingMaterial, if non-zero, configures the test to exchange
	// keying material and verify they match.
	exportKeyingMaterial int
	exportLabel          string
	exportContext        string
	useExportContext     bool
	// flags, if not empty, contains a list of command-line flags that will
	// be passed to the shim program.
	flags []string
	// testTLSUnique, if true, causes the shim to send the tls-unique value
	// which will be compared against the expected value.
	testTLSUnique bool
	// sendEmptyRecords is the number of consecutive empty records to send
	// before and after the test message.
	sendEmptyRecords int
	// sendWarningAlerts is the number of consecutive warning alerts to send
	// before and after the test message.
	sendWarningAlerts int
	// sendKeyUpdates is the number of consecutive key updates to send
	// before and after the test message.
	sendKeyUpdates int
	// keyUpdateRequest is the KeyUpdateRequest value to send in KeyUpdate messages.
	keyUpdateRequest byte
	// expectMessageDropped, if true, means the test message is expected to
	// be dropped by the client rather than echoed back.
	expectMessageDropped bool
	// expectPeerCertificate, if not nil, is the certificate chain the peer
	// is expected to send.
	expectPeerCertificate *Certificate
	// expectShortHeader is whether the short header extension should be negotiated.
	expectShortHeader bool
***REMOVED***

var testCases []testCase

func writeTranscript(test *testCase, num int, data []byte) ***REMOVED***
	if len(data) == 0 ***REMOVED***
		return
	***REMOVED***

	protocol := "tls"
	if test.protocol == dtls ***REMOVED***
		protocol = "dtls"
	***REMOVED***

	side := "client"
	if test.testType == serverTest ***REMOVED***
		side = "server"
	***REMOVED***

	dir := path.Join(*transcriptDir, protocol, side)
	if err := os.MkdirAll(dir, 0755); err != nil ***REMOVED***
		fmt.Fprintf(os.Stderr, "Error making %s: %s\n", dir, err)
		return
	***REMOVED***

	name := fmt.Sprintf("%s-%d", test.name, num)
	if err := ioutil.WriteFile(path.Join(dir, name), data, 0644); err != nil ***REMOVED***
		fmt.Fprintf(os.Stderr, "Error writing %s: %s\n", name, err)
	***REMOVED***
***REMOVED***

// A timeoutConn implements an idle timeout on each Read and Write operation.
type timeoutConn struct ***REMOVED***
	net.Conn
	timeout time.Duration
***REMOVED***

func (t *timeoutConn) Read(b []byte) (int, error) ***REMOVED***
	if err := t.SetReadDeadline(time.Now().Add(t.timeout)); err != nil ***REMOVED***
		return 0, err
	***REMOVED***
	return t.Conn.Read(b)
***REMOVED***

func (t *timeoutConn) Write(b []byte) (int, error) ***REMOVED***
	if err := t.SetWriteDeadline(time.Now().Add(t.timeout)); err != nil ***REMOVED***
		return 0, err
	***REMOVED***
	return t.Conn.Write(b)
***REMOVED***

func doExchange(test *testCase, config *Config, conn net.Conn, isResume bool, num int) error ***REMOVED***
	if !test.noSessionCache ***REMOVED***
		if config.ClientSessionCache == nil ***REMOVED***
			config.ClientSessionCache = NewLRUClientSessionCache(1)
		***REMOVED***
		if config.ServerSessionCache == nil ***REMOVED***
			config.ServerSessionCache = NewLRUServerSessionCache(1)
		***REMOVED***
	***REMOVED***
	if test.testType == clientTest ***REMOVED***
		if len(config.Certificates) == 0 ***REMOVED***
			config.Certificates = []Certificate***REMOVED***rsaCertificate***REMOVED***
		***REMOVED***
	***REMOVED*** else ***REMOVED***
		// Supply a ServerName to ensure a constant session cache key,
		// rather than falling back to net.Conn.RemoteAddr.
		if len(config.ServerName) == 0 ***REMOVED***
			config.ServerName = "test"
		***REMOVED***
	***REMOVED***
	if *fuzzer ***REMOVED***
		config.Bugs.NullAllCiphers = true
	***REMOVED***
	if *deterministic ***REMOVED***
		config.Time = func() time.Time ***REMOVED*** return time.Unix(1234, 1234) ***REMOVED***
	***REMOVED***

	conn = &timeoutConn***REMOVED***conn, *idleTimeout***REMOVED***

	if test.protocol == dtls ***REMOVED***
		config.Bugs.PacketAdaptor = newPacketAdaptor(conn)
		conn = config.Bugs.PacketAdaptor
	***REMOVED***

	if *flagDebug || len(*transcriptDir) != 0 ***REMOVED***
		local, peer := "client", "server"
		if test.testType == clientTest ***REMOVED***
			local, peer = peer, local
		***REMOVED***
		connDebug := &recordingConn***REMOVED***
			Conn:       conn,
			isDatagram: test.protocol == dtls,
			local:      local,
			peer:       peer,
		***REMOVED***
		conn = connDebug
		if *flagDebug ***REMOVED***
			defer connDebug.WriteTo(os.Stdout)
		***REMOVED***
		if len(*transcriptDir) != 0 ***REMOVED***
			defer func() ***REMOVED***
				writeTranscript(test, num, connDebug.Transcript())
			***REMOVED***()
		***REMOVED***

		if config.Bugs.PacketAdaptor != nil ***REMOVED***
			config.Bugs.PacketAdaptor.debug = connDebug
		***REMOVED***
	***REMOVED***

	if test.replayWrites ***REMOVED***
		conn = newReplayAdaptor(conn)
	***REMOVED***

	var connDamage *damageAdaptor
	if test.damageFirstWrite ***REMOVED***
		connDamage = newDamageAdaptor(conn)
		conn = connDamage
	***REMOVED***

	if test.sendPrefix != "" ***REMOVED***
		if _, err := conn.Write([]byte(test.sendPrefix)); err != nil ***REMOVED***
			return err
		***REMOVED***
	***REMOVED***

	var tlsConn *Conn
	if test.testType == clientTest ***REMOVED***
		if test.protocol == dtls ***REMOVED***
			tlsConn = DTLSServer(conn, config)
		***REMOVED*** else ***REMOVED***
			tlsConn = Server(conn, config)
		***REMOVED***
	***REMOVED*** else ***REMOVED***
		config.InsecureSkipVerify = true
		if test.protocol == dtls ***REMOVED***
			tlsConn = DTLSClient(conn, config)
		***REMOVED*** else ***REMOVED***
			tlsConn = Client(conn, config)
		***REMOVED***
	***REMOVED***
	defer tlsConn.Close()

	if err := tlsConn.Handshake(); err != nil ***REMOVED***
		return err
	***REMOVED***

	// TODO(davidben): move all per-connection expectations into a dedicated
	// expectations struct that can be specified separately for the two
	// legs.
	expectedVersion := test.expectedVersion
	if isResume && test.expectedResumeVersion != 0 ***REMOVED***
		expectedVersion = test.expectedResumeVersion
	***REMOVED***
	connState := tlsConn.ConnectionState()
	if vers := connState.Version; expectedVersion != 0 && vers != expectedVersion ***REMOVED***
		return fmt.Errorf("got version %x, expected %x", vers, expectedVersion)
	***REMOVED***

	if cipher := connState.CipherSuite; test.expectedCipher != 0 && cipher != test.expectedCipher ***REMOVED***
		return fmt.Errorf("got cipher %x, expected %x", cipher, test.expectedCipher)
	***REMOVED***
	if didResume := connState.DidResume; isResume && didResume == test.expectResumeRejected ***REMOVED***
		return fmt.Errorf("didResume is %t, but we expected the opposite", didResume)
	***REMOVED***

	if test.expectChannelID ***REMOVED***
		channelID := connState.ChannelID
		if channelID == nil ***REMOVED***
			return fmt.Errorf("no channel ID negotiated")
		***REMOVED***
		if channelID.Curve != channelIDKey.Curve ||
			channelIDKey.X.Cmp(channelIDKey.X) != 0 ||
			channelIDKey.Y.Cmp(channelIDKey.Y) != 0 ***REMOVED***
			return fmt.Errorf("incorrect channel ID")
		***REMOVED***
	***REMOVED***

	if expected := test.expectedNextProto; expected != "" ***REMOVED***
		if actual := connState.NegotiatedProtocol; actual != expected ***REMOVED***
			return fmt.Errorf("next proto mismatch: got %s, wanted %s", actual, expected)
		***REMOVED***
	***REMOVED***

	if test.expectNoNextProto ***REMOVED***
		if actual := connState.NegotiatedProtocol; actual != "" ***REMOVED***
			return fmt.Errorf("got unexpected next proto %s", actual)
		***REMOVED***
	***REMOVED***

	if test.expectedNextProtoType != 0 ***REMOVED***
		if (test.expectedNextProtoType == alpn) != connState.NegotiatedProtocolFromALPN ***REMOVED***
			return fmt.Errorf("next proto type mismatch")
		***REMOVED***
	***REMOVED***

	if p := connState.SRTPProtectionProfile; p != test.expectedSRTPProtectionProfile ***REMOVED***
		return fmt.Errorf("SRTP profile mismatch: got %d, wanted %d", p, test.expectedSRTPProtectionProfile)
	***REMOVED***

	if test.expectedOCSPResponse != nil && !bytes.Equal(test.expectedOCSPResponse, tlsConn.OCSPResponse()) ***REMOVED***
		return fmt.Errorf("OCSP Response mismatch: got %x, wanted %x", tlsConn.OCSPResponse(), test.expectedOCSPResponse)
	***REMOVED***

	if test.expectedSCTList != nil && !bytes.Equal(test.expectedSCTList, connState.SCTList) ***REMOVED***
		return fmt.Errorf("SCT list mismatch")
	***REMOVED***

	if expected := test.expectedPeerSignatureAlgorithm; expected != 0 && expected != connState.PeerSignatureAlgorithm ***REMOVED***
		return fmt.Errorf("expected peer to use signature algorithm %04x, but got %04x", expected, connState.PeerSignatureAlgorithm)
	***REMOVED***

	if expected := test.expectedCurveID; expected != 0 && expected != connState.CurveID ***REMOVED***
		return fmt.Errorf("expected peer to use curve %04x, but got %04x", expected, connState.CurveID)
	***REMOVED***

	if test.expectPeerCertificate != nil ***REMOVED***
		if len(connState.PeerCertificates) != len(test.expectPeerCertificate.Certificate) ***REMOVED***
			return fmt.Errorf("expected peer to send %d certificates, but got %d", len(connState.PeerCertificates), len(test.expectPeerCertificate.Certificate))
		***REMOVED***
		for i, cert := range connState.PeerCertificates ***REMOVED***
			if !bytes.Equal(cert.Raw, test.expectPeerCertificate.Certificate[i]) ***REMOVED***
				return fmt.Errorf("peer certificate %d did not match", i+1)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	if test.expectShortHeader != connState.ShortHeader ***REMOVED***
		return fmt.Errorf("ShortHeader is %t, but we expected the opposite", connState.ShortHeader)
	***REMOVED***

	if test.exportKeyingMaterial > 0 ***REMOVED***
		actual := make([]byte, test.exportKeyingMaterial)
		if _, err := io.ReadFull(tlsConn, actual); err != nil ***REMOVED***
			return err
		***REMOVED***
		expected, err := tlsConn.ExportKeyingMaterial(test.exportKeyingMaterial, []byte(test.exportLabel), []byte(test.exportContext), test.useExportContext)
		if err != nil ***REMOVED***
			return err
		***REMOVED***
		if !bytes.Equal(actual, expected) ***REMOVED***
			return fmt.Errorf("keying material mismatch")
		***REMOVED***
	***REMOVED***

	if test.testTLSUnique ***REMOVED***
		var peersValue [12]byte
		if _, err := io.ReadFull(tlsConn, peersValue[:]); err != nil ***REMOVED***
			return err
		***REMOVED***
		expected := tlsConn.ConnectionState().TLSUnique
		if !bytes.Equal(peersValue[:], expected) ***REMOVED***
			return fmt.Errorf("tls-unique mismatch: peer sent %x, but %x was expected", peersValue[:], expected)
		***REMOVED***
	***REMOVED***

	if test.shimWritesFirst ***REMOVED***
		var buf [5]byte
		_, err := io.ReadFull(tlsConn, buf[:])
		if err != nil ***REMOVED***
			return err
		***REMOVED***
		if string(buf[:]) != "hello" ***REMOVED***
			return fmt.Errorf("bad initial message")
		***REMOVED***
	***REMOVED***

	for i := 0; i < test.sendKeyUpdates; i++ ***REMOVED***
		if err := tlsConn.SendKeyUpdate(test.keyUpdateRequest); err != nil ***REMOVED***
			return err
		***REMOVED***
	***REMOVED***

	for i := 0; i < test.sendEmptyRecords; i++ ***REMOVED***
		tlsConn.Write(nil)
	***REMOVED***

	for i := 0; i < test.sendWarningAlerts; i++ ***REMOVED***
		tlsConn.SendAlert(alertLevelWarning, alertUnexpectedMessage)
	***REMOVED***

	if test.sendHalfHelloRequest ***REMOVED***
		tlsConn.SendHalfHelloRequest()
	***REMOVED***

	if test.renegotiate > 0 ***REMOVED***
		if test.renegotiateCiphers != nil ***REMOVED***
			config.CipherSuites = test.renegotiateCiphers
		***REMOVED***
		for i := 0; i < test.renegotiate; i++ ***REMOVED***
			if err := tlsConn.Renegotiate(); err != nil ***REMOVED***
				return err
			***REMOVED***
		***REMOVED***
	***REMOVED*** else if test.renegotiateCiphers != nil ***REMOVED***
		panic("renegotiateCiphers without renegotiate")
	***REMOVED***

	if test.damageFirstWrite ***REMOVED***
		connDamage.setDamage(true)
		tlsConn.Write([]byte("DAMAGED WRITE"))
		connDamage.setDamage(false)
	***REMOVED***

	messageLen := test.messageLen
	if messageLen < 0 ***REMOVED***
		if test.protocol == dtls ***REMOVED***
			return fmt.Errorf("messageLen < 0 not supported for DTLS tests")
		***REMOVED***
		// Read until EOF.
		_, err := io.Copy(ioutil.Discard, tlsConn)
		return err
	***REMOVED***
	if messageLen == 0 ***REMOVED***
		messageLen = 32
	***REMOVED***

	messageCount := test.messageCount
	if messageCount == 0 ***REMOVED***
		messageCount = 1
	***REMOVED***

	for j := 0; j < messageCount; j++ ***REMOVED***
		testMessage := make([]byte, messageLen)
		for i := range testMessage ***REMOVED***
			testMessage[i] = 0x42 ^ byte(j)
		***REMOVED***
		tlsConn.Write(testMessage)

		for i := 0; i < test.sendKeyUpdates; i++ ***REMOVED***
			tlsConn.SendKeyUpdate(test.keyUpdateRequest)
		***REMOVED***

		for i := 0; i < test.sendEmptyRecords; i++ ***REMOVED***
			tlsConn.Write(nil)
		***REMOVED***

		for i := 0; i < test.sendWarningAlerts; i++ ***REMOVED***
			tlsConn.SendAlert(alertLevelWarning, alertUnexpectedMessage)
		***REMOVED***

		if test.shimShutsDown || test.expectMessageDropped ***REMOVED***
			// The shim will not respond.
			continue
		***REMOVED***

		buf := make([]byte, len(testMessage))
		if test.protocol == dtls ***REMOVED***
			bufTmp := make([]byte, len(buf)+1)
			n, err := tlsConn.Read(bufTmp)
			if err != nil ***REMOVED***
				return err
			***REMOVED***
			if n != len(buf) ***REMOVED***
				return fmt.Errorf("bad reply; length mismatch (%d vs %d)", n, len(buf))
			***REMOVED***
			copy(buf, bufTmp)
		***REMOVED*** else ***REMOVED***
			_, err := io.ReadFull(tlsConn, buf)
			if err != nil ***REMOVED***
				return err
			***REMOVED***
		***REMOVED***

		for i, v := range buf ***REMOVED***
			if v != testMessage[i]^0xff ***REMOVED***
				return fmt.Errorf("bad reply contents at byte %d", i)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	return nil
***REMOVED***

func valgrindOf(dbAttach bool, path string, args ...string) *exec.Cmd ***REMOVED***
	valgrindArgs := []string***REMOVED***"--error-exitcode=99", "--track-origins=yes", "--leak-check=full", "--quiet"***REMOVED***
	if dbAttach ***REMOVED***
		valgrindArgs = append(valgrindArgs, "--db-attach=yes", "--db-command=xterm -e gdb -nw %f %p")
	***REMOVED***
	valgrindArgs = append(valgrindArgs, path)
	valgrindArgs = append(valgrindArgs, args...)

	return exec.Command("valgrind", valgrindArgs...)
***REMOVED***

func gdbOf(path string, args ...string) *exec.Cmd ***REMOVED***
	xtermArgs := []string***REMOVED***"-e", "gdb", "--args"***REMOVED***
	xtermArgs = append(xtermArgs, path)
	xtermArgs = append(xtermArgs, args...)

	return exec.Command("xterm", xtermArgs...)
***REMOVED***

func lldbOf(path string, args ...string) *exec.Cmd ***REMOVED***
	xtermArgs := []string***REMOVED***"-e", "lldb", "--"***REMOVED***
	xtermArgs = append(xtermArgs, path)
	xtermArgs = append(xtermArgs, args...)

	return exec.Command("xterm", xtermArgs...)
***REMOVED***

var (
	errMoreMallocs   = errors.New("child process did not exhaust all allocation calls")
	errUnimplemented = errors.New("child process does not implement needed flags")
)

// accept accepts a connection from listener, unless waitChan signals a process
// exit first.
func acceptOrWait(listener net.Listener, waitChan chan error) (net.Conn, error) ***REMOVED***
	type connOrError struct ***REMOVED***
		conn net.Conn
		err  error
	***REMOVED***
	connChan := make(chan connOrError, 1)
	go func() ***REMOVED***
		conn, err := listener.Accept()
		connChan <- connOrError***REMOVED***conn, err***REMOVED***
		close(connChan)
	***REMOVED***()
	select ***REMOVED***
	case result := <-connChan:
		return result.conn, result.err
	case childErr := <-waitChan:
		waitChan <- childErr
		return nil, fmt.Errorf("child exited early: %s", childErr)
	***REMOVED***
***REMOVED***

func translateExpectedError(errorStr string) string ***REMOVED***
	if translated, ok := shimConfig.ErrorMap[errorStr]; ok ***REMOVED***
		return translated
	***REMOVED***

	if *looseErrors ***REMOVED***
		return ""
	***REMOVED***

	return errorStr
***REMOVED***

func runTest(test *testCase, shimPath string, mallocNumToFail int64) error ***REMOVED***
	// Help debugging panics on the Go side.
	defer func() ***REMOVED***
		if r := recover(); r != nil ***REMOVED***
			fmt.Fprintf(os.Stderr, "Test '%s' panicked.\n", test.name)
			panic(r)
		***REMOVED***
	***REMOVED***()

	if !test.shouldFail && (len(test.expectedError) > 0 || len(test.expectedLocalError) > 0) ***REMOVED***
		panic("Error expected without shouldFail in " + test.name)
	***REMOVED***

	if test.expectResumeRejected && !test.resumeSession ***REMOVED***
		panic("expectResumeRejected without resumeSession in " + test.name)
	***REMOVED***

	for _, ver := range tlsVersions ***REMOVED***
		if !strings.Contains("-"+test.name+"-", "-"+ver.name+"-") ***REMOVED***
			continue
		***REMOVED***

		if test.config.MaxVersion != 0 || test.config.MinVersion != 0 || test.expectedVersion != 0 ***REMOVED***
			continue
		***REMOVED***

		panic(fmt.Sprintf("The name of test %q suggests that it's version specific, but min/max version in the Config is %x/%x. One of them should probably be %x", test.name, test.config.MinVersion, test.config.MaxVersion, ver.version))
	***REMOVED***

	listener, err := net.ListenTCP("tcp4", &net.TCPAddr***REMOVED***IP: net.IP***REMOVED***127, 0, 0, 1***REMOVED******REMOVED***)
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***
	defer func() ***REMOVED***
		if listener != nil ***REMOVED***
			listener.Close()
		***REMOVED***
	***REMOVED***()

	flags := []string***REMOVED***"-port", strconv.Itoa(listener.Addr().(*net.TCPAddr).Port)***REMOVED***
	if test.testType == serverTest ***REMOVED***
		flags = append(flags, "-server")

		flags = append(flags, "-key-file")
		if test.keyFile == "" ***REMOVED***
			flags = append(flags, path.Join(*resourceDir, rsaKeyFile))
		***REMOVED*** else ***REMOVED***
			flags = append(flags, path.Join(*resourceDir, test.keyFile))
		***REMOVED***

		flags = append(flags, "-cert-file")
		if test.certFile == "" ***REMOVED***
			flags = append(flags, path.Join(*resourceDir, rsaCertificateFile))
		***REMOVED*** else ***REMOVED***
			flags = append(flags, path.Join(*resourceDir, test.certFile))
		***REMOVED***
	***REMOVED***

	if test.protocol == dtls ***REMOVED***
		flags = append(flags, "-dtls")
	***REMOVED***

	var resumeCount int
	if test.resumeSession ***REMOVED***
		resumeCount++
		if test.resumeRenewedSession ***REMOVED***
			resumeCount++
		***REMOVED***
	***REMOVED***

	if resumeCount > 0 ***REMOVED***
		flags = append(flags, "-resume-count", strconv.Itoa(resumeCount))
	***REMOVED***

	if test.shimWritesFirst ***REMOVED***
		flags = append(flags, "-shim-writes-first")
	***REMOVED***

	if test.shimShutsDown ***REMOVED***
		flags = append(flags, "-shim-shuts-down")
	***REMOVED***

	if test.exportKeyingMaterial > 0 ***REMOVED***
		flags = append(flags, "-export-keying-material", strconv.Itoa(test.exportKeyingMaterial))
		flags = append(flags, "-export-label", test.exportLabel)
		flags = append(flags, "-export-context", test.exportContext)
		if test.useExportContext ***REMOVED***
			flags = append(flags, "-use-export-context")
		***REMOVED***
	***REMOVED***
	if test.expectResumeRejected ***REMOVED***
		flags = append(flags, "-expect-session-miss")
	***REMOVED***

	if test.testTLSUnique ***REMOVED***
		flags = append(flags, "-tls-unique")
	***REMOVED***

	flags = append(flags, test.flags...)

	var shim *exec.Cmd
	if *useValgrind ***REMOVED***
		shim = valgrindOf(false, shimPath, flags...)
	***REMOVED*** else if *useGDB ***REMOVED***
		shim = gdbOf(shimPath, flags...)
	***REMOVED*** else if *useLLDB ***REMOVED***
		shim = lldbOf(shimPath, flags...)
	***REMOVED*** else ***REMOVED***
		shim = exec.Command(shimPath, flags...)
	***REMOVED***
	shim.Stdin = os.Stdin
	var stdoutBuf, stderrBuf bytes.Buffer
	shim.Stdout = &stdoutBuf
	shim.Stderr = &stderrBuf
	if mallocNumToFail >= 0 ***REMOVED***
		shim.Env = os.Environ()
		shim.Env = append(shim.Env, "MALLOC_NUMBER_TO_FAIL="+strconv.FormatInt(mallocNumToFail, 10))
		if *mallocTestDebug ***REMOVED***
			shim.Env = append(shim.Env, "MALLOC_BREAK_ON_FAIL=1")
		***REMOVED***
		shim.Env = append(shim.Env, "_MALLOC_CHECK=1")
	***REMOVED***

	if err := shim.Start(); err != nil ***REMOVED***
		panic(err)
	***REMOVED***
	waitChan := make(chan error, 1)
	go func() ***REMOVED*** waitChan <- shim.Wait() ***REMOVED***()

	config := test.config

	if *deterministic ***REMOVED***
		config.Rand = &deterministicRand***REMOVED******REMOVED***
	***REMOVED***

	conn, err := acceptOrWait(listener, waitChan)
	if err == nil ***REMOVED***
		err = doExchange(test, &config, conn, false /* not a resumption */, 0)
		conn.Close()
	***REMOVED***

	for i := 0; err == nil && i < resumeCount; i++ ***REMOVED***
		var resumeConfig Config
		if test.resumeConfig != nil ***REMOVED***
			resumeConfig = *test.resumeConfig
			if !test.newSessionsOnResume ***REMOVED***
				resumeConfig.SessionTicketKey = config.SessionTicketKey
				resumeConfig.ClientSessionCache = config.ClientSessionCache
				resumeConfig.ServerSessionCache = config.ServerSessionCache
			***REMOVED***
			resumeConfig.Rand = config.Rand
		***REMOVED*** else ***REMOVED***
			resumeConfig = config
		***REMOVED***
		var connResume net.Conn
		connResume, err = acceptOrWait(listener, waitChan)
		if err == nil ***REMOVED***
			err = doExchange(test, &resumeConfig, connResume, true /* resumption */, i+1)
			connResume.Close()
		***REMOVED***
	***REMOVED***

	// Close the listener now. This is to avoid hangs should the shim try to
	// open more connections than expected.
	listener.Close()
	listener = nil

	childErr := <-waitChan
	var isValgrindError bool
	if exitError, ok := childErr.(*exec.ExitError); ok ***REMOVED***
		switch exitError.Sys().(syscall.WaitStatus).ExitStatus() ***REMOVED***
		case 88:
			return errMoreMallocs
		case 89:
			return errUnimplemented
		case 99:
			isValgrindError = true
		***REMOVED***
	***REMOVED***

	// Account for Windows line endings.
	stdout := strings.Replace(string(stdoutBuf.Bytes()), "\r\n", "\n", -1)
	stderr := strings.Replace(string(stderrBuf.Bytes()), "\r\n", "\n", -1)

	// Separate the errors from the shim and those from tools like
	// AddressSanitizer.
	var extraStderr string
	if stderrParts := strings.SplitN(stderr, "--- DONE ---\n", 2); len(stderrParts) == 2 ***REMOVED***
		stderr = stderrParts[0]
		extraStderr = stderrParts[1]
	***REMOVED***

	failed := err != nil || childErr != nil
	expectedError := translateExpectedError(test.expectedError)
	correctFailure := len(expectedError) == 0 || strings.Contains(stderr, expectedError)

	localError := "none"
	if err != nil ***REMOVED***
		localError = err.Error()
	***REMOVED***
	if len(test.expectedLocalError) != 0 ***REMOVED***
		correctFailure = correctFailure && strings.Contains(localError, test.expectedLocalError)
	***REMOVED***

	if failed != test.shouldFail || failed && !correctFailure ***REMOVED***
		childError := "none"
		if childErr != nil ***REMOVED***
			childError = childErr.Error()
		***REMOVED***

		var msg string
		switch ***REMOVED***
		case failed && !test.shouldFail:
			msg = "unexpected failure"
		case !failed && test.shouldFail:
			msg = "unexpected success"
		case failed && !correctFailure:
			msg = "bad error (wanted '" + expectedError + "' / '" + test.expectedLocalError + "')"
		default:
			panic("internal error")
		***REMOVED***

		return fmt.Errorf("%s: local error '%s', child error '%s', stdout:\n%s\nstderr:\n%s\n%s", msg, localError, childError, stdout, stderr, extraStderr)
	***REMOVED***

	if len(extraStderr) > 0 || (!failed && len(stderr) > 0) ***REMOVED***
		return fmt.Errorf("unexpected error output:\n%s\n%s", stderr, extraStderr)
	***REMOVED***

	if *useValgrind && isValgrindError ***REMOVED***
		return fmt.Errorf("valgrind error:\n%s\n%s", stderr, extraStderr)
	***REMOVED***

	return nil
***REMOVED***

type tlsVersion struct ***REMOVED***
	name    string
	version uint16
	flag    string
	hasDTLS bool
***REMOVED***

var tlsVersions = []tlsVersion***REMOVED***
	***REMOVED***"SSL3", VersionSSL30, "-no-ssl3", false***REMOVED***,
	***REMOVED***"TLS1", VersionTLS10, "-no-tls1", true***REMOVED***,
	***REMOVED***"TLS11", VersionTLS11, "-no-tls11", false***REMOVED***,
	***REMOVED***"TLS12", VersionTLS12, "-no-tls12", true***REMOVED***,
	***REMOVED***"TLS13", VersionTLS13, "-no-tls13", false***REMOVED***,
***REMOVED***

type testCipherSuite struct ***REMOVED***
	name string
	id   uint16
***REMOVED***

var testCipherSuites = []testCipherSuite***REMOVED***
	***REMOVED***"3DES-SHA", TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
	***REMOVED***"AES128-GCM", TLS_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
	***REMOVED***"AES128-SHA", TLS_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
	***REMOVED***"AES128-SHA256", TLS_RSA_WITH_AES_128_CBC_SHA256***REMOVED***,
	***REMOVED***"AES256-GCM", TLS_RSA_WITH_AES_256_GCM_SHA384***REMOVED***,
	***REMOVED***"AES256-SHA", TLS_RSA_WITH_AES_256_CBC_SHA***REMOVED***,
	***REMOVED***"AES256-SHA256", TLS_RSA_WITH_AES_256_CBC_SHA256***REMOVED***,
	***REMOVED***"DHE-RSA-AES128-GCM", TLS_DHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
	***REMOVED***"DHE-RSA-AES128-SHA", TLS_DHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
	***REMOVED***"DHE-RSA-AES128-SHA256", TLS_DHE_RSA_WITH_AES_128_CBC_SHA256***REMOVED***,
	***REMOVED***"DHE-RSA-AES256-GCM", TLS_DHE_RSA_WITH_AES_256_GCM_SHA384***REMOVED***,
	***REMOVED***"DHE-RSA-AES256-SHA", TLS_DHE_RSA_WITH_AES_256_CBC_SHA***REMOVED***,
	***REMOVED***"DHE-RSA-AES256-SHA256", TLS_DHE_RSA_WITH_AES_256_CBC_SHA256***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-AES128-GCM", TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-AES128-SHA", TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-AES128-SHA256", TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-AES256-GCM", TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-AES256-SHA", TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-AES256-SHA384", TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384***REMOVED***,
	***REMOVED***"ECDHE-ECDSA-CHACHA20-POLY1305", TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
	***REMOVED***"ECDHE-RSA-AES128-GCM", TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
	***REMOVED***"ECDHE-RSA-AES128-SHA", TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-RSA-AES128-SHA256", TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256***REMOVED***,
	***REMOVED***"ECDHE-RSA-AES256-GCM", TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384***REMOVED***,
	***REMOVED***"ECDHE-RSA-AES256-SHA", TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-RSA-AES256-SHA384", TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384***REMOVED***,
	***REMOVED***"ECDHE-RSA-CHACHA20-POLY1305", TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
	***REMOVED***"PSK-AES128-CBC-SHA", TLS_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
	***REMOVED***"PSK-AES256-CBC-SHA", TLS_PSK_WITH_AES_256_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-PSK-AES128-CBC-SHA", TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-PSK-AES256-CBC-SHA", TLS_ECDHE_PSK_WITH_AES_256_CBC_SHA***REMOVED***,
	***REMOVED***"ECDHE-PSK-CHACHA20-POLY1305", TLS_ECDHE_PSK_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
	***REMOVED***"AEAD-CHACHA20-POLY1305", TLS_CHACHA20_POLY1305_SHA256***REMOVED***,
	***REMOVED***"AEAD-AES128-GCM-SHA256", TLS_AES_128_GCM_SHA256***REMOVED***,
	***REMOVED***"AEAD-AES256-GCM-SHA384", TLS_AES_256_GCM_SHA384***REMOVED***,
	***REMOVED***"NULL-SHA", TLS_RSA_WITH_NULL_SHA***REMOVED***,
***REMOVED***

func hasComponent(suiteName, component string) bool ***REMOVED***
	return strings.Contains("-"+suiteName+"-", "-"+component+"-")
***REMOVED***

func isTLS12Only(suiteName string) bool ***REMOVED***
	return hasComponent(suiteName, "GCM") ||
		hasComponent(suiteName, "SHA256") ||
		hasComponent(suiteName, "SHA384") ||
		hasComponent(suiteName, "POLY1305")
***REMOVED***

func isTLS13Suite(suiteName string) bool ***REMOVED***
	return strings.HasPrefix(suiteName, "AEAD-")
***REMOVED***

func isDTLSCipher(suiteName string) bool ***REMOVED***
	return !hasComponent(suiteName, "RC4") && !hasComponent(suiteName, "NULL")
***REMOVED***

func bigFromHex(hex string) *big.Int ***REMOVED***
	ret, ok := new(big.Int).SetString(hex, 16)
	if !ok ***REMOVED***
		panic("failed to parse hex number 0x" + hex)
	***REMOVED***
	return ret
***REMOVED***

func addBasicTests() ***REMOVED***
	basicTests := []testCase***REMOVED***
		***REMOVED***
			name: "NoFallbackSCSV",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					FailIfNotFallbackSCSV: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "no fallback SCSV found",
		***REMOVED***,
		***REMOVED***
			name: "SendFallbackSCSV",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					FailIfNotFallbackSCSV: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-fallback-scsv"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "ClientCertificateTypes",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				ClientAuth: RequestClientCert,
				ClientCertificateTypes: []byte***REMOVED***
					CertTypeDSSSign,
					CertTypeRSASign,
					CertTypeECDSASign,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-expect-certificate-types",
				base64.StdEncoding.EncodeToString([]byte***REMOVED***
					CertTypeDSSSign,
					CertTypeRSASign,
					CertTypeECDSASign,
				***REMOVED***),
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "UnauthenticatedECDH",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					UnauthenticatedECDH: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_MESSAGE:",
		***REMOVED***,
		***REMOVED***
			name: "SkipCertificateStatus",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SkipCertificateStatus: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-ocsp-stapling",
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "SkipServerKeyExchange",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SkipServerKeyExchange: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_MESSAGE:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "Alert",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendSpuriousAlert: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":TLSV1_ALERT_RECORD_OVERFLOW:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			testType: serverTest,
			name:     "Alert-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendSpuriousAlert: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":TLSV1_ALERT_RECORD_OVERFLOW:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FragmentAlert",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					FragmentAlert:     true,
					SendSpuriousAlert: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_ALERT:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			testType: serverTest,
			name:     "FragmentAlert-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					FragmentAlert:     true,
					SendSpuriousAlert: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_ALERT:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "DoubleAlert",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					DoubleAlert:       true,
					SendSpuriousAlert: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_ALERT:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			testType: serverTest,
			name:     "DoubleAlert-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					DoubleAlert:       true,
					SendSpuriousAlert: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_ALERT:",
		***REMOVED***,
		***REMOVED***
			name: "SkipNewSessionTicket",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					SkipNewSessionTicket: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FallbackSCSV",
			config: Config***REMOVED***
				MaxVersion: VersionTLS11,
				Bugs: ProtocolBugs***REMOVED***
					SendFallbackSCSV: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedError:      ":INAPPROPRIATE_FALLBACK:",
			expectedLocalError: "remote error: inappropriate fallback",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FallbackSCSV-VersionMatch-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					SendFallbackSCSV: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FallbackSCSV-VersionMatch-TLS12",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					SendFallbackSCSV: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-max-version", strconv.Itoa(VersionTLS12)***REMOVED***,
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FragmentedClientVersion",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxHandshakeRecordLength: 1,
					FragmentClientVersion:    true,
				***REMOVED***,
			***REMOVED***,
			expectedVersion: VersionTLS13,
		***REMOVED***,
		***REMOVED***
			testType:      serverTest,
			name:          "HttpGET",
			sendPrefix:    "GET / HTTP/1.0\n",
			shouldFail:    true,
			expectedError: ":HTTP_REQUEST:",
		***REMOVED***,
		***REMOVED***
			testType:      serverTest,
			name:          "HttpPOST",
			sendPrefix:    "POST / HTTP/1.0\n",
			shouldFail:    true,
			expectedError: ":HTTP_REQUEST:",
		***REMOVED***,
		***REMOVED***
			testType:      serverTest,
			name:          "HttpHEAD",
			sendPrefix:    "HEAD / HTTP/1.0\n",
			shouldFail:    true,
			expectedError: ":HTTP_REQUEST:",
		***REMOVED***,
		***REMOVED***
			testType:      serverTest,
			name:          "HttpPUT",
			sendPrefix:    "PUT / HTTP/1.0\n",
			shouldFail:    true,
			expectedError: ":HTTP_REQUEST:",
		***REMOVED***,
		***REMOVED***
			testType:      serverTest,
			name:          "HttpCONNECT",
			sendPrefix:    "CONNECT www.google.com:443 HTTP/1.0\n",
			shouldFail:    true,
			expectedError: ":HTTPS_PROXY_REQUEST:",
		***REMOVED***,
		***REMOVED***
			testType:      serverTest,
			name:          "Garbage",
			sendPrefix:    "blah",
			shouldFail:    true,
			expectedError: ":WRONG_VERSION_NUMBER:",
		***REMOVED***,
		***REMOVED***
			name: "RSAEphemeralKey",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					RSAEphemeralKey: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_MESSAGE:",
		***REMOVED***,
		***REMOVED***
			name:          "DisableEverything",
			flags:         []string***REMOVED***"-no-tls13", "-no-tls12", "-no-tls11", "-no-tls1", "-no-ssl3"***REMOVED***,
			shouldFail:    true,
			expectedError: ":WRONG_SSL_VERSION:",
		***REMOVED***,
		***REMOVED***
			protocol:      dtls,
			name:          "DisableEverything-DTLS",
			flags:         []string***REMOVED***"-no-tls12", "-no-tls1"***REMOVED***,
			shouldFail:    true,
			expectedError: ":WRONG_SSL_VERSION:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			testType: serverTest,
			name:     "MTU",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxPacketLength: 256,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-mtu", "256"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			testType: serverTest,
			name:     "MTUExceeded",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxPacketLength: 255,
				***REMOVED***,
			***REMOVED***,
			flags:              []string***REMOVED***"-mtu", "256"***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "dtls: exceeded maximum packet length",
		***REMOVED***,
		***REMOVED***
			name: "CertMismatchRSA",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SendCipherSuite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":WRONG_CERTIFICATE_TYPE:",
		***REMOVED***,
		***REMOVED***
			name: "CertMismatchECDSA",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SendCipherSuite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":WRONG_CERTIFICATE_TYPE:",
		***REMOVED***,
		***REMOVED***
			name: "EmptyCertificateList",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					EmptyCertificateList: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":DECODE_ERROR:",
		***REMOVED***,
		***REMOVED***
			name: "EmptyCertificateList-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					EmptyCertificateList: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":PEER_DID_NOT_RETURN_A_CERTIFICATE:",
		***REMOVED***,
		***REMOVED***
			name:             "TLSFatalBadPackets",
			damageFirstWrite: true,
			shouldFail:       true,
			expectedError:    ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
		***REMOVED***,
		***REMOVED***
			protocol:         dtls,
			name:             "DTLSIgnoreBadPackets",
			damageFirstWrite: true,
		***REMOVED***,
		***REMOVED***
			protocol:         dtls,
			name:             "DTLSIgnoreBadPackets-Async",
			damageFirstWrite: true,
			flags:            []string***REMOVED***"-async"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "AppDataBeforeHandshake",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					AppDataBeforeHandshake: []byte("TEST MESSAGE"),
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			name: "AppDataBeforeHandshake-Empty",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					AppDataBeforeHandshake: []byte***REMOVED******REMOVED***,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "AppDataBeforeHandshake-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					AppDataBeforeHandshake: []byte("TEST MESSAGE"),
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "AppDataBeforeHandshake-DTLS-Empty",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					AppDataBeforeHandshake: []byte***REMOVED******REMOVED***,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			name: "AppDataAfterChangeCipherSpec",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					AppDataAfterChangeCipherSpec: []byte("TEST MESSAGE"),
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			name: "AppDataAfterChangeCipherSpec-Empty",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					AppDataAfterChangeCipherSpec: []byte***REMOVED******REMOVED***,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "AppDataAfterChangeCipherSpec-DTLS",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					AppDataAfterChangeCipherSpec: []byte("TEST MESSAGE"),
				***REMOVED***,
			***REMOVED***,
			// BoringSSL's DTLS implementation will drop the out-of-order
			// application data.
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "AppDataAfterChangeCipherSpec-DTLS-Empty",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					AppDataAfterChangeCipherSpec: []byte***REMOVED******REMOVED***,
				***REMOVED***,
			***REMOVED***,
			// BoringSSL's DTLS implementation will drop the out-of-order
			// application data.
		***REMOVED***,
		***REMOVED***
			name: "AlertAfterChangeCipherSpec",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					AlertAfterChangeCipherSpec: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":TLSV1_ALERT_RECORD_OVERFLOW:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "AlertAfterChangeCipherSpec-DTLS",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					AlertAfterChangeCipherSpec: alertRecordOverflow,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":TLSV1_ALERT_RECORD_OVERFLOW:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "ReorderHandshakeFragments-Small-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					ReorderHandshakeFragments: true,
					// Small enough that every handshake message is
					// fragmented.
					MaxHandshakeRecordLength: 2,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "ReorderHandshakeFragments-Large-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					ReorderHandshakeFragments: true,
					// Large enough that no handshake message is
					// fragmented.
					MaxHandshakeRecordLength: 2048,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "MixCompleteMessageWithFragments-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					ReorderHandshakeFragments:       true,
					MixCompleteMessageWithFragments: true,
					MaxHandshakeRecordLength:        2,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "SendInvalidRecordType",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendInvalidRecordType: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SendInvalidRecordType-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendInvalidRecordType: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			name: "FalseStart-SkipServerSecondLeg",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SkipNewSessionTicket: true,
					SkipChangeCipherSpec: true,
					SkipFinished:         true,
					ExpectFalseStart:     true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-handshake-never-done",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shimWritesFirst: true,
			shouldFail:      true,
			expectedError:   ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			name: "FalseStart-SkipServerSecondLeg-Implicit",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SkipNewSessionTicket: true,
					SkipChangeCipherSpec: true,
					SkipFinished:         true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-implicit-handshake",
				"-false-start",
				"-handshake-never-done",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			testType:           serverTest,
			name:               "FailEarlyCallback",
			flags:              []string***REMOVED***"-fail-early-callback"***REMOVED***,
			shouldFail:         true,
			expectedError:      ":CONNECTION_REJECTED:",
			expectedLocalError: "remote error: handshake failure",
		***REMOVED***,
		***REMOVED***
			name: "FailCertCallback-Client-TLS12",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				ClientAuth: RequestClientCert,
			***REMOVED***,
			flags:              []string***REMOVED***"-fail-cert-callback"***REMOVED***,
			shouldFail:         true,
			expectedError:      ":CERT_CB_ERROR:",
			expectedLocalError: "remote error: internal error",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FailCertCallback-Server-TLS12",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			flags:              []string***REMOVED***"-fail-cert-callback"***REMOVED***,
			shouldFail:         true,
			expectedError:      ":CERT_CB_ERROR:",
			expectedLocalError: "remote error: internal error",
		***REMOVED***,
		***REMOVED***
			name: "FailCertCallback-Client-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				ClientAuth: RequestClientCert,
			***REMOVED***,
			flags:              []string***REMOVED***"-fail-cert-callback"***REMOVED***,
			shouldFail:         true,
			expectedError:      ":CERT_CB_ERROR:",
			expectedLocalError: "remote error: internal error",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "FailCertCallback-Server-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			flags:              []string***REMOVED***"-fail-cert-callback"***REMOVED***,
			shouldFail:         true,
			expectedError:      ":CERT_CB_ERROR:",
			expectedLocalError: "remote error: internal error",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "FragmentMessageTypeMismatch-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxHandshakeRecordLength:    2,
					FragmentMessageTypeMismatch: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":FRAGMENT_MISMATCH:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "FragmentMessageLengthMismatch-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxHandshakeRecordLength:      2,
					FragmentMessageLengthMismatch: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":FRAGMENT_MISMATCH:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SplitFragments-Header-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SplitFragments: 2,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_HANDSHAKE_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SplitFragments-Boundary-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SplitFragments: dtlsRecordHeaderLen,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_HANDSHAKE_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SplitFragments-Body-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SplitFragments: dtlsRecordHeaderLen + 1,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_HANDSHAKE_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SendEmptyFragments-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendEmptyFragments: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "BadFinished-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					BadFinished: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":DIGEST_CHECK_FAILED:",
		***REMOVED***,
		***REMOVED***
			name: "BadFinished-Client-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					BadFinished: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":DIGEST_CHECK_FAILED:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "BadFinished-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					BadFinished: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":DIGEST_CHECK_FAILED:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "BadFinished-Server-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					BadFinished: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":DIGEST_CHECK_FAILED:",
		***REMOVED***,
		***REMOVED***
			name: "FalseStart-BadFinished",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					BadFinished:      true,
					ExpectFalseStart: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-handshake-never-done",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shimWritesFirst: true,
			shouldFail:      true,
			expectedError:   ":DIGEST_CHECK_FAILED:",
		***REMOVED***,
		***REMOVED***
			name: "NoFalseStart-NoALPN",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart:          true,
					AlertBeforeFalseStartTest: alertAccessDenied,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
			***REMOVED***,
			shimWritesFirst:    true,
			shouldFail:         true,
			expectedError:      ":TLSV1_ALERT_ACCESS_DENIED:",
			expectedLocalError: "tls: peer did not false start: EOF",
		***REMOVED***,
		***REMOVED***
			name: "NoFalseStart-NoAEAD",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart:          true,
					AlertBeforeFalseStartTest: alertAccessDenied,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shimWritesFirst:    true,
			shouldFail:         true,
			expectedError:      ":TLSV1_ALERT_ACCESS_DENIED:",
			expectedLocalError: "tls: peer did not false start: EOF",
		***REMOVED***,
		***REMOVED***
			name: "NoFalseStart-RSA",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart:          true,
					AlertBeforeFalseStartTest: alertAccessDenied,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shimWritesFirst:    true,
			shouldFail:         true,
			expectedError:      ":TLSV1_ALERT_ACCESS_DENIED:",
			expectedLocalError: "tls: peer did not false start: EOF",
		***REMOVED***,
		***REMOVED***
			name: "NoFalseStart-DHE_RSA",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_DHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart:          true,
					AlertBeforeFalseStartTest: alertAccessDenied,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shimWritesFirst:    true,
			shouldFail:         true,
			expectedError:      ":TLSV1_ALERT_ACCESS_DENIED:",
			expectedLocalError: "tls: peer did not false start: EOF",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SendSplitAlert-Sync",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendSplitAlert: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SendSplitAlert-Async",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendSplitAlert: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-async"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "PackDTLSHandshake",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxHandshakeRecordLength: 2,
					PackHandshakeFragments:   20,
					PackHandshakeRecords:     200,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name:             "SendEmptyRecords-Pass",
			sendEmptyRecords: 32,
		***REMOVED***,
		***REMOVED***
			name:             "SendEmptyRecords",
			sendEmptyRecords: 33,
			shouldFail:       true,
			expectedError:    ":TOO_MANY_EMPTY_FRAGMENTS:",
		***REMOVED***,
		***REMOVED***
			name:             "SendEmptyRecords-Async",
			sendEmptyRecords: 33,
			flags:            []string***REMOVED***"-async"***REMOVED***,
			shouldFail:       true,
			expectedError:    ":TOO_MANY_EMPTY_FRAGMENTS:",
		***REMOVED***,
		***REMOVED***
			name: "SendWarningAlerts-Pass",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			sendWarningAlerts: 4,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "SendWarningAlerts-DTLS-Pass",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			sendWarningAlerts: 4,
		***REMOVED***,
		***REMOVED***
			name: "SendWarningAlerts-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			sendWarningAlerts:  4,
			shouldFail:         true,
			expectedError:      ":BAD_ALERT:",
			expectedLocalError: "remote error: error decoding message",
		***REMOVED***,
		***REMOVED***
			name: "SendWarningAlerts",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			sendWarningAlerts: 5,
			shouldFail:        true,
			expectedError:     ":TOO_MANY_WARNING_ALERTS:",
		***REMOVED***,
		***REMOVED***
			name: "SendWarningAlerts-Async",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			sendWarningAlerts: 5,
			flags:             []string***REMOVED***"-async"***REMOVED***,
			shouldFail:        true,
			expectedError:     ":TOO_MANY_WARNING_ALERTS:",
		***REMOVED***,
		***REMOVED***
			name: "TooManyKeyUpdates",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			sendKeyUpdates:   33,
			keyUpdateRequest: keyUpdateNotRequested,
			shouldFail:       true,
			expectedError:    ":TOO_MANY_KEY_UPDATES:",
		***REMOVED***,
		***REMOVED***
			name: "EmptySessionID",
			config: Config***REMOVED***
				MaxVersion:             VersionTLS12,
				SessionTicketsDisabled: true,
			***REMOVED***,
			noSessionCache: true,
			flags:          []string***REMOVED***"-expect-no-session"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "Unclean-Shutdown",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					NoCloseNotify:     true,
					ExpectCloseNotify: true,
				***REMOVED***,
			***REMOVED***,
			shimShutsDown: true,
			flags:         []string***REMOVED***"-check-close-notify"***REMOVED***,
			shouldFail:    true,
			expectedError: "Unexpected SSL_shutdown result: -1 != 1",
		***REMOVED***,
		***REMOVED***
			name: "Unclean-Shutdown-Ignored",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					NoCloseNotify: true,
				***REMOVED***,
			***REMOVED***,
			shimShutsDown: true,
		***REMOVED***,
		***REMOVED***
			name: "Unclean-Shutdown-Alert",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendAlertOnShutdown: alertDecompressionFailure,
					ExpectCloseNotify:   true,
				***REMOVED***,
			***REMOVED***,
			shimShutsDown: true,
			flags:         []string***REMOVED***"-check-close-notify"***REMOVED***,
			shouldFail:    true,
			expectedError: ":SSLV3_ALERT_DECOMPRESSION_FAILURE:",
		***REMOVED***,
		***REMOVED***
			name: "LargePlaintext",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendLargeRecords: true,
				***REMOVED***,
			***REMOVED***,
			messageLen:    maxPlaintext + 1,
			shouldFail:    true,
			expectedError: ":DATA_LENGTH_TOO_LONG:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "LargePlaintext-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendLargeRecords: true,
				***REMOVED***,
			***REMOVED***,
			messageLen:    maxPlaintext + 1,
			shouldFail:    true,
			expectedError: ":DATA_LENGTH_TOO_LONG:",
		***REMOVED***,
		***REMOVED***
			name: "LargeCiphertext",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendLargeRecords: true,
				***REMOVED***,
			***REMOVED***,
			messageLen:    maxPlaintext * 2,
			shouldFail:    true,
			expectedError: ":ENCRYPTED_LENGTH_TOO_LONG:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "LargeCiphertext-DTLS",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendLargeRecords: true,
				***REMOVED***,
			***REMOVED***,
			messageLen: maxPlaintext * 2,
			// Unlike the other four cases, DTLS drops records which
			// are invalid before authentication, so the connection
			// does not fail.
			expectMessageDropped: true,
		***REMOVED***,
		***REMOVED***
			name:        "BadHelloRequest-1",
			renegotiate: 1,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					BadHelloRequest: []byte***REMOVED***typeHelloRequest, 0, 0, 1, 1***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-renegotiate-freely",
				"-expect-total-renegotiations", "1",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":EXCESSIVE_MESSAGE_SIZE:",
		***REMOVED***,
		***REMOVED***
			name:        "BadHelloRequest-2",
			renegotiate: 1,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					BadHelloRequest: []byte***REMOVED***typeServerKeyExchange, 0, 0, 0***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-renegotiate-freely",
				"-expect-total-renegotiations", "1",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":BAD_HELLO_REQUEST:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "SupportTicketsWithSessionID",
			config: Config***REMOVED***
				MaxVersion:             VersionTLS12,
				SessionTicketsDisabled: true,
			***REMOVED***,
			resumeConfig: &Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			resumeSession: true,
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "DTLS-SendExtraFinished",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					SendExtraFinished: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			protocol: dtls,
			name:     "DTLS-SendExtraFinished-Reordered",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxHandshakeRecordLength:  2,
					ReorderHandshakeFragments: true,
					SendExtraFinished:         true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "V2ClientHello-EmptyRecordPrefix",
			config: Config***REMOVED***
				// Choose a cipher suite that does not involve
				// elliptic curves, so no extensions are
				// involved.
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SendV2ClientHello: true,
				***REMOVED***,
			***REMOVED***,
			sendPrefix: string([]byte***REMOVED***
				byte(recordTypeHandshake),
				3, 1, // version
				0, 0, // length
			***REMOVED***),
			// A no-op empty record may not be sent before V2ClientHello.
			shouldFail:    true,
			expectedError: ":WRONG_VERSION_NUMBER:",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "V2ClientHello-WarningAlertPrefix",
			config: Config***REMOVED***
				// Choose a cipher suite that does not involve
				// elliptic curves, so no extensions are
				// involved.
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SendV2ClientHello: true,
				***REMOVED***,
			***REMOVED***,
			sendPrefix: string([]byte***REMOVED***
				byte(recordTypeAlert),
				3, 1, // version
				0, 2, // length
				alertLevelWarning, byte(alertDecompressionFailure),
			***REMOVED***),
			// A no-op warning alert may not be sent before V2ClientHello.
			shouldFail:    true,
			expectedError: ":WRONG_VERSION_NUMBER:",
		***REMOVED***,
		***REMOVED***
			name: "KeyUpdate-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			sendKeyUpdates:   1,
			keyUpdateRequest: keyUpdateNotRequested,
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "KeyUpdate-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			sendKeyUpdates:   1,
			keyUpdateRequest: keyUpdateNotRequested,
		***REMOVED***,
		***REMOVED***
			name: "KeyUpdate-InvalidRequestMode",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			sendKeyUpdates:   1,
			keyUpdateRequest: 42,
			shouldFail:       true,
			expectedError:    ":DECODE_ERROR:",
		***REMOVED***,
		***REMOVED***
			name: "SendSNIWarningAlert",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					SendSNIWarningAlert: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "ExtraCompressionMethods-TLS12",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					SendCompressionMethods: []byte***REMOVED***1, 2, 3, compressionNone, 4, 5, 6***REMOVED***,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "ExtraCompressionMethods-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					SendCompressionMethods: []byte***REMOVED***1, 2, 3, compressionNone, 4, 5, 6***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedError:      ":INVALID_COMPRESSION_LIST:",
			expectedLocalError: "remote error: illegal parameter",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "NoNullCompression-TLS12",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					SendCompressionMethods: []byte***REMOVED***1, 2, 3, 4, 5, 6***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedError:      ":INVALID_COMPRESSION_LIST:",
			expectedLocalError: "remote error: illegal parameter",
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "NoNullCompression-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					SendCompressionMethods: []byte***REMOVED***1, 2, 3, 4, 5, 6***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedError:      ":INVALID_COMPRESSION_LIST:",
			expectedLocalError: "remote error: illegal parameter",
		***REMOVED***,
		***REMOVED***
			name: "GREASE-Client-TLS12",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					ExpectGREASE: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-enable-grease"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			name: "GREASE-Client-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					ExpectGREASE: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-enable-grease"***REMOVED***,
		***REMOVED***,
		***REMOVED***
			testType: serverTest,
			name:     "GREASE-Server-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					// TLS 1.3 servers are expected to
					// always enable GREASE. TLS 1.3 is new,
					// so there is no existing ecosystem to
					// worry about.
					ExpectGREASE: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			// Test the server so there is a large certificate as
			// well as application data.
			testType: serverTest,
			name:     "MaxSendFragment",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					MaxReceivePlaintext: 512,
				***REMOVED***,
			***REMOVED***,
			messageLen: 1024,
			flags: []string***REMOVED***
				"-max-send-fragment", "512",
				"-read-size", "1024",
			***REMOVED***,
		***REMOVED***,
		***REMOVED***
			// Test the server so there is a large certificate as
			// well as application data.
			testType: serverTest,
			name:     "MaxSendFragment-TooLarge",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					// Ensure that some of the records are
					// 512.
					MaxReceivePlaintext: 511,
				***REMOVED***,
			***REMOVED***,
			messageLen: 1024,
			flags: []string***REMOVED***
				"-max-send-fragment", "512",
				"-read-size", "1024",
			***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "local error: record overflow",
		***REMOVED***,
	***REMOVED***
	testCases = append(testCases, basicTests...)

	// Test that very large messages can be received.
	cert := rsaCertificate
	for i := 0; i < 50; i++ ***REMOVED***
		cert.Certificate = append(cert.Certificate, cert.Certificate[0])
	***REMOVED***
	testCases = append(testCases, testCase***REMOVED***
		name: "LargeMessage",
		config: Config***REMOVED***
			Certificates: []Certificate***REMOVED***cert***REMOVED***,
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "LargeMessage-DTLS",
		config: Config***REMOVED***
			Certificates: []Certificate***REMOVED***cert***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// They are rejected if the maximum certificate chain length is capped.
	testCases = append(testCases, testCase***REMOVED***
		name: "LargeMessage-Reject",
		config: Config***REMOVED***
			Certificates: []Certificate***REMOVED***cert***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-max-cert-list", "16384"***REMOVED***,
		shouldFail:    true,
		expectedError: ":EXCESSIVE_MESSAGE_SIZE:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "LargeMessage-Reject-DTLS",
		config: Config***REMOVED***
			Certificates: []Certificate***REMOVED***cert***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-max-cert-list", "16384"***REMOVED***,
		shouldFail:    true,
		expectedError: ":EXCESSIVE_MESSAGE_SIZE:",
	***REMOVED***)
***REMOVED***

func addTestForCipherSuite(suite testCipherSuite, ver tlsVersion, protocol protocol) ***REMOVED***
	const psk = "12345"
	const pskIdentity = "luggage combo"

	var prefix string
	if protocol == dtls ***REMOVED***
		if !ver.hasDTLS ***REMOVED***
			return
		***REMOVED***
		prefix = "D"
	***REMOVED***

	var cert Certificate
	var certFile string
	var keyFile string
	if hasComponent(suite.name, "ECDSA") ***REMOVED***
		cert = ecdsaP256Certificate
		certFile = ecdsaP256CertificateFile
		keyFile = ecdsaP256KeyFile
	***REMOVED*** else ***REMOVED***
		cert = rsaCertificate
		certFile = rsaCertificateFile
		keyFile = rsaKeyFile
	***REMOVED***

	var flags []string
	if hasComponent(suite.name, "PSK") ***REMOVED***
		flags = append(flags,
			"-psk", psk,
			"-psk-identity", pskIdentity)
	***REMOVED***
	if hasComponent(suite.name, "NULL") ***REMOVED***
		// NULL ciphers must be explicitly enabled.
		flags = append(flags, "-cipher", "DEFAULT:NULL-SHA")
	***REMOVED***

	var shouldServerFail, shouldClientFail bool
	if hasComponent(suite.name, "ECDHE") && ver.version == VersionSSL30 ***REMOVED***
		// BoringSSL clients accept ECDHE on SSLv3, but
		// a BoringSSL server will never select it
		// because the extension is missing.
		shouldServerFail = true
	***REMOVED***
	if isTLS12Only(suite.name) && ver.version < VersionTLS12 ***REMOVED***
		shouldClientFail = true
		shouldServerFail = true
	***REMOVED***
	if !isTLS13Suite(suite.name) && ver.version >= VersionTLS13 ***REMOVED***
		shouldClientFail = true
		shouldServerFail = true
	***REMOVED***
	if isTLS13Suite(suite.name) && ver.version < VersionTLS13 ***REMOVED***
		shouldClientFail = true
		shouldServerFail = true
	***REMOVED***
	if !isDTLSCipher(suite.name) && protocol == dtls ***REMOVED***
		shouldClientFail = true
		shouldServerFail = true
	***REMOVED***

	var sendCipherSuite uint16
	var expectedServerError, expectedClientError string
	serverCipherSuites := []uint16***REMOVED***suite.id***REMOVED***
	if shouldServerFail ***REMOVED***
		expectedServerError = ":NO_SHARED_CIPHER:"
	***REMOVED***
	if shouldClientFail ***REMOVED***
		expectedClientError = ":WRONG_CIPHER_RETURNED:"
		// Configure the server to select ciphers as normal but
		// select an incompatible cipher in ServerHello.
		serverCipherSuites = nil
		sendCipherSuite = suite.id
	***REMOVED***

	// For cipher suites and versions where exporters are defined, verify
	// that they interoperate.
	var exportKeyingMaterial int
	if ver.version > VersionSSL30 ***REMOVED***
		exportKeyingMaterial = 1024
	***REMOVED***

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		protocol: protocol,
		name:     prefix + ver.name + "-" + suite.name + "-server",
		config: Config***REMOVED***
			MinVersion:           ver.version,
			MaxVersion:           ver.version,
			CipherSuites:         []uint16***REMOVED***suite.id***REMOVED***,
			Certificates:         []Certificate***REMOVED***cert***REMOVED***,
			PreSharedKey:         []byte(psk),
			PreSharedKeyIdentity: pskIdentity,
			Bugs: ProtocolBugs***REMOVED***
				AdvertiseAllConfiguredCiphers: true,
			***REMOVED***,
		***REMOVED***,
		certFile:             certFile,
		keyFile:              keyFile,
		flags:                flags,
		resumeSession:        true,
		shouldFail:           shouldServerFail,
		expectedError:        expectedServerError,
		exportKeyingMaterial: exportKeyingMaterial,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		protocol: protocol,
		name:     prefix + ver.name + "-" + suite.name + "-client",
		config: Config***REMOVED***
			MinVersion:           ver.version,
			MaxVersion:           ver.version,
			CipherSuites:         serverCipherSuites,
			Certificates:         []Certificate***REMOVED***cert***REMOVED***,
			PreSharedKey:         []byte(psk),
			PreSharedKeyIdentity: pskIdentity,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerCipherPreferences: shouldClientFail,
				SendCipherSuite:             sendCipherSuite,
			***REMOVED***,
		***REMOVED***,
		flags:                flags,
		resumeSession:        true,
		shouldFail:           shouldClientFail,
		expectedError:        expectedClientError,
		exportKeyingMaterial: exportKeyingMaterial,
	***REMOVED***)

	if shouldClientFail ***REMOVED***
		return
	***REMOVED***

	// Ensure the maximum record size is accepted.
	testCases = append(testCases, testCase***REMOVED***
		protocol: protocol,
		name:     prefix + ver.name + "-" + suite.name + "-LargeRecord",
		config: Config***REMOVED***
			MinVersion:           ver.version,
			MaxVersion:           ver.version,
			CipherSuites:         []uint16***REMOVED***suite.id***REMOVED***,
			Certificates:         []Certificate***REMOVED***cert***REMOVED***,
			PreSharedKey:         []byte(psk),
			PreSharedKeyIdentity: pskIdentity,
		***REMOVED***,
		flags:      flags,
		messageLen: maxPlaintext,
	***REMOVED***)

	// Test bad records for all ciphers. Bad records are fatal in TLS
	// and ignored in DTLS.
	var shouldFail bool
	var expectedError string
	if protocol == tls ***REMOVED***
		shouldFail = true
		expectedError = ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:"
	***REMOVED***

	testCases = append(testCases, testCase***REMOVED***
		protocol: protocol,
		name:     prefix + ver.name + "-" + suite.name + "-BadRecord",
		config: Config***REMOVED***
			MinVersion:           ver.version,
			MaxVersion:           ver.version,
			CipherSuites:         []uint16***REMOVED***suite.id***REMOVED***,
			Certificates:         []Certificate***REMOVED***cert***REMOVED***,
			PreSharedKey:         []byte(psk),
			PreSharedKeyIdentity: pskIdentity,
		***REMOVED***,
		flags:            flags,
		damageFirstWrite: true,
		messageLen:       maxPlaintext,
		shouldFail:       shouldFail,
		expectedError:    expectedError,
	***REMOVED***)

	if ver.version >= VersionTLS13 ***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			protocol: protocol,
			name:     prefix + ver.name + "-" + suite.name + "-ShortHeader",
			config: Config***REMOVED***
				MinVersion:           ver.version,
				MaxVersion:           ver.version,
				CipherSuites:         []uint16***REMOVED***suite.id***REMOVED***,
				Certificates:         []Certificate***REMOVED***cert***REMOVED***,
				PreSharedKey:         []byte(psk),
				PreSharedKeyIdentity: pskIdentity,
				Bugs: ProtocolBugs***REMOVED***
					EnableShortHeader: true,
				***REMOVED***,
			***REMOVED***,
			flags:             append([]string***REMOVED***"-enable-short-header"***REMOVED***, flags...),
			resumeSession:     true,
			expectShortHeader: true,
		***REMOVED***)
	***REMOVED***
***REMOVED***

func addCipherSuiteTests() ***REMOVED***
	const bogusCipher = 0xfe00

	for _, suite := range testCipherSuites ***REMOVED***
		for _, ver := range tlsVersions ***REMOVED***
			for _, protocol := range []protocol***REMOVED***tls, dtls***REMOVED*** ***REMOVED***
				addTestForCipherSuite(suite, ver, protocol)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	testCases = append(testCases, testCase***REMOVED***
		name: "NoSharedCipher",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED******REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":HANDSHAKE_FAILURE_ON_CLIENT_HELLO:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "NoSharedCipher-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED******REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":HANDSHAKE_FAILURE_ON_CLIENT_HELLO:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "UnsupportedCipherSuite",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerCipherPreferences: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-cipher", "DEFAULT:!AES"***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CIPHER_RETURNED:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ServerHelloBogusCipher",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendCipherSuite: bogusCipher,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNKNOWN_CIPHER_RETURNED:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "ServerHelloBogusCipher-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendCipherSuite: bogusCipher,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNKNOWN_CIPHER_RETURNED:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "WeakDH",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_DHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				// This is a 1023-bit prime number, generated
				// with:
				// openssl gendh 1023 | openssl asn1parse -i
				DHGroupPrime: bigFromHex("518E9B7930CE61C6E445C8360584E5FC78D9137C0FFDC880B495D5338ADF7689951A6821C17A76B3ACB8E0156AEA607B7EC406EBEDBB84D8376EB8FE8F8BA1433488BEE0C3EDDFD3A32DBB9481980A7AF6C96BFCF490A094CFFB2B8192C1BB5510B77B658436E27C2D4D023FE3718222AB0CA1273995B51F6D625A4944D0DD4B"),
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BAD_DH_P_LENGTH:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "SillyDH",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_DHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				// This is a 4097-bit prime number, generated
				// with:
				// openssl gendh 4097 | openssl asn1parse -i
				DHGroupPrime: bigFromHex("01D366FA64A47419B0CD4A45918E8D8C8430F674621956A9F52B0CA592BC104C6E38D60C58F2CA66792A2B7EBDC6F8FFE75AB7D6862C261F34E96A2AEEF53AB7C21365C2E8FB0582F71EB57B1C227C0E55AE859E9904A25EFECD7B435C4D4357BD840B03649D4A1F8037D89EA4E1967DBEEF1CC17A6111C48F12E9615FFF336D3F07064CB17C0B765A012C850B9E3AA7A6984B96D8C867DDC6D0F4AB52042572244796B7ECFF681CD3B3E2E29AAECA391A775BEE94E502FB15881B0F4AC60314EA947C0C82541C3D16FD8C0E09BB7F8F786582032859D9C13187CE6C0CB6F2D3EE6C3C9727C15F14B21D3CD2E02BDB9D119959B0E03DC9E5A91E2578762300B1517D2352FC1D0BB934A4C3E1B20CE9327DB102E89A6C64A8C3148EDFC5A94913933853442FA84451B31FD21E492F92DD5488E0D871AEBFE335A4B92431DEC69591548010E76A5B365D346786E9A2D3E589867D796AA5E25211201D757560D318A87DFB27F3E625BC373DB48BF94A63161C674C3D4265CB737418441B7650EABC209CF675A439BEB3E9D1AA1B79F67198A40CEFD1C89144F7D8BAF61D6AD36F466DA546B4174A0E0CAF5BD788C8243C7C2DDDCC3DB6FC89F12F17D19FBD9B0BC76FE92891CD6BA07BEA3B66EF12D0D85E788FD58675C1B0FBD16029DCC4D34E7A1A41471BDEDF78BF591A8B4E96D88BEC8EDC093E616292BFC096E69A916E8D624B"),
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DH_P_TOO_LONG:",
	***REMOVED***)

	// This test ensures that Diffie-Hellman public values are padded with
	// zeros so that they're the same length as the prime. This is to avoid
	// hitting a bug in yaSSL.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "DHPublicValuePadded",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_DHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				RequireDHPublicValueLen: (1025 + 7) / 8,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-use-sparse-dh-prime"***REMOVED***,
	***REMOVED***)

	// The server must be tolerant to bogus ciphers.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "UnknownCipher",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***bogusCipher, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				AdvertiseAllConfiguredCiphers: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// The server must be tolerant to bogus ciphers.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "UnknownCipher-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***bogusCipher, TLS_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				AdvertiseAllConfiguredCiphers: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// Test empty ECDHE_PSK identity hints work as expected.
	testCases = append(testCases, testCase***REMOVED***
		name: "EmptyECDHEPSKHint",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
			PreSharedKey: []byte("secret"),
		***REMOVED***,
		flags: []string***REMOVED***"-psk", "secret"***REMOVED***,
	***REMOVED***)

	// Test empty PSK identity hints work as expected, even if an explicit
	// ServerKeyExchange is sent.
	testCases = append(testCases, testCase***REMOVED***
		name: "ExplicitEmptyPSKHint",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
			PreSharedKey: []byte("secret"),
			Bugs: ProtocolBugs***REMOVED***
				AlwaysSendPreSharedKeyIdentityHint: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-psk", "secret"***REMOVED***,
	***REMOVED***)
***REMOVED***

func addBadECDSASignatureTests() ***REMOVED***
	for badR := BadValue(1); badR < NumBadValues; badR++ ***REMOVED***
		for badS := BadValue(1); badS < NumBadValues; badS++ ***REMOVED***
			testCases = append(testCases, testCase***REMOVED***
				name: fmt.Sprintf("BadECDSA-%d-%d", badR, badS),
				config: Config***REMOVED***
					MaxVersion:   VersionTLS12,
					CipherSuites: []uint16***REMOVED***TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256***REMOVED***,
					Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						BadECDSAR: badR,
						BadECDSAS: badS,
					***REMOVED***,
				***REMOVED***,
				shouldFail:    true,
				expectedError: ":BAD_SIGNATURE:",
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				name: fmt.Sprintf("BadECDSA-%d-%d-TLS13", badR, badS),
				config: Config***REMOVED***
					MaxVersion:   VersionTLS13,
					Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						BadECDSAR: badR,
						BadECDSAS: badS,
					***REMOVED***,
				***REMOVED***,
				shouldFail:    true,
				expectedError: ":BAD_SIGNATURE:",
			***REMOVED***)
		***REMOVED***
	***REMOVED***
***REMOVED***

func addCBCPaddingTests() ***REMOVED***
	testCases = append(testCases, testCase***REMOVED***
		name: "MaxCBCPadding",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				MaxPadding: true,
			***REMOVED***,
		***REMOVED***,
		messageLen: 12, // 20 bytes of SHA-1 + 12 == 0 % block size
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "BadCBCPadding",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				PaddingFirstByteBad: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
	***REMOVED***)
	// OpenSSL previously had an issue where the first byte of padding in
	// 255 bytes of padding wasn't checked.
	testCases = append(testCases, testCase***REMOVED***
		name: "BadCBCPadding255",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				MaxPadding:               true,
				PaddingFirstByteBadIf255: true,
			***REMOVED***,
		***REMOVED***,
		messageLen:    12, // 20 bytes of SHA-1 + 12 == 0 % block size
		shouldFail:    true,
		expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
	***REMOVED***)
***REMOVED***

func addCBCSplittingTests() ***REMOVED***
	testCases = append(testCases, testCase***REMOVED***
		name: "CBCRecordSplitting",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS10,
			MinVersion:   VersionTLS10,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
		***REMOVED***,
		messageLen:    -1, // read until EOF
		resumeSession: true,
		flags: []string***REMOVED***
			"-async",
			"-write-different-record-sizes",
			"-cbc-record-splitting",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "CBCRecordSplittingPartialWrite",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS10,
			MinVersion:   VersionTLS10,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
		***REMOVED***,
		messageLen: -1, // read until EOF
		flags: []string***REMOVED***
			"-async",
			"-write-different-record-sizes",
			"-cbc-record-splitting",
			"-partial-write",
		***REMOVED***,
	***REMOVED***)
***REMOVED***

func addClientAuthTests() ***REMOVED***
	// Add a dummy cert pool to stress certificate authority parsing.
	// TODO(davidben): Add tests that those values parse out correctly.
	certPool := x509.NewCertPool()
	cert, err := x509.ParseCertificate(rsaCertificate.Certificate[0])
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***
	certPool.AddCert(cert)

	for _, ver := range tlsVersions ***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     ver.name + "-Client-ClientAuth-RSA",
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
				ClientAuth: RequireAnyClientCert,
				ClientCAs:  certPool,
			***REMOVED***,
			flags: []string***REMOVED***
				"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
				"-key-file", path.Join(*resourceDir, rsaKeyFile),
			***REMOVED***,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     ver.name + "-Server-ClientAuth-RSA",
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
		***REMOVED***)
		if ver.version != VersionSSL30 ***REMOVED***
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     ver.name + "-Server-ClientAuth-ECDSA",
				config: Config***REMOVED***
					MinVersion:   ver.version,
					MaxVersion:   ver.version,
					Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				testType: clientTest,
				name:     ver.name + "-Client-ClientAuth-ECDSA",
				config: Config***REMOVED***
					MinVersion: ver.version,
					MaxVersion: ver.version,
					ClientAuth: RequireAnyClientCert,
					ClientCAs:  certPool,
				***REMOVED***,
				flags: []string***REMOVED***
					"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
					"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
				***REMOVED***,
			***REMOVED***)
		***REMOVED***

		testCases = append(testCases, testCase***REMOVED***
			name: "NoClientCertificate-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
				ClientAuth: RequireAnyClientCert,
			***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "client didn't provide a certificate",
		***REMOVED***)

		testCases = append(testCases, testCase***REMOVED***
			// Even if not configured to expect a certificate, OpenSSL will
			// return X509_V_OK as the verify_result.
			testType: serverTest,
			name:     "NoClientCertificateRequested-Server-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
			***REMOVED***,
			flags: []string***REMOVED***
				"-expect-verify-result",
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		testCases = append(testCases, testCase***REMOVED***
			// If a client certificate is not provided, OpenSSL will still
			// return X509_V_OK as the verify_result.
			testType: serverTest,
			name:     "NoClientCertificate-Server-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
			***REMOVED***,
			flags: []string***REMOVED***
				"-expect-verify-result",
				"-verify-peer",
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		certificateRequired := "remote error: certificate required"
		if ver.version < VersionTLS13 ***REMOVED***
			// Prior to TLS 1.3, the generic handshake_failure alert
			// was used.
			certificateRequired = "remote error: handshake failure"
		***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "RequireAnyClientCertificate-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
			***REMOVED***,
			flags:              []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
			shouldFail:         true,
			expectedError:      ":PEER_DID_NOT_RETURN_A_CERTIFICATE:",
			expectedLocalError: certificateRequired,
		***REMOVED***)

		if ver.version != VersionSSL30 ***REMOVED***
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "SkipClientCertificate-" + ver.name,
				config: Config***REMOVED***
					MinVersion: ver.version,
					MaxVersion: ver.version,
					Bugs: ProtocolBugs***REMOVED***
						SkipClientCertificate: true,
					***REMOVED***,
				***REMOVED***,
				// Setting SSL_VERIFY_PEER allows anonymous clients.
				flags:         []string***REMOVED***"-verify-peer"***REMOVED***,
				shouldFail:    true,
				expectedError: ":UNEXPECTED_MESSAGE:",
			***REMOVED***)
		***REMOVED***
	***REMOVED***

	// Client auth is only legal in certificate-based ciphers.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-PSK",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
			PreSharedKey: []byte("secret"),
			ClientAuth:   RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-psk", "secret",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-ECDHE_PSK",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
			PreSharedKey: []byte("secret"),
			ClientAuth:   RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-psk", "secret",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)

	// Regression test for a bug where the client CA list, if explicitly
	// set to NULL, was mis-encoded.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Null-Client-CA-List",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-require-any-client-certificate",
			"-use-null-client-ca-list",
		***REMOVED***,
	***REMOVED***)
***REMOVED***

func addExtendedMasterSecretTests() ***REMOVED***
	const expectEMSFlag = "-expect-extended-master-secret"

	for _, with := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		prefix := "No"
		if with ***REMOVED***
			prefix = ""
		***REMOVED***

		for _, isClient := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
			suffix := "-Server"
			testType := serverTest
			if isClient ***REMOVED***
				suffix = "-Client"
				testType = clientTest
			***REMOVED***

			for _, ver := range tlsVersions ***REMOVED***
				// In TLS 1.3, the extension is irrelevant and
				// always reports as enabled.
				var flags []string
				if with || ver.version >= VersionTLS13 ***REMOVED***
					flags = []string***REMOVED***expectEMSFlag***REMOVED***
				***REMOVED***

				test := testCase***REMOVED***
					testType: testType,
					name:     prefix + "ExtendedMasterSecret-" + ver.name + suffix,
					config: Config***REMOVED***
						MinVersion: ver.version,
						MaxVersion: ver.version,
						Bugs: ProtocolBugs***REMOVED***
							NoExtendedMasterSecret:      !with,
							RequireExtendedMasterSecret: with,
						***REMOVED***,
					***REMOVED***,
					flags:      flags,
					shouldFail: ver.version == VersionSSL30 && with,
				***REMOVED***
				if test.shouldFail ***REMOVED***
					test.expectedLocalError = "extended master secret required but not supported by peer"
				***REMOVED***
				testCases = append(testCases, test)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	for _, isClient := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		for _, supportedInFirstConnection := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
			for _, supportedInResumeConnection := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
				boolToWord := func(b bool) string ***REMOVED***
					if b ***REMOVED***
						return "Yes"
					***REMOVED***
					return "No"
				***REMOVED***
				suffix := boolToWord(supportedInFirstConnection) + "To" + boolToWord(supportedInResumeConnection) + "-"
				if isClient ***REMOVED***
					suffix += "Client"
				***REMOVED*** else ***REMOVED***
					suffix += "Server"
				***REMOVED***

				supportedConfig := Config***REMOVED***
					MaxVersion: VersionTLS12,
					Bugs: ProtocolBugs***REMOVED***
						RequireExtendedMasterSecret: true,
					***REMOVED***,
				***REMOVED***

				noSupportConfig := Config***REMOVED***
					MaxVersion: VersionTLS12,
					Bugs: ProtocolBugs***REMOVED***
						NoExtendedMasterSecret: true,
					***REMOVED***,
				***REMOVED***

				test := testCase***REMOVED***
					name:          "ExtendedMasterSecret-" + suffix,
					resumeSession: true,
				***REMOVED***

				if !isClient ***REMOVED***
					test.testType = serverTest
				***REMOVED***

				if supportedInFirstConnection ***REMOVED***
					test.config = supportedConfig
				***REMOVED*** else ***REMOVED***
					test.config = noSupportConfig
				***REMOVED***

				if supportedInResumeConnection ***REMOVED***
					test.resumeConfig = &supportedConfig
				***REMOVED*** else ***REMOVED***
					test.resumeConfig = &noSupportConfig
				***REMOVED***

				switch suffix ***REMOVED***
				case "YesToYes-Client", "YesToYes-Server":
					// When a session is resumed, it should
					// still be aware that its master
					// secret was generated via EMS and
					// thus it's safe to use tls-unique.
					test.flags = []string***REMOVED***expectEMSFlag***REMOVED***
				case "NoToYes-Server":
					// If an original connection did not
					// contain EMS, but a resumption
					// handshake does, then a server should
					// not resume the session.
					test.expectResumeRejected = true
				case "YesToNo-Server":
					// Resuming an EMS session without the
					// EMS extension should cause the
					// server to abort the connection.
					test.shouldFail = true
					test.expectedError = ":RESUMED_EMS_SESSION_WITHOUT_EMS_EXTENSION:"
				case "NoToYes-Client":
					// A client should abort a connection
					// where the server resumed a non-EMS
					// session but echoed the EMS
					// extension.
					test.shouldFail = true
					test.expectedError = ":RESUMED_NON_EMS_SESSION_WITH_EMS_EXTENSION:"
				case "YesToNo-Client":
					// A client should abort a connection
					// where the server didn't echo EMS
					// when the session used it.
					test.shouldFail = true
					test.expectedError = ":RESUMED_EMS_SESSION_WITHOUT_EMS_EXTENSION:"
				***REMOVED***

				testCases = append(testCases, test)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	// Switching EMS on renegotiation is forbidden.
	testCases = append(testCases, testCase***REMOVED***
		name: "ExtendedMasterSecret-Renego-NoEMS",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoExtendedMasterSecret:                true,
				NoExtendedMasterSecretOnRenegotiation: true,
			***REMOVED***,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ExtendedMasterSecret-Renego-Upgrade",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoExtendedMasterSecret: true,
			***REMOVED***,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":RENEGOTIATION_EMS_MISMATCH:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ExtendedMasterSecret-Renego-Downgrade",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoExtendedMasterSecretOnRenegotiation: true,
			***REMOVED***,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":RENEGOTIATION_EMS_MISMATCH:",
	***REMOVED***)
***REMOVED***

type stateMachineTestConfig struct ***REMOVED***
	protocol                            protocol
	async                               bool
	splitHandshake, packHandshakeFlight bool
***REMOVED***

// Adds tests that try to cover the range of the handshake state machine, under
// various conditions. Some of these are redundant with other tests, but they
// only cover the synchronous case.
func addAllStateMachineCoverageTests() ***REMOVED***
	for _, async := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		for _, protocol := range []protocol***REMOVED***tls, dtls***REMOVED*** ***REMOVED***
			addStateMachineCoverageTests(stateMachineTestConfig***REMOVED***
				protocol: protocol,
				async:    async,
			***REMOVED***)
			addStateMachineCoverageTests(stateMachineTestConfig***REMOVED***
				protocol:       protocol,
				async:          async,
				splitHandshake: true,
			***REMOVED***)
			if protocol == tls ***REMOVED***
				addStateMachineCoverageTests(stateMachineTestConfig***REMOVED***
					protocol:            protocol,
					async:               async,
					packHandshakeFlight: true,
				***REMOVED***)
			***REMOVED***
		***REMOVED***
	***REMOVED***
***REMOVED***

func addStateMachineCoverageTests(config stateMachineTestConfig) ***REMOVED***
	var tests []testCase

	// Basic handshake, with resumption. Client and server,
	// session ID and session ticket.
	tests = append(tests, testCase***REMOVED***
		name: "Basic-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		resumeSession: true,
		// Ensure session tickets are used, not session IDs.
		noSessionCache: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		name: "Basic-Client-RenewTicket",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				RenewTicketOnResume: true,
			***REMOVED***,
		***REMOVED***,
		flags:                []string***REMOVED***"-expect-ticket-renewal"***REMOVED***,
		resumeSession:        true,
		resumeRenewedSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		name: "Basic-Client-NoTicket",
		config: Config***REMOVED***
			MaxVersion:             VersionTLS12,
			SessionTicketsDisabled: true,
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		name: "Basic-Client-Implicit",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		flags:         []string***REMOVED***"-implicit-handshake"***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				RequireSessionTickets: true,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
		flags:         []string***REMOVED***"-expect-no-session-id"***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server-NoTickets",
		config: Config***REMOVED***
			MaxVersion:             VersionTLS12,
			SessionTicketsDisabled: true,
		***REMOVED***,
		resumeSession: true,
		flags:         []string***REMOVED***"-expect-session-id"***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server-Implicit",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		flags:         []string***REMOVED***"-implicit-handshake"***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server-EarlyCallback",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		flags:         []string***REMOVED***"-use-early-callback"***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// TLS 1.3 basic handshake shapes.
	if config.protocol == tls ***REMOVED***
		tests = append(tests, testCase***REMOVED***
			name: "TLS13-1RTT-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				MinVersion: VersionTLS13,
			***REMOVED***,
			resumeSession:        true,
			resumeRenewedSession: true,
		***REMOVED***)

		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "TLS13-1RTT-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				MinVersion: VersionTLS13,
			***REMOVED***,
			resumeSession:        true,
			resumeRenewedSession: true,
			// TLS 1.3 uses tickets, so the session should not be
			// cached statefully.
			flags: []string***REMOVED***"-expect-no-session-id"***REMOVED***,
		***REMOVED***)

		tests = append(tests, testCase***REMOVED***
			name: "TLS13-HelloRetryRequest-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				MinVersion: VersionTLS13,
				// P-384 requires a HelloRetryRequest against BoringSSL's default
				// configuration. Assert this with ExpectMissingKeyShare.
				CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectMissingKeyShare: true,
				***REMOVED***,
			***REMOVED***,
			// Cover HelloRetryRequest during an ECDHE-PSK resumption.
			resumeSession: true,
		***REMOVED***)

		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "TLS13-HelloRetryRequest-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				MinVersion: VersionTLS13,
				// Require a HelloRetryRequest for every curve.
				DefaultCurves: []CurveID***REMOVED******REMOVED***,
			***REMOVED***,
			// Cover HelloRetryRequest during an ECDHE-PSK resumption.
			resumeSession: true,
		***REMOVED***)
	***REMOVED***

	// TLS client auth.
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-NoCertificate-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequestClientCert,
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "ClientAuth-NoCertificate-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		// Setting SSL_VERIFY_PEER allows anonymous clients.
		flags: []string***REMOVED***"-verify-peer"***REMOVED***,
	***REMOVED***)
	if config.protocol == tls ***REMOVED***
		tests = append(tests, testCase***REMOVED***
			testType: clientTest,
			name:     "ClientAuth-NoCertificate-Client-SSL3",
			config: Config***REMOVED***
				MaxVersion: VersionSSL30,
				ClientAuth: RequestClientCert,
			***REMOVED***,
		***REMOVED***)
		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "ClientAuth-NoCertificate-Server-SSL3",
			config: Config***REMOVED***
				MaxVersion: VersionSSL30,
			***REMOVED***,
			// Setting SSL_VERIFY_PEER allows anonymous clients.
			flags: []string***REMOVED***"-verify-peer"***REMOVED***,
		***REMOVED***)
		tests = append(tests, testCase***REMOVED***
			testType: clientTest,
			name:     "ClientAuth-NoCertificate-Client-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				ClientAuth: RequestClientCert,
			***REMOVED***,
		***REMOVED***)
		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "ClientAuth-NoCertificate-Server-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			// Setting SSL_VERIFY_PEER allows anonymous clients.
			flags: []string***REMOVED***"-verify-peer"***REMOVED***,
		***REMOVED***)
	***REMOVED***
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-RSA-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-RSA-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-ECDSA-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
			"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-ECDSA-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
			"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-NoCertificate-OldCallback",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequestClientCert,
		***REMOVED***,
		flags: []string***REMOVED***"-use-old-client-cert-callback"***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-NoCertificate-OldCallback-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequestClientCert,
		***REMOVED***,
		flags: []string***REMOVED***"-use-old-client-cert-callback"***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-OldCallback",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-use-old-client-cert-callback",
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientAuth-OldCallback-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-use-old-client-cert-callback",
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "ClientAuth-Server",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "ClientAuth-Server-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
	***REMOVED***)

	// Test each key exchange on the server side for async keys.
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server-RSA",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server-ECDHE-RSA",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "Basic-Server-ECDHE-ECDSA",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
			"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
		***REMOVED***,
	***REMOVED***)

	// No session ticket support; server doesn't send NewSessionTicket.
	tests = append(tests, testCase***REMOVED***
		name: "SessionTicketsDisabled-Client",
		config: Config***REMOVED***
			MaxVersion:             VersionTLS12,
			SessionTicketsDisabled: true,
		***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "SessionTicketsDisabled-Server",
		config: Config***REMOVED***
			MaxVersion:             VersionTLS12,
			SessionTicketsDisabled: true,
		***REMOVED***,
	***REMOVED***)

	// Skip ServerKeyExchange in PSK key exchange if there's no
	// identity hint.
	tests = append(tests, testCase***REMOVED***
		name: "EmptyPSKHint-Client",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
			PreSharedKey: []byte("secret"),
		***REMOVED***,
		flags: []string***REMOVED***"-psk", "secret"***REMOVED***,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "EmptyPSKHint-Server",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_PSK_WITH_AES_128_CBC_SHA***REMOVED***,
			PreSharedKey: []byte("secret"),
		***REMOVED***,
		flags: []string***REMOVED***"-psk", "secret"***REMOVED***,
	***REMOVED***)

	// OCSP stapling tests.
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "OCSPStapling-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-ocsp-stapling",
			"-expect-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
			"-verify-peer",
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "OCSPStapling-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		expectedOCSPResponse: testOCSPResponse,
		flags: []string***REMOVED***
			"-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: clientTest,
		name:     "OCSPStapling-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-ocsp-stapling",
			"-expect-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
			"-verify-peer",
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	tests = append(tests, testCase***REMOVED***
		testType: serverTest,
		name:     "OCSPStapling-Server-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
		***REMOVED***,
		expectedOCSPResponse: testOCSPResponse,
		flags: []string***REMOVED***
			"-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// Certificate verification tests.
	for _, vers := range tlsVersions ***REMOVED***
		if config.protocol == dtls && !vers.hasDTLS ***REMOVED***
			continue
		***REMOVED***
		for _, testType := range []testType***REMOVED***clientTest, serverTest***REMOVED*** ***REMOVED***
			suffix := "-Client"
			if testType == serverTest ***REMOVED***
				suffix = "-Server"
			***REMOVED***
			suffix += "-" + vers.name

			flag := "-verify-peer"
			if testType == serverTest ***REMOVED***
				flag = "-require-any-client-certificate"
			***REMOVED***

			tests = append(tests, testCase***REMOVED***
				testType: testType,
				name:     "CertificateVerificationSucceed" + suffix,
				config: Config***REMOVED***
					MaxVersion:   vers.version,
					Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					flag,
					"-expect-verify-result",
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
			tests = append(tests, testCase***REMOVED***
				testType: testType,
				name:     "CertificateVerificationFail" + suffix,
				config: Config***REMOVED***
					MaxVersion:   vers.version,
					Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					flag,
					"-verify-fail",
				***REMOVED***,
				shouldFail:    true,
				expectedError: ":CERTIFICATE_VERIFY_FAILED:",
			***REMOVED***)
		***REMOVED***

		// By default, the client is in a soft fail mode where the peer
		// certificate is verified but failures are non-fatal.
		tests = append(tests, testCase***REMOVED***
			testType: clientTest,
			name:     "CertificateVerificationSoftFail-" + vers.name,
			config: Config***REMOVED***
				MaxVersion:   vers.version,
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-verify-fail",
				"-expect-verify-result",
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)
	***REMOVED***

	tests = append(tests, testCase***REMOVED***
		name:               "ShimSendAlert",
		flags:              []string***REMOVED***"-send-alert"***REMOVED***,
		shimWritesFirst:    true,
		shouldFail:         true,
		expectedLocalError: "remote error: decompression failure",
	***REMOVED***)

	if config.protocol == tls ***REMOVED***
		tests = append(tests, testCase***REMOVED***
			name: "Renegotiate-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			renegotiate: 1,
			flags: []string***REMOVED***
				"-renegotiate-freely",
				"-expect-total-renegotiations", "1",
			***REMOVED***,
		***REMOVED***)

		tests = append(tests, testCase***REMOVED***
			name: "SendHalfHelloRequest",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					PackHelloRequestWithFinished: config.packHandshakeFlight,
				***REMOVED***,
			***REMOVED***,
			sendHalfHelloRequest: true,
			flags:                []string***REMOVED***"-renegotiate-ignore"***REMOVED***,
			shouldFail:           true,
			expectedError:        ":UNEXPECTED_RECORD:",
		***REMOVED***)

		// NPN on client and server; results in post-handshake message.
		tests = append(tests, testCase***REMOVED***
			name: "NPN-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				NextProtos: []string***REMOVED***"foo"***REMOVED***,
			***REMOVED***,
			flags:                 []string***REMOVED***"-select-next-proto", "foo"***REMOVED***,
			resumeSession:         true,
			expectedNextProto:     "foo",
			expectedNextProtoType: npn,
		***REMOVED***)
		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "NPN-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				NextProtos: []string***REMOVED***"bar"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-advertise-npn", "\x03foo\x03bar\x03baz",
				"-expect-next-proto", "bar",
			***REMOVED***,
			resumeSession:         true,
			expectedNextProto:     "bar",
			expectedNextProtoType: npn,
		***REMOVED***)

		// TODO(davidben): Add tests for when False Start doesn't trigger.

		// Client does False Start and negotiates NPN.
		tests = append(tests, testCase***REMOVED***
			name: "FalseStart",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-select-next-proto", "foo",
			***REMOVED***,
			shimWritesFirst: true,
			resumeSession:   true,
		***REMOVED***)

		// Client does False Start and negotiates ALPN.
		tests = append(tests, testCase***REMOVED***
			name: "FalseStart-ALPN",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shimWritesFirst: true,
			resumeSession:   true,
		***REMOVED***)

		// Client does False Start but doesn't explicitly call
		// SSL_connect.
		tests = append(tests, testCase***REMOVED***
			name: "FalseStart-Implicit",
			config: Config***REMOVED***
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:   []string***REMOVED***"foo"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-implicit-handshake",
				"-false-start",
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
		***REMOVED***)

		// False Start without session tickets.
		tests = append(tests, testCase***REMOVED***
			name: "FalseStart-SessionTicketsDisabled",
			config: Config***REMOVED***
				MaxVersion:             VersionTLS12,
				CipherSuites:           []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				NextProtos:             []string***REMOVED***"foo"***REMOVED***,
				SessionTicketsDisabled: true,
				Bugs: ProtocolBugs***REMOVED***
					ExpectFalseStart: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-false-start",
				"-select-next-proto", "foo",
			***REMOVED***,
			shimWritesFirst: true,
		***REMOVED***)

		// Server parses a V2ClientHello.
		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "SendV2ClientHello",
			config: Config***REMOVED***
				// Choose a cipher suite that does not involve
				// elliptic curves, so no extensions are
				// involved.
				MaxVersion:   VersionTLS12,
				CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					SendV2ClientHello: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		// Test Channel ID
		for _, ver := range tlsVersions ***REMOVED***
			if ver.version < VersionTLS10 ***REMOVED***
				continue
			***REMOVED***
			// Client sends a Channel ID.
			tests = append(tests, testCase***REMOVED***
				name: "ChannelID-Client-" + ver.name,
				config: Config***REMOVED***
					MaxVersion:       ver.version,
					RequestChannelID: true,
				***REMOVED***,
				flags:           []string***REMOVED***"-send-channel-id", path.Join(*resourceDir, channelIDKeyFile)***REMOVED***,
				resumeSession:   true,
				expectChannelID: true,
			***REMOVED***)

			// Server accepts a Channel ID.
			tests = append(tests, testCase***REMOVED***
				testType: serverTest,
				name:     "ChannelID-Server-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					ChannelID:  channelIDKey,
				***REMOVED***,
				flags: []string***REMOVED***
					"-expect-channel-id",
					base64.StdEncoding.EncodeToString(channelIDBytes),
				***REMOVED***,
				resumeSession:   true,
				expectChannelID: true,
			***REMOVED***)

			tests = append(tests, testCase***REMOVED***
				testType: serverTest,
				name:     "InvalidChannelIDSignature-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					ChannelID:  channelIDKey,
					Bugs: ProtocolBugs***REMOVED***
						InvalidChannelIDSignature: true,
					***REMOVED***,
				***REMOVED***,
				flags:         []string***REMOVED***"-enable-channel-id"***REMOVED***,
				shouldFail:    true,
				expectedError: ":CHANNEL_ID_SIGNATURE_INVALID:",
			***REMOVED***)
		***REMOVED***

		// Channel ID and NPN at the same time, to ensure their relative
		// ordering is correct.
		tests = append(tests, testCase***REMOVED***
			name: "ChannelID-NPN-Client",
			config: Config***REMOVED***
				MaxVersion:       VersionTLS12,
				RequestChannelID: true,
				NextProtos:       []string***REMOVED***"foo"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-send-channel-id", path.Join(*resourceDir, channelIDKeyFile),
				"-select-next-proto", "foo",
			***REMOVED***,
			resumeSession:         true,
			expectChannelID:       true,
			expectedNextProto:     "foo",
			expectedNextProtoType: npn,
		***REMOVED***)
		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			name:     "ChannelID-NPN-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				ChannelID:  channelIDKey,
				NextProtos: []string***REMOVED***"bar"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-expect-channel-id",
				base64.StdEncoding.EncodeToString(channelIDBytes),
				"-advertise-npn", "\x03foo\x03bar\x03baz",
				"-expect-next-proto", "bar",
			***REMOVED***,
			resumeSession:         true,
			expectChannelID:       true,
			expectedNextProto:     "bar",
			expectedNextProtoType: npn,
		***REMOVED***)

		// Bidirectional shutdown with the runner initiating.
		tests = append(tests, testCase***REMOVED***
			name: "Shutdown-Runner",
			config: Config***REMOVED***
				Bugs: ProtocolBugs***REMOVED***
					ExpectCloseNotify: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-check-close-notify"***REMOVED***,
		***REMOVED***)

		// Bidirectional shutdown with the shim initiating. The runner,
		// in the meantime, sends garbage before the close_notify which
		// the shim must ignore.
		tests = append(tests, testCase***REMOVED***
			name: "Shutdown-Shim",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					ExpectCloseNotify: true,
				***REMOVED***,
			***REMOVED***,
			shimShutsDown:     true,
			sendEmptyRecords:  1,
			sendWarningAlerts: 1,
			flags:             []string***REMOVED***"-check-close-notify"***REMOVED***,
		***REMOVED***)
	***REMOVED*** else ***REMOVED***
		// TODO(davidben): DTLS 1.3 will want a similar thing for
		// HelloRetryRequest.
		tests = append(tests, testCase***REMOVED***
			name: "SkipHelloVerifyRequest",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					SkipHelloVerifyRequest: true,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)
	***REMOVED***

	for _, test := range tests ***REMOVED***
		test.protocol = config.protocol
		if config.protocol == dtls ***REMOVED***
			test.name += "-DTLS"
		***REMOVED***
		if config.async ***REMOVED***
			test.name += "-Async"
			test.flags = append(test.flags, "-async")
		***REMOVED*** else ***REMOVED***
			test.name += "-Sync"
		***REMOVED***
		if config.splitHandshake ***REMOVED***
			test.name += "-SplitHandshakeRecords"
			test.config.Bugs.MaxHandshakeRecordLength = 1
			if config.protocol == dtls ***REMOVED***
				test.config.Bugs.MaxPacketLength = 256
				test.flags = append(test.flags, "-mtu", "256")
			***REMOVED***
		***REMOVED***
		if config.packHandshakeFlight ***REMOVED***
			test.name += "-PackHandshakeFlight"
			test.config.Bugs.PackHandshakeFlight = true
		***REMOVED***
		testCases = append(testCases, test)
	***REMOVED***
***REMOVED***

func addDDoSCallbackTests() ***REMOVED***
	// DDoS callback.
	for _, resume := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		suffix := "Resume"
		if resume ***REMOVED***
			suffix = "No" + suffix
		***REMOVED***

		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "Server-DDoS-OK-" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			flags:         []string***REMOVED***"-install-ddos-callback"***REMOVED***,
			resumeSession: resume,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "Server-DDoS-OK-" + suffix + "-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			flags:         []string***REMOVED***"-install-ddos-callback"***REMOVED***,
			resumeSession: resume,
		***REMOVED***)

		failFlag := "-fail-ddos-callback"
		if resume ***REMOVED***
			failFlag = "-fail-second-ddos-callback"
		***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "Server-DDoS-Reject-" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			flags:              []string***REMOVED***"-install-ddos-callback", failFlag***REMOVED***,
			resumeSession:      resume,
			shouldFail:         true,
			expectedError:      ":CONNECTION_REJECTED:",
			expectedLocalError: "remote error: internal error",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "Server-DDoS-Reject-" + suffix + "-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
			flags:              []string***REMOVED***"-install-ddos-callback", failFlag***REMOVED***,
			resumeSession:      resume,
			shouldFail:         true,
			expectedError:      ":CONNECTION_REJECTED:",
			expectedLocalError: "remote error: internal error",
		***REMOVED***)
	***REMOVED***
***REMOVED***

func addVersionNegotiationTests() ***REMOVED***
	for i, shimVers := range tlsVersions ***REMOVED***
		// Assemble flags to disable all newer versions on the shim.
		var flags []string
		for _, vers := range tlsVersions[i+1:] ***REMOVED***
			flags = append(flags, vers.flag)
		***REMOVED***

		// Test configuring the runner's maximum version.
		for _, runnerVers := range tlsVersions ***REMOVED***
			protocols := []protocol***REMOVED***tls***REMOVED***
			if runnerVers.hasDTLS && shimVers.hasDTLS ***REMOVED***
				protocols = append(protocols, dtls)
			***REMOVED***
			for _, protocol := range protocols ***REMOVED***
				expectedVersion := shimVers.version
				if runnerVers.version < shimVers.version ***REMOVED***
					expectedVersion = runnerVers.version
				***REMOVED***

				suffix := shimVers.name + "-" + runnerVers.name
				if protocol == dtls ***REMOVED***
					suffix += "-DTLS"
				***REMOVED***

				shimVersFlag := strconv.Itoa(int(versionToWire(shimVers.version, protocol == dtls)))

				// Determine the expected initial record-layer versions.
				clientVers := shimVers.version
				if clientVers > VersionTLS10 ***REMOVED***
					clientVers = VersionTLS10
				***REMOVED***
				clientVers = versionToWire(clientVers, protocol == dtls)
				serverVers := expectedVersion
				if expectedVersion >= VersionTLS13 ***REMOVED***
					serverVers = VersionTLS10
				***REMOVED***
				serverVers = versionToWire(serverVers, protocol == dtls)

				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: clientTest,
					name:     "VersionNegotiation-Client-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
						Bugs: ProtocolBugs***REMOVED***
							ExpectInitialRecordVersion: clientVers,
						***REMOVED***,
					***REMOVED***,
					flags:           flags,
					expectedVersion: expectedVersion,
				***REMOVED***)
				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: clientTest,
					name:     "VersionNegotiation-Client2-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
						Bugs: ProtocolBugs***REMOVED***
							ExpectInitialRecordVersion: clientVers,
						***REMOVED***,
					***REMOVED***,
					flags:           []string***REMOVED***"-max-version", shimVersFlag***REMOVED***,
					expectedVersion: expectedVersion,
				***REMOVED***)

				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: serverTest,
					name:     "VersionNegotiation-Server-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
						Bugs: ProtocolBugs***REMOVED***
							ExpectInitialRecordVersion: serverVers,
						***REMOVED***,
					***REMOVED***,
					flags:           flags,
					expectedVersion: expectedVersion,
				***REMOVED***)
				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: serverTest,
					name:     "VersionNegotiation-Server2-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
						Bugs: ProtocolBugs***REMOVED***
							ExpectInitialRecordVersion: serverVers,
						***REMOVED***,
					***REMOVED***,
					flags:           []string***REMOVED***"-max-version", shimVersFlag***REMOVED***,
					expectedVersion: expectedVersion,
				***REMOVED***)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	// Test the version extension at all versions.
	for _, vers := range tlsVersions ***REMOVED***
		protocols := []protocol***REMOVED***tls***REMOVED***
		if vers.hasDTLS ***REMOVED***
			protocols = append(protocols, dtls)
		***REMOVED***
		for _, protocol := range protocols ***REMOVED***
			suffix := vers.name
			if protocol == dtls ***REMOVED***
				suffix += "-DTLS"
			***REMOVED***

			wireVersion := versionToWire(vers.version, protocol == dtls)
			testCases = append(testCases, testCase***REMOVED***
				protocol: protocol,
				testType: serverTest,
				name:     "VersionNegotiationExtension-" + suffix,
				config: Config***REMOVED***
					Bugs: ProtocolBugs***REMOVED***
						SendSupportedVersions: []uint16***REMOVED***0x1111, wireVersion, 0x2222***REMOVED***,
					***REMOVED***,
				***REMOVED***,
				expectedVersion: vers.version,
			***REMOVED***)
		***REMOVED***

	***REMOVED***

	// If all versions are unknown, negotiation fails.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "NoSupportedVersions",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedVersions: []uint16***REMOVED***0x1111***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNSUPPORTED_PROTOCOL:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		testType: serverTest,
		name:     "NoSupportedVersions-DTLS",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedVersions: []uint16***REMOVED***0x1111***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNSUPPORTED_PROTOCOL:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ClientHelloVersionTooHigh",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     0x0304,
				OmitSupportedVersions: true,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS12,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ConflictingVersionNegotiation",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     VersionTLS12,
				SendSupportedVersions: []uint16***REMOVED***VersionTLS11***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		// The extension takes precedence over the ClientHello version.
		expectedVersion: VersionTLS11,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ConflictingVersionNegotiation-2",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     VersionTLS11,
				SendSupportedVersions: []uint16***REMOVED***VersionTLS12***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		// The extension takes precedence over the ClientHello version.
		expectedVersion: VersionTLS12,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "RejectFinalTLS13",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedVersions: []uint16***REMOVED***VersionTLS13, VersionTLS12***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		// We currently implement a draft TLS 1.3 version. Ensure that
		// the true TLS 1.3 value is ignored for now.
		expectedVersion: VersionTLS12,
	***REMOVED***)

	// Test that the maximum version is selected regardless of the
	// client-sent order.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "IgnoreClientVersionOrder",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedVersions: []uint16***REMOVED***VersionTLS12, tls13DraftVersion***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS13,
	***REMOVED***)

	// Test for version tolerance.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "MinorVersionTolerance",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     0x03ff,
				OmitSupportedVersions: true,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS12,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "MajorVersionTolerance",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     0x0400,
				OmitSupportedVersions: true,
			***REMOVED***,
		***REMOVED***,
		// TLS 1.3 must be negotiated with the supported_versions
		// extension, not ClientHello.version.
		expectedVersion: VersionTLS12,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "VersionTolerance-TLS13",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				// Although TLS 1.3 does not use
				// ClientHello.version, it still tolerates high
				// values there.
				SendClientVersion: 0x0400,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS13,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		testType: serverTest,
		name:     "MinorVersionTolerance-DTLS",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     0xfe00,
				OmitSupportedVersions: true,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS12,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		testType: serverTest,
		name:     "MajorVersionTolerance-DTLS",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     0xfdff,
				OmitSupportedVersions: true,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS12,
	***REMOVED***)

	// Test that versions below 3.0 are rejected.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "VersionTooLow",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion:     0x0200,
				OmitSupportedVersions: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNSUPPORTED_PROTOCOL:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		testType: serverTest,
		name:     "VersionTooLow-DTLS",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion: 0xffff,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNSUPPORTED_PROTOCOL:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ServerBogusVersion",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendServerHelloVersion: 0x1234,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNSUPPORTED_PROTOCOL:",
	***REMOVED***)

	// Test TLS 1.3's downgrade signal.
	testCases = append(testCases, testCase***REMOVED***
		name: "Downgrade-TLS12-Client",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				NegotiateVersion: VersionTLS12,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS12,
		// TODO(davidben): This test should fail once TLS 1.3 is final
		// and the fallback signal restored.
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Downgrade-TLS12-Server",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedVersions: []uint16***REMOVED***VersionTLS12***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		expectedVersion: VersionTLS12,
		// TODO(davidben): This test should fail once TLS 1.3 is final
		// and the fallback signal restored.
	***REMOVED***)
***REMOVED***

func addMinimumVersionTests() ***REMOVED***
	for i, shimVers := range tlsVersions ***REMOVED***
		// Assemble flags to disable all older versions on the shim.
		var flags []string
		for _, vers := range tlsVersions[:i] ***REMOVED***
			flags = append(flags, vers.flag)
		***REMOVED***

		for _, runnerVers := range tlsVersions ***REMOVED***
			protocols := []protocol***REMOVED***tls***REMOVED***
			if runnerVers.hasDTLS && shimVers.hasDTLS ***REMOVED***
				protocols = append(protocols, dtls)
			***REMOVED***
			for _, protocol := range protocols ***REMOVED***
				suffix := shimVers.name + "-" + runnerVers.name
				if protocol == dtls ***REMOVED***
					suffix += "-DTLS"
				***REMOVED***
				shimVersFlag := strconv.Itoa(int(versionToWire(shimVers.version, protocol == dtls)))

				var expectedVersion uint16
				var shouldFail bool
				var expectedError, expectedLocalError string
				if runnerVers.version >= shimVers.version ***REMOVED***
					expectedVersion = runnerVers.version
				***REMOVED*** else ***REMOVED***
					shouldFail = true
					expectedError = ":UNSUPPORTED_PROTOCOL:"
					expectedLocalError = "remote error: protocol version not supported"
				***REMOVED***

				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: clientTest,
					name:     "MinimumVersion-Client-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
						Bugs: ProtocolBugs***REMOVED***
							// Ensure the server does not decline to
							// select a version (versions extension) or
							// cipher (some ciphers depend on versions).
							NegotiateVersion:            runnerVers.version,
							IgnorePeerCipherPreferences: shouldFail,
						***REMOVED***,
					***REMOVED***,
					flags:              flags,
					expectedVersion:    expectedVersion,
					shouldFail:         shouldFail,
					expectedError:      expectedError,
					expectedLocalError: expectedLocalError,
				***REMOVED***)
				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: clientTest,
					name:     "MinimumVersion-Client2-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
						Bugs: ProtocolBugs***REMOVED***
							// Ensure the server does not decline to
							// select a version (versions extension) or
							// cipher (some ciphers depend on versions).
							NegotiateVersion:            runnerVers.version,
							IgnorePeerCipherPreferences: shouldFail,
						***REMOVED***,
					***REMOVED***,
					flags:              []string***REMOVED***"-min-version", shimVersFlag***REMOVED***,
					expectedVersion:    expectedVersion,
					shouldFail:         shouldFail,
					expectedError:      expectedError,
					expectedLocalError: expectedLocalError,
				***REMOVED***)

				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: serverTest,
					name:     "MinimumVersion-Server-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
					***REMOVED***,
					flags:              flags,
					expectedVersion:    expectedVersion,
					shouldFail:         shouldFail,
					expectedError:      expectedError,
					expectedLocalError: expectedLocalError,
				***REMOVED***)
				testCases = append(testCases, testCase***REMOVED***
					protocol: protocol,
					testType: serverTest,
					name:     "MinimumVersion-Server2-" + suffix,
					config: Config***REMOVED***
						MaxVersion: runnerVers.version,
					***REMOVED***,
					flags:              []string***REMOVED***"-min-version", shimVersFlag***REMOVED***,
					expectedVersion:    expectedVersion,
					shouldFail:         shouldFail,
					expectedError:      expectedError,
					expectedLocalError: expectedLocalError,
				***REMOVED***)
			***REMOVED***
		***REMOVED***
	***REMOVED***
***REMOVED***

func addExtensionTests() ***REMOVED***
	// TODO(davidben): Extensions, where applicable, all move their server
	// halves to EncryptedExtensions in TLS 1.3. Duplicate each of these
	// tests for both. Also test interaction with 0-RTT when implemented.

	// Repeat extensions tests all versions except SSL 3.0.
	for _, ver := range tlsVersions ***REMOVED***
		if ver.version == VersionSSL30 ***REMOVED***
			continue
		***REMOVED***

		// Test that duplicate extensions are rejected.
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "DuplicateExtensionClient-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					DuplicateExtension: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "remote error: error decoding message",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "DuplicateExtensionServer-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					DuplicateExtension: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "remote error: error decoding message",
		***REMOVED***)

		// Test SNI.
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ServerNameExtensionClient-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					ExpectServerName: "example.com",
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***"-host-name", "example.com"***REMOVED***,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ServerNameExtensionClientMismatch-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					ExpectServerName: "mismatch.com",
				***REMOVED***,
			***REMOVED***,
			flags:              []string***REMOVED***"-host-name", "example.com"***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "tls: unexpected server name",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ServerNameExtensionClientMissing-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					ExpectServerName: "missing.com",
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedLocalError: "tls: unexpected server name",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "TolerateServerNameAck-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendServerNameAck: true,
				***REMOVED***,
			***REMOVED***,
			flags:         []string***REMOVED***"-host-name", "example.com"***REMOVED***,
			resumeSession: true,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "UnsolicitedServerNameAck-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendServerNameAck: true,
				***REMOVED***,
			***REMOVED***,
			shouldFail:         true,
			expectedError:      ":UNEXPECTED_EXTENSION:",
			expectedLocalError: "remote error: unsupported extension",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "ServerNameExtensionServer-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				ServerName: "example.com",
			***REMOVED***,
			flags:         []string***REMOVED***"-expect-server-name", "example.com"***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		// Test ALPN.
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ALPNClient-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				NextProtos: []string***REMOVED***"foo"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-advertise-alpn", "\x03foo\x03bar\x03baz",
				"-expect-alpn", "foo",
			***REMOVED***,
			expectedNextProto:     "foo",
			expectedNextProtoType: alpn,
			resumeSession:         true,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ALPNClient-Mismatch-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendALPN: "baz",
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-advertise-alpn", "\x03foo\x03bar",
			***REMOVED***,
			shouldFail:         true,
			expectedError:      ":INVALID_ALPN_PROTOCOL:",
			expectedLocalError: "remote error: illegal parameter",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "ALPNServer-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-expect-advertised-alpn", "\x03foo\x03bar\x03baz",
				"-select-alpn", "foo",
			***REMOVED***,
			expectedNextProto:     "foo",
			expectedNextProtoType: alpn,
			resumeSession:         true,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "ALPNServer-Decline-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
			***REMOVED***,
			flags:             []string***REMOVED***"-decline-alpn"***REMOVED***,
			expectNoNextProto: true,
			resumeSession:     true,
		***REMOVED***)

		// Test ALPN in async mode as well to ensure that extensions callbacks are only
		// called once.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "ALPNServer-Async-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
				// Prior to TLS 1.3, exercise the asynchronous session callback.
				SessionTicketsDisabled: ver.version < VersionTLS13,
			***REMOVED***,
			flags: []string***REMOVED***
				"-expect-advertised-alpn", "\x03foo\x03bar\x03baz",
				"-select-alpn", "foo",
				"-async",
			***REMOVED***,
			expectedNextProto:     "foo",
			expectedNextProtoType: alpn,
			resumeSession:         true,
		***REMOVED***)

		var emptyString string
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ALPNClient-EmptyProtocolName-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				NextProtos: []string***REMOVED***""***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					// A server returning an empty ALPN protocol
					// should be rejected.
					ALPNProtocol: &emptyString,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-advertise-alpn", "\x03foo",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":PARSE_TLSEXT:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "ALPNServer-EmptyProtocolName-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				// A ClientHello containing an empty ALPN protocol
				// should be rejected.
				NextProtos: []string***REMOVED***"foo", "", "baz"***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-select-alpn", "foo",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":PARSE_TLSEXT:",
		***REMOVED***)

		// Test NPN and the interaction with ALPN.
		if ver.version < VersionTLS13 ***REMOVED***
			// Test that the server prefers ALPN over NPN.
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "ALPNServer-Preferred-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-expect-advertised-alpn", "\x03foo\x03bar\x03baz",
					"-select-alpn", "foo",
					"-advertise-npn", "\x03foo\x03bar\x03baz",
				***REMOVED***,
				expectedNextProto:     "foo",
				expectedNextProtoType: alpn,
				resumeSession:         true,
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "ALPNServer-Preferred-Swapped-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						SwapNPNAndALPN: true,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-expect-advertised-alpn", "\x03foo\x03bar\x03baz",
					"-select-alpn", "foo",
					"-advertise-npn", "\x03foo\x03bar\x03baz",
				***REMOVED***,
				expectedNextProto:     "foo",
				expectedNextProtoType: alpn,
				resumeSession:         true,
			***REMOVED***)

			// Test that negotiating both NPN and ALPN is forbidden.
			testCases = append(testCases, testCase***REMOVED***
				name: "NegotiateALPNAndNPN-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						NegotiateALPNAndNPN: true,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-advertise-alpn", "\x03foo",
					"-select-next-proto", "foo",
				***REMOVED***,
				shouldFail:    true,
				expectedError: ":NEGOTIATED_BOTH_NPN_AND_ALPN:",
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				name: "NegotiateALPNAndNPN-Swapped-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						NegotiateALPNAndNPN: true,
						SwapNPNAndALPN:      true,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-advertise-alpn", "\x03foo",
					"-select-next-proto", "foo",
				***REMOVED***,
				shouldFail:    true,
				expectedError: ":NEGOTIATED_BOTH_NPN_AND_ALPN:",
			***REMOVED***)
		***REMOVED***

		// Test ticket behavior.

		// Resume with a corrupt ticket.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "CorruptTicket-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
						in[len(in)-1] ^= 1
						return in, nil
					***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			resumeSession:        true,
			expectResumeRejected: true,
		***REMOVED***)
		// Test the ticket callback, with and without renewal.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "TicketCallback-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
			***REMOVED***,
			resumeSession: true,
			flags:         []string***REMOVED***"-use-ticket-callback"***REMOVED***,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "TicketCallback-Renew-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					ExpectNewTicket: true,
				***REMOVED***,
			***REMOVED***,
			flags:         []string***REMOVED***"-use-ticket-callback", "-renew-ticket"***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		// Test that the ticket callback is only called once when everything before
		// it in the ClientHello is asynchronous. This corrupts the ticket so
		// certificate selection callbacks run.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "TicketCallback-SingleCall-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
						in[len(in)-1] ^= 1
						return in, nil
					***REMOVED***,
				***REMOVED***,
			***REMOVED***,
			resumeSession:        true,
			expectResumeRejected: true,
			flags: []string***REMOVED***
				"-use-ticket-callback",
				"-async",
			***REMOVED***,
		***REMOVED***)

		// Resume with various lengths of ticket session id.
		if ver.version < VersionTLS13 ***REMOVED***
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "TicketSessionIDLength-0-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					Bugs: ProtocolBugs***REMOVED***
						EmptyTicketSessionID: true,
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "TicketSessionIDLength-16-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					Bugs: ProtocolBugs***REMOVED***
						TicketSessionIDLength: 16,
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "TicketSessionIDLength-32-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					Bugs: ProtocolBugs***REMOVED***
						TicketSessionIDLength: 32,
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "TicketSessionIDLength-33-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					Bugs: ProtocolBugs***REMOVED***
						TicketSessionIDLength: 33,
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
				shouldFail:    true,
				// The maximum session ID length is 32.
				expectedError: ":DECODE_ERROR:",
			***REMOVED***)
		***REMOVED***

		// Basic DTLS-SRTP tests. Include fake profiles to ensure they
		// are ignored.
		if ver.hasDTLS ***REMOVED***
			testCases = append(testCases, testCase***REMOVED***
				protocol: dtls,
				name:     "SRTP-Client-" + ver.name,
				config: Config***REMOVED***
					MaxVersion:             ver.version,
					SRTPProtectionProfiles: []uint16***REMOVED***40, SRTP_AES128_CM_HMAC_SHA1_80, 42***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-srtp-profiles",
					"SRTP_AES128_CM_SHA1_80:SRTP_AES128_CM_SHA1_32",
				***REMOVED***,
				expectedSRTPProtectionProfile: SRTP_AES128_CM_HMAC_SHA1_80,
			***REMOVED***)
			testCases = append(testCases, testCase***REMOVED***
				protocol: dtls,
				testType: serverTest,
				name:     "SRTP-Server-" + ver.name,
				config: Config***REMOVED***
					MaxVersion:             ver.version,
					SRTPProtectionProfiles: []uint16***REMOVED***40, SRTP_AES128_CM_HMAC_SHA1_80, 42***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-srtp-profiles",
					"SRTP_AES128_CM_SHA1_80:SRTP_AES128_CM_SHA1_32",
				***REMOVED***,
				expectedSRTPProtectionProfile: SRTP_AES128_CM_HMAC_SHA1_80,
			***REMOVED***)
			// Test that the MKI is ignored.
			testCases = append(testCases, testCase***REMOVED***
				protocol: dtls,
				testType: serverTest,
				name:     "SRTP-Server-IgnoreMKI-" + ver.name,
				config: Config***REMOVED***
					MaxVersion:             ver.version,
					SRTPProtectionProfiles: []uint16***REMOVED***SRTP_AES128_CM_HMAC_SHA1_80***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						SRTPMasterKeyIdentifer: "bogus",
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-srtp-profiles",
					"SRTP_AES128_CM_SHA1_80:SRTP_AES128_CM_SHA1_32",
				***REMOVED***,
				expectedSRTPProtectionProfile: SRTP_AES128_CM_HMAC_SHA1_80,
			***REMOVED***)
			// Test that SRTP isn't negotiated on the server if there were
			// no matching profiles.
			testCases = append(testCases, testCase***REMOVED***
				protocol: dtls,
				testType: serverTest,
				name:     "SRTP-Server-NoMatch-" + ver.name,
				config: Config***REMOVED***
					MaxVersion:             ver.version,
					SRTPProtectionProfiles: []uint16***REMOVED***100, 101, 102***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-srtp-profiles",
					"SRTP_AES128_CM_SHA1_80:SRTP_AES128_CM_SHA1_32",
				***REMOVED***,
				expectedSRTPProtectionProfile: 0,
			***REMOVED***)
			// Test that the server returning an invalid SRTP profile is
			// flagged as an error by the client.
			testCases = append(testCases, testCase***REMOVED***
				protocol: dtls,
				name:     "SRTP-Client-NoMatch-" + ver.name,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					Bugs: ProtocolBugs***REMOVED***
						SendSRTPProtectionProfile: SRTP_AES128_CM_HMAC_SHA1_32,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-srtp-profiles",
					"SRTP_AES128_CM_SHA1_80",
				***REMOVED***,
				shouldFail:    true,
				expectedError: ":BAD_SRTP_PROTECTION_PROFILE_LIST:",
			***REMOVED***)
		***REMOVED***

		// Test SCT list.
		testCases = append(testCases, testCase***REMOVED***
			name:     "SignedCertificateTimestampList-Client-" + ver.name,
			testType: clientTest,
			config: Config***REMOVED***
				MaxVersion: ver.version,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-signed-cert-timestamps",
				"-expect-signed-cert-timestamps",
				base64.StdEncoding.EncodeToString(testSCTList),
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		var differentSCTList []byte
		differentSCTList = append(differentSCTList, testSCTList...)
		differentSCTList[len(differentSCTList)-1] ^= 1

		// The SCT extension did not specify that it must only be sent on resumption as it
		// should have, so test that we tolerate but ignore it.
		testCases = append(testCases, testCase***REMOVED***
			name: "SendSCTListOnResume-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendSCTListOnResume: differentSCTList,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-signed-cert-timestamps",
				"-expect-signed-cert-timestamps",
				base64.StdEncoding.EncodeToString(testSCTList),
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		testCases = append(testCases, testCase***REMOVED***
			name:     "SignedCertificateTimestampList-Server-" + ver.name,
			testType: serverTest,
			config: Config***REMOVED***
				MaxVersion: ver.version,
			***REMOVED***,
			flags: []string***REMOVED***
				"-signed-cert-timestamps",
				base64.StdEncoding.EncodeToString(testSCTList),
			***REMOVED***,
			expectedSCTList: testSCTList,
			resumeSession:   true,
		***REMOVED***)

		emptySCTListCert := *testCerts[0].cert
		emptySCTListCert.SignedCertificateTimestampList = []byte***REMOVED***0, 0***REMOVED***

		// Test empty SCT list.
		testCases = append(testCases, testCase***REMOVED***
			name:     "SignedCertificateTimestampListEmpty-Client-" + ver.name,
			testType: clientTest,
			config: Config***REMOVED***
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***emptySCTListCert***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-signed-cert-timestamps",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":ERROR_PARSING_EXTENSION:",
		***REMOVED***)

		emptySCTCert := *testCerts[0].cert
		emptySCTCert.SignedCertificateTimestampList = []byte***REMOVED***0, 6, 0, 2, 1, 2, 0, 0***REMOVED***

		// Test empty SCT in non-empty list.
		testCases = append(testCases, testCase***REMOVED***
			name:     "SignedCertificateTimestampListEmptySCT-Client-" + ver.name,
			testType: clientTest,
			config: Config***REMOVED***
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***emptySCTCert***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-signed-cert-timestamps",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":ERROR_PARSING_EXTENSION:",
		***REMOVED***)

		// Test that certificate-related extensions are not sent unsolicited.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "UnsolicitedCertificateExtensions-" + ver.name,
			config: Config***REMOVED***
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					NoOCSPStapling:                true,
					NoSignedCertificateTimestamps: true,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-ocsp-response",
				base64.StdEncoding.EncodeToString(testOCSPResponse),
				"-signed-cert-timestamps",
				base64.StdEncoding.EncodeToString(testSCTList),
			***REMOVED***,
		***REMOVED***)
	***REMOVED***

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "ClientHelloPadding",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				RequireClientHelloSize: 512,
			***REMOVED***,
		***REMOVED***,
		// This hostname just needs to be long enough to push the
		// ClientHello into F5's danger zone between 256 and 511 bytes
		// long.
		flags: []string***REMOVED***"-host-name", "01234567890123456789012345678901234567890123456789012345678901234567890123456789.com"***REMOVED***,
	***REMOVED***)

	// Extensions should not function in SSL 3.0.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SSLv3Extensions-NoALPN",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
			NextProtos: []string***REMOVED***"foo", "bar", "baz"***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-select-alpn", "foo",
		***REMOVED***,
		expectNoNextProto: true,
	***REMOVED***)

	// Test session tickets separately as they follow a different codepath.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SSLv3Extensions-NoTickets",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
			Bugs: ProtocolBugs***REMOVED***
				// Historically, session tickets in SSL 3.0
				// failed in different ways depending on whether
				// the client supported renegotiation_info.
				NoRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SSLv3Extensions-NoTickets2",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// But SSL 3.0 does send and process renegotiation_info.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SSLv3Extensions-RenegotiationInfo",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
			Bugs: ProtocolBugs***REMOVED***
				RequireRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-expect-secure-renegotiation"***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SSLv3Extensions-RenegotiationInfo-SCSV",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfo:      true,
				SendRenegotiationSCSV:    true,
				RequireRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-expect-secure-renegotiation"***REMOVED***,
	***REMOVED***)

	// Test that illegal extensions in TLS 1.3 are rejected by the client if
	// in ServerHello.
	testCases = append(testCases, testCase***REMOVED***
		name: "NPN-Forbidden-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			NextProtos: []string***REMOVED***"foo"***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NegotiateNPNAtAllVersions: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-select-next-proto", "foo"***REMOVED***,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "EMS-Forbidden-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				NegotiateEMSAtAllVersions: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "RenegotiationInfo-Forbidden-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				NegotiateRenegotiationInfoAtAllVersions: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Ticket-Forbidden-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				AdvertiseTicketExtension: true,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)

	// Test that illegal extensions in TLS 1.3 are declined by the server if
	// offered in ClientHello. The runner's server will fail if this occurs,
	// so we exercise the offering path. (EMS and Renegotiation Info are
	// implicit in every test.)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "NPN-Declined-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			NextProtos: []string***REMOVED***"bar"***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-advertise-npn", "\x03foo\x03bar\x03baz"***REMOVED***,
	***REMOVED***)

	// OpenSSL sends the status_request extension on resumption in TLS 1.2. Test that this is
	// tolerated.
	testCases = append(testCases, testCase***REMOVED***
		name: "SendOCSPResponseOnResume-TLS12",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendOCSPResponseOnResume: []byte("bogus"),
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-ocsp-stapling",
			"-expect-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "SendUnsolicitedOCSPOnCertificate-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendExtensionOnCertificate: testOCSPExtension,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "SendUnsolicitedSCTOnCertificate-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendExtensionOnCertificate: testSCTExtension,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	// Test that extensions on client certificates are never accepted.
	testCases = append(testCases, testCase***REMOVED***
		name:     "SendExtensionOnClientCertificate-TLS13",
		testType: serverTest,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendExtensionOnCertificate: testOCSPExtension,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-ocsp-stapling",
			"-require-any-client-certificate",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "SendUnknownExtensionOnCertificate-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendExtensionOnCertificate: []byte***REMOVED***0x00, 0x7f, 0, 0***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	var differentSCTList []byte
	differentSCTList = append(differentSCTList, testSCTList...)
	differentSCTList[len(differentSCTList)-1] ^= 1

	// Test that extensions on intermediates are allowed but ignored.
	testCases = append(testCases, testCase***REMOVED***
		name: "IgnoreExtensionsOnIntermediates-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***rsaChainCertificate***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				// Send different values on the intermediate. This tests
				// the intermediate's extensions do not override the
				// leaf's.
				SendOCSPOnIntermediates: []byte***REMOVED***1, 3, 3, 7***REMOVED***,
				SendSCTOnIntermediates:  differentSCTList,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-ocsp-stapling",
			"-expect-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
			"-enable-signed-cert-timestamps",
			"-expect-signed-cert-timestamps",
			base64.StdEncoding.EncodeToString(testSCTList),
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// Test that extensions are not sent on intermediates when configured
	// only for a leaf.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SendNoExtensionsOnIntermediate-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExpectNoExtensionsOnIntermediate: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaChainCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaChainKeyFile),
			"-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
			"-signed-cert-timestamps",
			base64.StdEncoding.EncodeToString(testSCTList),
		***REMOVED***,
	***REMOVED***)

	// Test that extensions are not sent on client certificates.
	testCases = append(testCases, testCase***REMOVED***
		name: "SendNoClientCertificateExtensions-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-ocsp-response",
			base64.StdEncoding.EncodeToString(testOCSPResponse),
			"-signed-cert-timestamps",
			base64.StdEncoding.EncodeToString(testSCTList),
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "SendDuplicateExtensionsOnCerts-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendDuplicateCertExtensions: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-ocsp-stapling",
			"-enable-signed-cert-timestamps",
		***REMOVED***,
		resumeSession: true,
		shouldFail:    true,
		expectedError: ":DUPLICATE_EXTENSION:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name:     "SignedCertificateTimestampListInvalid-Server",
		testType: serverTest,
		flags: []string***REMOVED***
			"-signed-cert-timestamps",
			base64.StdEncoding.EncodeToString([]byte***REMOVED***0, 0***REMOVED***),
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":INVALID_SCT_LIST:",
	***REMOVED***)
***REMOVED***

func addResumptionVersionTests() ***REMOVED***
	for _, sessionVers := range tlsVersions ***REMOVED***
		for _, resumeVers := range tlsVersions ***REMOVED***
			// SSL 3.0 does not have tickets and TLS 1.3 does not
			// have session IDs, so skip their cross-resumption
			// tests.
			if (sessionVers.version >= VersionTLS13 && resumeVers.version == VersionSSL30) ||
				(resumeVers.version >= VersionTLS13 && sessionVers.version == VersionSSL30) ***REMOVED***
				continue
			***REMOVED***

			protocols := []protocol***REMOVED***tls***REMOVED***
			if sessionVers.hasDTLS && resumeVers.hasDTLS ***REMOVED***
				protocols = append(protocols, dtls)
			***REMOVED***
			for _, protocol := range protocols ***REMOVED***
				suffix := "-" + sessionVers.name + "-" + resumeVers.name
				if protocol == dtls ***REMOVED***
					suffix += "-DTLS"
				***REMOVED***

				if sessionVers.version == resumeVers.version ***REMOVED***
					testCases = append(testCases, testCase***REMOVED***
						protocol:      protocol,
						name:          "Resume-Client" + suffix,
						resumeSession: true,
						config: Config***REMOVED***
							MaxVersion: sessionVers.version,
							Bugs: ProtocolBugs***REMOVED***
								ExpectNoTLS12Session: sessionVers.version >= VersionTLS13,
								ExpectNoTLS13PSK:     sessionVers.version < VersionTLS13,
							***REMOVED***,
						***REMOVED***,
						expectedVersion:       sessionVers.version,
						expectedResumeVersion: resumeVers.version,
					***REMOVED***)
				***REMOVED*** else ***REMOVED***
					error := ":OLD_SESSION_VERSION_NOT_RETURNED:"

					// Offering a TLS 1.3 session sends an empty session ID, so
					// there is no way to convince a non-lookahead client the
					// session was resumed. It will appear to the client that a
					// stray ChangeCipherSpec was sent.
					if resumeVers.version < VersionTLS13 && sessionVers.version >= VersionTLS13 ***REMOVED***
						error = ":UNEXPECTED_RECORD:"
					***REMOVED***

					testCases = append(testCases, testCase***REMOVED***
						protocol:      protocol,
						name:          "Resume-Client-Mismatch" + suffix,
						resumeSession: true,
						config: Config***REMOVED***
							MaxVersion: sessionVers.version,
						***REMOVED***,
						expectedVersion: sessionVers.version,
						resumeConfig: &Config***REMOVED***
							MaxVersion: resumeVers.version,
							Bugs: ProtocolBugs***REMOVED***
								AcceptAnySession: true,
							***REMOVED***,
						***REMOVED***,
						expectedResumeVersion: resumeVers.version,
						shouldFail:            true,
						expectedError:         error,
					***REMOVED***)
				***REMOVED***

				testCases = append(testCases, testCase***REMOVED***
					protocol:      protocol,
					name:          "Resume-Client-NoResume" + suffix,
					resumeSession: true,
					config: Config***REMOVED***
						MaxVersion: sessionVers.version,
					***REMOVED***,
					expectedVersion: sessionVers.version,
					resumeConfig: &Config***REMOVED***
						MaxVersion: resumeVers.version,
					***REMOVED***,
					newSessionsOnResume:   true,
					expectResumeRejected:  true,
					expectedResumeVersion: resumeVers.version,
				***REMOVED***)

				testCases = append(testCases, testCase***REMOVED***
					protocol:      protocol,
					testType:      serverTest,
					name:          "Resume-Server" + suffix,
					resumeSession: true,
					config: Config***REMOVED***
						MaxVersion: sessionVers.version,
					***REMOVED***,
					expectedVersion:      sessionVers.version,
					expectResumeRejected: sessionVers.version != resumeVers.version,
					resumeConfig: &Config***REMOVED***
						MaxVersion: resumeVers.version,
						Bugs: ProtocolBugs***REMOVED***
							SendBothTickets: true,
						***REMOVED***,
					***REMOVED***,
					expectedResumeVersion: resumeVers.version,
				***REMOVED***)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	// Make sure shim ticket mutations are functional.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "ShimTicketRewritable",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					in, err := SetShimTicketVersion(in, VersionTLS12)
					if err != nil ***REMOVED***
						return nil, err
					***REMOVED***
					return SetShimTicketCipherSuite(in, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
	***REMOVED***)

	// Resumptions are declined if the version does not match.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-DeclineCrossVersion",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				ExpectNewTicket: true,
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					return SetShimTicketVersion(in, VersionTLS13)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-DeclineCrossVersion-TLS13",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					return SetShimTicketVersion(in, VersionTLS12)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	// Resumptions are declined if the cipher is invalid or disabled.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-DeclineBadCipher",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				ExpectNewTicket: true,
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					return SetShimTicketCipherSuite(in, TLS_AES_128_GCM_SHA256)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-DeclineBadCipher-2",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				ExpectNewTicket: true,
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					return SetShimTicketCipherSuite(in, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cipher", "AES128",
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	// Sessions are not resumed if they do not use the preferred cipher.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-CipherNotPreferred",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				ExpectNewTicket: true,
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					return SetShimTicketCipherSuite(in, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		shouldFail:           false,
		expectResumeRejected: true,
	***REMOVED***)

	// TLS 1.3 allows sessions to be resumed at a different cipher if their
	// PRF hashes match, but BoringSSL will always decline such resumptions.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-CipherNotPreferred-TLS13",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_CHACHA20_POLY1305_SHA256, TLS_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					// If the client (runner) offers ChaCha20-Poly1305 first, the
					// server (shim) always prefers it. Switch it to AES-GCM.
					return SetShimTicketCipherSuite(in, TLS_AES_128_GCM_SHA256)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		shouldFail:           false,
		expectResumeRejected: true,
	***REMOVED***)

	// Sessions may not be resumed if they contain another version's cipher.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-DeclineBadCipher-TLS13",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				FilterTicket: func(in []byte) ([]byte, error) ***REMOVED***
					return SetShimTicketCipherSuite(in, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256)
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-ticket-key",
			base64.StdEncoding.EncodeToString(TestShimTicketKey),
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	// If the client does not offer the cipher from the session, decline to
	// resume. Clients are forbidden from doing this, but BoringSSL selects
	// the cipher first, so we only decline.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-UnofferedCipher",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendCipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	// In TLS 1.3, clients may advertise a cipher list which does not
	// include the selected cipher. Test that we tolerate this. Servers may
	// resume at another cipher if the PRF matches, but BoringSSL will
	// always decline.
	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-UnofferedCipher-TLS13",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_CHACHA20_POLY1305_SHA256***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_CHACHA20_POLY1305_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendCipherSuites: []uint16***REMOVED***TLS_AES_128_GCM_SHA256***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		expectResumeRejected: true,
	***REMOVED***)

	// Sessions may not be resumed at a different cipher.
	testCases = append(testCases, testCase***REMOVED***
		name:          "Resume-Client-CipherMismatch",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendCipherSuite: TLS_RSA_WITH_AES_128_CBC_SHA,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":OLD_SESSION_CIPHER_NOT_RETURNED:",
	***REMOVED***)

	// Session resumption in TLS 1.3 may change the cipher suite if the PRF
	// matches.
	testCases = append(testCases, testCase***REMOVED***
		name:          "Resume-Client-CipherMismatch-TLS13",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_CHACHA20_POLY1305_SHA256***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// Session resumption in TLS 1.3 is forbidden if the PRF does not match.
	testCases = append(testCases, testCase***REMOVED***
		name:          "Resume-Client-PRFMismatch-TLS13",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:   VersionTLS13,
			CipherSuites: []uint16***REMOVED***TLS_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendCipherSuite: TLS_AES_256_GCM_SHA384,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":OLD_SESSION_PRF_HASH_MISMATCH:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-BinderWrongLength",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendShortPSKBinder: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: error decrypting message",
		expectedError:      ":DIGEST_CHECK_FAILED:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-NoPSKBinder",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendNoPSKBinder: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: error decoding message",
		expectedError:      ":DECODE_ERROR:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-ExtraPSKBinder",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendExtraPSKBinder: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: illegal parameter",
		expectedError:      ":PSK_IDENTITY_BINDER_COUNT_MISMATCH:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-ExtraIdentityNoBinder",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExtraPSKIdentity: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: illegal parameter",
		expectedError:      ":PSK_IDENTITY_BINDER_COUNT_MISMATCH:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-InvalidPSKBinder",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendInvalidPSKBinder: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: error decrypting message",
		expectedError:      ":DIGEST_CHECK_FAILED:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType:      serverTest,
		name:          "Resume-Server-PSKBinderFirstExtension",
		resumeSession: true,
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				PSKBinderFirst: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: illegal parameter",
		expectedError:      ":PRE_SHARED_KEY_MUST_BE_LAST:",
	***REMOVED***)
***REMOVED***

func addRenegotiationTests() ***REMOVED***
	// Servers cannot renegotiate.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Renegotiate-Server-Forbidden",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate:        1,
		shouldFail:         true,
		expectedError:      ":NO_RENEGOTIATION:",
		expectedLocalError: "remote error: no renegotiation",
	***REMOVED***)
	// The server shouldn't echo the renegotiation extension unless
	// requested by the client.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Renegotiate-Server-NoExt",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfo:      true,
				RequireRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "renegotiation extension missing",
	***REMOVED***)
	// The renegotiation SCSV should be sufficient for the server to echo
	// the extension.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Renegotiate-Server-NoExt-SCSV",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfo:      true,
				SendRenegotiationSCSV:    true,
				RequireRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				FailIfResumeOnRenego: true,
			***REMOVED***,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
			"-expect-secure-renegotiation",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-EmptyExt",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				EmptyRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-renegotiate-freely"***REMOVED***,
		shouldFail:    true,
		expectedError: ":RENEGOTIATION_MISMATCH:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-BadExt",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				BadRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-renegotiate-freely"***REMOVED***,
		shouldFail:    true,
		expectedError: ":RENEGOTIATION_MISMATCH:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-Downgrade",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfoAfterInitial: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-renegotiate-freely"***REMOVED***,
		shouldFail:    true,
		expectedError: ":RENEGOTIATION_MISMATCH:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-Upgrade",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfoInInitial: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-renegotiate-freely"***REMOVED***,
		shouldFail:    true,
		expectedError: ":RENEGOTIATION_MISMATCH:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-NoExt-Allowed",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
			"-expect-no-secure-renegotiation",
		***REMOVED***,
	***REMOVED***)

	// Test that the server may switch ciphers on renegotiation without
	// problems.
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-SwitchCiphers",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
		***REMOVED***,
		renegotiateCiphers: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-Client-SwitchCiphers2",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
		***REMOVED***,
		renegotiateCiphers: []uint16***REMOVED***TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)

	// Test that the server may not switch versions on renegotiation.
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-SwitchVersion",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			// Pick a cipher which exists at both versions.
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_CBC_SHA***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NegotiateVersionOnRenego: VersionTLS11,
				// Avoid failing early at the record layer.
				SendRecordVersion: VersionTLS12,
			***REMOVED***,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SSL_VERSION:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-SameClientVersion",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion: VersionTLS10,
			Bugs: ProtocolBugs***REMOVED***
				RequireSameRenegoClientVersion: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name:        "Renegotiate-FalseStart",
		renegotiate: 1,
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			NextProtos:   []string***REMOVED***"foo"***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-false-start",
			"-select-next-proto", "foo",
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
		shimWritesFirst: true,
	***REMOVED***)

	// Client-side renegotiation controls.
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Forbidden-1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate:        1,
		shouldFail:         true,
		expectedError:      ":NO_RENEGOTIATION:",
		expectedLocalError: "remote error: no renegotiation",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Once-1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-once",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Freely-1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Once-2",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate:        2,
		flags:              []string***REMOVED***"-renegotiate-once"***REMOVED***,
		shouldFail:         true,
		expectedError:      ":NO_RENEGOTIATION:",
		expectedLocalError: "remote error: no renegotiation",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Freely-2",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate: 2,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "2",
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-NoIgnore",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRequestBeforeEveryAppDataRecord: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_RENEGOTIATION:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Ignore",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRequestBeforeEveryAppDataRecord: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-renegotiate-ignore",
			"-expect-total-renegotiations", "0",
		***REMOVED***,
	***REMOVED***)

	// Renegotiation is not allowed at SSL 3.0.
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-SSL3",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":NO_RENEGOTIATION:",
		expectedLocalError: "remote error: no renegotiation",
	***REMOVED***)

	// Renegotiation is not allowed when there is an unfinished write.
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-UnfinishedWrite",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-async",
			"-renegotiate-freely",
			"-read-with-unfinished-write",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_RENEGOTIATION:",
		// We do not successfully send the no_renegotiation alert in
		// this case. https://crbug.com/boringssl/130
	***REMOVED***)

	// We reject stray HelloRequests during the handshake in TLS 1.2.
	testCases = append(testCases, testCase***REMOVED***
		name: "StrayHelloRequest",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRequestBeforeEveryHandshakeMessage: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "StrayHelloRequest-Packed",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				PackHandshakeFlight:                         true,
				SendHelloRequestBeforeEveryHandshakeMessage: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)

	// Test renegotiation works if HelloRequest and server Finished come in
	// the same record.
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-Packed",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				PackHandshakeFlight:          true,
				PackHelloRequestWithFinished: true,
			***REMOVED***,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)

	// Renegotiation is forbidden in TLS 1.3.
	testCases = append(testCases, testCase***REMOVED***
		name: "Renegotiate-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRequestBeforeEveryAppDataRecord: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-renegotiate-freely",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)

	// Stray HelloRequests during the handshake are forbidden in TLS 1.3.
	testCases = append(testCases, testCase***REMOVED***
		name: "StrayHelloRequest-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRequestBeforeEveryHandshakeMessage: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)

	// The renegotiation_info extension is not sent in TLS 1.3, but TLS 1.3
	// always reads as supporting it, regardless of whether it was
	// negotiated.
	testCases = append(testCases, testCase***REMOVED***
		name: "AlwaysReportRenegotiationInfo-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				NoRenegotiationInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-expect-secure-renegotiation",
		***REMOVED***,
	***REMOVED***)
***REMOVED***

func addDTLSReplayTests() ***REMOVED***
	// Test that sequence number replays are detected.
	testCases = append(testCases, testCase***REMOVED***
		protocol:     dtls,
		name:         "DTLS-Replay",
		messageCount: 200,
		replayWrites: true,
	***REMOVED***)

	// Test the incoming sequence number skipping by values larger
	// than the retransmit window.
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "DTLS-Replay-LargeGaps",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SequenceNumberMapping: func(in uint64) uint64 ***REMOVED***
					return in * 127
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		messageCount: 200,
		replayWrites: true,
	***REMOVED***)

	// Test the incoming sequence number changing non-monotonically.
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "DTLS-Replay-NonMonotonic",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SequenceNumberMapping: func(in uint64) uint64 ***REMOVED***
					return in ^ 31
				***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		messageCount: 200,
		replayWrites: true,
	***REMOVED***)
***REMOVED***

var testSignatureAlgorithms = []struct ***REMOVED***
	name string
	id   signatureAlgorithm
	cert testCert
***REMOVED******REMOVED***
	***REMOVED***"RSA-PKCS1-SHA1", signatureRSAPKCS1WithSHA1, testCertRSA***REMOVED***,
	***REMOVED***"RSA-PKCS1-SHA256", signatureRSAPKCS1WithSHA256, testCertRSA***REMOVED***,
	***REMOVED***"RSA-PKCS1-SHA384", signatureRSAPKCS1WithSHA384, testCertRSA***REMOVED***,
	***REMOVED***"RSA-PKCS1-SHA512", signatureRSAPKCS1WithSHA512, testCertRSA***REMOVED***,
	***REMOVED***"ECDSA-SHA1", signatureECDSAWithSHA1, testCertECDSAP256***REMOVED***,
	***REMOVED***"ECDSA-P256-SHA256", signatureECDSAWithP256AndSHA256, testCertECDSAP256***REMOVED***,
	***REMOVED***"ECDSA-P384-SHA384", signatureECDSAWithP384AndSHA384, testCertECDSAP384***REMOVED***,
	***REMOVED***"ECDSA-P521-SHA512", signatureECDSAWithP521AndSHA512, testCertECDSAP521***REMOVED***,
	***REMOVED***"RSA-PSS-SHA256", signatureRSAPSSWithSHA256, testCertRSA***REMOVED***,
	***REMOVED***"RSA-PSS-SHA384", signatureRSAPSSWithSHA384, testCertRSA***REMOVED***,
	***REMOVED***"RSA-PSS-SHA512", signatureRSAPSSWithSHA512, testCertRSA***REMOVED***,
	// Tests for key types prior to TLS 1.2.
	***REMOVED***"RSA", 0, testCertRSA***REMOVED***,
	***REMOVED***"ECDSA", 0, testCertECDSAP256***REMOVED***,
***REMOVED***

const fakeSigAlg1 signatureAlgorithm = 0x2a01
const fakeSigAlg2 signatureAlgorithm = 0xff01

func addSignatureAlgorithmTests() ***REMOVED***
	// Not all ciphers involve a signature. Advertise a list which gives all
	// versions a signing cipher.
	signingCiphers := []uint16***REMOVED***
		TLS_AES_128_GCM_SHA256,
		TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
		TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
		TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,
		TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,
		TLS_DHE_RSA_WITH_AES_128_CBC_SHA,
	***REMOVED***

	var allAlgorithms []signatureAlgorithm
	for _, alg := range testSignatureAlgorithms ***REMOVED***
		if alg.id != 0 ***REMOVED***
			allAlgorithms = append(allAlgorithms, alg.id)
		***REMOVED***
	***REMOVED***

	// Make sure each signature algorithm works. Include some fake values in
	// the list and ensure they're ignored.
	for _, alg := range testSignatureAlgorithms ***REMOVED***
		for _, ver := range tlsVersions ***REMOVED***
			if (ver.version < VersionTLS12) != (alg.id == 0) ***REMOVED***
				continue
			***REMOVED***

			// TODO(davidben): Support ECDSA in SSL 3.0 in Go for testing
			// or remove it in C.
			if ver.version == VersionSSL30 && alg.cert != testCertRSA ***REMOVED***
				continue
			***REMOVED***

			var shouldSignFail, shouldVerifyFail bool
			// ecdsa_sha1 does not exist in TLS 1.3.
			if ver.version >= VersionTLS13 && alg.id == signatureECDSAWithSHA1 ***REMOVED***
				shouldSignFail = true
				shouldVerifyFail = true
			***REMOVED***
			// RSA-PKCS1 does not exist in TLS 1.3.
			if ver.version == VersionTLS13 && hasComponent(alg.name, "PKCS1") ***REMOVED***
				shouldSignFail = true
				shouldVerifyFail = true
			***REMOVED***

			// BoringSSL will sign SHA-1 and SHA-512 with ECDSA but not accept them.
			if alg.id == signatureECDSAWithSHA1 || alg.id == signatureECDSAWithP521AndSHA512 ***REMOVED***
				shouldVerifyFail = true
			***REMOVED***

			var signError, verifyError string
			if shouldSignFail ***REMOVED***
				signError = ":NO_COMMON_SIGNATURE_ALGORITHMS:"
			***REMOVED***
			if shouldVerifyFail ***REMOVED***
				verifyError = ":WRONG_SIGNATURE_TYPE:"
			***REMOVED***

			suffix := "-" + alg.name + "-" + ver.name

			testCases = append(testCases, testCase***REMOVED***
				name: "ClientAuth-Sign" + suffix,
				config: Config***REMOVED***
					MaxVersion: ver.version,
					ClientAuth: RequireAnyClientCert,
					VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
						fakeSigAlg1,
						alg.id,
						fakeSigAlg2,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-cert-file", path.Join(*resourceDir, getShimCertificate(alg.cert)),
					"-key-file", path.Join(*resourceDir, getShimKey(alg.cert)),
					"-enable-all-curves",
				***REMOVED***,
				shouldFail:                     shouldSignFail,
				expectedError:                  signError,
				expectedPeerSignatureAlgorithm: alg.id,
			***REMOVED***)

			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "ClientAuth-Verify" + suffix,
				config: Config***REMOVED***
					MaxVersion:   ver.version,
					Certificates: []Certificate***REMOVED***getRunnerCertificate(alg.cert)***REMOVED***,
					SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
						alg.id,
					***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						SkipECDSACurveCheck:          shouldVerifyFail,
						IgnoreSignatureVersionChecks: shouldVerifyFail,
						// Some signature algorithms may not be advertised.
						IgnorePeerSignatureAlgorithmPreferences: shouldVerifyFail,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-require-any-client-certificate",
					"-expect-peer-signature-algorithm", strconv.Itoa(int(alg.id)),
					"-enable-all-curves",
				***REMOVED***,
				// Resume the session to assert the peer signature
				// algorithm is reported on both handshakes.
				resumeSession: !shouldVerifyFail,
				shouldFail:    shouldVerifyFail,
				expectedError: verifyError,
			***REMOVED***)

			testCases = append(testCases, testCase***REMOVED***
				testType: serverTest,
				name:     "ServerAuth-Sign" + suffix,
				config: Config***REMOVED***
					MaxVersion:   ver.version,
					CipherSuites: signingCiphers,
					VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
						fakeSigAlg1,
						alg.id,
						fakeSigAlg2,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-cert-file", path.Join(*resourceDir, getShimCertificate(alg.cert)),
					"-key-file", path.Join(*resourceDir, getShimKey(alg.cert)),
					"-enable-all-curves",
				***REMOVED***,
				shouldFail:                     shouldSignFail,
				expectedError:                  signError,
				expectedPeerSignatureAlgorithm: alg.id,
			***REMOVED***)

			testCases = append(testCases, testCase***REMOVED***
				name: "ServerAuth-Verify" + suffix,
				config: Config***REMOVED***
					MaxVersion:   ver.version,
					Certificates: []Certificate***REMOVED***getRunnerCertificate(alg.cert)***REMOVED***,
					CipherSuites: signingCiphers,
					SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
						alg.id,
					***REMOVED***,
					Bugs: ProtocolBugs***REMOVED***
						SkipECDSACurveCheck:          shouldVerifyFail,
						IgnoreSignatureVersionChecks: shouldVerifyFail,
						// Some signature algorithms may not be advertised.
						IgnorePeerSignatureAlgorithmPreferences: shouldVerifyFail,
					***REMOVED***,
				***REMOVED***,
				flags: []string***REMOVED***
					"-expect-peer-signature-algorithm", strconv.Itoa(int(alg.id)),
					"-enable-all-curves",
				***REMOVED***,
				// Resume the session to assert the peer signature
				// algorithm is reported on both handshakes.
				resumeSession: !shouldVerifyFail,
				shouldFail:    shouldVerifyFail,
				expectedError: verifyError,
			***REMOVED***)

			if !shouldVerifyFail ***REMOVED***
				testCases = append(testCases, testCase***REMOVED***
					testType: serverTest,
					name:     "ClientAuth-InvalidSignature" + suffix,
					config: Config***REMOVED***
						MaxVersion:   ver.version,
						Certificates: []Certificate***REMOVED***getRunnerCertificate(alg.cert)***REMOVED***,
						SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
							alg.id,
						***REMOVED***,
						Bugs: ProtocolBugs***REMOVED***
							InvalidSignature: true,
						***REMOVED***,
					***REMOVED***,
					flags: []string***REMOVED***
						"-require-any-client-certificate",
						"-enable-all-curves",
					***REMOVED***,
					shouldFail:    true,
					expectedError: ":BAD_SIGNATURE:",
				***REMOVED***)

				testCases = append(testCases, testCase***REMOVED***
					name: "ServerAuth-InvalidSignature" + suffix,
					config: Config***REMOVED***
						MaxVersion:   ver.version,
						Certificates: []Certificate***REMOVED***getRunnerCertificate(alg.cert)***REMOVED***,
						CipherSuites: signingCiphers,
						SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
							alg.id,
						***REMOVED***,
						Bugs: ProtocolBugs***REMOVED***
							InvalidSignature: true,
						***REMOVED***,
					***REMOVED***,
					flags:         []string***REMOVED***"-enable-all-curves"***REMOVED***,
					shouldFail:    true,
					expectedError: ":BAD_SIGNATURE:",
				***REMOVED***)
			***REMOVED***

			if ver.version >= VersionTLS12 && !shouldSignFail ***REMOVED***
				testCases = append(testCases, testCase***REMOVED***
					name: "ClientAuth-Sign-Negotiate" + suffix,
					config: Config***REMOVED***
						MaxVersion:                ver.version,
						ClientAuth:                RequireAnyClientCert,
						VerifySignatureAlgorithms: allAlgorithms,
					***REMOVED***,
					flags: []string***REMOVED***
						"-cert-file", path.Join(*resourceDir, getShimCertificate(alg.cert)),
						"-key-file", path.Join(*resourceDir, getShimKey(alg.cert)),
						"-enable-all-curves",
						"-signing-prefs", strconv.Itoa(int(alg.id)),
					***REMOVED***,
					expectedPeerSignatureAlgorithm: alg.id,
				***REMOVED***)

				testCases = append(testCases, testCase***REMOVED***
					testType: serverTest,
					name:     "ServerAuth-Sign-Negotiate" + suffix,
					config: Config***REMOVED***
						MaxVersion:                ver.version,
						CipherSuites:              signingCiphers,
						VerifySignatureAlgorithms: allAlgorithms,
					***REMOVED***,
					flags: []string***REMOVED***
						"-cert-file", path.Join(*resourceDir, getShimCertificate(alg.cert)),
						"-key-file", path.Join(*resourceDir, getShimKey(alg.cert)),
						"-enable-all-curves",
						"-signing-prefs", strconv.Itoa(int(alg.id)),
					***REMOVED***,
					expectedPeerSignatureAlgorithm: alg.id,
				***REMOVED***)
			***REMOVED***
		***REMOVED***
	***REMOVED***

	// Test that algorithm selection takes the key type into account.
	testCases = append(testCases, testCase***REMOVED***
		name: "ClientAuth-SignatureType",
		config: Config***REMOVED***
			ClientAuth: RequireAnyClientCert,
			MaxVersion: VersionTLS12,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP521AndSHA512,
				signatureRSAPKCS1WithSHA384,
				signatureECDSAWithSHA1,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPKCS1WithSHA384,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ClientAuth-SignatureType-TLS13",
		config: Config***REMOVED***
			ClientAuth: RequireAnyClientCert,
			MaxVersion: VersionTLS13,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP521AndSHA512,
				signatureRSAPKCS1WithSHA384,
				signatureRSAPSSWithSHA384,
				signatureECDSAWithSHA1,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPSSWithSHA384,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ServerAuth-SignatureType",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP521AndSHA512,
				signatureRSAPKCS1WithSHA384,
				signatureECDSAWithSHA1,
			***REMOVED***,
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPKCS1WithSHA384,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ServerAuth-SignatureType-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP521AndSHA512,
				signatureRSAPKCS1WithSHA384,
				signatureRSAPSSWithSHA384,
				signatureECDSAWithSHA1,
			***REMOVED***,
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPSSWithSHA384,
	***REMOVED***)

	// Test that signature verification takes the key type into account.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Verify-ClientAuth-SignatureType",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA256,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSignatureAlgorithm: signatureECDSAWithP256AndSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-require-any-client-certificate",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "Verify-ClientAuth-SignatureType-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPSSWithSHA256,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSignatureAlgorithm: signatureECDSAWithP256AndSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-require-any-client-certificate",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "Verify-ServerAuth-SignatureType",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA256,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSignatureAlgorithm: signatureECDSAWithP256AndSHA256,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "Verify-ServerAuth-SignatureType-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPSSWithSHA256,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSignatureAlgorithm: signatureECDSAWithP256AndSHA256,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	// Test that, if the list is missing, the peer falls back to SHA-1 in
	// TLS 1.2, but not TLS 1.3.
	testCases = append(testCases, testCase***REMOVED***
		name: "ClientAuth-SHA1-Fallback-RSA",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSignatureAlgorithms: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ServerAuth-SHA1-Fallback-RSA",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSignatureAlgorithms: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ClientAuth-SHA1-Fallback-ECDSA",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithSHA1,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSignatureAlgorithms: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
			"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ServerAuth-SHA1-Fallback-ECDSA",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithSHA1,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSignatureAlgorithms: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
			"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ClientAuth-NoFallback-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSignatureAlgorithms: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
		shouldFail: true,
		// An empty CertificateRequest signature algorithm list is a
		// syntax error in TLS 1.3.
		expectedError:      ":DECODE_ERROR:",
		expectedLocalError: "remote error: error decoding message",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ServerAuth-NoFallback-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSignatureAlgorithms: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_COMMON_SIGNATURE_ALGORITHMS:",
	***REMOVED***)

	// Test that hash preferences are enforced. BoringSSL does not implement
	// MD5 signatures.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ClientAuth-Enforced",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithMD5,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerSignatureAlgorithmPreferences: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ServerAuth-Enforced",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithMD5,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerSignatureAlgorithmPreferences: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ClientAuth-Enforced-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithMD5,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerSignatureAlgorithmPreferences: true,
				IgnoreSignatureVersionChecks:            true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "ServerAuth-Enforced-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithMD5,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerSignatureAlgorithmPreferences: true,
				IgnoreSignatureVersionChecks:            true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	// Test that the agreed upon digest respects the client preferences and
	// the server digests.
	testCases = append(testCases, testCase***REMOVED***
		name: "NoCommonAlgorithms-Digests",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA512,
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-digest-prefs", "SHA256",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_COMMON_SIGNATURE_ALGORITHMS:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "NoCommonAlgorithms",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA512,
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-signing-prefs", strconv.Itoa(int(signatureRSAPKCS1WithSHA256)),
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_COMMON_SIGNATURE_ALGORITHMS:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "NoCommonAlgorithms-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPSSWithSHA512,
				signatureRSAPSSWithSHA384,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-signing-prefs", strconv.Itoa(int(signatureRSAPSSWithSHA256)),
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_COMMON_SIGNATURE_ALGORITHMS:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Agree-Digest-SHA256",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA1,
				signatureRSAPKCS1WithSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-digest-prefs", "SHA256,SHA1",
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPKCS1WithSHA256,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Agree-Digest-SHA1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA1,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-digest-prefs", "SHA512,SHA256,SHA1",
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPKCS1WithSHA1,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "Agree-Digest-Default",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			ClientAuth: RequireAnyClientCert,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA256,
				signatureECDSAWithP256AndSHA256,
				signatureRSAPKCS1WithSHA1,
				signatureECDSAWithSHA1,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPKCS1WithSHA256,
	***REMOVED***)

	// Test that the signing preference list may include extra algorithms
	// without negotiation problems.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "FilterExtraAlgorithms",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPKCS1WithSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
			"-signing-prefs", strconv.Itoa(int(fakeSigAlg1)),
			"-signing-prefs", strconv.Itoa(int(signatureECDSAWithP256AndSHA256)),
			"-signing-prefs", strconv.Itoa(int(signatureRSAPKCS1WithSHA256)),
			"-signing-prefs", strconv.Itoa(int(fakeSigAlg2)),
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureRSAPKCS1WithSHA256,
	***REMOVED***)

	// In TLS 1.2 and below, ECDSA uses the curve list rather than the
	// signature algorithms.
	testCases = append(testCases, testCase***REMOVED***
		name: "CheckLeafCurve",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-p384-only"***REMOVED***,
		shouldFail:    true,
		expectedError: ":BAD_ECC_CERT:",
	***REMOVED***)

	// In TLS 1.3, ECDSA does not use the ECDHE curve list.
	testCases = append(testCases, testCase***REMOVED***
		name: "CheckLeafCurve-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-p384-only"***REMOVED***,
	***REMOVED***)

	// In TLS 1.2, the ECDSA curve is not in the signature algorithm.
	testCases = append(testCases, testCase***REMOVED***
		name: "ECDSACurveMismatch-Verify-TLS12",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP384AndSHA384,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// In TLS 1.3, the ECDSA curve comes from the signature algorithm.
	testCases = append(testCases, testCase***REMOVED***
		name: "ECDSACurveMismatch-Verify-TLS13",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS13,
			Certificates: []Certificate***REMOVED***ecdsaP256Certificate***REMOVED***,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP384AndSHA384,
			***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SkipECDSACurveCheck: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_SIGNATURE_TYPE:",
	***REMOVED***)

	// Signature algorithm selection in TLS 1.3 should take the curve into
	// account.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ECDSACurveMismatch-Sign-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureECDSAWithP384AndSHA384,
				signatureECDSAWithP256AndSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, ecdsaP256CertificateFile),
			"-key-file", path.Join(*resourceDir, ecdsaP256KeyFile),
		***REMOVED***,
		expectedPeerSignatureAlgorithm: signatureECDSAWithP256AndSHA256,
	***REMOVED***)

	// RSASSA-PSS with SHA-512 is too large for 1024-bit RSA. Test that the
	// server does not attempt to sign in that case.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "RSA-PSS-Large",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPSSWithSHA512,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsa1024CertificateFile),
			"-key-file", path.Join(*resourceDir, rsa1024KeyFile),
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_COMMON_SIGNATURE_ALGORITHMS:",
	***REMOVED***)

	// Test that RSA-PSS is enabled by default for TLS 1.2.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "RSA-PSS-Default-Verify",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			SignSignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPSSWithSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-max-version", strconv.Itoa(VersionTLS12)***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "RSA-PSS-Default-Sign",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			VerifySignatureAlgorithms: []signatureAlgorithm***REMOVED***
				signatureRSAPSSWithSHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-max-version", strconv.Itoa(VersionTLS12)***REMOVED***,
	***REMOVED***)
***REMOVED***

// timeouts is the retransmit schedule for BoringSSL. It doubles and
// caps at 60 seconds. On the 13th timeout, it gives up.
var timeouts = []time.Duration***REMOVED***
	1 * time.Second,
	2 * time.Second,
	4 * time.Second,
	8 * time.Second,
	16 * time.Second,
	32 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
***REMOVED***

// shortTimeouts is an alternate set of timeouts which would occur if the
// initial timeout duration was set to 250ms.
var shortTimeouts = []time.Duration***REMOVED***
	250 * time.Millisecond,
	500 * time.Millisecond,
	1 * time.Second,
	2 * time.Second,
	4 * time.Second,
	8 * time.Second,
	16 * time.Second,
	32 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
	60 * time.Second,
***REMOVED***

func addDTLSRetransmitTests() ***REMOVED***
	// These tests work by coordinating some behavior on both the shim and
	// the runner.
	//
	// TimeoutSchedule configures the runner to send a series of timeout
	// opcodes to the shim (see packetAdaptor) immediately before reading
	// each peer handshake flight N. The timeout opcode both simulates a
	// timeout in the shim and acts as a synchronization point to help the
	// runner bracket each handshake flight.
	//
	// We assume the shim does not read from the channel eagerly. It must
	// first wait until it has sent flight N and is ready to receive
	// handshake flight N+1. At this point, it will process the timeout
	// opcode. It must then immediately respond with a timeout ACK and act
	// as if the shim was idle for the specified amount of time.
	//
	// The runner then drops all packets received before the ACK and
	// continues waiting for flight N. This ordering results in one attempt
	// at sending flight N to be dropped. For the test to complete, the
	// shim must send flight N again, testing that the shim implements DTLS
	// retransmit on a timeout.

	// TODO(davidben): Add DTLS 1.3 versions of these tests. There will
	// likely be more epochs to cross and the final message's retransmit may
	// be more complex.

	for _, async := range []bool***REMOVED***true, false***REMOVED*** ***REMOVED***
		var tests []testCase

		// Test that this is indeed the timeout schedule. Stress all
		// four patterns of handshake.
		for i := 1; i < len(timeouts); i++ ***REMOVED***
			number := strconv.Itoa(i)
			tests = append(tests, testCase***REMOVED***
				protocol: dtls,
				name:     "DTLS-Retransmit-Client-" + number,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
					Bugs: ProtocolBugs***REMOVED***
						TimeoutSchedule: timeouts[:i],
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
			tests = append(tests, testCase***REMOVED***
				protocol: dtls,
				testType: serverTest,
				name:     "DTLS-Retransmit-Server-" + number,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
					Bugs: ProtocolBugs***REMOVED***
						TimeoutSchedule: timeouts[:i],
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
		***REMOVED***

		// Test that exceeding the timeout schedule hits a read
		// timeout.
		tests = append(tests, testCase***REMOVED***
			protocol: dtls,
			name:     "DTLS-Retransmit-Timeout",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					TimeoutSchedule: timeouts,
				***REMOVED***,
			***REMOVED***,
			resumeSession: true,
			shouldFail:    true,
			expectedError: ":READ_TIMEOUT_EXPIRED:",
		***REMOVED***)

		if async ***REMOVED***
			// Test that timeout handling has a fudge factor, due to API
			// problems.
			tests = append(tests, testCase***REMOVED***
				protocol: dtls,
				name:     "DTLS-Retransmit-Fudge",
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
					Bugs: ProtocolBugs***REMOVED***
						TimeoutSchedule: []time.Duration***REMOVED***
							timeouts[0] - 10*time.Millisecond,
						***REMOVED***,
					***REMOVED***,
				***REMOVED***,
				resumeSession: true,
			***REMOVED***)
		***REMOVED***

		// Test that the final Finished retransmitting isn't
		// duplicated if the peer badly fragments everything.
		tests = append(tests, testCase***REMOVED***
			testType: serverTest,
			protocol: dtls,
			name:     "DTLS-Retransmit-Fragmented",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					TimeoutSchedule:          []time.Duration***REMOVED***timeouts[0]***REMOVED***,
					MaxHandshakeRecordLength: 2,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		// Test the timeout schedule when a shorter initial timeout duration is set.
		tests = append(tests, testCase***REMOVED***
			protocol: dtls,
			name:     "DTLS-Retransmit-Short-Client",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					TimeoutSchedule: shortTimeouts[:len(shortTimeouts)-1],
				***REMOVED***,
			***REMOVED***,
			resumeSession: true,
			flags:         []string***REMOVED***"-initial-timeout-duration-ms", "250"***REMOVED***,
		***REMOVED***)
		tests = append(tests, testCase***REMOVED***
			protocol: dtls,
			testType: serverTest,
			name:     "DTLS-Retransmit-Short-Server",
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					TimeoutSchedule: shortTimeouts[:len(shortTimeouts)-1],
				***REMOVED***,
			***REMOVED***,
			resumeSession: true,
			flags:         []string***REMOVED***"-initial-timeout-duration-ms", "250"***REMOVED***,
		***REMOVED***)

		for _, test := range tests ***REMOVED***
			if async ***REMOVED***
				test.name += "-Async"
				test.flags = append(test.flags, "-async")
			***REMOVED***

			testCases = append(testCases, test)
		***REMOVED***
	***REMOVED***
***REMOVED***

func addExportKeyingMaterialTests() ***REMOVED***
	for _, vers := range tlsVersions ***REMOVED***
		if vers.version == VersionSSL30 ***REMOVED***
			continue
		***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			name: "ExportKeyingMaterial-" + vers.name,
			config: Config***REMOVED***
				MaxVersion: vers.version,
			***REMOVED***,
			exportKeyingMaterial: 1024,
			exportLabel:          "label",
			exportContext:        "context",
			useExportContext:     true,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			name: "ExportKeyingMaterial-NoContext-" + vers.name,
			config: Config***REMOVED***
				MaxVersion: vers.version,
			***REMOVED***,
			exportKeyingMaterial: 1024,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			name: "ExportKeyingMaterial-EmptyContext-" + vers.name,
			config: Config***REMOVED***
				MaxVersion: vers.version,
			***REMOVED***,
			exportKeyingMaterial: 1024,
			useExportContext:     true,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			name: "ExportKeyingMaterial-Small-" + vers.name,
			config: Config***REMOVED***
				MaxVersion: vers.version,
			***REMOVED***,
			exportKeyingMaterial: 1,
			exportLabel:          "label",
			exportContext:        "context",
			useExportContext:     true,
		***REMOVED***)
	***REMOVED***

	testCases = append(testCases, testCase***REMOVED***
		name: "ExportKeyingMaterial-SSL3",
		config: Config***REMOVED***
			MaxVersion: VersionSSL30,
		***REMOVED***,
		exportKeyingMaterial: 1024,
		exportLabel:          "label",
		exportContext:        "context",
		useExportContext:     true,
		shouldFail:           true,
		expectedError:        "failed to export keying material",
	***REMOVED***)

	// Exporters work during a False Start.
	testCases = append(testCases, testCase***REMOVED***
		name: "ExportKeyingMaterial-FalseStart",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			NextProtos:   []string***REMOVED***"foo"***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				ExpectFalseStart: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-false-start",
			"-advertise-alpn", "\x03foo",
		***REMOVED***,
		shimWritesFirst:      true,
		exportKeyingMaterial: 1024,
		exportLabel:          "label",
		exportContext:        "context",
		useExportContext:     true,
	***REMOVED***)

	// Exporters do not work in the middle of a renegotiation. Test this by
	// triggering the exporter after every SSL_read call and configuring the
	// shim to run asynchronously.
	testCases = append(testCases, testCase***REMOVED***
		name: "ExportKeyingMaterial-Renegotiate",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-async",
			"-use-exporter-between-reads",
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
		shouldFail:    true,
		expectedError: "failed to export keying material",
	***REMOVED***)
***REMOVED***

func addTLSUniqueTests() ***REMOVED***
	for _, isClient := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		for _, isResumption := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
			for _, hasEMS := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
				var suffix string
				if isResumption ***REMOVED***
					suffix = "Resume-"
				***REMOVED*** else ***REMOVED***
					suffix = "Full-"
				***REMOVED***

				if hasEMS ***REMOVED***
					suffix += "EMS-"
				***REMOVED*** else ***REMOVED***
					suffix += "NoEMS-"
				***REMOVED***

				if isClient ***REMOVED***
					suffix += "Client"
				***REMOVED*** else ***REMOVED***
					suffix += "Server"
				***REMOVED***

				test := testCase***REMOVED***
					name:          "TLSUnique-" + suffix,
					testTLSUnique: true,
					config: Config***REMOVED***
						MaxVersion: VersionTLS12,
						Bugs: ProtocolBugs***REMOVED***
							NoExtendedMasterSecret: !hasEMS,
						***REMOVED***,
					***REMOVED***,
				***REMOVED***

				if isResumption ***REMOVED***
					test.resumeSession = true
					test.resumeConfig = &Config***REMOVED***
						MaxVersion: VersionTLS12,
						Bugs: ProtocolBugs***REMOVED***
							NoExtendedMasterSecret: !hasEMS,
						***REMOVED***,
					***REMOVED***
				***REMOVED***

				if isResumption && !hasEMS ***REMOVED***
					test.shouldFail = true
					test.expectedError = "failed to get tls-unique"
				***REMOVED***

				testCases = append(testCases, test)
			***REMOVED***
		***REMOVED***
	***REMOVED***
***REMOVED***

func addCustomExtensionTests() ***REMOVED***
	expectedContents := "custom extension"
	emptyString := ""

	for _, isClient := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		suffix := "Server"
		flag := "-enable-server-custom-extension"
		testType := serverTest
		if isClient ***REMOVED***
			suffix = "Client"
			flag = "-enable-client-custom-extension"
			testType = clientTest
		***REMOVED***

		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         expectedContents,
					ExpectedCustomExtension: &expectedContents,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***flag***REMOVED***,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-" + suffix + "-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         expectedContents,
					ExpectedCustomExtension: &expectedContents,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***flag***REMOVED***,
		***REMOVED***)

		// If the parse callback fails, the handshake should also fail.
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-ParseError-" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         expectedContents + "foo",
					ExpectedCustomExtension: &expectedContents,
				***REMOVED***,
			***REMOVED***,
			flags:         []string***REMOVED***flag***REMOVED***,
			shouldFail:    true,
			expectedError: ":CUSTOM_EXTENSION_ERROR:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-ParseError-" + suffix + "-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         expectedContents + "foo",
					ExpectedCustomExtension: &expectedContents,
				***REMOVED***,
			***REMOVED***,
			flags:         []string***REMOVED***flag***REMOVED***,
			shouldFail:    true,
			expectedError: ":CUSTOM_EXTENSION_ERROR:",
		***REMOVED***)

		// If the add callback fails, the handshake should also fail.
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-FailAdd-" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         expectedContents,
					ExpectedCustomExtension: &expectedContents,
				***REMOVED***,
			***REMOVED***,
			flags:         []string***REMOVED***flag, "-custom-extension-fail-add"***REMOVED***,
			shouldFail:    true,
			expectedError: ":CUSTOM_EXTENSION_ERROR:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-FailAdd-" + suffix + "-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         expectedContents,
					ExpectedCustomExtension: &expectedContents,
				***REMOVED***,
			***REMOVED***,
			flags:         []string***REMOVED***flag, "-custom-extension-fail-add"***REMOVED***,
			shouldFail:    true,
			expectedError: ":CUSTOM_EXTENSION_ERROR:",
		***REMOVED***)

		// If the add callback returns zero, no extension should be
		// added.
		skipCustomExtension := expectedContents
		if isClient ***REMOVED***
			// For the case where the client skips sending the
			// custom extension, the server must not “echo” it.
			skipCustomExtension = ""
		***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-Skip-" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         skipCustomExtension,
					ExpectedCustomExtension: &emptyString,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***flag, "-custom-extension-skip"***REMOVED***,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: testType,
			name:     "CustomExtensions-Skip-" + suffix + "-TLS13",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				Bugs: ProtocolBugs***REMOVED***
					CustomExtension:         skipCustomExtension,
					ExpectedCustomExtension: &emptyString,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***flag, "-custom-extension-skip"***REMOVED***,
		***REMOVED***)
	***REMOVED***

	// The custom extension add callback should not be called if the client
	// doesn't send the extension.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "CustomExtensions-NotCalled-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				ExpectedCustomExtension: &emptyString,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-enable-server-custom-extension", "-custom-extension-fail-add"***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "CustomExtensions-NotCalled-Server-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExpectedCustomExtension: &emptyString,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-enable-server-custom-extension", "-custom-extension-fail-add"***REMOVED***,
	***REMOVED***)

	// Test an unknown extension from the server.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "UnknownExtension-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				CustomExtension: expectedContents,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":UNEXPECTED_EXTENSION:",
		expectedLocalError: "remote error: unsupported extension",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "UnknownExtension-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				CustomExtension: expectedContents,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":UNEXPECTED_EXTENSION:",
		expectedLocalError: "remote error: unsupported extension",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "UnknownUnencryptedExtension-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				CustomUnencryptedExtension: expectedContents,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
		// The shim must send an alert, but alerts at this point do not
		// get successfully decrypted by the runner.
		expectedLocalError: "local error: bad record MAC",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "UnexpectedUnencryptedExtension-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendUnencryptedALPN: "foo",
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-advertise-alpn", "\x03foo\x03bar",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
		// The shim must send an alert, but alerts at this point do not
		// get successfully decrypted by the runner.
		expectedLocalError: "local error: bad record MAC",
	***REMOVED***)

	// Test a known but unoffered extension from the server.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "UnofferedExtension-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendALPN: "alpn",
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":UNEXPECTED_EXTENSION:",
		expectedLocalError: "remote error: unsupported extension",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "UnofferedExtension-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendALPN: "alpn",
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":UNEXPECTED_EXTENSION:",
		expectedLocalError: "remote error: unsupported extension",
	***REMOVED***)
***REMOVED***

func addRSAClientKeyExchangeTests() ***REMOVED***
	for bad := RSABadValue(1); bad < NumRSABadValues; bad++ ***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     fmt.Sprintf("BadRSAClientKeyExchange-%d", bad),
			config: Config***REMOVED***
				// Ensure the ClientHello version and final
				// version are different, to detect if the
				// server uses the wrong one.
				MaxVersion:   VersionTLS11,
				CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_3DES_EDE_CBC_SHA***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					BadRSAClientKeyExchange: bad,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
		***REMOVED***)
	***REMOVED***

	// The server must compare whatever was in ClientHello.version for the
	// RSA premaster.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SendClientVersion-RSA",
		config: Config***REMOVED***
			CipherSuites: []uint16***REMOVED***TLS_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendClientVersion: 0x1234,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-max-version", strconv.Itoa(VersionTLS12)***REMOVED***,
	***REMOVED***)
***REMOVED***

var testCurves = []struct ***REMOVED***
	name string
	id   CurveID
***REMOVED******REMOVED***
	***REMOVED***"P-256", CurveP256***REMOVED***,
	***REMOVED***"P-384", CurveP384***REMOVED***,
	***REMOVED***"P-521", CurveP521***REMOVED***,
	***REMOVED***"X25519", CurveX25519***REMOVED***,
***REMOVED***

const bogusCurve = 0x1234

func addCurveTests() ***REMOVED***
	for _, curve := range testCurves ***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			name: "CurveTest-Client-" + curve.name,
			config: Config***REMOVED***
				MaxVersion:       VersionTLS12,
				CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				CurvePreferences: []CurveID***REMOVED***curve.id***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-all-curves",
				"-expect-curve-id", strconv.Itoa(int(curve.id)),
			***REMOVED***,
			expectedCurveID: curve.id,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			name: "CurveTest-Client-" + curve.name + "-TLS13",
			config: Config***REMOVED***
				MaxVersion:       VersionTLS13,
				CurvePreferences: []CurveID***REMOVED***curve.id***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-all-curves",
				"-expect-curve-id", strconv.Itoa(int(curve.id)),
			***REMOVED***,
			expectedCurveID: curve.id,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "CurveTest-Server-" + curve.name,
			config: Config***REMOVED***
				MaxVersion:       VersionTLS12,
				CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				CurvePreferences: []CurveID***REMOVED***curve.id***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-all-curves",
				"-expect-curve-id", strconv.Itoa(int(curve.id)),
			***REMOVED***,
			expectedCurveID: curve.id,
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "CurveTest-Server-" + curve.name + "-TLS13",
			config: Config***REMOVED***
				MaxVersion:       VersionTLS13,
				CurvePreferences: []CurveID***REMOVED***curve.id***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-enable-all-curves",
				"-expect-curve-id", strconv.Itoa(int(curve.id)),
			***REMOVED***,
			expectedCurveID: curve.id,
		***REMOVED***)
	***REMOVED***

	// The server must be tolerant to bogus curves.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "UnknownCurve",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS12,
			CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***bogusCurve, CurveP256***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// The server must be tolerant to bogus curves.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "UnknownCurve-TLS13",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***bogusCurve, CurveP256***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// The server must not consider ECDHE ciphers when there are no
	// supported curves.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "NoSupportedCurves",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				NoSupportedCurves: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_SHARED_CIPHER:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "NoSupportedCurves-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				NoSupportedCurves: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":NO_SHARED_GROUP:",
	***REMOVED***)

	// The server must fall back to another cipher when there are no
	// supported curves.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "NoCommonCurves",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			CipherSuites: []uint16***REMOVED***
				TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
				TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,
			***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***CurveP224***REMOVED***,
		***REMOVED***,
		expectedCipher: TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,
	***REMOVED***)

	// The client must reject bogus curves and disabled curves.
	testCases = append(testCases, testCase***REMOVED***
		name: "BadECDHECurve",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendCurve: bogusCurve,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "BadECDHECurve-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendCurve: bogusCurve,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "UnsupportedCurve",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS12,
			CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerCurvePreferences: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-p384-only"***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		// TODO(davidben): Add a TLS 1.3 version where
		// HelloRetryRequest requests an unsupported curve.
		name: "UnsupportedCurve-ServerHello-TLS13",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendCurve: CurveP256,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-p384-only"***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	// Test invalid curve points.
	testCases = append(testCases, testCase***REMOVED***
		name: "InvalidECDHPoint-Client",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS12,
			CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				InvalidECDHPoint: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":INVALID_ENCODING:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "InvalidECDHPoint-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				InvalidECDHPoint: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":INVALID_ENCODING:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "InvalidECDHPoint-Server",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS12,
			CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				InvalidECDHPoint: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":INVALID_ENCODING:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "InvalidECDHPoint-Server-TLS13",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				InvalidECDHPoint: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":INVALID_ENCODING:",
	***REMOVED***)

	// The previous curve ID should be reported on TLS 1.2 resumption.
	testCases = append(testCases, testCase***REMOVED***
		name: "CurveID-Resume-Client",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS12,
			CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***CurveX25519***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-expect-curve-id", strconv.Itoa(int(CurveX25519))***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "CurveID-Resume-Server",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS12,
			CipherSuites:     []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
			CurvePreferences: []CurveID***REMOVED***CurveX25519***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-expect-curve-id", strconv.Itoa(int(CurveX25519))***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// TLS 1.3 allows resuming at a differet curve. If this happens, the new
	// one should be reported.
	testCases = append(testCases, testCase***REMOVED***
		name: "CurveID-Resume-Client-TLS13",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveX25519***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-expect-curve-id", strconv.Itoa(int(CurveX25519)),
			"-expect-resume-curve-id", strconv.Itoa(int(CurveP256)),
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "CurveID-Resume-Server-TLS13",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveX25519***REMOVED***,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-expect-curve-id", strconv.Itoa(int(CurveX25519)),
			"-expect-resume-curve-id", strconv.Itoa(int(CurveP256)),
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// Server-sent point formats are legal in TLS 1.2, but not in TLS 1.3.
	testCases = append(testCases, testCase***REMOVED***
		name: "PointFormat-ServerHello-TLS12",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED***pointFormatUncompressed***REMOVED***,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "PointFormat-EncryptedExtensions-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED***pointFormatUncompressed***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)

	// Test that we tolerate unknown point formats, as long as
	// pointFormatUncompressed is present. Limit ciphers to ECDHE ciphers to
	// check they are still functional.
	testCases = append(testCases, testCase***REMOVED***
		name: "PointFormat-Client-Tolerance",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED***42, pointFormatUncompressed, 99, pointFormatCompressedPrime***REMOVED***,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "PointFormat-Server-Tolerance",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED***42, pointFormatUncompressed, 99, pointFormatCompressedPrime***REMOVED***,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// Test TLS 1.2 does not require the point format extension to be
	// present.
	testCases = append(testCases, testCase***REMOVED***
		name: "PointFormat-Client-Missing",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED******REMOVED***,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "PointFormat-Server-Missing",
		config: Config***REMOVED***
			MaxVersion:   VersionTLS12,
			CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED******REMOVED***,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// If the point format extension is present, uncompressed points must be
	// offered. BoringSSL requires this whether or not ECDHE is used.
	testCases = append(testCases, testCase***REMOVED***
		name: "PointFormat-Client-MissingUncompressed",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED***pointFormatCompressedPrime***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "PointFormat-Server-MissingUncompressed",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendSupportedPointFormats: []byte***REMOVED***pointFormatCompressedPrime***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":ERROR_PARSING_EXTENSION:",
	***REMOVED***)
***REMOVED***

func addTLS13RecordTests() ***REMOVED***
	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-RecordPadding",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			MinVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				RecordPadding: 10,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-EmptyRecords",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			MinVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				OmitRecordContents: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-OnlyPadding",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			MinVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				OmitRecordContents: true,
				RecordPadding:      10,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-WrongOuterRecord",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			MinVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				OuterRecordType: recordTypeHandshake,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":INVALID_OUTER_RECORD_TYPE:",
	***REMOVED***)
***REMOVED***

func addSessionTicketTests() ***REMOVED***
	testCases = append(testCases, testCase***REMOVED***
		// In TLS 1.2 and below, empty NewSessionTicket messages
		// mean the server changed its mind on sending a ticket.
		name: "SendEmptySessionTicket",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendEmptySessionTicket: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-expect-no-session"***REMOVED***,
	***REMOVED***)

	// Test that the server ignores unknown PSK modes.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-SendUnknownModeSessionTicket-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendPSKKeyExchangeModes: []byte***REMOVED***0x1a, pskDHEKEMode, 0x2a***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		resumeSession:         true,
		expectedResumeVersion: VersionTLS13,
	***REMOVED***)

	// Test that the server does not send session tickets with no matching key exchange mode.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-ExpectNoSessionTicketOnBadKEMode-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendPSKKeyExchangeModes:  []byte***REMOVED***0x1a***REMOVED***,
				ExpectNoNewSessionTicket: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// Test that the server does not accept a session with no matching key exchange mode.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-SendBadKEModeSessionTicket-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
		***REMOVED***,
		resumeConfig: &Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendPSKKeyExchangeModes: []byte***REMOVED***0x1a***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		resumeSession:        true,
		expectResumeRejected: true,
	***REMOVED***)

	// Test that the client ticket age is sent correctly.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-TestValidTicketAge-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExpectTicketAge: 10 * time.Second,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
		flags: []string***REMOVED***
			"-resumption-delay", "10",
		***REMOVED***,
	***REMOVED***)

	// Test that the client ticket age is enforced.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-TestBadTicketAge-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExpectTicketAge: 1000 * time.Second,
			***REMOVED***,
		***REMOVED***,
		resumeSession:      true,
		shouldFail:         true,
		expectedLocalError: "tls: invalid ticket age",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-SendTicketEarlyDataInfo",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			MaxEarlyDataSize: 16384,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-early-data",
			"-expect-early-data-info",
		***REMOVED***,
	***REMOVED***)

	// Test that 0-RTT tickets are ignored in clients unless opted in.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-SendTicketEarlyDataInfo-Disabled",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			MaxEarlyDataSize: 16384,
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-DuplicateTicketEarlyDataInfo",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			MaxEarlyDataSize: 16384,
			Bugs: ProtocolBugs***REMOVED***
				DuplicateTicketEarlyDataInfo: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":DUPLICATE_EXTENSION:",
		expectedLocalError: "remote error: illegal parameter",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-ExpectTicketEarlyDataInfo",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExpectTicketEarlyDataInfo: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-enable-early-data",
		***REMOVED***,
	***REMOVED***)

	// Test that, in TLS 1.3, the server-offered NewSessionTicket lifetime
	// is honored.
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-HonorServerSessionTicketLifetime",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendTicketLifetime: 20 * time.Second,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-resumption-delay", "19",
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "TLS13-HonorServerSessionTicketLifetime-2",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendTicketLifetime: 20 * time.Second,
				// The client should not offer the expired session.
				ExpectNoTLS13PSK: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-resumption-delay", "21",
		***REMOVED***,
		resumeSession:        true,
		expectResumeRejected: true,
	***REMOVED***)
***REMOVED***

func addChangeCipherSpecTests() ***REMOVED***
	// Test missing ChangeCipherSpecs.
	testCases = append(testCases, testCase***REMOVED***
		name: "SkipChangeCipherSpec-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SkipChangeCipherSpec: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipChangeCipherSpec-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SkipChangeCipherSpec: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipChangeCipherSpec-Server-NPN",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			NextProtos: []string***REMOVED***"bar"***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SkipChangeCipherSpec: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-advertise-npn", "\x03foo\x03bar\x03baz",
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
	***REMOVED***)

	// Test synchronization between the handshake and ChangeCipherSpec.
	// Partial post-CCS handshake messages before ChangeCipherSpec should be
	// rejected. Test both with and without handshake packing to handle both
	// when the partial post-CCS message is in its own record and when it is
	// attached to the pre-CCS message.
	for _, packed := range []bool***REMOVED***false, true***REMOVED*** ***REMOVED***
		var suffix string
		if packed ***REMOVED***
			suffix = "-Packed"
		***REMOVED***

		testCases = append(testCases, testCase***REMOVED***
			name: "FragmentAcrossChangeCipherSpec-Client" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					FragmentAcrossChangeCipherSpec: true,
					PackHandshakeFlight:            packed,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			name: "FragmentAcrossChangeCipherSpec-Client-Resume" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			resumeSession: true,
			resumeConfig: &Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					FragmentAcrossChangeCipherSpec: true,
					PackHandshakeFlight:            packed,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "FragmentAcrossChangeCipherSpec-Server" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					FragmentAcrossChangeCipherSpec: true,
					PackHandshakeFlight:            packed,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "FragmentAcrossChangeCipherSpec-Server-Resume" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
			***REMOVED***,
			resumeSession: true,
			resumeConfig: &Config***REMOVED***
				MaxVersion: VersionTLS12,
				Bugs: ProtocolBugs***REMOVED***
					FragmentAcrossChangeCipherSpec: true,
					PackHandshakeFlight:            packed,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***)
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "FragmentAcrossChangeCipherSpec-Server-NPN" + suffix,
			config: Config***REMOVED***
				MaxVersion: VersionTLS12,
				NextProtos: []string***REMOVED***"bar"***REMOVED***,
				Bugs: ProtocolBugs***REMOVED***
					FragmentAcrossChangeCipherSpec: true,
					PackHandshakeFlight:            packed,
				***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-advertise-npn", "\x03foo\x03bar\x03baz",
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":UNEXPECTED_RECORD:",
		***REMOVED***)
	***REMOVED***

	// Test that, in DTLS, ChangeCipherSpec is not allowed when there are
	// messages in the handshake queue. Do this by testing the server
	// reading the client Finished, reversing the flight so Finished comes
	// first.
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		testType: serverTest,
		name:     "SendUnencryptedFinished-DTLS",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				SendUnencryptedFinished:   true,
				ReverseHandshakeFragments: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BUFFERED_MESSAGES_ON_CIPHER_CHANGE:",
	***REMOVED***)

	// Test synchronization between encryption changes and the handshake in
	// TLS 1.3, where ChangeCipherSpec is implicit.
	testCases = append(testCases, testCase***REMOVED***
		name: "PartialEncryptedExtensionsWithServerHello",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				PartialEncryptedExtensionsWithServerHello: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BUFFERED_MESSAGES_ON_CIPHER_CHANGE:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "PartialClientFinishedWithClientHello",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				PartialClientFinishedWithClientHello: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BUFFERED_MESSAGES_ON_CIPHER_CHANGE:",
	***REMOVED***)

	// Test that early ChangeCipherSpecs are handled correctly.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "EarlyChangeCipherSpec-server-1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				EarlyChangeCipherSpec: 1,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "EarlyChangeCipherSpec-server-2",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				EarlyChangeCipherSpec: 2,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "StrayChangeCipherSpec",
		config: Config***REMOVED***
			// TODO(davidben): Once DTLS 1.3 exists, test
			// that stray ChangeCipherSpec messages are
			// rejected.
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				StrayChangeCipherSpec: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// Test that the contents of ChangeCipherSpec are checked.
	testCases = append(testCases, testCase***REMOVED***
		name: "BadChangeCipherSpec-1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				BadChangeCipherSpec: []byte***REMOVED***2***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BAD_CHANGE_CIPHER_SPEC:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "BadChangeCipherSpec-2",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				BadChangeCipherSpec: []byte***REMOVED***1, 1***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BAD_CHANGE_CIPHER_SPEC:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "BadChangeCipherSpec-DTLS-1",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				BadChangeCipherSpec: []byte***REMOVED***2***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BAD_CHANGE_CIPHER_SPEC:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		protocol: dtls,
		name:     "BadChangeCipherSpec-DTLS-2",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				BadChangeCipherSpec: []byte***REMOVED***1, 1***REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":BAD_CHANGE_CIPHER_SPEC:",
	***REMOVED***)
***REMOVED***

type perMessageTest struct ***REMOVED***
	messageType uint8
	test        testCase
***REMOVED***

// makePerMessageTests returns a series of test templates which cover each
// message in the TLS handshake. These may be used with bugs like
// WrongMessageType to fully test a per-message bug.
func makePerMessageTests() []perMessageTest ***REMOVED***
	var ret []perMessageTest
	for _, protocol := range []protocol***REMOVED***tls, dtls***REMOVED*** ***REMOVED***
		var suffix string
		if protocol == dtls ***REMOVED***
			suffix = "-DTLS"
		***REMOVED***

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeClientHello,
			test: testCase***REMOVED***
				protocol: protocol,
				testType: serverTest,
				name:     "ClientHello" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		if protocol == dtls ***REMOVED***
			ret = append(ret, perMessageTest***REMOVED***
				messageType: typeHelloVerifyRequest,
				test: testCase***REMOVED***
					protocol: protocol,
					name:     "HelloVerifyRequest" + suffix,
					config: Config***REMOVED***
						MaxVersion: VersionTLS12,
					***REMOVED***,
				***REMOVED***,
			***REMOVED***)
		***REMOVED***

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeServerHello,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "ServerHello" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeCertificate,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "ServerCertificate" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeCertificateStatus,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "CertificateStatus" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
				flags: []string***REMOVED***"-enable-ocsp-stapling"***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeServerKeyExchange,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "ServerKeyExchange" + suffix,
				config: Config***REMOVED***
					MaxVersion:   VersionTLS12,
					CipherSuites: []uint16***REMOVED***TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256***REMOVED***,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeCertificateRequest,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "CertificateRequest" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
					ClientAuth: RequireAnyClientCert,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeServerHelloDone,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "ServerHelloDone" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeCertificate,
			test: testCase***REMOVED***
				testType: serverTest,
				protocol: protocol,
				name:     "ClientCertificate" + suffix,
				config: Config***REMOVED***
					Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
					MaxVersion:   VersionTLS12,
				***REMOVED***,
				flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeCertificateVerify,
			test: testCase***REMOVED***
				testType: serverTest,
				protocol: protocol,
				name:     "CertificateVerify" + suffix,
				config: Config***REMOVED***
					Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
					MaxVersion:   VersionTLS12,
				***REMOVED***,
				flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeClientKeyExchange,
			test: testCase***REMOVED***
				testType: serverTest,
				protocol: protocol,
				name:     "ClientKeyExchange" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		if protocol != dtls ***REMOVED***
			ret = append(ret, perMessageTest***REMOVED***
				messageType: typeNextProtocol,
				test: testCase***REMOVED***
					testType: serverTest,
					protocol: protocol,
					name:     "NextProtocol" + suffix,
					config: Config***REMOVED***
						MaxVersion: VersionTLS12,
						NextProtos: []string***REMOVED***"bar"***REMOVED***,
					***REMOVED***,
					flags: []string***REMOVED***"-advertise-npn", "\x03foo\x03bar\x03baz"***REMOVED***,
				***REMOVED***,
			***REMOVED***)

			ret = append(ret, perMessageTest***REMOVED***
				messageType: typeChannelID,
				test: testCase***REMOVED***
					testType: serverTest,
					protocol: protocol,
					name:     "ChannelID" + suffix,
					config: Config***REMOVED***
						MaxVersion: VersionTLS12,
						ChannelID:  channelIDKey,
					***REMOVED***,
					flags: []string***REMOVED***
						"-expect-channel-id",
						base64.StdEncoding.EncodeToString(channelIDBytes),
					***REMOVED***,
				***REMOVED***,
			***REMOVED***)
		***REMOVED***

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeFinished,
			test: testCase***REMOVED***
				testType: serverTest,
				protocol: protocol,
				name:     "ClientFinished" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeNewSessionTicket,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "NewSessionTicket" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		ret = append(ret, perMessageTest***REMOVED***
			messageType: typeFinished,
			test: testCase***REMOVED***
				protocol: protocol,
				name:     "ServerFinished" + suffix,
				config: Config***REMOVED***
					MaxVersion: VersionTLS12,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

	***REMOVED***

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeClientHello,
		test: testCase***REMOVED***
			testType: serverTest,
			name:     "TLS13-ClientHello",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeServerHello,
		test: testCase***REMOVED***
			name: "TLS13-ServerHello",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeEncryptedExtensions,
		test: testCase***REMOVED***
			name: "TLS13-EncryptedExtensions",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeCertificateRequest,
		test: testCase***REMOVED***
			name: "TLS13-CertificateRequest",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
				ClientAuth: RequireAnyClientCert,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeCertificate,
		test: testCase***REMOVED***
			name: "TLS13-ServerCertificate",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeCertificateVerify,
		test: testCase***REMOVED***
			name: "TLS13-ServerCertificateVerify",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeFinished,
		test: testCase***REMOVED***
			name: "TLS13-ServerFinished",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeCertificate,
		test: testCase***REMOVED***
			testType: serverTest,
			name:     "TLS13-ClientCertificate",
			config: Config***REMOVED***
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
				MaxVersion:   VersionTLS13,
			***REMOVED***,
			flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeCertificateVerify,
		test: testCase***REMOVED***
			testType: serverTest,
			name:     "TLS13-ClientCertificateVerify",
			config: Config***REMOVED***
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
				MaxVersion:   VersionTLS13,
			***REMOVED***,
			flags: []string***REMOVED***"-require-any-client-certificate"***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	ret = append(ret, perMessageTest***REMOVED***
		messageType: typeFinished,
		test: testCase***REMOVED***
			testType: serverTest,
			name:     "TLS13-ClientFinished",
			config: Config***REMOVED***
				MaxVersion: VersionTLS13,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	return ret
***REMOVED***

func addWrongMessageTypeTests() ***REMOVED***
	for _, t := range makePerMessageTests() ***REMOVED***
		t.test.name = "WrongMessageType-" + t.test.name
		t.test.config.Bugs.SendWrongMessageType = t.messageType
		t.test.shouldFail = true
		t.test.expectedError = ":UNEXPECTED_MESSAGE:"
		t.test.expectedLocalError = "remote error: unexpected message"

		if t.test.config.MaxVersion >= VersionTLS13 && t.messageType == typeServerHello ***REMOVED***
			// In TLS 1.3, a bad ServerHello means the client sends
			// an unencrypted alert while the server expects
			// encryption, so the alert is not readable by runner.
			t.test.expectedLocalError = "local error: bad record MAC"
		***REMOVED***

		testCases = append(testCases, t.test)
	***REMOVED***
***REMOVED***

func addTrailingMessageDataTests() ***REMOVED***
	for _, t := range makePerMessageTests() ***REMOVED***
		t.test.name = "TrailingMessageData-" + t.test.name
		t.test.config.Bugs.SendTrailingMessageData = t.messageType
		t.test.shouldFail = true
		t.test.expectedError = ":DECODE_ERROR:"
		t.test.expectedLocalError = "remote error: error decoding message"

		if t.test.config.MaxVersion >= VersionTLS13 && t.messageType == typeServerHello ***REMOVED***
			// In TLS 1.3, a bad ServerHello means the client sends
			// an unencrypted alert while the server expects
			// encryption, so the alert is not readable by runner.
			t.test.expectedLocalError = "local error: bad record MAC"
		***REMOVED***

		if t.messageType == typeFinished ***REMOVED***
			// Bad Finished messages read as the verify data having
			// the wrong length.
			t.test.expectedError = ":DIGEST_CHECK_FAILED:"
			t.test.expectedLocalError = "remote error: error decrypting message"
		***REMOVED***

		testCases = append(testCases, t.test)
	***REMOVED***
***REMOVED***

func addTLS13HandshakeTests() ***REMOVED***
	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "NegotiatePSKResumption-TLS13",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				NegotiatePSKResumption: true,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
		shouldFail:    true,
		expectedError: ":MISSING_KEY_SHARE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "MissingKeyShare-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				MissingKeyShare: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":MISSING_KEY_SHARE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "MissingKeyShare-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				MissingKeyShare: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":MISSING_KEY_SHARE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "DuplicateKeyShares",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				DuplicateKeyShares: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DUPLICATE_KEY_SHARE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 4,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-OmitEarlyDataExtension",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 4,
				OmitEarlyDataExtension:  true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-TooMuchData",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 16384 + 1,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":TOO_MUCH_SKIPPED_EARLY_DATA:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-Interleaved",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 4,
				InterleaveEarlyData:     true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECRYPTION_FAILED_OR_BAD_RECORD_MAC:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-EarlyDataInTLS12",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 4,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
		flags:         []string***REMOVED***"-max-version", strconv.Itoa(VersionTLS12)***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-HRR",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 4,
			***REMOVED***,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-HRR-Interleaved",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 4,
				InterleaveEarlyData:     true,
			***REMOVED***,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_RECORD:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-HRR-TooMuchData",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendFakeEarlyDataLength: 16384 + 1,
			***REMOVED***,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":TOO_MUCH_SKIPPED_EARLY_DATA:",
	***REMOVED***)

	// Test that skipping early data looking for cleartext correctly
	// processes an alert record.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-HRR-FatalAlert",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendEarlyAlert:          true,
				SendFakeEarlyDataLength: 4,
			***REMOVED***,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":SSLV3_ALERT_HANDSHAKE_FAILURE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SkipEarlyData-SecondClientHelloEarlyData",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendEarlyDataOnSecondClientHello: true,
			***REMOVED***,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: bad record MAC",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "EmptyEncryptedExtensions",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EmptyEncryptedExtensions: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: error decoding message",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: clientTest,
		name:     "EncryptedExtensionsWithKeyShare",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EncryptedExtensionsWithKeyShare: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedLocalError: "remote error: unsupported extension",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SendHelloRetryRequest",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// Require a HelloRetryRequest for every curve.
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
		***REMOVED***,
		expectedCurveID: CurveX25519,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SendHelloRetryRequest-2",
		config: Config***REMOVED***
			MaxVersion:    VersionTLS13,
			DefaultCurves: []CurveID***REMOVED***CurveP384***REMOVED***,
		***REMOVED***,
		// Although the ClientHello did not predict our preferred curve,
		// we always select it whether it is predicted or not.
		expectedCurveID: CurveX25519,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "UnknownCurve-HelloRetryRequest",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires HelloRetryRequest in BoringSSL.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRetryRequestCurve: bogusCurve,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "DisabledCurve-HelloRetryRequest",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveP256***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				IgnorePeerCurvePreferences: true,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-p384-only"***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "UnnecessaryHelloRetryRequest",
		config: Config***REMOVED***
			MaxVersion:       VersionTLS13,
			CurvePreferences: []CurveID***REMOVED***CurveX25519***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRetryRequestCurve: CurveX25519,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "SecondHelloRetryRequest",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires HelloRetryRequest in BoringSSL.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SecondHelloRetryRequest: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_MESSAGE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-Empty",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				AlwaysSendHelloRetryRequest: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECODE_ERROR:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-DuplicateCurve",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires a HelloRetryRequest against BoringSSL's default
			// configuration. Assert this ExpectMissingKeyShare.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				ExpectMissingKeyShare:                true,
				DuplicateHelloRetryRequestExtensions: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":DUPLICATE_EXTENSION:",
		expectedLocalError: "remote error: illegal parameter",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-Cookie",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRetryRequestCookie: []byte("cookie"),
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-DuplicateCookie",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRetryRequestCookie:          []byte("cookie"),
				DuplicateHelloRetryRequestExtensions: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":DUPLICATE_EXTENSION:",
		expectedLocalError: "remote error: illegal parameter",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-EmptyCookie",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRetryRequestCookie: []byte***REMOVED******REMOVED***,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECODE_ERROR:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-Cookie-Curve",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires HelloRetryRequest in BoringSSL.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendHelloRetryRequestCookie: []byte("cookie"),
				ExpectMissingKeyShare:       true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequest-Unknown",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				CustomHelloRetryRequestExtension: "extension",
			***REMOVED***,
		***REMOVED***,
		shouldFail:         true,
		expectedError:      ":UNEXPECTED_EXTENSION:",
		expectedLocalError: "remote error: unsupported extension",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SecondClientHelloMissingKeyShare",
		config: Config***REMOVED***
			MaxVersion:    VersionTLS13,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SecondClientHelloMissingKeyShare: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":MISSING_KEY_SHARE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "SecondClientHelloWrongCurve",
		config: Config***REMOVED***
			MaxVersion:    VersionTLS13,
			DefaultCurves: []CurveID***REMOVED******REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				MisinterpretHelloRetryRequestCurve: CurveP521,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequestVersionMismatch",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires HelloRetryRequest in BoringSSL.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SendServerHelloVersion: 0x0305,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_VERSION_NUMBER:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "HelloRetryRequestCurveMismatch",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires HelloRetryRequest in BoringSSL.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				// Send P-384 (correct) in the HelloRetryRequest.
				SendHelloRetryRequestCurve: CurveP384,
				// But send P-256 in the ServerHello.
				SendCurve: CurveP256,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	// Test the server selecting a curve that requires a HelloRetryRequest
	// without sending it.
	testCases = append(testCases, testCase***REMOVED***
		name: "SkipHelloRetryRequest",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// P-384 requires HelloRetryRequest in BoringSSL.
			CurvePreferences: []CurveID***REMOVED***CurveP384***REMOVED***,
			Bugs: ProtocolBugs***REMOVED***
				SkipHelloRetryRequest: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":WRONG_CURVE:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-RequestContextInHandshake",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			MinVersion: VersionTLS13,
			ClientAuth: RequireAnyClientCert,
			Bugs: ProtocolBugs***REMOVED***
				SendRequestContext: []byte("request context"),
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-cert-file", path.Join(*resourceDir, rsaCertificateFile),
			"-key-file", path.Join(*resourceDir, rsaKeyFile),
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECODE_ERROR:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-TrailingKeyShareData",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				TrailingKeyShareData: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":DECODE_ERROR:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-AlwaysSelectPSKIdentity",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				AlwaysSelectPSKIdentity: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-InvalidPSKIdentity",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				SelectPSKIdentityOnResume: 1,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
		shouldFail:    true,
		expectedError: ":PSK_IDENTITY_NOT_FOUND:",
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-ExtraPSKIdentity",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				ExtraPSKIdentity:   true,
				SendExtraPSKBinder: true,
			***REMOVED***,
		***REMOVED***,
		resumeSession: true,
	***REMOVED***)

	// Test that unknown NewSessionTicket extensions are tolerated.
	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-CustomTicketExtension",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				CustomTicketExtension: "1234",
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)
***REMOVED***

func addTLS13CipherPreferenceTests() ***REMOVED***
	// Test that client preference is honored if the shim has AES hardware
	// and ChaCha20-Poly1305 is preferred otherwise.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-CipherPreference-Server-ChaCha20-AES",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			CipherSuites: []uint16***REMOVED***
				TLS_CHACHA20_POLY1305_SHA256,
				TLS_AES_128_GCM_SHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-expect-cipher-aes", strconv.Itoa(int(TLS_CHACHA20_POLY1305_SHA256)),
			"-expect-cipher-no-aes", strconv.Itoa(int(TLS_CHACHA20_POLY1305_SHA256)),
		***REMOVED***,
	***REMOVED***)

	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "TLS13-CipherPreference-Server-AES-ChaCha20",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			CipherSuites: []uint16***REMOVED***
				TLS_AES_128_GCM_SHA256,
				TLS_CHACHA20_POLY1305_SHA256,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-expect-cipher-aes", strconv.Itoa(int(TLS_AES_128_GCM_SHA256)),
			"-expect-cipher-no-aes", strconv.Itoa(int(TLS_CHACHA20_POLY1305_SHA256)),
		***REMOVED***,
	***REMOVED***)

	// Test that the client orders ChaCha20-Poly1305 and AES-GCM based on
	// whether it has AES hardware.
	testCases = append(testCases, testCase***REMOVED***
		name: "TLS13-CipherPreference-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			// Use the client cipher order. (This is the default but
			// is listed to be explicit.)
			PreferServerCipherSuites: false,
		***REMOVED***,
		flags: []string***REMOVED***
			"-expect-cipher-aes", strconv.Itoa(int(TLS_AES_128_GCM_SHA256)),
			"-expect-cipher-no-aes", strconv.Itoa(int(TLS_CHACHA20_POLY1305_SHA256)),
		***REMOVED***,
	***REMOVED***)
***REMOVED***

func addPeekTests() ***REMOVED***
	// Test SSL_peek works, including on empty records.
	testCases = append(testCases, testCase***REMOVED***
		name:             "Peek-Basic",
		sendEmptyRecords: 1,
		flags:            []string***REMOVED***"-peek-then-read"***REMOVED***,
	***REMOVED***)

	// Test SSL_peek can drive the initial handshake.
	testCases = append(testCases, testCase***REMOVED***
		name: "Peek-ImplicitHandshake",
		flags: []string***REMOVED***
			"-peek-then-read",
			"-implicit-handshake",
		***REMOVED***,
	***REMOVED***)

	// Test SSL_peek can discover and drive a renegotiation.
	testCases = append(testCases, testCase***REMOVED***
		name: "Peek-Renegotiate",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
		***REMOVED***,
		renegotiate: 1,
		flags: []string***REMOVED***
			"-peek-then-read",
			"-renegotiate-freely",
			"-expect-total-renegotiations", "1",
		***REMOVED***,
	***REMOVED***)

	// Test SSL_peek can discover a close_notify.
	testCases = append(testCases, testCase***REMOVED***
		name: "Peek-Shutdown",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				ExpectCloseNotify: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***
			"-peek-then-read",
			"-check-close-notify",
		***REMOVED***,
	***REMOVED***)

	// Test SSL_peek can discover an alert.
	testCases = append(testCases, testCase***REMOVED***
		name: "Peek-Alert",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				SendSpuriousAlert: alertRecordOverflow,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-peek-then-read"***REMOVED***,
		shouldFail:    true,
		expectedError: ":TLSV1_ALERT_RECORD_OVERFLOW:",
	***REMOVED***)

	// Test SSL_peek can handle KeyUpdate.
	testCases = append(testCases, testCase***REMOVED***
		name: "Peek-KeyUpdate",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
		***REMOVED***,
		sendKeyUpdates:   1,
		keyUpdateRequest: keyUpdateNotRequested,
		flags:            []string***REMOVED***"-peek-then-read"***REMOVED***,
	***REMOVED***)
***REMOVED***

func addRecordVersionTests() ***REMOVED***
	for _, ver := range tlsVersions ***REMOVED***
		// Test that the record version is enforced.
		testCases = append(testCases, testCase***REMOVED***
			name: "CheckRecordVersion-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendRecordVersion: 0x03ff,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":WRONG_VERSION_NUMBER:",
		***REMOVED***)

		// Test that the ClientHello may use any record version, for
		// compatibility reasons.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "LooseInitialRecordVersion-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendInitialRecordVersion: 0x03ff,
				***REMOVED***,
			***REMOVED***,
		***REMOVED***)

		// Test that garbage ClientHello record versions are rejected.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "GarbageInitialRecordVersion-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
				Bugs: ProtocolBugs***REMOVED***
					SendInitialRecordVersion: 0xffff,
				***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":WRONG_VERSION_NUMBER:",
		***REMOVED***)
	***REMOVED***
***REMOVED***

func addCertificateTests() ***REMOVED***
	// Test that a certificate chain with intermediate may be sent and
	// received as both client and server.
	for _, ver := range tlsVersions ***REMOVED***
		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "SendReceiveIntermediate-Client-" + ver.name,
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***rsaChainCertificate***REMOVED***,
				ClientAuth:   RequireAnyClientCert,
			***REMOVED***,
			expectPeerCertificate: &rsaChainCertificate,
			flags: []string***REMOVED***
				"-cert-file", path.Join(*resourceDir, rsaChainCertificateFile),
				"-key-file", path.Join(*resourceDir, rsaChainKeyFile),
				"-expect-peer-cert-file", path.Join(*resourceDir, rsaChainCertificateFile),
			***REMOVED***,
		***REMOVED***)

		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "SendReceiveIntermediate-Server-" + ver.name,
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***rsaChainCertificate***REMOVED***,
			***REMOVED***,
			expectPeerCertificate: &rsaChainCertificate,
			flags: []string***REMOVED***
				"-cert-file", path.Join(*resourceDir, rsaChainCertificateFile),
				"-key-file", path.Join(*resourceDir, rsaChainKeyFile),
				"-require-any-client-certificate",
				"-expect-peer-cert-file", path.Join(*resourceDir, rsaChainCertificateFile),
			***REMOVED***,
		***REMOVED***)
	***REMOVED***
***REMOVED***

func addRetainOnlySHA256ClientCertTests() ***REMOVED***
	for _, ver := range tlsVersions ***REMOVED***
		// Test that enabling
		// SSL_CTX_set_retain_only_sha256_of_client_certs without
		// actually requesting a client certificate is a no-op.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "RetainOnlySHA256-NoCert-" + ver.name,
			config: Config***REMOVED***
				MinVersion: ver.version,
				MaxVersion: ver.version,
			***REMOVED***,
			flags: []string***REMOVED***
				"-retain-only-sha256-client-cert-initial",
				"-retain-only-sha256-client-cert-resume",
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		// Test that when retaining only a SHA-256 certificate is
		// enabled, the hash appears as expected.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "RetainOnlySHA256-Cert-" + ver.name,
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-verify-peer",
				"-retain-only-sha256-client-cert-initial",
				"-retain-only-sha256-client-cert-resume",
				"-expect-sha256-client-cert-initial",
				"-expect-sha256-client-cert-resume",
			***REMOVED***,
			resumeSession: true,
		***REMOVED***)

		// Test that when the config changes from on to off, a
		// resumption is rejected because the server now wants the full
		// certificate chain.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "RetainOnlySHA256-OnOff-" + ver.name,
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-verify-peer",
				"-retain-only-sha256-client-cert-initial",
				"-expect-sha256-client-cert-initial",
			***REMOVED***,
			resumeSession:        true,
			expectResumeRejected: true,
		***REMOVED***)

		// Test that when the config changes from off to on, a
		// resumption is rejected because the server now wants just the
		// hash.
		testCases = append(testCases, testCase***REMOVED***
			testType: serverTest,
			name:     "RetainOnlySHA256-OffOn-" + ver.name,
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***rsaCertificate***REMOVED***,
			***REMOVED***,
			flags: []string***REMOVED***
				"-verify-peer",
				"-retain-only-sha256-client-cert-resume",
				"-expect-sha256-client-cert-resume",
			***REMOVED***,
			resumeSession:        true,
			expectResumeRejected: true,
		***REMOVED***)
	***REMOVED***
***REMOVED***

func addECDSAKeyUsageTests() ***REMOVED***
	p256 := elliptic.P256()
	priv, err := ecdsa.GenerateKey(p256, rand.Reader)
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***

	serialNumberLimit := new(big.Int).Lsh(big.NewInt(1), 128)
	serialNumber, err := rand.Int(rand.Reader, serialNumberLimit)
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***

	template := x509.Certificate***REMOVED***
		SerialNumber: serialNumber,
		Subject: pkix.Name***REMOVED***
			Organization: []string***REMOVED***"Acme Co"***REMOVED***,
		***REMOVED***,
		NotBefore: time.Now(),
		NotAfter:  time.Now(),

		// An ECC certificate with only the keyAgreement key usgae may
		// be used with ECDH, but not ECDSA.
		KeyUsage:              x509.KeyUsageKeyAgreement,
		ExtKeyUsage:           []x509.ExtKeyUsage***REMOVED***x509.ExtKeyUsageServerAuth***REMOVED***,
		BasicConstraintsValid: true,
	***REMOVED***

	derBytes, err := x509.CreateCertificate(rand.Reader, &template, &template, &priv.PublicKey, priv)
	if err != nil ***REMOVED***
		panic(err)
	***REMOVED***

	cert := Certificate***REMOVED***
		Certificate: [][]byte***REMOVED***derBytes***REMOVED***,
		PrivateKey:  priv,
	***REMOVED***

	for _, ver := range tlsVersions ***REMOVED***
		if ver.version < VersionTLS12 ***REMOVED***
			continue
		***REMOVED***

		testCases = append(testCases, testCase***REMOVED***
			testType: clientTest,
			name:     "ECDSAKeyUsage-" + ver.name,
			config: Config***REMOVED***
				MinVersion:   ver.version,
				MaxVersion:   ver.version,
				Certificates: []Certificate***REMOVED***cert***REMOVED***,
			***REMOVED***,
			shouldFail:    true,
			expectedError: ":ECC_CERT_NOT_FOR_SIGNING:",
		***REMOVED***)
	***REMOVED***
***REMOVED***

func addShortHeaderTests() ***REMOVED***
	// The short header extension may be negotiated as either client or
	// server.
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader: true,
			***REMOVED***,
		***REMOVED***,
		flags:             []string***REMOVED***"-enable-short-header"***REMOVED***,
		expectShortHeader: true,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ShortHeader-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader: true,
			***REMOVED***,
		***REMOVED***,
		flags:             []string***REMOVED***"-enable-short-header"***REMOVED***,
		expectShortHeader: true,
	***REMOVED***)

	// If the peer doesn't support it, it will not be negotiated.
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-No-Yes-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
		***REMOVED***,
		flags: []string***REMOVED***"-enable-short-header"***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ShortHeader-No-Yes-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
		***REMOVED***,
		flags: []string***REMOVED***"-enable-short-header"***REMOVED***,
	***REMOVED***)

	// If we don't support it, it will not be negotiated.
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-Yes-No-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ShortHeader-Yes-No-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader: true,
			***REMOVED***,
		***REMOVED***,
	***REMOVED***)

	// It will not be negotiated at TLS 1.2.
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-TLS12-Client",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-enable-short-header"***REMOVED***,
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ShortHeader-TLS12-Server",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader: true,
			***REMOVED***,
		***REMOVED***,
		flags: []string***REMOVED***"-enable-short-header"***REMOVED***,
	***REMOVED***)

	// Servers reject early data and short header sent together.
	testCases = append(testCases, testCase***REMOVED***
		testType: serverTest,
		name:     "ShortHeader-EarlyData",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader:       true,
				SendFakeEarlyDataLength: 1,
			***REMOVED***,
		***REMOVED***,
		flags:         []string***REMOVED***"-enable-short-header"***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	// Clients reject unsolicited short header extensions.
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-Unsolicited",
		config: Config***REMOVED***
			MaxVersion: VersionTLS13,
			Bugs: ProtocolBugs***REMOVED***
				AlwaysNegotiateShortHeader: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-Unsolicited-TLS12",
		config: Config***REMOVED***
			MaxVersion: VersionTLS12,
			Bugs: ProtocolBugs***REMOVED***
				AlwaysNegotiateShortHeader: true,
			***REMOVED***,
		***REMOVED***,
		shouldFail:    true,
		expectedError: ":UNEXPECTED_EXTENSION:",
	***REMOVED***)

	// The high bit must be checked in short headers.
	testCases = append(testCases, testCase***REMOVED***
		name: "ShortHeader-ClearShortHeaderBit",
		config: Config***REMOVED***
			Bugs: ProtocolBugs***REMOVED***
				EnableShortHeader:   true,
				ClearShortHeaderBit: true,
			***REMOVED***,
		***REMOVED***,
		flags:              []string***REMOVED***"-enable-short-header"***REMOVED***,
		shouldFail:         true,
		expectedError:      ":DECODE_ERROR:",
		expectedLocalError: "remote error: error decoding message",
	***REMOVED***)
***REMOVED***

func worker(statusChan chan statusMsg, c chan *testCase, shimPath string, wg *sync.WaitGroup) ***REMOVED***
	defer wg.Done()

	for test := range c ***REMOVED***
		var err error

		if *mallocTest >= 0 ***REMOVED***
			for mallocNumToFail := int64(*mallocTest); ; mallocNumToFail++ ***REMOVED***
				statusChan <- statusMsg***REMOVED***test: test, started: true***REMOVED***
				if err = runTest(test, shimPath, mallocNumToFail); err != errMoreMallocs ***REMOVED***
					if err != nil ***REMOVED***
						fmt.Printf("\n\nmalloc test failed at %d: %s\n", mallocNumToFail, err)
					***REMOVED***
					break
				***REMOVED***
			***REMOVED***
		***REMOVED*** else if *repeatUntilFailure ***REMOVED***
			for err == nil ***REMOVED***
				statusChan <- statusMsg***REMOVED***test: test, started: true***REMOVED***
				err = runTest(test, shimPath, -1)
			***REMOVED***
		***REMOVED*** else ***REMOVED***
			statusChan <- statusMsg***REMOVED***test: test, started: true***REMOVED***
			err = runTest(test, shimPath, -1)
		***REMOVED***
		statusChan <- statusMsg***REMOVED***test: test, err: err***REMOVED***
	***REMOVED***
***REMOVED***

type statusMsg struct ***REMOVED***
	test    *testCase
	started bool
	err     error
***REMOVED***

func statusPrinter(doneChan chan *testOutput, statusChan chan statusMsg, total int) ***REMOVED***
	var started, done, failed, unimplemented, lineLen int

	testOutput := newTestOutput()
	for msg := range statusChan ***REMOVED***
		if !*pipe ***REMOVED***
			// Erase the previous status line.
			var erase string
			for i := 0; i < lineLen; i++ ***REMOVED***
				erase += "\b \b"
			***REMOVED***
			fmt.Print(erase)
		***REMOVED***

		if msg.started ***REMOVED***
			started++
		***REMOVED*** else ***REMOVED***
			done++

			if msg.err != nil ***REMOVED***
				if msg.err == errUnimplemented ***REMOVED***
					if *pipe ***REMOVED***
						// Print each test instead of a status line.
						fmt.Printf("UNIMPLEMENTED (%s)\n", msg.test.name)
					***REMOVED***
					unimplemented++
					testOutput.addResult(msg.test.name, "UNIMPLEMENTED")
				***REMOVED*** else ***REMOVED***
					fmt.Printf("FAILED (%s)\n%s\n", msg.test.name, msg.err)
					failed++
					testOutput.addResult(msg.test.name, "FAIL")
				***REMOVED***
			***REMOVED*** else ***REMOVED***
				if *pipe ***REMOVED***
					// Print each test instead of a status line.
					fmt.Printf("PASSED (%s)\n", msg.test.name)
				***REMOVED***
				testOutput.addResult(msg.test.name, "PASS")
			***REMOVED***
		***REMOVED***

		if !*pipe ***REMOVED***
			// Print a new status line.
			line := fmt.Sprintf("%d/%d/%d/%d/%d", failed, unimplemented, done, started, total)
			lineLen = len(line)
			os.Stdout.WriteString(line)
		***REMOVED***
	***REMOVED***

	doneChan <- testOutput
***REMOVED***

func main() ***REMOVED***
	flag.Parse()
	*resourceDir = path.Clean(*resourceDir)
	initCertificates()

	addBasicTests()
	addCipherSuiteTests()
	addBadECDSASignatureTests()
	addCBCPaddingTests()
	addCBCSplittingTests()
	addClientAuthTests()
	addDDoSCallbackTests()
	addVersionNegotiationTests()
	addMinimumVersionTests()
	addExtensionTests()
	addResumptionVersionTests()
	addExtendedMasterSecretTests()
	addRenegotiationTests()
	addDTLSReplayTests()
	addSignatureAlgorithmTests()
	addDTLSRetransmitTests()
	addExportKeyingMaterialTests()
	addTLSUniqueTests()
	addCustomExtensionTests()
	addRSAClientKeyExchangeTests()
	addCurveTests()
	addSessionTicketTests()
	addTLS13RecordTests()
	addAllStateMachineCoverageTests()
	addChangeCipherSpecTests()
	addWrongMessageTypeTests()
	addTrailingMessageDataTests()
	addTLS13HandshakeTests()
	addTLS13CipherPreferenceTests()
	addPeekTests()
	addRecordVersionTests()
	addCertificateTests()
	addRetainOnlySHA256ClientCertTests()
	addECDSAKeyUsageTests()
	addShortHeaderTests()

	var wg sync.WaitGroup

	statusChan := make(chan statusMsg, *numWorkers)
	testChan := make(chan *testCase, *numWorkers)
	doneChan := make(chan *testOutput)

	if len(*shimConfigFile) != 0 ***REMOVED***
		encoded, err := ioutil.ReadFile(*shimConfigFile)
		if err != nil ***REMOVED***
			fmt.Fprintf(os.Stderr, "Couldn't read config file %q: %s\n", *shimConfigFile, err)
			os.Exit(1)
		***REMOVED***

		if err := json.Unmarshal(encoded, &shimConfig); err != nil ***REMOVED***
			fmt.Fprintf(os.Stderr, "Couldn't decode config file %q: %s\n", *shimConfigFile, err)
			os.Exit(1)
		***REMOVED***
	***REMOVED***

	go statusPrinter(doneChan, statusChan, len(testCases))

	for i := 0; i < *numWorkers; i++ ***REMOVED***
		wg.Add(1)
		go worker(statusChan, testChan, *shimPath, &wg)
	***REMOVED***

	var foundTest bool
	for i := range testCases ***REMOVED***
		matched := true
		if len(*testToRun) != 0 ***REMOVED***
			var err error
			matched, err = filepath.Match(*testToRun, testCases[i].name)
			if err != nil ***REMOVED***
				fmt.Fprintf(os.Stderr, "Error matching pattern: %s\n", err)
				os.Exit(1)
			***REMOVED***
		***REMOVED***

		if !*includeDisabled ***REMOVED***
			for pattern := range shimConfig.DisabledTests ***REMOVED***
				isDisabled, err := filepath.Match(pattern, testCases[i].name)
				if err != nil ***REMOVED***
					fmt.Fprintf(os.Stderr, "Error matching pattern %q from config file: %s\n", pattern, err)
					os.Exit(1)
				***REMOVED***

				if isDisabled ***REMOVED***
					matched = false
					break
				***REMOVED***
			***REMOVED***
		***REMOVED***

		if matched ***REMOVED***
			foundTest = true
			testChan <- &testCases[i]

			// Only run one test if repeating until failure.
			if *repeatUntilFailure ***REMOVED***
				break
			***REMOVED***
		***REMOVED***
	***REMOVED***

	if !foundTest ***REMOVED***
		fmt.Fprintf(os.Stderr, "No tests run\n")
		os.Exit(1)
	***REMOVED***

	close(testChan)
	wg.Wait()
	close(statusChan)
	testOutput := <-doneChan

	fmt.Printf("\n")

	if *jsonOutput != "" ***REMOVED***
		if err := testOutput.writeTo(*jsonOutput); err != nil ***REMOVED***
			fmt.Fprintf(os.Stderr, "Error: %s\n", err)
		***REMOVED***
	***REMOVED***

	if !*allowUnimplemented && testOutput.NumFailuresByType["UNIMPLEMENTED"] > 0 ***REMOVED***
		os.Exit(1)
	***REMOVED***

	if !testOutput.noneFailed ***REMOVED***
		os.Exit(1)
	***REMOVED***
***REMOVED***
