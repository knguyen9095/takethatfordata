/* Generates a random, valid protobuf message. Useful to seed
 * external fuzzers such as afl-fuzz.
 */

#include <pb_encode.h>
#include <pb_common.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include <time.h>
#include "alltypes_static.pb.h"

static uint64_t random_seed;

/* Uses xorshift64 here instead of rand() for both speed and
 * reproducibility across platforms. */
static uint32_t rand_word()
***REMOVED***
    random_seed ^= random_seed >> 12;
    random_seed ^= random_seed << 25;
    random_seed ^= random_seed >> 27;
    return random_seed * 2685821657736338717ULL;
***REMOVED***

/* Fills a buffer with random data. */
static void rand_fill(uint8_t *buf, size_t count)
***REMOVED***
    while (count--)
    ***REMOVED***
        *buf++ = rand_word() & 0xff;
    ***REMOVED***
***REMOVED***

/* Check that size/count fields do not exceed their max size.
 * Otherwise we would have to loop pretty long in generate_message().
 * Note that there may still be a few encoding errors from submessages.
 */
static void limit_sizes(alltypes_static_AllTypes *msg)
***REMOVED***
    pb_field_iter_t iter;
    pb_field_iter_begin(&iter, alltypes_static_AllTypes_fields, msg);
    while (pb_field_iter_next(&iter))
    ***REMOVED***
        if (PB_LTYPE(iter.pos->type) == PB_LTYPE_BYTES)
        ***REMOVED***
            ((pb_bytes_array_t*)iter.pData)->size %= iter.pos->data_size - PB_BYTES_ARRAY_T_ALLOCSIZE(0);
        ***REMOVED***
        
        if (PB_HTYPE(iter.pos->type) == PB_HTYPE_REPEATED)
        ***REMOVED***
            *((pb_size_t*)iter.pSize) %= iter.pos->array_size;
        ***REMOVED***
        
        if (PB_HTYPE(iter.pos->type) == PB_HTYPE_ONEOF)
        ***REMOVED***
            /* Set the oneof to this message type with 50% chance. */
            if (rand_word() & 1)
            ***REMOVED***
                *((pb_size_t*)iter.pSize) = iter.pos->tag;
            ***REMOVED***
        ***REMOVED***
    ***REMOVED***
***REMOVED***

static void generate_message()
***REMOVED***
    alltypes_static_AllTypes msg;
    uint8_t buf[8192];
    pb_ostream_t stream = ***REMOVED***0***REMOVED***;
    
    do ***REMOVED***
        if (stream.errmsg)
            fprintf(stderr, "Encoder error: %s\n", stream.errmsg);
        
        stream = pb_ostream_from_buffer(buf, sizeof(buf));
        rand_fill((void*)&msg, sizeof(msg));
        limit_sizes(&msg);
    ***REMOVED*** while (!pb_encode(&stream, alltypes_static_AllTypes_fields, &msg));
    
    fwrite(buf, 1, stream.bytes_written, stdout);
***REMOVED***

int main(int argc, char **argv)
***REMOVED***
    if (argc > 1)
    ***REMOVED***
        random_seed = atol(argv[1]);
    ***REMOVED***
    else
    ***REMOVED***
        random_seed = time(NULL);
    ***REMOVED***
    
    fprintf(stderr, "Random seed: %llu\n", (long long unsigned)random_seed);
    
    generate_message();
    
    return 0;
***REMOVED***

