/*
 *
 * Copyright 2016 gRPC authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

#include "src/core/lib/channel/handshaker_registry.h"

#include <string.h>

#include <grpc/support/alloc.h>

//
// grpc_handshaker_factory_list
//

typedef struct ***REMOVED***
  grpc_handshaker_factory** list;
  size_t num_factories;
***REMOVED*** grpc_handshaker_factory_list;

static void grpc_handshaker_factory_list_register(
    grpc_handshaker_factory_list* list, bool at_start,
    grpc_handshaker_factory* factory) ***REMOVED***
  list->list = (grpc_handshaker_factory**)gpr_realloc(
      list->list, (list->num_factories + 1) * sizeof(grpc_handshaker_factory*));
  if (at_start) ***REMOVED***
    memmove(list->list + 1, list->list,
            sizeof(grpc_handshaker_factory*) * list->num_factories);
    list->list[0] = factory;
  ***REMOVED*** else ***REMOVED***
    list->list[list->num_factories] = factory;
  ***REMOVED***
  ++list->num_factories;
***REMOVED***

static void grpc_handshaker_factory_list_add_handshakers(
    grpc_exec_ctx* exec_ctx, grpc_handshaker_factory_list* list,
    const grpc_channel_args* args, grpc_handshake_manager* handshake_mgr) ***REMOVED***
  for (size_t i = 0; i < list->num_factories; ++i) ***REMOVED***
    grpc_handshaker_factory_add_handshakers(exec_ctx, list->list[i], args,
                                            handshake_mgr);
  ***REMOVED***
***REMOVED***

static void grpc_handshaker_factory_list_destroy(
    grpc_exec_ctx* exec_ctx, grpc_handshaker_factory_list* list) ***REMOVED***
  for (size_t i = 0; i < list->num_factories; ++i) ***REMOVED***
    grpc_handshaker_factory_destroy(exec_ctx, list->list[i]);
  ***REMOVED***
  gpr_free(list->list);
***REMOVED***

//
// plugin
//

static grpc_handshaker_factory_list
    g_handshaker_factory_lists[NUM_HANDSHAKER_TYPES];

void grpc_handshaker_factory_registry_init() ***REMOVED***
  memset(g_handshaker_factory_lists, 0, sizeof(g_handshaker_factory_lists));
***REMOVED***

void grpc_handshaker_factory_registry_shutdown(grpc_exec_ctx* exec_ctx) ***REMOVED***
  for (size_t i = 0; i < NUM_HANDSHAKER_TYPES; ++i) ***REMOVED***
    grpc_handshaker_factory_list_destroy(exec_ctx,
                                         &g_handshaker_factory_lists[i]);
  ***REMOVED***
***REMOVED***

void grpc_handshaker_factory_register(bool at_start,
                                      grpc_handshaker_type handshaker_type,
                                      grpc_handshaker_factory* factory) ***REMOVED***
  grpc_handshaker_factory_list_register(
      &g_handshaker_factory_lists[handshaker_type], at_start, factory);
***REMOVED***

void grpc_handshakers_add(grpc_exec_ctx* exec_ctx,
                          grpc_handshaker_type handshaker_type,
                          const grpc_channel_args* args,
                          grpc_handshake_manager* handshake_mgr) ***REMOVED***
  grpc_handshaker_factory_list_add_handshakers(
      exec_ctx, &g_handshaker_factory_lists[handshaker_type], args,
      handshake_mgr);
***REMOVED***
