'use strict'
var util = require('util')
var TrackerBase = require('./tracker-base.js')
var Tracker = require('./tracker.js')
var TrackerStream = require('./tracker-stream.js')

var TrackerGroup = module.exports = function (name) ***REMOVED***
  TrackerBase.call(this, name)
  this.parentGroup = null
  this.trackers = []
  this.completion = ***REMOVED******REMOVED***
  this.weight = ***REMOVED******REMOVED***
  this.totalWeight = 0
  this.finished = false
  this.bubbleChange = bubbleChange(this)
***REMOVED***
util.inherits(TrackerGroup, TrackerBase)

function bubbleChange (trackerGroup) ***REMOVED***
  return function (name, completed, tracker) ***REMOVED***
    trackerGroup.completion[tracker.id] = completed
    if (trackerGroup.finished) return
    trackerGroup.emit('change', name || trackerGroup.name, trackerGroup.completed(), trackerGroup)
  ***REMOVED***
***REMOVED***

TrackerGroup.prototype.nameInTree = function () ***REMOVED***
  var names = []
  var from = this
  while (from) ***REMOVED***
    names.unshift(from.name)
    from = from.parentGroup
  ***REMOVED***
  return names.join('/')
***REMOVED***

TrackerGroup.prototype.addUnit = function (unit, weight) ***REMOVED***
  if (unit.addUnit) ***REMOVED***
    var toTest = this
    while (toTest) ***REMOVED***
      if (unit === toTest) ***REMOVED***
        throw new Error(
          'Attempted to add tracker group ' +
          unit.name + ' to tree that already includes it ' +
          this.nameInTree(this))
      ***REMOVED***
      toTest = toTest.parentGroup
    ***REMOVED***
    unit.parentGroup = this
  ***REMOVED***
  this.weight[unit.id] = weight || 1
  this.totalWeight += this.weight[unit.id]
  this.trackers.push(unit)
  this.completion[unit.id] = unit.completed()
  unit.on('change', this.bubbleChange)
  if (!this.finished) this.emit('change', unit.name, this.completion[unit.id], unit)
  return unit
***REMOVED***

TrackerGroup.prototype.completed = function () ***REMOVED***
  if (this.trackers.length === 0) return 0
  var valPerWeight = 1 / this.totalWeight
  var completed = 0
  for (var ii = 0; ii < this.trackers.length; ii++) ***REMOVED***
    var trackerId = this.trackers[ii].id
    completed += valPerWeight * this.weight[trackerId] * this.completion[trackerId]
  ***REMOVED***
  return completed
***REMOVED***

TrackerGroup.prototype.newGroup = function (name, weight) ***REMOVED***
  return this.addUnit(new TrackerGroup(name), weight)
***REMOVED***

TrackerGroup.prototype.newItem = function (name, todo, weight) ***REMOVED***
  return this.addUnit(new Tracker(name, todo), weight)
***REMOVED***

TrackerGroup.prototype.newStream = function (name, todo, weight) ***REMOVED***
  return this.addUnit(new TrackerStream(name, todo), weight)
***REMOVED***

TrackerGroup.prototype.finish = function () ***REMOVED***
  this.finished = true
  if (!this.trackers.length) this.addUnit(new Tracker(), 1, true)
  for (var ii = 0; ii < this.trackers.length; ii++) ***REMOVED***
    var tracker = this.trackers[ii]
    tracker.finish()
    tracker.removeListener('change', this.bubbleChange)
  ***REMOVED***
  this.emit('change', this.name, 1, this)
***REMOVED***

var buffer = '                                  '
TrackerGroup.prototype.debug = function (depth) ***REMOVED***
  depth = depth || 0
  var indent = depth ? buffer.substr(0, depth) : ''
  var output = indent + (this.name || 'top') + ': ' + this.completed() + '\n'
  this.trackers.forEach(function (tracker) ***REMOVED***
    if (tracker instanceof TrackerGroup) ***REMOVED***
      output += tracker.debug(depth + 1)
    ***REMOVED*** else ***REMOVED***
      output += indent + ' ' + tracker.name + ': ' + tracker.completed() + '\n'
    ***REMOVED***
  ***REMOVED***)
  return output
***REMOVED***
