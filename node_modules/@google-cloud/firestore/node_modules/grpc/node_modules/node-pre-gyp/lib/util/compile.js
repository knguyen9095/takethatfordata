"use strict";

module.exports = exports;

var fs = require('fs');
var path = require('path');
var win = process.platform == 'win32';
var existsSync = fs.existsSync || path.existsSync;
var cp = require('child_process');

// try to build up the complete path to node-gyp
/* priority:
  - node-gyp on ENV:npm_config_node_gyp (https://github.com/npm/npm/pull/4887)
  - node-gyp on NODE_PATH
  - node-gyp inside npm on NODE_PATH (ignore on iojs)
  - node-gyp inside npm beside node exe
*/
function which_node_gyp() ***REMOVED***
    var node_gyp_bin;
    if (process.env.npm_config_node_gyp) ***REMOVED***
      try ***REMOVED***
          node_gyp_bin = process.env.npm_config_node_gyp;
          if (existsSync(node_gyp_bin)) ***REMOVED***
              return node_gyp_bin;
          ***REMOVED***
      ***REMOVED*** catch (err) ***REMOVED*** ***REMOVED***
    ***REMOVED***
    try ***REMOVED***
        var node_gyp_main = require.resolve('node-gyp');
        node_gyp_bin = path.join(path.dirname(
                                     path.dirname(node_gyp_main)),
                                     'bin/node-gyp.js');
        if (existsSync(node_gyp_bin)) ***REMOVED***
            return node_gyp_bin;
        ***REMOVED***
    ***REMOVED*** catch (err) ***REMOVED*** ***REMOVED***
    if (process.execPath.indexOf('iojs') === -1) ***REMOVED***
        try ***REMOVED***
            var npm_main = require.resolve('npm');
            node_gyp_bin = path.join(path.dirname(
                                         path.dirname(npm_main)),
                                         'node_modules/node-gyp/bin/node-gyp.js');
            if (existsSync(node_gyp_bin)) ***REMOVED***
                return node_gyp_bin;
            ***REMOVED***
        ***REMOVED*** catch (err) ***REMOVED*** ***REMOVED***
    ***REMOVED***
    var npm_base = path.join(path.dirname(
                             path.dirname(process.execPath)),
                             'lib/node_modules/npm/');
    node_gyp_bin = path.join(npm_base, 'node_modules/node-gyp/bin/node-gyp.js');
    if (existsSync(node_gyp_bin)) ***REMOVED***
        return node_gyp_bin;
    ***REMOVED***
***REMOVED***

module.exports.run_gyp = function(args,opts,callback) ***REMOVED***
    var shell_cmd = '';
    var cmd_args = [];
    if (opts.runtime && opts.runtime == 'node-webkit') ***REMOVED***
        shell_cmd = 'nw-gyp';
        if (win) shell_cmd += '.cmd';
    ***REMOVED*** else ***REMOVED***
        var node_gyp_path = which_node_gyp();
        if (node_gyp_path) ***REMOVED***
            shell_cmd = process.execPath;
            cmd_args.push(node_gyp_path);
        ***REMOVED*** else ***REMOVED***
            shell_cmd = 'node-gyp';
            if (win) shell_cmd += '.cmd';
        ***REMOVED***
    ***REMOVED***
    var final_args = cmd_args.concat(args);
    var cmd = cp.spawn(shell_cmd, final_args, ***REMOVED***cwd: undefined, env: process.env, stdio: [ 0, 1, 2]***REMOVED***);
    cmd.on('error', function (err) ***REMOVED***
        if (err) ***REMOVED***
            return callback(new Error("Failed to execute '" + shell_cmd + ' ' + final_args.join(' ') + "' (" + err + ")"));
        ***REMOVED***
        callback(null,opts);
    ***REMOVED***);
    cmd.on('close', function (code) ***REMOVED***
        if (code && code !== 0) ***REMOVED***
            return callback(new Error("Failed to execute '" + shell_cmd + ' ' + final_args.join(' ') + "' (" + code + ")"));
        ***REMOVED***
        callback(null,opts);
    ***REMOVED***);
***REMOVED***;
