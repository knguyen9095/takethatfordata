var json = typeof JSON !== 'undefined' ? JSON : require('jsonify');

module.exports = function (obj, opts) ***REMOVED***
    if (!opts) opts = ***REMOVED******REMOVED***;
    if (typeof opts === 'function') opts = ***REMOVED*** cmp: opts ***REMOVED***;
    var space = opts.space || '';
    if (typeof space === 'number') space = Array(space+1).join(' ');
    var cycles = (typeof opts.cycles === 'boolean') ? opts.cycles : false;
    var replacer = opts.replacer || function(key, value) ***REMOVED*** return value; ***REMOVED***;

    var cmp = opts.cmp && (function (f) ***REMOVED***
        return function (node) ***REMOVED***
            return function (a, b) ***REMOVED***
                var aobj = ***REMOVED*** key: a, value: node[a] ***REMOVED***;
                var bobj = ***REMOVED*** key: b, value: node[b] ***REMOVED***;
                return f(aobj, bobj);
            ***REMOVED***;
        ***REMOVED***;
    ***REMOVED***)(opts.cmp);

    var seen = [];
    return (function stringify (parent, key, node, level) ***REMOVED***
        var indent = space ? ('\n' + new Array(level + 1).join(space)) : '';
        var colonSeparator = space ? ': ' : ':';

        if (node && node.toJSON && typeof node.toJSON === 'function') ***REMOVED***
            node = node.toJSON();
        ***REMOVED***

        node = replacer.call(parent, key, node);

        if (node === undefined) ***REMOVED***
            return;
        ***REMOVED***
        if (typeof node !== 'object' || node === null) ***REMOVED***
            return json.stringify(node);
        ***REMOVED***
        if (isArray(node)) ***REMOVED***
            var out = [];
            for (var i = 0; i < node.length; i++) ***REMOVED***
                var item = stringify(node, i, node[i], level+1) || json.stringify(null);
                out.push(indent + space + item);
            ***REMOVED***
            return '[' + out.join(',') + indent + ']';
        ***REMOVED***
        else ***REMOVED***
            if (seen.indexOf(node) !== -1) ***REMOVED***
                if (cycles) return json.stringify('__cycle__');
                throw new TypeError('Converting circular structure to JSON');
            ***REMOVED***
            else seen.push(node);

            var keys = objectKeys(node).sort(cmp && cmp(node));
            var out = [];
            for (var i = 0; i < keys.length; i++) ***REMOVED***
                var key = keys[i];
                var value = stringify(node, key, node[key], level+1);

                if(!value) continue;

                var keyValue = json.stringify(key)
                    + colonSeparator
                    + value;
                ;
                out.push(indent + space + keyValue);
            ***REMOVED***
            seen.splice(seen.indexOf(node), 1);
            return '***REMOVED***' + out.join(',') + indent + '***REMOVED***';
        ***REMOVED***
    ***REMOVED***)(***REMOVED*** '': obj ***REMOVED***, '', obj, 0);
***REMOVED***;

var isArray = Array.isArray || function (x) ***REMOVED***
    return ***REMOVED******REMOVED***.toString.call(x) === '[object Array]';
***REMOVED***;

var objectKeys = Object.keys || function (obj) ***REMOVED***
    var has = Object.prototype.hasOwnProperty || function () ***REMOVED*** return true ***REMOVED***;
    var keys = [];
    for (var key in obj) ***REMOVED***
        if (has.call(obj, key)) keys.push(key);
    ***REMOVED***
    return keys;
***REMOVED***;
