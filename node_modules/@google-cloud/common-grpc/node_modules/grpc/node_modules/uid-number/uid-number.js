module.exports = uidNumber

// This module calls into get-uid-gid.js, which sets the
// uid and gid to the supplied argument, in order to find out their
// numeric value.  This can't be done in the main node process,
// because otherwise node would be running as that user from this
// point on.

var child_process = require("child_process")
  , path = require("path")
  , uidSupport = process.getuid && process.setuid
  , uidCache = ***REMOVED******REMOVED***
  , gidCache = ***REMOVED******REMOVED***

function uidNumber (uid, gid, cb) ***REMOVED***
  if (!uidSupport) return cb()
  if (typeof cb !== "function") cb = gid, gid = null
  if (typeof cb !== "function") cb = uid, uid = null
  if (gid == null) gid = process.getgid()
  if (uid == null) uid = process.getuid()
  if (!isNaN(gid)) gid = gidCache[gid] = +gid
  if (!isNaN(uid)) uid = uidCache[uid] = +uid

  if (uidCache.hasOwnProperty(uid)) uid = uidCache[uid]
  if (gidCache.hasOwnProperty(gid)) gid = gidCache[gid]

  if (typeof gid === "number" && typeof uid === "number") ***REMOVED***
    return process.nextTick(cb.bind(null, null, uid, gid))
  ***REMOVED***

  var getter = require.resolve("./get-uid-gid.js")

  child_process.execFile( process.execPath
                        , [getter, uid, gid]
                        , function (code, out, stderr) ***REMOVED***
    if (code) ***REMOVED***
      var er = new Error("could not get uid/gid\n" + stderr)
      er.code = code
      return cb(er)
    ***REMOVED***

    try ***REMOVED***
      out = JSON.parse(out+"")
    ***REMOVED*** catch (ex) ***REMOVED***
      return cb(ex)
    ***REMOVED***

    if (out.error) ***REMOVED***
      var er = new Error(out.error)
      er.errno = out.errno
      return cb(er)
    ***REMOVED***

    if (isNaN(out.uid) || isNaN(out.gid)) return cb(new Error(
      "Could not get uid/gid: "+JSON.stringify(out)))

    cb(null, uidCache[uid] = +out.uid, gidCache[gid] = +out.gid)
  ***REMOVED***)
***REMOVED***
