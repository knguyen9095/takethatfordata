// Basically just a wrapper around an fs.ReadStream

module.exports = FileReader

var fs = require('graceful-fs')
var inherits = require('inherits')
var Reader = require('./reader.js')
var EOF = ***REMOVED***EOF: true***REMOVED***
var CLOSE = ***REMOVED***CLOSE: true***REMOVED***

inherits(FileReader, Reader)

function FileReader (props) ***REMOVED***
  // console.error("    FR create", props.path, props.size, new Error().stack)
  var self = this
  if (!(self instanceof FileReader)) ***REMOVED***
    throw new Error('FileReader must be called as constructor.')
  ***REMOVED***

  // should already be established as a File type
  // XXX Todo: preserve hardlinks by tracking dev+inode+nlink,
  // with a HardLinkReader class.
  if (!((props.type === 'Link' && props.Link) ||
    (props.type === 'File' && props.File))) ***REMOVED***
    throw new Error('Non-file type ' + props.type)
  ***REMOVED***

  self._buffer = []
  self._bytesEmitted = 0
  Reader.call(self, props)
***REMOVED***

FileReader.prototype._getStream = function () ***REMOVED***
  var self = this
  var stream = self._stream = fs.createReadStream(self._path, self.props)

  if (self.props.blksize) ***REMOVED***
    stream.bufferSize = self.props.blksize
  ***REMOVED***

  stream.on('open', self.emit.bind(self, 'open'))

  stream.on('data', function (c) ***REMOVED***
    // console.error('\t\t%d %s', c.length, self.basename)
    self._bytesEmitted += c.length
    // no point saving empty chunks
    if (!c.length) ***REMOVED***
      return
    ***REMOVED*** else if (self._paused || self._buffer.length) ***REMOVED***
      self._buffer.push(c)
      self._read()
    ***REMOVED*** else self.emit('data', c)
  ***REMOVED***)

  stream.on('end', function () ***REMOVED***
    if (self._paused || self._buffer.length) ***REMOVED***
      // console.error('FR Buffering End', self._path)
      self._buffer.push(EOF)
      self._read()
    ***REMOVED*** else ***REMOVED***
      self.emit('end')
    ***REMOVED***

    if (self._bytesEmitted !== self.props.size) ***REMOVED***
      self.error("Didn't get expected byte count\n" +
        'expect: ' + self.props.size + '\n' +
        'actual: ' + self._bytesEmitted)
    ***REMOVED***
  ***REMOVED***)

  stream.on('close', function () ***REMOVED***
    if (self._paused || self._buffer.length) ***REMOVED***
      // console.error('FR Buffering Close', self._path)
      self._buffer.push(CLOSE)
      self._read()
    ***REMOVED*** else ***REMOVED***
      // console.error('FR close 1', self._path)
      self.emit('close')
    ***REMOVED***
  ***REMOVED***)

  stream.on('error', function (e) ***REMOVED***
    self.emit('error', e)
  ***REMOVED***)

  self._read()
***REMOVED***

FileReader.prototype._read = function () ***REMOVED***
  var self = this
  // console.error('FR _read', self._path)
  if (self._paused) ***REMOVED***
    // console.error('FR _read paused', self._path)
    return
  ***REMOVED***

  if (!self._stream) ***REMOVED***
    // console.error('FR _getStream calling', self._path)
    return self._getStream()
  ***REMOVED***

  // clear out the buffer, if there is one.
  if (self._buffer.length) ***REMOVED***
    // console.error('FR _read has buffer', self._buffer.length, self._path)
    var buf = self._buffer
    for (var i = 0, l = buf.length; i < l; i++) ***REMOVED***
      var c = buf[i]
      if (c === EOF) ***REMOVED***
        // console.error('FR Read emitting buffered end', self._path)
        self.emit('end')
      ***REMOVED*** else if (c === CLOSE) ***REMOVED***
        // console.error('FR Read emitting buffered close', self._path)
        self.emit('close')
      ***REMOVED*** else ***REMOVED***
        // console.error('FR Read emitting buffered data', self._path)
        self.emit('data', c)
      ***REMOVED***

      if (self._paused) ***REMOVED***
        // console.error('FR Read Re-pausing at '+i, self._path)
        self._buffer = buf.slice(i)
        return
      ***REMOVED***
    ***REMOVED***
    self._buffer.length = 0
  ***REMOVED***
// console.error("FR _read done")
// that's about all there is to it.
***REMOVED***

FileReader.prototype.pause = function (who) ***REMOVED***
  var self = this
  // console.error('FR Pause', self._path)
  if (self._paused) return
  who = who || self
  self._paused = true
  if (self._stream) self._stream.pause()
  self.emit('pause', who)
***REMOVED***

FileReader.prototype.resume = function (who) ***REMOVED***
  var self = this
  // console.error('FR Resume', self._path)
  if (!self._paused) return
  who = who || self
  self.emit('resume', who)
  self._paused = false
  if (self._stream) self._stream.resume()
  self._read()
***REMOVED***
