/* Copyright (c) 2016, Google Inc.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
 * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
 * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
 * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE. */

#if !defined(__STDC_FORMAT_MACROS)
#define __STDC_FORMAT_MACROS
#endif

#include <openssl/base.h>

#include <stdio.h>
#include <string.h>

#include <openssl/bn.h>
#include <openssl/mem.h>

#include "../bn/internal.h"
#include "../test/file_test.h"
#include "p256-x86_64.h"


// Disable tests if BORINGSSL_SHARED_LIBRARY is defined. These tests need access
// to internal functions.
#if !defined(OPENSSL_NO_ASM) && defined(OPENSSL_X86_64) && \
    !defined(OPENSSL_SMALL) && !defined(BORINGSSL_SHARED_LIBRARY)

static bool TestSelectW5() ***REMOVED***
  // Fill a table with some garbage input.
  P256_POINT table[16];
  for (size_t i = 0; i < 16; i++) ***REMOVED***
    OPENSSL_memset(table[i].X, 3 * i, sizeof(table[i].X));
    OPENSSL_memset(table[i].Y, 3 * i + 1, sizeof(table[i].Y));
    OPENSSL_memset(table[i].Z, 3 * i + 2, sizeof(table[i].Z));
  ***REMOVED***

  for (int i = 0; i <= 16; i++) ***REMOVED***
    P256_POINT val;
    ecp_nistz256_select_w5(&val, table, i);

    P256_POINT expected;
    if (i == 0) ***REMOVED***
      OPENSSL_memset(&expected, 0, sizeof(expected));
    ***REMOVED*** else ***REMOVED***
      expected = table[i-1];
    ***REMOVED***

    if (OPENSSL_memcmp(&val, &expected, sizeof(P256_POINT)) != 0) ***REMOVED***
      fprintf(stderr, "ecp_nistz256_select_w5(%d) gave the wrong value.\n", i);
      return false;
    ***REMOVED***
  ***REMOVED***

  return true;
***REMOVED***

static bool TestSelectW7() ***REMOVED***
  // Fill a table with some garbage input.
  P256_POINT_AFFINE table[64];
  for (size_t i = 0; i < 64; i++) ***REMOVED***
    OPENSSL_memset(table[i].X, 2 * i, sizeof(table[i].X));
    OPENSSL_memset(table[i].Y, 2 * i + 1, sizeof(table[i].Y));
  ***REMOVED***

  for (int i = 0; i <= 64; i++) ***REMOVED***
    P256_POINT_AFFINE val;
    ecp_nistz256_select_w7(&val, table, i);

    P256_POINT_AFFINE expected;
    if (i == 0) ***REMOVED***
      OPENSSL_memset(&expected, 0, sizeof(expected));
    ***REMOVED*** else ***REMOVED***
      expected = table[i-1];
    ***REMOVED***

    if (OPENSSL_memcmp(&val, &expected, sizeof(P256_POINT_AFFINE)) != 0) ***REMOVED***
      fprintf(stderr, "ecp_nistz256_select_w7(%d) gave the wrong value.\n", i);
      return false;
    ***REMOVED***
  ***REMOVED***

  return true;
***REMOVED***

static bool GetFieldElement(FileTest *t, BN_ULONG out[P256_LIMBS],
                            const char *name) ***REMOVED***
  std::vector<uint8_t> bytes;
  if (!t->GetBytes(&bytes, name)) ***REMOVED***
    return false;
  ***REMOVED***

  if (bytes.size() != BN_BYTES * P256_LIMBS) ***REMOVED***
    t->PrintLine("Invalid length: %s", name);
    return false;
  ***REMOVED***

  // |byte| contains bytes in big-endian while |out| should contain |BN_ULONG|s
  // in little-endian.
  OPENSSL_memset(out, 0, P256_LIMBS * sizeof(BN_ULONG));
  for (size_t i = 0; i < bytes.size(); i++) ***REMOVED***
    out[P256_LIMBS - 1 - (i / BN_BYTES)] <<= 8;
    out[P256_LIMBS - 1 - (i / BN_BYTES)] |= bytes[i];
  ***REMOVED***

  return true;
***REMOVED***

static std::string FieldElementToString(const BN_ULONG a[P256_LIMBS]) ***REMOVED***
  std::string ret;
  for (size_t i = P256_LIMBS-1; i < P256_LIMBS; i--) ***REMOVED***
    char buf[2 * BN_BYTES + 1];
    BIO_snprintf(buf, sizeof(buf), BN_HEX_FMT2, a[i]);
    ret += buf;
  ***REMOVED***
  return ret;
***REMOVED***

static bool ExpectFieldElementsEqual(FileTest *t, const char *message,
                                     const BN_ULONG expected[P256_LIMBS],
                                     const BN_ULONG actual[P256_LIMBS]) ***REMOVED***
  if (OPENSSL_memcmp(expected, actual, sizeof(BN_ULONG) * P256_LIMBS) == 0) ***REMOVED***
    return true;
  ***REMOVED***

  t->PrintLine("%s", message);
  t->PrintLine("Expected: %s", FieldElementToString(expected).c_str());
  t->PrintLine("Actual:   %s", FieldElementToString(actual).c_str());
  return false;
***REMOVED***

static bool PointToAffine(P256_POINT_AFFINE *out, const P256_POINT *in) ***REMOVED***
  static const uint8_t kP[] = ***REMOVED***
      0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  ***REMOVED***;

  bssl::UniquePtr<BIGNUM> x(BN_new()), y(BN_new()), z(BN_new());
  bssl::UniquePtr<BIGNUM> p(BN_bin2bn(kP, sizeof(kP), nullptr));
  if (!x || !y || !z || !p ||
      !bn_set_words(x.get(), in->X, P256_LIMBS) ||
      !bn_set_words(y.get(), in->Y, P256_LIMBS) ||
      !bn_set_words(z.get(), in->Z, P256_LIMBS)) ***REMOVED***
    return false;
  ***REMOVED***

  // Coordinates must be fully-reduced.
  if (BN_cmp(x.get(), p.get()) >= 0 ||
      BN_cmp(y.get(), p.get()) >= 0 ||
      BN_cmp(z.get(), p.get()) >= 0) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memset(out, 0, sizeof(P256_POINT_AFFINE));

  if (BN_is_zero(z.get())) ***REMOVED***
    // The point at infinity is represented as (0, 0).
    return true;
  ***REMOVED***

  bssl::UniquePtr<BN_CTX> ctx(BN_CTX_new());
  bssl::UniquePtr<BN_MONT_CTX> mont(BN_MONT_CTX_new());
  if (!ctx || !mont ||
      !BN_MONT_CTX_set(mont.get(), p.get(), ctx.get()) ||
      // Invert Z.
      !BN_from_montgomery(z.get(), z.get(), mont.get(), ctx.get()) ||
      !BN_mod_inverse(z.get(), z.get(), p.get(), ctx.get()) ||
      !BN_to_montgomery(z.get(), z.get(), mont.get(), ctx.get()) ||
      // Convert (X, Y, Z) to (X/Z^2, Y/Z^3).
      !BN_mod_mul_montgomery(x.get(), x.get(), z.get(), mont.get(),
                             ctx.get()) ||
      !BN_mod_mul_montgomery(x.get(), x.get(), z.get(), mont.get(),
                             ctx.get()) ||
      !BN_mod_mul_montgomery(y.get(), y.get(), z.get(), mont.get(),
                             ctx.get()) ||
      !BN_mod_mul_montgomery(y.get(), y.get(), z.get(), mont.get(),
                             ctx.get()) ||
      !BN_mod_mul_montgomery(y.get(), y.get(), z.get(), mont.get(),
                             ctx.get())) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(out->X, x->d, sizeof(BN_ULONG) * x->top);
  OPENSSL_memcpy(out->Y, y->d, sizeof(BN_ULONG) * y->top);
  return true;
***REMOVED***

static bool ExpectPointsEqual(FileTest *t, const char *message,
                              const P256_POINT_AFFINE *expected,
                              const P256_POINT *point) ***REMOVED***
  // There are multiple representations of the same |P256_POINT|, so convert to
  // |P256_POINT_AFFINE| and compare.
  P256_POINT_AFFINE affine;
  if (!PointToAffine(&affine, point)) ***REMOVED***
    t->PrintLine("%s", message);
    t->PrintLine("Could not convert to affine: (%s, %s, %s)",
                 FieldElementToString(point->X).c_str(),
                 FieldElementToString(point->Y).c_str(),
                 FieldElementToString(point->Z).c_str());
    return false;
  ***REMOVED***

  if (OPENSSL_memcmp(expected, &affine, sizeof(P256_POINT_AFFINE)) != 0) ***REMOVED***
    t->PrintLine("%s", message);
    t->PrintLine("Expected: (%s, %s)",
                 FieldElementToString(expected->X).c_str(),
                 FieldElementToString(expected->Y).c_str());
    t->PrintLine("Actual:   (%s, %s)", FieldElementToString(affine.X).c_str(),
                 FieldElementToString(affine.Y).c_str());
    return false;
  ***REMOVED***

  return true;
***REMOVED***

static bool TestNegate(FileTest *t) ***REMOVED***
  BN_ULONG a[P256_LIMBS], b[P256_LIMBS];
  if (!GetFieldElement(t, a, "A") ||
      !GetFieldElement(t, b, "B")) ***REMOVED***
    return false;
  ***REMOVED***

  // Test that -A = B.
  BN_ULONG ret[P256_LIMBS];
  ecp_nistz256_neg(ret, a);
  if (!ExpectFieldElementsEqual(t, "ecp_nistz256_neg(A) was incorrect.", b,
                                ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, a, sizeof(ret));
  ecp_nistz256_neg(ret, ret);
  if (!ExpectFieldElementsEqual(
          t, "In-place ecp_nistz256_neg(A) was incorrect.", b, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  // Test that -B = A.
  ecp_nistz256_neg(ret, b);
  if (!ExpectFieldElementsEqual(t, "ecp_nistz256_neg(B) was incorrect.", a,
                                ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, b, sizeof(ret));
  ecp_nistz256_neg(ret, ret);
  if (!ExpectFieldElementsEqual(
          t, "In-place ecp_nistz256_neg(B) was incorrect.", a, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  return true;
***REMOVED***

static bool TestMulMont(FileTest *t) ***REMOVED***
  BN_ULONG a[P256_LIMBS], b[P256_LIMBS], result[P256_LIMBS];
  if (!GetFieldElement(t, a, "A") ||
      !GetFieldElement(t, b, "B") ||
      !GetFieldElement(t, result, "Result")) ***REMOVED***
    return false;
  ***REMOVED***

  BN_ULONG ret[P256_LIMBS];
  ecp_nistz256_mul_mont(ret, a, b);
  if (!ExpectFieldElementsEqual(t, "ecp_nistz256_mul_mont(A, B) was incorrect.",
                                result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  ecp_nistz256_mul_mont(ret, b, a);
  if (!ExpectFieldElementsEqual(t, "ecp_nistz256_mul_mont(B, A) was incorrect.",
                                result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, a, sizeof(ret));
  ecp_nistz256_mul_mont(ret, ret, b);
  if (!ExpectFieldElementsEqual(
          t, "ecp_nistz256_mul_mont(ret = A, B) was incorrect.", result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, a, sizeof(ret));
  ecp_nistz256_mul_mont(ret, b, ret);
  if (!ExpectFieldElementsEqual(
          t, "ecp_nistz256_mul_mont(B, ret = A) was incorrect.", result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, b, sizeof(ret));
  ecp_nistz256_mul_mont(ret, a, ret);
  if (!ExpectFieldElementsEqual(
          t, "ecp_nistz256_mul_mont(A, ret = B) was incorrect.", result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, b, sizeof(ret));
  ecp_nistz256_mul_mont(ret, ret, a);
  if (!ExpectFieldElementsEqual(
          t, "ecp_nistz256_mul_mont(ret = B, A) was incorrect.", result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  if (OPENSSL_memcmp(a, b, sizeof(a)) == 0) ***REMOVED***
    ecp_nistz256_sqr_mont(ret, a);
    if (!ExpectFieldElementsEqual(t, "ecp_nistz256_sqr_mont(A) was incorrect.",
                                  result, ret)) ***REMOVED***
      return false;
    ***REMOVED***

    OPENSSL_memcpy(ret, a, sizeof(ret));
    ecp_nistz256_sqr_mont(ret, ret);
    if (!ExpectFieldElementsEqual(
            t, "ecp_nistz256_sqr_mont(ret = A) was incorrect.", result, ret)) ***REMOVED***
      return false;
    ***REMOVED***
  ***REMOVED***

  return true;
***REMOVED***

static bool TestFromMont(FileTest *t) ***REMOVED***
  BN_ULONG a[P256_LIMBS], result[P256_LIMBS];
  if (!GetFieldElement(t, a, "A") ||
      !GetFieldElement(t, result, "Result")) ***REMOVED***
    return false;
  ***REMOVED***

  BN_ULONG ret[P256_LIMBS];
  ecp_nistz256_from_mont(ret, a);
  if (!ExpectFieldElementsEqual(t, "ecp_nistz256_from_mont(A) was incorrect.",
                                result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(ret, a, sizeof(ret));
  ecp_nistz256_from_mont(ret, ret);
  if (!ExpectFieldElementsEqual(
          t, "ecp_nistz256_from_mont(ret = A) was incorrect.", result, ret)) ***REMOVED***
    return false;
  ***REMOVED***

  return true;
***REMOVED***

static bool TestPointAdd(FileTest *t) ***REMOVED***
  P256_POINT a, b;
  P256_POINT_AFFINE result;
  if (!GetFieldElement(t, a.X, "A.X") ||
      !GetFieldElement(t, a.Y, "A.Y") ||
      !GetFieldElement(t, a.Z, "A.Z") ||
      !GetFieldElement(t, b.X, "B.X") ||
      !GetFieldElement(t, b.Y, "B.Y") ||
      !GetFieldElement(t, b.Z, "B.Z") ||
      !GetFieldElement(t, result.X, "Result.X") ||
      !GetFieldElement(t, result.Y, "Result.Y")) ***REMOVED***
    return false;
  ***REMOVED***

  P256_POINT ret;
  ecp_nistz256_point_add(&ret, &a, &b);
  if (!ExpectPointsEqual(t, "ecp_nistz256_point_add(A, B) was incorrect.",
                         &result, &ret)) ***REMOVED***
    return false;
  ***REMOVED***

  ecp_nistz256_point_add(&ret, &b, &a);
  if (!ExpectPointsEqual(t, "ecp_nistz256_point_add(B, A) was incorrect.",
                         &result, &ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(&ret, &a, sizeof(ret));
  ecp_nistz256_point_add(&ret, &ret, &b);
  if (!ExpectPointsEqual(t, "ecp_nistz256_point_add(ret = A, B) was incorrect.",
                         &result, &ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(&ret, &a, sizeof(ret));
  ecp_nistz256_point_add(&ret, &b, &ret);
  if (!ExpectPointsEqual(t, "ecp_nistz256_point_add(B, ret = A) was incorrect.",
                         &result, &ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(&ret, &b, sizeof(ret));
  ecp_nistz256_point_add(&ret, &a, &ret);
  if (!ExpectPointsEqual(t, "ecp_nistz256_point_add(ret = A, B) was incorrect.",
                         &result, &ret)) ***REMOVED***
    return false;
  ***REMOVED***

  OPENSSL_memcpy(&ret, &b, sizeof(ret));
  ecp_nistz256_point_add(&ret, &ret, &a);
  if (!ExpectPointsEqual(t, "ecp_nistz256_point_add(ret = B, A) was incorrect.",
                         &result, &ret)) ***REMOVED***
    return false;
  ***REMOVED***

  P256_POINT_AFFINE a_affine, b_affine, infinity;
  OPENSSL_memset(&infinity, 0, sizeof(infinity));
  if (!PointToAffine(&a_affine, &a) ||
      !PointToAffine(&b_affine, &b)) ***REMOVED***
    return false;
  ***REMOVED***

  // ecp_nistz256_point_add_affine does not work when a == b unless doubling the
  // point at infinity.
  if (OPENSSL_memcmp(&a_affine, &b_affine, sizeof(a_affine)) != 0 ||
      OPENSSL_memcmp(&a_affine, &infinity, sizeof(a_affine)) == 0) ***REMOVED***
    ecp_nistz256_point_add_affine(&ret, &a, &b_affine);
    if (!ExpectPointsEqual(t,
                           "ecp_nistz256_point_add_affine(A, B) was incorrect.",
                           &result, &ret)) ***REMOVED***
      return false;
    ***REMOVED***

    OPENSSL_memcpy(&ret, &a, sizeof(ret));
    ecp_nistz256_point_add_affine(&ret, &ret, &b_affine);
    if (!ExpectPointsEqual(
            t, "ecp_nistz256_point_add_affine(ret = A, B) was incorrect.",
            &result, &ret)) ***REMOVED***
      return false;
    ***REMOVED***

    ecp_nistz256_point_add_affine(&ret, &b, &a_affine);
    if (!ExpectPointsEqual(t,
                           "ecp_nistz256_point_add_affine(B, A) was incorrect.",
                           &result, &ret)) ***REMOVED***
      return false;
    ***REMOVED***

    OPENSSL_memcpy(&ret, &b, sizeof(ret));
    ecp_nistz256_point_add_affine(&ret, &ret, &a_affine);
    if (!ExpectPointsEqual(
            t, "ecp_nistz256_point_add_affine(ret = B, A) was incorrect.",
            &result, &ret)) ***REMOVED***
      return false;
    ***REMOVED***
  ***REMOVED***

  if (OPENSSL_memcmp(&a, &b, sizeof(a)) == 0) ***REMOVED***
    ecp_nistz256_point_double(&ret, &a);
    if (!ExpectPointsEqual(t, "ecp_nistz256_point_double(A) was incorrect.",
                           &result, &ret)) ***REMOVED***
      return false;
    ***REMOVED***

    ret = a;
    ecp_nistz256_point_double(&ret, &ret);
    if (!ExpectPointsEqual(
            t, "In-place ecp_nistz256_point_double(A) was incorrect.", &result,
            &ret)) ***REMOVED***
      return false;
    ***REMOVED***
  ***REMOVED***

  return true;
***REMOVED***

int main(int argc, char **argv) ***REMOVED***
  if (argc != 2) ***REMOVED***
    fprintf(stderr, "%s TEST_FILE\n", argv[0]);
    return 1;
  ***REMOVED***

  if (!TestSelectW5() ||
      !TestSelectW7()) ***REMOVED***
    return 1;
  ***REMOVED***

  return FileTestMain([](FileTest *t, void *) -> bool ***REMOVED***
    if (t->GetParameter() == "Negate") ***REMOVED***
      return TestNegate(t);
    ***REMOVED***
    if (t->GetParameter() == "MulMont") ***REMOVED***
      return TestMulMont(t);
    ***REMOVED***
    if (t->GetParameter() == "FromMont") ***REMOVED***
      return TestFromMont(t);
    ***REMOVED***
    if (t->GetParameter() == "PointAdd") ***REMOVED***
      return TestPointAdd(t);
    ***REMOVED***

    t->PrintLine("Unknown test type: %s", t->GetParameter().c_str());
    return false;
  ***REMOVED***, nullptr, argv[1]);
***REMOVED***

#else

int main() ***REMOVED***
  printf("PASS\n");
  return 0;
***REMOVED***

#endif
