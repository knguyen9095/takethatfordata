'use strict';
const pTry = require('p-try');

module.exports = concurrency => ***REMOVED***
	if (concurrency < 1) ***REMOVED***
		throw new TypeError('Expected `concurrency` to be a number from 1 and up');
	***REMOVED***

	const queue = [];
	let activeCount = 0;

	const next = () => ***REMOVED***
		activeCount--;

		if (queue.length > 0) ***REMOVED***
			queue.shift()();
		***REMOVED***
	***REMOVED***;

	return fn => new Promise((resolve, reject) => ***REMOVED***
		const run = () => ***REMOVED***
			activeCount++;

			pTry(() => fn()).then(
				val => ***REMOVED***
					resolve(val);
					next();
				***REMOVED***,
				err => ***REMOVED***
					reject(err);
					next();
				***REMOVED***
			);
		***REMOVED***;

		if (activeCount < concurrency) ***REMOVED***
			run();
		***REMOVED*** else ***REMOVED***
			queue.push(run);
		***REMOVED***
	***REMOVED***);
***REMOVED***;
