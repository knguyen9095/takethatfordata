var global = require('./_global');
var macrotask = require('./_task').set;
var Observer = global.MutationObserver || global.WebKitMutationObserver;
var process = global.process;
var Promise = global.Promise;
var isNode = require('./_cof')(process) == 'process';

module.exports = function () ***REMOVED***
  var head, last, notify;

  var flush = function () ***REMOVED***
    var parent, fn;
    if (isNode && (parent = process.domain)) parent.exit();
    while (head) ***REMOVED***
      fn = head.fn;
      head = head.next;
      try ***REMOVED***
        fn();
      ***REMOVED*** catch (e) ***REMOVED***
        if (head) notify();
        else last = undefined;
        throw e;
      ***REMOVED***
    ***REMOVED*** last = undefined;
    if (parent) parent.enter();
  ***REMOVED***;

  // Node.js
  if (isNode) ***REMOVED***
    notify = function () ***REMOVED***
      process.nextTick(flush);
    ***REMOVED***;
  // browsers with MutationObserver, except iOS Safari - https://github.com/zloirock/core-js/issues/339
  ***REMOVED*** else if (Observer && !(global.navigator && global.navigator.standalone)) ***REMOVED***
    var toggle = true;
    var node = document.createTextNode('');
    new Observer(flush).observe(node, ***REMOVED*** characterData: true ***REMOVED***); // eslint-disable-line no-new
    notify = function () ***REMOVED***
      node.data = toggle = !toggle;
    ***REMOVED***;
  // environments with maybe non-completely correct, but existent Promise
  ***REMOVED*** else if (Promise && Promise.resolve) ***REMOVED***
    var promise = Promise.resolve();
    notify = function () ***REMOVED***
      promise.then(flush);
    ***REMOVED***;
  // for other environments - macrotask based on:
  // - setImmediate
  // - MessageChannel
  // - window.postMessag
  // - onreadystatechange
  // - setTimeout
  ***REMOVED*** else ***REMOVED***
    notify = function () ***REMOVED***
      // strange IE + webpack dev server bug - use .call(global)
      macrotask.call(global, flush);
    ***REMOVED***;
  ***REMOVED***

  return function (fn) ***REMOVED***
    var task = ***REMOVED*** fn: fn, next: undefined ***REMOVED***;
    if (last) last.next = task;
    if (!head) ***REMOVED***
      head = task;
      notify();
    ***REMOVED*** last = task;
  ***REMOVED***;
***REMOVED***;
