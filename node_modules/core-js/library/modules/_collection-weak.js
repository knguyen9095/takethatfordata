'use strict';
var redefineAll = require('./_redefine-all');
var getWeak = require('./_meta').getWeak;
var anObject = require('./_an-object');
var isObject = require('./_is-object');
var anInstance = require('./_an-instance');
var forOf = require('./_for-of');
var createArrayMethod = require('./_array-methods');
var $has = require('./_has');
var validate = require('./_validate-collection');
var arrayFind = createArrayMethod(5);
var arrayFindIndex = createArrayMethod(6);
var id = 0;

// fallback for uncaught frozen keys
var uncaughtFrozenStore = function (that) ***REMOVED***
  return that._l || (that._l = new UncaughtFrozenStore());
***REMOVED***;
var UncaughtFrozenStore = function () ***REMOVED***
  this.a = [];
***REMOVED***;
var findUncaughtFrozen = function (store, key) ***REMOVED***
  return arrayFind(store.a, function (it) ***REMOVED***
    return it[0] === key;
  ***REMOVED***);
***REMOVED***;
UncaughtFrozenStore.prototype = ***REMOVED***
  get: function (key) ***REMOVED***
    var entry = findUncaughtFrozen(this, key);
    if (entry) return entry[1];
  ***REMOVED***,
  has: function (key) ***REMOVED***
    return !!findUncaughtFrozen(this, key);
  ***REMOVED***,
  set: function (key, value) ***REMOVED***
    var entry = findUncaughtFrozen(this, key);
    if (entry) entry[1] = value;
    else this.a.push([key, value]);
  ***REMOVED***,
  'delete': function (key) ***REMOVED***
    var index = arrayFindIndex(this.a, function (it) ***REMOVED***
      return it[0] === key;
    ***REMOVED***);
    if (~index) this.a.splice(index, 1);
    return !!~index;
  ***REMOVED***
***REMOVED***;

module.exports = ***REMOVED***
  getConstructor: function (wrapper, NAME, IS_MAP, ADDER) ***REMOVED***
    var C = wrapper(function (that, iterable) ***REMOVED***
      anInstance(that, C, NAME, '_i');
      that._t = NAME;      // collection type
      that._i = id++;      // collection id
      that._l = undefined; // leak store for uncaught frozen objects
      if (iterable != undefined) forOf(iterable, IS_MAP, that[ADDER], that);
    ***REMOVED***);
    redefineAll(C.prototype, ***REMOVED***
      // 23.3.3.2 WeakMap.prototype.delete(key)
      // 23.4.3.3 WeakSet.prototype.delete(value)
      'delete': function (key) ***REMOVED***
        if (!isObject(key)) return false;
        var data = getWeak(key);
        if (data === true) return uncaughtFrozenStore(validate(this, NAME))['delete'](key);
        return data && $has(data, this._i) && delete data[this._i];
      ***REMOVED***,
      // 23.3.3.4 WeakMap.prototype.has(key)
      // 23.4.3.4 WeakSet.prototype.has(value)
      has: function has(key) ***REMOVED***
        if (!isObject(key)) return false;
        var data = getWeak(key);
        if (data === true) return uncaughtFrozenStore(validate(this, NAME)).has(key);
        return data && $has(data, this._i);
      ***REMOVED***
    ***REMOVED***);
    return C;
  ***REMOVED***,
  def: function (that, key, value) ***REMOVED***
    var data = getWeak(anObject(key), true);
    if (data === true) uncaughtFrozenStore(that).set(key, value);
    else data[that._i] = value;
    return that;
  ***REMOVED***,
  ufstore: uncaughtFrozenStore
***REMOVED***;
