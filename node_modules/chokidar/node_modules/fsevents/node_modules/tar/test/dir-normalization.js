// Set the umask, so that it works the same everywhere.
process.umask(parseInt('22', 8))

var fs = require('fs')
var path = require('path')

var fstream = require('fstream')
var test = require('tap').test

var tar = require('../tar.js')
var file = path.resolve(__dirname, 'dir-normalization.tar')
var target = path.resolve(__dirname, 'tmp/dir-normalization-test')
var ee = 0

var expectEntries = [
  ***REMOVED*** path: 'fixtures/',
    mode: '755',
    type: '5',
    linkpath: ''
  ***REMOVED***,
  ***REMOVED*** path: 'fixtures/a/',
    mode: '755',
    type: '5',
    linkpath: ''
  ***REMOVED***,
  ***REMOVED*** path: 'fixtures/the-chumbler',
    mode: '755',
    type: '2',
    linkpath: path.resolve(target, 'a/b/c/d/the-chumbler'),
  ***REMOVED***,
  ***REMOVED*** path: 'fixtures/a/b/',
    mode: '755',
    type: '5',
    linkpath: ''
  ***REMOVED***,
  ***REMOVED*** path: 'fixtures/a/x',
    mode: '644',
    type: '0',
    linkpath: ''
  ***REMOVED***,
  ***REMOVED*** path: 'fixtures/a/b/c/',
    mode: '755',
    type: '5',
    linkpath: ''
  ***REMOVED***,
  ***REMOVED*** path: 'fixtures/a/b/c/y',
    mode: '755',
    type: '2',
    linkpath: '../../x',
  ***REMOVED***
]

var ef = 0
var expectFiles = [
  ***REMOVED*** path: '',
    mode: '40755',
    type: 'Directory',
    depth: 0,
    linkpath: undefined
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures',
    mode: '40755',
    type: 'Directory',
    depth: 1,
    linkpath: undefined
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures/a',
    mode: '40755',
    type: 'Directory',
    depth: 2,
    linkpath: undefined
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures/a/b',
    mode: '40755',
    type: 'Directory',
    depth: 3,
    linkpath: undefined
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures/a/b/c',
    mode: '40755',
    type: 'Directory',
    depth: 4,
    linkpath: undefined
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures/a/b/c/y',
    mode: '120755',
    type: 'SymbolicLink',
    depth: 5,
    linkpath: '../../x'
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures/a/x',
    mode: '100644',
    type: 'File',
    depth: 3,
    linkpath: undefined
  ***REMOVED***,
  ***REMOVED*** path: '/fixtures/the-chumbler',
    mode: '120755',
    type: 'SymbolicLink',
    depth: 2,
    linkpath: path.resolve(target, 'a/b/c/d/the-chumbler')
  ***REMOVED***
]

test('preclean', function (t) ***REMOVED***
  require('rimraf').sync(path.join(__dirname, '/tmp/dir-normalization-test'))
  t.pass('cleaned!')
  t.end()
***REMOVED***)

test('extract test', function (t) ***REMOVED***
  var extract = tar.Extract(target)
  var inp = fs.createReadStream(file)

  inp.pipe(extract)

  extract.on('end', function () ***REMOVED***
    t.equal(ee, expectEntries.length, 'should see ' + expectEntries.length + ' entries')

    // should get no more entries after end
    extract.removeAllListeners('entry')
    extract.on('entry', function (e) ***REMOVED***
      t.fail('Should not get entries after end!')
    ***REMOVED***)

    next()
  ***REMOVED***)

  extract.on('entry', function (entry) ***REMOVED***
    var mode = entry.props.mode & (~parseInt('22', 8))
    var found = ***REMOVED***
      path: entry.path,
      mode: mode.toString(8),
      type: entry.props.type,
      linkpath: entry.props.linkpath,
    ***REMOVED***

    var wanted = expectEntries[ee++]
    t.equivalent(found, wanted, 'tar entry ' + ee + ' ' + (wanted && wanted.path))
  ***REMOVED***)

  function next () ***REMOVED***
    var r = fstream.Reader(***REMOVED***
      path: target,
      type: 'Directory',
      sort: 'alpha'
    ***REMOVED***)

    r.on('ready', function () ***REMOVED***
      foundEntry(r)
    ***REMOVED***)

    r.on('end', finish)

    function foundEntry (entry) ***REMOVED***
      var p = entry.path.substr(target.length)
      var mode = entry.props.mode & (~parseInt('22', 8))
      var found = ***REMOVED***
        path: p,
        mode: mode.toString(8),
        type: entry.props.type,
        depth: entry.props.depth,
        linkpath: entry.props.linkpath
      ***REMOVED***

      var wanted = expectFiles[ef++]
      t.equivalent(found, wanted, 'unpacked file ' + ef + ' ' + (wanted && wanted.path))

      entry.on('entry', foundEntry)
    ***REMOVED***

    function finish () ***REMOVED***
      t.equal(ef, expectFiles.length, 'should have ' + ef + ' items')
      t.end()
    ***REMOVED***
  ***REMOVED***
***REMOVED***)
