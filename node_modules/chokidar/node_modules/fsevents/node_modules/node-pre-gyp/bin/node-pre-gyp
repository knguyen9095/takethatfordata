#!/usr/bin/env node

"use strict";

/**
 * Set the title.
 */

process.title = 'node-pre-gyp';

/**
 * Module dependencies.
 */

var node_pre_gyp = require('../');
var log = require('npmlog');

/**
 * Process and execute the selected commands.
 */

var prog = new node_pre_gyp.Run();
var completed = false;
prog.parseArgv(process.argv);

if (prog.todo.length === 0) ***REMOVED***
  if (~process.argv.indexOf('-v') || ~process.argv.indexOf('--version')) ***REMOVED***
    console.log('v%s', prog.version);
    return process.exit(0);
  ***REMOVED*** else if (~process.argv.indexOf('-h') || ~process.argv.indexOf('--help')) ***REMOVED***
    console.log('%s', prog.usage());
    return process.exit(0);
  ***REMOVED***
  console.log('%s', prog.usage());
  return process.exit(1);
***REMOVED***

// if --no-color is passed
if (prog.opts && prog.opts.hasOwnProperty('color') && !prog.opts.color) ***REMOVED***
  log.disableColor();
***REMOVED***

log.info('it worked if it ends with', 'ok');
log.verbose('cli', process.argv);
log.info('using', process.title + '@%s', prog.version);
log.info('using', 'node@%s | %s | %s', process.versions.node, process.platform, process.arch);


/**
 * Change dir if -C/--directory was passed.
 */

var dir = prog.opts.directory;
if (dir) ***REMOVED***
  var fs = require('fs');
  try ***REMOVED***
    var stat = fs.statSync(dir);
    if (stat.isDirectory()) ***REMOVED***
      log.info('chdir', dir);
      process.chdir(dir);
    ***REMOVED*** else ***REMOVED***
      log.warn('chdir', dir + ' is not a directory');
    ***REMOVED***
  ***REMOVED*** catch (e) ***REMOVED***
    if (e.code === 'ENOENT') ***REMOVED***
      log.warn('chdir', dir + ' is not a directory');
    ***REMOVED*** else ***REMOVED***
      log.warn('chdir', 'error during chdir() "%s"', e.message);
    ***REMOVED***
  ***REMOVED***
***REMOVED***

function run () ***REMOVED***
  var command = prog.todo.shift();
  if (!command) ***REMOVED***
    // done!
    completed = true;
    log.info('ok');
    return;
  ***REMOVED***

  prog.commands[command.name](command.args, function (err) ***REMOVED***
    if (err) ***REMOVED***
      log.error(command.name + ' error');
      log.error('stack', err.stack);
      errorMessage();
      log.error('not ok');
      console.log(err.message);
      return process.exit(1);
    ***REMOVED***
    var args_array = [].slice.call(arguments, 1);
    if (args_array.length) ***REMOVED***
      console.log.apply(console, args_array);
    ***REMOVED***
    // now run the next command in the queue
    process.nextTick(run);
  ***REMOVED***);
***REMOVED***

process.on('exit', function (code) ***REMOVED***
  if (!completed && !code) ***REMOVED***
    log.error('Completion callback never invoked!');
    issueMessage();
    process.exit(6);
  ***REMOVED***
***REMOVED***);

process.on('uncaughtException', function (err) ***REMOVED***
  log.error('UNCAUGHT EXCEPTION');
  log.error('stack', err.stack);
  issueMessage();
  process.exit(7);
***REMOVED***);

function errorMessage () ***REMOVED***
  // copied from npm's lib/util/error-handler.js
  var os = require('os');
  log.error('System', os.type() + ' ' + os.release());
  log.error('command', process.argv.map(JSON.stringify).join(' '));
  log.error('cwd', process.cwd());
  log.error('node -v', process.version);
  log.error(process.title+' -v', 'v' + prog.package.version);
***REMOVED***

function issueMessage () ***REMOVED***
  errorMessage();
  log.error('', [ 'This is a bug in `'+process.title+'`.',
                  'Try to update '+process.title+' and file an issue if it does not help:',
                  '    <https://github.com/mapbox/'+process.title+'/issues>',
                ].join('\n'));
***REMOVED***

// start running the given commands!
run();
