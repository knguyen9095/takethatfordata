var assert = require('assert');

var uuid = require('../');

// Verify ordering of v1 ids created with explicit times
var TIME = 1321644961388; // 2011-11-18 11:36:01.388-08:00

function compare(name, ids) ***REMOVED***
  test(name, function() ***REMOVED***
    // avoid .map for older browsers
    for (var i=0 ; i<ids.length ; ++i) ***REMOVED***
      ids[i] = ids[i].split('-').reverse().join('-');
    ***REMOVED***
    ids = ids.sort();
    var sorted = ([].concat(ids)).sort();

    assert(sorted.toString() == ids.toString(), name + ' have expected order');
  ***REMOVED***);
***REMOVED***

// Verify ordering of v1 ids created using default behavior
compare('uuids with current time', [
  uuid.v1(),
  uuid.v1(),
  uuid.v1(),
  uuid.v1(),
  uuid.v1()
]);

// Verify ordering of v1 ids created with explicit times
compare('uuids with time option', [
  uuid.v1(***REMOVED***msecs: TIME - 10*3600*1000***REMOVED***),
  uuid.v1(***REMOVED***msecs: TIME - 1***REMOVED***),
  uuid.v1(***REMOVED***msecs: TIME***REMOVED***),
  uuid.v1(***REMOVED***msecs: TIME + 1***REMOVED***),
  uuid.v1(***REMOVED***msecs: TIME + 28*24*3600*1000***REMOVED***)
]);

test('msec', function() ***REMOVED***
  assert(
    uuid.v1(***REMOVED***msecs: TIME***REMOVED***) != uuid.v1(***REMOVED***msecs: TIME***REMOVED***),
    'IDs created at same msec are different'
  );
***REMOVED***);

test('exception thrown when > 10k ids created in 1ms', function() ***REMOVED***
  // Verify throw if too many ids created
  var thrown = false;
  try ***REMOVED***
    uuid.v1(***REMOVED***msecs: TIME, nsecs: 10000***REMOVED***);
  ***REMOVED*** catch (e) ***REMOVED***
    thrown = true;
  ***REMOVED***
  assert(thrown, 'Exception thrown when > 10K ids created in 1 ms');
***REMOVED***);

test('clock regression by msec', function() ***REMOVED***
  // Verify clock regression bumps clockseq
  var uidt = uuid.v1(***REMOVED***msecs: TIME***REMOVED***);
  var uidtb = uuid.v1(***REMOVED***msecs: TIME - 1***REMOVED***);
  assert(
    parseInt(uidtb.split('-')[3], 16) - parseInt(uidt.split('-')[3], 16) === 1,
    'Clock regression by msec increments the clockseq'
  );
***REMOVED***);

test('clock regression by nsec', function() ***REMOVED***
  // Verify clock regression bumps clockseq
  var uidtn = uuid.v1(***REMOVED***msecs: TIME, nsecs: 10***REMOVED***);
  var uidtnb = uuid.v1(***REMOVED***msecs: TIME, nsecs: 9***REMOVED***);
  assert(
    parseInt(uidtnb.split('-')[3], 16) - parseInt(uidtn.split('-')[3], 16) === 1,
    'Clock regression by nsec increments the clockseq'
  );
***REMOVED***);

test('explicit options product expected id', function() ***REMOVED***
  // Verify explicit options produce expected id
  var id = uuid.v1(***REMOVED***
    msecs: 1321651533573,
    nsecs: 5432,
    clockseq: 0x385c,
    node: [ 0x61, 0xcd, 0x3c, 0xbb, 0x32, 0x10 ]
  ***REMOVED***);
  assert(id == 'd9428888-122b-11e1-b85c-61cd3cbb3210', 'Explicit options produce expected id');
***REMOVED***);

test('ids spanning 1ms boundary are 100ns apart', function() ***REMOVED***
  // Verify adjacent ids across a msec boundary are 1 time unit apart
  var u0 = uuid.v1(***REMOVED***msecs: TIME, nsecs: 9999***REMOVED***);
  var u1 = uuid.v1(***REMOVED***msecs: TIME + 1, nsecs: 0***REMOVED***);

  var before = u0.split('-')[0], after = u1.split('-')[0];
  var dt = parseInt(after, 16) - parseInt(before, 16);
  assert(dt === 1, 'Ids spanning 1ms boundary are 100ns apart');
***REMOVED***);
