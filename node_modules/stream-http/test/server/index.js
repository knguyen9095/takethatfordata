var cookieParser = require('cookie-parser')
var basicAuth = require('basic-auth')
var express = require('express')
var fs = require('fs')
var http = require('http')
var path = require('path')
var url = require('url')

var app = express()
var server = http.createServer(app)

// Otherwise, use 'application/octet-stream'
var copiesMimeTypes = ***REMOVED***
	'/basic.txt': 'text/plain'
***REMOVED***

var maxDelay = 5000 // ms

// This should make sure bodies aren't cached
// so the streaming tests always pass
app.use(function (req, res, next) ***REMOVED***
	res.setHeader('Cache-Control', 'no-store')
	next()
***REMOVED***)

app.get('/testHeaders', function (req, res) ***REMOVED***
	var parsed = url.parse(req.url, true)

	// Values in query parameters are sent as response headers
	Object.keys(parsed.query).forEach(function (key) ***REMOVED***
		res.setHeader('Test-' + key, parsed.query[key])
	***REMOVED***)

	res.setHeader('Content-Type', 'application/json')
	res.setHeader('Cache-Control', 'no-cache')

	// Request headers are sent in the body as json
	var reqHeaders = ***REMOVED******REMOVED***
	Object.keys(req.headers).forEach(function (key) ***REMOVED***
		key = key.toLowerCase()
		if (key.indexOf('test-') === 0) ***REMOVED***
			// different browsers format request headers with multiple values
			// slightly differently, so normalize
			reqHeaders[key] = req.headers[key].replace(', ', ',')
		***REMOVED***
	***REMOVED***)

	var body = JSON.stringify(reqHeaders)
	res.setHeader('Content-Length', body.length)
	res.write(body)
	res.end()
***REMOVED***)

app.get('/cookie', cookieParser(), function (req, res) ***REMOVED***
	res.setHeader('Content-Type', 'text/plain')
	res.write('hello=' + req.cookies.hello)
	res.end()
***REMOVED***)

app.get('/auth', function (req, res) ***REMOVED***
	var user = basicAuth(req)

	if (!user || user.name !== 'TestUser' || user.pass !== 'trustno1') ***REMOVED***
		res.setHeader('WWW-Authenticate', 'Basic realm="example"')
		res.end('Access denied')
	***REMOVED*** else ***REMOVED***
		res.setHeader('Content-Type', 'text/plain')
		res.write('You\'re in!')
		res.end()
	***REMOVED***
***REMOVED***)

app.post('/echo', function (req, res) ***REMOVED***
	res.setHeader('Content-Type', 'application/octet-stream')
	req.pipe(res)
***REMOVED***)

app.use('/verifyEmpty', function (req, res) ***REMOVED***
	var empty = true
	req.on('data', function (buf) ***REMOVED***
		if (buf.length > 0) ***REMOVED***
			empty = false
		***REMOVED***
	***REMOVED***)
	req.on('end', function () ***REMOVED***
		res.setHeader('Content-Type', 'text/plain')

		if (empty) ***REMOVED***
			res.end('empty')
		***REMOVED*** else ***REMOVED***
			res.end('not empty')
		***REMOVED***
	***REMOVED***)
***REMOVED***)

app.use(function (req, res, next) ***REMOVED***
	var parsed = url.parse(req.url, true)

	if ('copies' in parsed.query) ***REMOVED***
		var totalCopies = parseInt(parsed.query.copies, 10)
		function fail () ***REMOVED***
			res.statusCode = 500
			res.end()
		***REMOVED***
		fs.readFile(path.join(__dirname, 'static', parsed.pathname), function (err, data) ***REMOVED***
			if (err)
				return fail()

			var mimeType = copiesMimeTypes[parsed.pathname] || 'application/octet-stream'
			res.setHeader('Content-Type', mimeType)
			res.setHeader('Content-Length', data.length * totalCopies)
			var pieceDelay = maxDelay / totalCopies
			if (pieceDelay > 100)
				pieceDelay = 100

			function write (copies) ***REMOVED***
				if (copies === 0) 
					return res.end()

				res.write(data, function (err) ***REMOVED***
					if (err)
						return fail()
					setTimeout(write.bind(null, copies - 1), pieceDelay)
				***REMOVED***)
			***REMOVED***
			write(totalCopies)
		***REMOVED***)
		return
	***REMOVED***
	next()
***REMOVED***)

app.use(express.static(path.join(__dirname, 'static')))

var port = parseInt(process.env.ZUUL_PORT) || 8199
console.log('Test server listening on port', port)
server.listen(port)
