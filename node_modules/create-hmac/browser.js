'use strict'
var inherits = require('inherits')
var Legacy = require('./legacy')
var Base = require('cipher-base')
var Buffer = require('safe-buffer').Buffer
var md5 = require('create-hash/md5')
var RIPEMD160 = require('ripemd160')

var sha = require('sha.js')

var ZEROS = Buffer.alloc(128)

function Hmac (alg, key) ***REMOVED***
  Base.call(this, 'digest')
  if (typeof key === 'string') ***REMOVED***
    key = Buffer.from(key)
  ***REMOVED***

  var blocksize = (alg === 'sha512' || alg === 'sha384') ? 128 : 64

  this._alg = alg
  this._key = key
  if (key.length > blocksize) ***REMOVED***
    var hash = alg === 'rmd160' ? new RIPEMD160() : sha(alg)
    key = hash.update(key).digest()
  ***REMOVED*** else if (key.length < blocksize) ***REMOVED***
    key = Buffer.concat([key, ZEROS], blocksize)
  ***REMOVED***

  var ipad = this._ipad = Buffer.allocUnsafe(blocksize)
  var opad = this._opad = Buffer.allocUnsafe(blocksize)

  for (var i = 0; i < blocksize; i++) ***REMOVED***
    ipad[i] = key[i] ^ 0x36
    opad[i] = key[i] ^ 0x5C
  ***REMOVED***
  this._hash = alg === 'rmd160' ? new RIPEMD160() : sha(alg)
  this._hash.update(ipad)
***REMOVED***

inherits(Hmac, Base)

Hmac.prototype._update = function (data) ***REMOVED***
  this._hash.update(data)
***REMOVED***

Hmac.prototype._final = function () ***REMOVED***
  var h = this._hash.digest()
  var hash = this._alg === 'rmd160' ? new RIPEMD160() : sha(this._alg)
  return hash.update(this._opad).update(h).digest()
***REMOVED***

module.exports = function createHmac (alg, key) ***REMOVED***
  alg = alg.toLowerCase()
  if (alg === 'rmd160' || alg === 'ripemd160') ***REMOVED***
    return new Hmac('rmd160', key)
  ***REMOVED***
  if (alg === 'md5') ***REMOVED***
    return new Legacy(md5, key)
  ***REMOVED***
  return new Hmac(alg, key)
***REMOVED***
