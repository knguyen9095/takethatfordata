'use strict';
var token = '%[a-f0-9]***REMOVED***2***REMOVED***';
var singleMatcher = new RegExp(token, 'gi');
var multiMatcher = new RegExp('(' + token + ')+', 'gi');

function decodeComponents(components, split) ***REMOVED***
	try ***REMOVED***
		// Try to decode the entire string first
		return decodeURIComponent(components.join(''));
	***REMOVED*** catch (err) ***REMOVED***
		// Do nothing
	***REMOVED***

	if (components.length === 1) ***REMOVED***
		return components;
	***REMOVED***

	split = split || 1;

	// Split the array in 2 parts
	var left = components.slice(0, split);
	var right = components.slice(split);

	return Array.prototype.concat.call([], decodeComponents(left), decodeComponents(right));
***REMOVED***

function decode(input) ***REMOVED***
	try ***REMOVED***
		return decodeURIComponent(input);
	***REMOVED*** catch (err) ***REMOVED***
		var tokens = input.match(singleMatcher);

		for (var i = 1; i < tokens.length; i++) ***REMOVED***
			input = decodeComponents(tokens, i).join('');

			tokens = input.match(singleMatcher);
		***REMOVED***

		return input;
	***REMOVED***
***REMOVED***

function customDecodeURIComponent(input) ***REMOVED***
	// Keep track of all the replacements and prefill the map with the `BOM`
	var replaceMap = ***REMOVED***
		'%FE%FF': '\uFFFD\uFFFD',
		'%FF%FE': '\uFFFD\uFFFD'
	***REMOVED***;

	var match = multiMatcher.exec(input);
	while (match) ***REMOVED***
		try ***REMOVED***
			// Decode as big chunks as possible
			replaceMap[match[0]] = decodeURIComponent(match[0]);
		***REMOVED*** catch (err) ***REMOVED***
			var result = decode(match[0]);

			if (result !== match[0]) ***REMOVED***
				replaceMap[match[0]] = result;
			***REMOVED***
		***REMOVED***

		match = multiMatcher.exec(input);
	***REMOVED***

	// Add `%C2` at the end of the map to make sure it does not replace the combinator before everything else
	replaceMap['%C2'] = '\uFFFD';

	var entries = Object.keys(replaceMap);

	for (var i = 0; i < entries.length; i++) ***REMOVED***
		// Replace all decoded components
		var key = entries[i];
		input = input.replace(new RegExp(key, 'g'), replaceMap[key]);
	***REMOVED***

	return input;
***REMOVED***

module.exports = function (encodedURI) ***REMOVED***
	if (typeof encodedURI !== 'string') ***REMOVED***
		throw new TypeError('Expected `encodedURI` to be of type `string`, got `' + typeof encodedURI + '`');
	***REMOVED***

	try ***REMOVED***
		encodedURI = encodedURI.replace(/\+/g, ' ');

		// Try the built in decoder first
		return decodeURIComponent(encodedURI);
	***REMOVED*** catch (err) ***REMOVED***
		// Fallback to a more advanced decoder
		return customDecodeURIComponent(encodedURI);
	***REMOVED***
***REMOVED***;
