"use strict";

var stream = require("stream");

function DuplexWrapper(options, writable, readable) ***REMOVED***
  if (typeof readable === "undefined") ***REMOVED***
    readable = writable;
    writable = options;
    options = null;
  ***REMOVED***

  stream.Duplex.call(this, options);

  if (typeof readable.read !== "function") ***REMOVED***
    readable = (new stream.Readable(options)).wrap(readable);
  ***REMOVED***

  this._writable = writable;
  this._readable = readable;
  this._waiting = false;

  var self = this;

  writable.once("finish", function() ***REMOVED***
    self.end();
  ***REMOVED***);

  this.once("finish", function() ***REMOVED***
    writable.end();
  ***REMOVED***);

  readable.on("readable", function() ***REMOVED***
    if (self._waiting) ***REMOVED***
      self._waiting = false;
      self._read();
    ***REMOVED***
  ***REMOVED***);

  readable.once("end", function() ***REMOVED***
    self.push(null);
  ***REMOVED***);

  if (!options || typeof options.bubbleErrors === "undefined" || options.bubbleErrors) ***REMOVED***
    writable.on("error", function(err) ***REMOVED***
      self.emit("error", err);
    ***REMOVED***);

    readable.on("error", function(err) ***REMOVED***
      self.emit("error", err);
    ***REMOVED***);
  ***REMOVED***
***REMOVED***

DuplexWrapper.prototype = Object.create(stream.Duplex.prototype, ***REMOVED***constructor: ***REMOVED***value: DuplexWrapper***REMOVED******REMOVED***);

DuplexWrapper.prototype._write = function _write(input, encoding, done) ***REMOVED***
  this._writable.write(input, encoding, done);
***REMOVED***;

DuplexWrapper.prototype._read = function _read() ***REMOVED***
  var buf;
  var reads = 0;
  while ((buf = this._readable.read()) !== null) ***REMOVED***
    this.push(buf);
    reads++;
  ***REMOVED***
  if (reads === 0) ***REMOVED***
    this._waiting = true;
  ***REMOVED***
***REMOVED***;

module.exports = function duplex2(options, writable, readable) ***REMOVED***
  return new DuplexWrapper(options, writable, readable);
***REMOVED***;

module.exports.DuplexWrapper = DuplexWrapper;
