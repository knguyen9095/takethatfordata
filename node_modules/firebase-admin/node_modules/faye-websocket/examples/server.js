var WebSocket = require('../lib/faye/websocket'),
    deflate   = require('permessage-deflate'),
    fs        = require('fs'),
    http      = require('http'),
    https     = require('https');

var port    = process.argv[2] || 7000,
    secure  = process.argv[3] === 'tls',
    options = ***REMOVED***extensions: [deflate], ping: 5***REMOVED***;

var upgradeHandler = function(request, socket, head) ***REMOVED***
  var ws = new WebSocket(request, socket, head, ['irc', 'xmpp'], options);
  console.log('[open]', ws.url, ws.version, ws.protocol, request.headers);

  ws.pipe(ws);

  ws.onclose = function(event) ***REMOVED***
    console.log('[close]', event.code, event.reason);
    ws = null;
  ***REMOVED***;
***REMOVED***;

var requestHandler = function(request, response) ***REMOVED***
  if (!WebSocket.EventSource.isEventSource(request))
    return staticHandler(request, response);

  var es   = new WebSocket.EventSource(request, response),
      time = parseInt(es.lastEventId, 10) || 0;

  console.log('[open]', es.url, es.lastEventId);

  var loop = setInterval(function() ***REMOVED***
    time += 1;
    es.send('Time: ' + time);
    setTimeout(function() ***REMOVED***
      if (es) es.send('Update!!', ***REMOVED***event: 'update', id: time***REMOVED***);
    ***REMOVED***, 1000);
  ***REMOVED***, 2000);

  fs.createReadStream(__dirname + '/haproxy.conf').pipe(es, ***REMOVED***end: false***REMOVED***);

  es.onclose = function() ***REMOVED***
    clearInterval(loop);
    console.log('[close]', es.url);
    es = null;
  ***REMOVED***;
***REMOVED***;

var staticHandler = function(request, response) ***REMOVED***
  var path = request.url;

  fs.readFile(__dirname + path, function(err, content) ***REMOVED***
    var status = err ? 404 : 200;
    response.writeHead(status, ***REMOVED***'Content-Type': 'text/html'***REMOVED***);
    response.write(content || 'Not found');
    response.end();
  ***REMOVED***);
***REMOVED***;

var server = secure
           ? https.createServer(***REMOVED***
               key:  fs.readFileSync(__dirname + '/../spec/server.key'),
               cert: fs.readFileSync(__dirname + '/../spec/server.crt')
             ***REMOVED***)
           : http.createServer();

server.on('request', requestHandler);
server.on('upgrade', upgradeHandler);
server.listen(port);
