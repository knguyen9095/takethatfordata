var WebSocket = require('../lib/faye/websocket'),
    deflate   = require('permessage-deflate'),
    pace      = require('pace');

var host    = 'ws://localhost:9001',
    agent   = encodeURIComponent('node-' + process.version),
    cases   = 0,
    options = ***REMOVED***extensions: [deflate]***REMOVED***;

var socket = new WebSocket.Client(host + '/getCaseCount'),
    url, progress;

socket.onmessage = function(event) ***REMOVED***
  console.log('Total cases to run: ' + event.data);
  cases = parseInt(event.data);
  progress = pace(cases);
***REMOVED***;

var runCase = function(n) ***REMOVED***
  if (n > cases) ***REMOVED***
    url = host + '/updateReports?agent=' + agent;
    socket = new WebSocket.Client(url);
    socket.onclose = process.exit;
    return;
  ***REMOVED***

  url = host + '/runCase?case=' + n + '&agent=' + agent;
  socket = new WebSocket.Client(url, null, options);
  socket.pipe(socket);

  socket.on('close', function() ***REMOVED***
    progress.op();
    runCase(n + 1);
  ***REMOVED***);
***REMOVED***;

socket.onclose = function() ***REMOVED***
  runCase(1);
***REMOVED***;
