(function () ***REMOVED***
    var Testem = window.Testem
    var regex = /^((?:not )?ok) (\d+) (.+)$/

    Testem.useCustomAdapter(tapAdapter)

    function tapAdapter(socket)***REMOVED***
        var results = ***REMOVED***
            failed: 0
            , passed: 0
            , total: 0
            , tests: []
        ***REMOVED***

        socket.emit('tests-start')

        Testem.handleConsoleMessage = function(msg)***REMOVED***
            var m = msg.match(regex)
            if (m) ***REMOVED***
                var passed = m[1] === 'ok'
                var test = ***REMOVED***
                    passed: passed ? 1 : 0,
                    failed: passed ? 0 : 1,
                    total: 1,
                    id: m[2],
                    name: m[3],
                    items: []
                ***REMOVED***

                if (passed) ***REMOVED***
                    results.passed++
                ***REMOVED*** else ***REMOVED***
                    console.error("failure", m)

                    results.failed++
                ***REMOVED***

                results.total++

                // console.log("emitted test", test)
                socket.emit('test-result', test)
                results.tests.push(test)
            ***REMOVED*** else if (msg === '# ok' || msg.match(/^# tests \d+/))***REMOVED***
                // console.log("emitted all test")
                socket.emit('all-test-results', results)
            ***REMOVED***

            // return false if you want to prevent the console message from
            // going to the console
            // return false
        ***REMOVED***
    ***REMOVED***
***REMOVED***())
