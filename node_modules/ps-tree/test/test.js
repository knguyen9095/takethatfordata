var path = require('path');
var test  = require('tape');
var chalk = require('chalk');
var cp = require('child_process');
var treeKill = require('tree-kill');
var psTree = require('../');

var red = chalk.red,
    green = chalk.green,
    cyan = chalk.cyan;

var scripts = ***REMOVED***
  parent: path.join(__dirname, 'exec', 'parent.js'),
  child: path.join(__dirname, 'exec', 'child.js')
***REMOVED***;

test(cyan('Spawn a Parent process which has a Two Child Processes'), function (t) ***REMOVED***
  var parent = cp.exec('node ' + scripts.parent, function (error, stdout, stderr) ***REMOVED******REMOVED***);

  setTimeout(function () ***REMOVED***
    psTree(parent.pid, function (err, children) ***REMOVED***
      if (err) ***REMOVED*** console.log(err); ***REMOVED***
      console.log(red('Children: '), children, '\n');
      t.true(children.length > 0, green('✓ There are ' + children.length + ' active child processes'));
      treeKill(parent.pid);
    ***REMOVED***);

    setTimeout(function () ***REMOVED***
      psTree(parent.pid, function (err, children) ***REMOVED***
        if (err) ***REMOVED*** console.log(err); ***REMOVED***
        // console.log('Children: ', children, '\n');
        // console.log(' ')
        t.equal(children.length, 0, green('✓ No more active child processes (we killed them)'));
        t.end();
      ***REMOVED***);
    ***REMOVED***, 2000); // give psTree time to kill the processes
  ***REMOVED***, 500); // give the child process time to spawn
  // need more time on a slow(or heavy load server). maybe promise.then is better instead of the timeout
***REMOVED***);

test(cyan('FORCE ERROR by calling psTree without supplying a Callback'), function (t) ***REMOVED***
  var errmsg = 'Error: childrenOfPid(pid, callback) expects callback'
  // Attempt to call psTree without a callback
  try ***REMOVED*** psTree(1234); ***REMOVED***
  catch (e) ***REMOVED***
    t.equal(e.toString(), errmsg, green('✓ Fails when no callback supplied (as expected)'))
  ***REMOVED***

  t.end();
***REMOVED***);


test(cyan('Spawn a Child Process and psTree with a String as pid'), function (t) ***REMOVED***
  var child = cp.exec('node ' + scripts.child, function(error, stdout, stderr) ***REMOVED******REMOVED***);
  setTimeout(function()***REMOVED***
    psTree(child.pid.toString(), function (err, children) ***REMOVED***
      if (err) ***REMOVED*** console.log(err); ***REMOVED***
      // cp.spawn('kill', ['-9'].concat(children.map(function (p) ***REMOVED*** return p.PID ***REMOVED***)))
      treeKill(child.pid);
    ***REMOVED***);

    setTimeout(function() ***REMOVED***
      psTree(child.pid.toString(), function (err, children) ***REMOVED***
        if (err) ***REMOVED*** console.log(err); ***REMOVED***
        t.equal(children.length, 0, green('✓ No more active child processes'));
        t.end();
      ***REMOVED***);
    ***REMOVED***, 1000); // give psTree time to kill the processes
  ***REMOVED***, 200); // give the child process time to spawn
***REMOVED***);
