'use strict';

var assert = require('assert')
var duplexify = require('duplexify')
var stream = require('stream')
var StreamEvents = require('./')
var util = require('util')

var tests = []

function FakeStream(_read, _write) ***REMOVED***
  stream.Transform.call(this)
  this._read = _read || function() ***REMOVED******REMOVED***
  this._write = _write || function() ***REMOVED******REMOVED***
  StreamEvents.call(this)
***REMOVED***
util.inherits(FakeStream, stream.Transform)

test('is a function', function() ***REMOVED***
  assert.equal(typeof StreamEvents, 'function')
***REMOVED***)

test('overwrites _read and _write', function() ***REMOVED***
  var _readCalled = false
  var _writeCalled = false

  var fs = new FakeStream(function() ***REMOVED***
    _readCalled = true
  ***REMOVED***, function() ***REMOVED***
    _writeCalled = true
  ***REMOVED***)

  assert.strictEqual(_readCalled, false)
  fs._read()
  assert.strictEqual(_readCalled, true)

  assert.strictEqual(_writeCalled, false)
  fs._write()
  assert.strictEqual(_writeCalled, true)
***REMOVED***)

test('emits reading and writing events', function() ***REMOVED***
  var eventsCalled = 0

  var fs = new FakeStream()

  fs.on('reading', function() ***REMOVED***
    assert.equal(++eventsCalled, 1)
  ***REMOVED***)
  fs._read()

  fs.on('writing', function() ***REMOVED***
    assert.equal(++eventsCalled, 2)
  ***REMOVED***)
  fs._write()
***REMOVED***)

test('works with existing stream', function() ***REMOVED***
  var dup = StreamEvents(duplexify())

  var called = false
  dup.on('reading', function() ***REMOVED***
    called = true
  ***REMOVED***)

  dup._read()
  assert(called)
***REMOVED***)

function test(message, fn) ***REMOVED***
  try ***REMOVED***
    fn()
    tests.push(***REMOVED*** success: true, fail: false, message: message ***REMOVED***)
  ***REMOVED*** catch(e) ***REMOVED***
    tests.push(***REMOVED*** success: false, fail: true, message: message, error: e ***REMOVED***)
  ***REMOVED***
***REMOVED***

tests.forEach(function(test, index) ***REMOVED***
  function black(message) ***REMOVED***
    return '\u001b[30m' + message + '\u001b[39m'
  ***REMOVED***
  function greenBg(message) ***REMOVED***
    return '\u001b[42m' + message + '\u001b[49m'
  ***REMOVED***
  function redBg(message) ***REMOVED***
    return '\u001b[41m' + message + '\u001b[49m'
  ***REMOVED***
  function bold(message) ***REMOVED***
    return '\u001b[1m' + message + '\u001b[22m'
  ***REMOVED***

  var icon, message
  if (test.success) ***REMOVED***
    icon = '✔︎'
    message = greenBg(black(' ' + icon + ' ' + test.message + ' '))
  ***REMOVED*** else ***REMOVED***
    icon = '✖'
    message = redBg(bold(' ' + icon + ' ' + test.message + ' '))
  ***REMOVED***

  console.log((index > 0 ? '\n' : '') + message)
  if (test.error) ***REMOVED***
    console.log('  ' + test.error.stack)
  ***REMOVED***
***REMOVED***)