"use strict";

var clear    = require("es5-ext/array/#/clear")
  , assign   = require("es5-ext/object/assign")
  , callable = require("es5-ext/object/valid-callable")
  , value    = require("es5-ext/object/valid-value")
  , d        = require("d")
  , autoBind = require("d/auto-bind")
  , Symbol   = require("es6-symbol");

var defineProperty = Object.defineProperty, defineProperties = Object.defineProperties, Iterator;

module.exports = Iterator = function (list, context) ***REMOVED***
	if (!(this instanceof Iterator)) throw new TypeError("Constructor requires 'new'");
	defineProperties(this, ***REMOVED***
		__list__: d("w", value(list)),
		__context__: d("w", context),
		__nextIndex__: d("w", 0)
	***REMOVED***);
	if (!context) return;
	callable(context.on);
	context.on("_add", this._onAdd);
	context.on("_delete", this._onDelete);
	context.on("_clear", this._onClear);
***REMOVED***;

// Internal %IteratorPrototype% doesn't expose its constructor
delete Iterator.prototype.constructor;

defineProperties(
	Iterator.prototype,
	assign(
		***REMOVED***
			_next: d(function () ***REMOVED***
				var i;
				if (!this.__list__) return undefined;
				if (this.__redo__) ***REMOVED***
					i = this.__redo__.shift();
					if (i !== undefined) return i;
				***REMOVED***
				if (this.__nextIndex__ < this.__list__.length) return this.__nextIndex__++;
				this._unBind();
				return undefined;
			***REMOVED***),
			next: d(function () ***REMOVED***
				return this._createResult(this._next());
			***REMOVED***),
			_createResult: d(function (i) ***REMOVED***
				if (i === undefined) return ***REMOVED*** done: true, value: undefined ***REMOVED***;
				return ***REMOVED*** done: false, value: this._resolve(i) ***REMOVED***;
			***REMOVED***),
			_resolve: d(function (i) ***REMOVED***
				return this.__list__[i];
			***REMOVED***),
			_unBind: d(function () ***REMOVED***
				this.__list__ = null;
				delete this.__redo__;
				if (!this.__context__) return;
				this.__context__.off("_add", this._onAdd);
				this.__context__.off("_delete", this._onDelete);
				this.__context__.off("_clear", this._onClear);
				this.__context__ = null;
			***REMOVED***),
			toString: d(function () ***REMOVED***
				return "[object " + (this[Symbol.toStringTag] || "Object") + "]";
			***REMOVED***)
		***REMOVED***,
		autoBind(***REMOVED***
			_onAdd: d(function (index) ***REMOVED***
				if (index >= this.__nextIndex__) return;
				++this.__nextIndex__;
				if (!this.__redo__) ***REMOVED***
					defineProperty(this, "__redo__", d("c", [index]));
					return;
				***REMOVED***
				this.__redo__.forEach(function (redo, i) ***REMOVED***
					if (redo >= index) this.__redo__[i] = ++redo;
				***REMOVED***, this);
				this.__redo__.push(index);
			***REMOVED***),
			_onDelete: d(function (index) ***REMOVED***
				var i;
				if (index >= this.__nextIndex__) return;
				--this.__nextIndex__;
				if (!this.__redo__) return;
				i = this.__redo__.indexOf(index);
				if (i !== -1) this.__redo__.splice(i, 1);
				this.__redo__.forEach(function (redo, j) ***REMOVED***
					if (redo > index) this.__redo__[j] = --redo;
				***REMOVED***, this);
			***REMOVED***),
			_onClear: d(function () ***REMOVED***
				if (this.__redo__) clear.call(this.__redo__);
				this.__nextIndex__ = 0;
			***REMOVED***)
		***REMOVED***)
	)
);

defineProperty(
	Iterator.prototype,
	Symbol.iterator,
	d(function () ***REMOVED***
		return this;
	***REMOVED***)
);
