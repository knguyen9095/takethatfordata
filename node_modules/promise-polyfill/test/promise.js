var Promise = require('../promise');
var sinon = require('sinon');
var assert = require('assert');
var adapter = require('./adapter');
describe("Promises/A+ Tests", function () ***REMOVED***
  require("promises-aplus-tests").mocha(adapter);
***REMOVED***);
describe('Promise', function () ***REMOVED***
  describe('Promise._setImmediateFn', function () ***REMOVED***
    afterEach(function() ***REMOVED***
      Promise._setImmediateFn((typeof setImmediate === 'function' && function (fn) ***REMOVED***
            setImmediate(fn);
          ***REMOVED***) ||
      function (fn) ***REMOVED***
        setTimeout(fn, 1);
      ***REMOVED***);
    ***REMOVED***);
    it('changes immediate fn', function () ***REMOVED***
      var spy = sinon.spy();

      function immediateFn(fn) ***REMOVED***
        spy();
        fn();
      ***REMOVED***
      Promise._setImmediateFn(immediateFn);
      var done = false;
      new Promise(function (resolve) ***REMOVED***
        resolve();
      ***REMOVED***).then(function () ***REMOVED***
        done = true;
      ***REMOVED***);
      assert(spy.calledOnce);
      assert(done);
    ***REMOVED***);
    it('changes immediate fn multiple', function () ***REMOVED***
      var spy1 = sinon.spy();

      function immediateFn1(fn) ***REMOVED***
        spy1();
        fn();
      ***REMOVED***

      var spy2 = sinon.spy();

      function immediateFn2(fn) ***REMOVED***
        spy2();
        fn();
      ***REMOVED***

      Promise._setImmediateFn(immediateFn1);
      var done = false;
      new Promise(function (resolve) ***REMOVED***
        resolve();
      ***REMOVED***).then(function () ***REMOVED***
      ***REMOVED***);
      Promise._setImmediateFn(immediateFn2);
      new Promise(function (resolve) ***REMOVED***
        resolve();
      ***REMOVED***).then(function () ***REMOVED***
        done = true;
      ***REMOVED***);
      assert(spy2.called);
      assert(spy1.calledOnce);
      assert(done);
    ***REMOVED***);
  ***REMOVED***);
  describe('Promise._onUnhandledRejection', function () ***REMOVED***
    var stub, sandbox;
    beforeEach(function() ***REMOVED***
      sandbox = sinon.sandbox.create();
      stub = sandbox.stub(console, 'warn');
    ***REMOVED***);
    afterEach(function() ***REMOVED***
      sandbox.restore();
    ***REMOVED***);
    it('no error on resolve', function (done) ***REMOVED***
      Promise.resolve(true).then(function(result) ***REMOVED***
        return result;
      ***REMOVED***).then(function(result) ***REMOVED***
        return result;
      ***REMOVED***);

      setTimeout(function() ***REMOVED***
        assert(!stub.called);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('error single Promise', function (done) ***REMOVED***
      new Promise(function(resolve, reject) ***REMOVED***
        abc.abc = 1;
      ***REMOVED***);
      setTimeout(function() ***REMOVED***
        assert(stub.calledOnce);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('multi promise error', function (done) ***REMOVED***
      new Promise(function(resolve, reject) ***REMOVED***
        abc.abc = 1;
      ***REMOVED***).then(function(result) ***REMOVED***
        return result;
      ***REMOVED***);
      setTimeout(function() ***REMOVED***
        assert(stub.calledOnce);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('promise catch no error', function (done) ***REMOVED***
      new Promise(function(resolve, reject) ***REMOVED***
        abc.abc = 1;
      ***REMOVED***).catch(function(result) ***REMOVED***
        return result;
      ***REMOVED***);
      setTimeout(function() ***REMOVED***
        assert(!stub.called);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('promise catch no error', function (done) ***REMOVED***
      new Promise(function(resolve, reject) ***REMOVED***
        abc.abc = 1;
      ***REMOVED***).then(function(result) ***REMOVED***
        return result;
      ***REMOVED***).catch(function(result) ***REMOVED***
        return result;
      ***REMOVED***);
      setTimeout(function() ***REMOVED***
        assert(!stub.called);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('promise reject error', function (done) ***REMOVED***
      Promise.reject('hello');
      setTimeout(function() ***REMOVED***
        assert(stub.calledOnce);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('promise reject error late', function (done) ***REMOVED***
      var prom = Promise.reject('hello');
      prom.catch(function() ***REMOVED***

      ***REMOVED***);
      setTimeout(function() ***REMOVED***
        assert(!stub.called);
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
    it('promise reject error late', function (done) ***REMOVED***
      Promise.reject('hello');
      setTimeout(function() ***REMOVED***
        assert.equal(stub.args[0][1], 'hello');
        done();
      ***REMOVED***, 50);
    ***REMOVED***);
  ***REMOVED***);
  describe('Promise.prototype.then', function() ***REMOVED***
    var spy,
        SubClass;
    beforeEach(function() ***REMOVED***
      spy = sinon.spy();
      SubClass = function() ***REMOVED***
        spy();
        Promise.apply(this, arguments);
      ***REMOVED***;

      function __() ***REMOVED*** this.constructor = SubClass; ***REMOVED***
      __.prototype = Promise.prototype;
      SubClass.prototype = new __();

      SubClass.prototype.then = function() ***REMOVED***
        return Promise.prototype.then.apply(this, arguments);
      ***REMOVED***;
    ***REMOVED***);
    it('subclassed Promise resolves to subclass', function() ***REMOVED***
      var prom = new SubClass(function(resolve) ***REMOVED***
        resolve();
      ***REMOVED***).then(function() ***REMOVED******REMOVED***, function() ***REMOVED******REMOVED***);
      assert(spy.calledTwice);
      assert(prom instanceof SubClass);
    ***REMOVED***);
    it('subclassed Promise rejects to subclass', function() ***REMOVED***
      var prom = new SubClass(function(_, reject) ***REMOVED***
        reject();
      ***REMOVED***).then(function() ***REMOVED******REMOVED***, function() ***REMOVED******REMOVED***);
      assert(spy.calledTwice);
      assert(prom instanceof SubClass);
    ***REMOVED***);
  ***REMOVED***);
  describe('Promise.all', function() ***REMOVED***
    it('throws on implicit undefined', function () ***REMOVED***
      return Promise.all().then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on explicit undefined', function () ***REMOVED***
      return Promise.all(undefined).then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on null', function () ***REMOVED***
      return Promise.all(null).then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on 0', function () ***REMOVED***
      return Promise.all(0).then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on false', function () ***REMOVED***
      return Promise.all(false).then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on a number', function () ***REMOVED***
      return Promise.all().then(function () ***REMOVED***
        assert.fail(20);
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on a boolean', function () ***REMOVED***
      return Promise.all(true).then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
    it('throws on an object', function () ***REMOVED***
      return Promise.all(***REMOVED*** test: 'object' ***REMOVED***).then(function () ***REMOVED***
        assert.fail();
      ***REMOVED***, function (error) ***REMOVED***
        assert.ok(error instanceof Error);
      ***REMOVED***);
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***);â€¨
