"use strict";

const path = require("path");
const emojisList = require("emojis-list");
const getHashDigest = require("./getHashDigest");

const emojiRegex = /[\uD800-\uDFFF]./;
const emojiList = emojisList.filter(emoji => emojiRegex.test(emoji));
const emojiCache = ***REMOVED******REMOVED***;

function encodeStringToEmoji(content, length) ***REMOVED***
	if(emojiCache[content]) return emojiCache[content];
	length = length || 1;
	const emojis = [];
	do ***REMOVED***
		const index = Math.floor(Math.random() * emojiList.length);
		emojis.push(emojiList[index]);
		emojiList.splice(index, 1);
	***REMOVED*** while(--length > 0);
	const emojiEncoding = emojis.join("");
	emojiCache[content] = emojiEncoding;
	return emojiEncoding;
***REMOVED***

function interpolateName(loaderContext, name, options) ***REMOVED***
	let filename;
	if(typeof name === "function") ***REMOVED***
		filename = name(loaderContext.resourcePath);
	***REMOVED*** else ***REMOVED***
		filename = name || "[hash].[ext]";
	***REMOVED***
	const context = options.context;
	const content = options.content;
	const regExp = options.regExp;
	let ext = "bin";
	let basename = "file";
	let directory = "";
	let folder = "";
	if(loaderContext.resourcePath) ***REMOVED***
		const parsed = path.parse(loaderContext.resourcePath);
		let resourcePath = loaderContext.resourcePath;

		if(parsed.ext) ***REMOVED***
			ext = parsed.ext.substr(1);
		***REMOVED***
		if(parsed.dir) ***REMOVED***
			basename = parsed.name;
			resourcePath = parsed.dir + path.sep;
		***REMOVED***
		if(typeof context !== "undefined") ***REMOVED***
			directory = path.relative(context, resourcePath + "_").replace(/\\/g, "/").replace(/\.\.(\/)?/g, "_$1");
			directory = directory.substr(0, directory.length - 1);
		***REMOVED*** else ***REMOVED***
			directory = resourcePath.replace(/\\/g, "/").replace(/\.\.(\/)?/g, "_$1");
		***REMOVED***
		if(directory.length === 1) ***REMOVED***
			directory = "";
		***REMOVED*** else if(directory.length > 1) ***REMOVED***
			folder = path.basename(directory);
		***REMOVED***
	***REMOVED***
	let url = filename;
	if(content) ***REMOVED***
		// Match hash template
		url = url
			.replace(
				/\[(?:(\w+):)?hash(?::([a-z]+\d*))?(?::(\d+))?\]/ig,
				(all, hashType, digestType, maxLength) => getHashDigest(content, hashType, digestType, parseInt(maxLength, 10))
			)
			.replace(
				/\[emoji(?::(\d+))?\]/ig,
				(all, length) => encodeStringToEmoji(content, length)
			);
	***REMOVED***
	url = url
		.replace(/\[ext\]/ig, () => ext)
		.replace(/\[name\]/ig, () => basename)
		.replace(/\[path\]/ig, () => directory)
		.replace(/\[folder\]/ig, () => folder);
	if(regExp && loaderContext.resourcePath) ***REMOVED***
		const match = loaderContext.resourcePath.match(new RegExp(regExp));
		match && match.forEach((matched, i) => ***REMOVED***
			url = url.replace(
				new RegExp("\\[" + i + "\\]", "ig"),
				matched
			);
		***REMOVED***);
	***REMOVED***
	if(typeof loaderContext.options === "object" && typeof loaderContext.options.customInterpolateName === "function") ***REMOVED***
		url = loaderContext.options.customInterpolateName.call(loaderContext, url, name, options);
	***REMOVED***
	return url;
***REMOVED***

module.exports = interpolateName;
