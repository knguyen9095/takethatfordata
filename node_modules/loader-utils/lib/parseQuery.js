"use strict";

const JSON5 = require("json5");

const specialValues = ***REMOVED***
	"null": null,
	"true": true,
	"false": false
***REMOVED***;

function parseQuery(query) ***REMOVED***
	if(query.substr(0, 1) !== "?") ***REMOVED***
		throw new Error("A valid query string passed to parseQuery should begin with '?'");
	***REMOVED***
	query = query.substr(1);
	if(!query) ***REMOVED***
		return ***REMOVED******REMOVED***;
	***REMOVED***
	if(query.substr(0, 1) === "***REMOVED***" && query.substr(-1) === "***REMOVED***") ***REMOVED***
		return JSON5.parse(query);
	***REMOVED***
	const queryArgs = query.split(/[,&]/g);
	const result = ***REMOVED******REMOVED***;
	queryArgs.forEach(arg => ***REMOVED***
		const idx = arg.indexOf("=");
		if(idx >= 0) ***REMOVED***
			let name = arg.substr(0, idx);
			let value = decodeURIComponent(arg.substr(idx + 1));
			if(specialValues.hasOwnProperty(value)) ***REMOVED***
				value = specialValues[value];
			***REMOVED***
			if(name.substr(-2) === "[]") ***REMOVED***
				name = decodeURIComponent(name.substr(0, name.length - 2));
				if(!Array.isArray(result[name]))
					result[name] = [];
				result[name].push(value);
			***REMOVED*** else ***REMOVED***
				name = decodeURIComponent(name);
				result[name] = value;
			***REMOVED***
		***REMOVED*** else ***REMOVED***
			if(arg.substr(0, 1) === "-") ***REMOVED***
				result[decodeURIComponent(arg.substr(1))] = false;
			***REMOVED*** else if(arg.substr(0, 1) === "+") ***REMOVED***
				result[decodeURIComponent(arg.substr(1))] = true;
			***REMOVED*** else ***REMOVED***
				result[decodeURIComponent(arg)] = true;
			***REMOVED***
		***REMOVED***
	***REMOVED***);
	return result;
***REMOVED***

module.exports = parseQuery;
