'use strict';

var Base = require('./base'),
    util = require('util');

var Draft75 = function(request, url, options) ***REMOVED***
  Base.apply(this, arguments);
  this._stage  = 0;
  this.version = 'hixie-75';

  this._headers.set('Upgrade', 'WebSocket');
  this._headers.set('Connection', 'Upgrade');
  this._headers.set('WebSocket-Origin', this._request.headers.origin);
  this._headers.set('WebSocket-Location', this.url);
***REMOVED***;
util.inherits(Draft75, Base);

var instance = ***REMOVED***
  close: function() ***REMOVED***
    if (this.readyState === 3) return false;
    this.readyState = 3;
    this.emit('close', new Base.CloseEvent(null, null));
    return true;
  ***REMOVED***,

  parse: function(chunk) ***REMOVED***
    if (this.readyState > 1) return;

    this._reader.put(chunk);

    this._reader.eachByte(function(octet) ***REMOVED***
      var message;

      switch (this._stage) ***REMOVED***
        case -1:
          this._body.push(octet);
          this._sendHandshakeBody();
          break;

        case 0:
          this._parseLeadingByte(octet);
          break;

        case 1:
          this._length = (octet & 0x7F) + 128 * this._length;

          if (this._closing && this._length === 0) ***REMOVED***
            return this.close();
          ***REMOVED***
          else if ((octet & 0x80) !== 0x80) ***REMOVED***
            if (this._length === 0) ***REMOVED***
              this._stage = 0;
            ***REMOVED***
            else ***REMOVED***
              this._skipped = 0;
              this._stage   = 2;
            ***REMOVED***
          ***REMOVED***
          break;

        case 2:
          if (octet === 0xFF) ***REMOVED***
            this._stage = 0;
            message = new Buffer(this._buffer).toString('utf8', 0, this._buffer.length);
            this.emit('message', new Base.MessageEvent(message));
          ***REMOVED***
          else ***REMOVED***
            if (this._length) ***REMOVED***
              this._skipped += 1;
              if (this._skipped === this._length)
                this._stage = 0;
            ***REMOVED*** else ***REMOVED***
              this._buffer.push(octet);
              if (this._buffer.length > this._maxLength) return this.close();
            ***REMOVED***
          ***REMOVED***
          break;
      ***REMOVED***
    ***REMOVED***, this);
  ***REMOVED***,

  frame: function(buffer) ***REMOVED***
    if (this.readyState === 0) return this._queue([buffer]);
    if (this.readyState > 1) return false;

    if (typeof buffer !== 'string') buffer = buffer.toString();

    var payload = new Buffer(buffer, 'utf8'),
        frame   = new Buffer(payload.length + 2);

    frame[0] = 0x00;
    frame[payload.length + 1] = 0xFF;
    payload.copy(frame, 1);

    this._write(frame);
    return true;
  ***REMOVED***,

  _handshakeResponse: function() ***REMOVED***
    var start   = 'HTTP/1.1 101 Web Socket Protocol Handshake',
        headers = [start, this._headers.toString(), ''];

    return new Buffer(headers.join('\r\n'), 'utf8');
  ***REMOVED***,

  _parseLeadingByte: function(octet) ***REMOVED***
    if ((octet & 0x80) === 0x80) ***REMOVED***
      this._length = 0;
      this._stage  = 1;
    ***REMOVED*** else ***REMOVED***
      delete this._length;
      delete this._skipped;
      this._buffer = [];
      this._stage  = 2;
    ***REMOVED***
  ***REMOVED***
***REMOVED***;

for (var key in instance)
  Draft75.prototype[key] = instance[key];

module.exports = Draft75;
