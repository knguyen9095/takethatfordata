'use strict';

var StreamReader = function() ***REMOVED***
  this._queue     = [];
  this._queueSize = 0;
  this._offset    = 0;
***REMOVED***;

StreamReader.prototype.put = function(buffer) ***REMOVED***
  if (!buffer || buffer.length === 0) return;
  if (!buffer.copy) buffer = new Buffer(buffer);
  this._queue.push(buffer);
  this._queueSize += buffer.length;
***REMOVED***;

StreamReader.prototype.read = function(length) ***REMOVED***
  if (length > this._queueSize) return null;
  if (length === 0) return new Buffer(0);

  this._queueSize -= length;

  var queue  = this._queue,
      remain = length,
      first  = queue[0],
      buffers, buffer;

  if (first.length >= length) ***REMOVED***
    if (first.length === length) ***REMOVED***
      return queue.shift();
    ***REMOVED*** else ***REMOVED***
      buffer = first.slice(0, length);
      queue[0] = first.slice(length);
      return buffer;
    ***REMOVED***
  ***REMOVED***

  for (var i = 0, n = queue.length; i < n; i++) ***REMOVED***
    if (remain < queue[i].length) break;
    remain -= queue[i].length;
  ***REMOVED***
  buffers = queue.splice(0, i);

  if (remain > 0 && queue.length > 0) ***REMOVED***
    buffers.push(queue[0].slice(0, remain));
    queue[0] = queue[0].slice(remain);
  ***REMOVED***
  return this._concat(buffers, length);
***REMOVED***;

StreamReader.prototype.eachByte = function(callback, context) ***REMOVED***
  var buffer, n, index;

  while (this._queue.length > 0) ***REMOVED***
    buffer = this._queue[0];
    n = buffer.length;

    while (this._offset < n) ***REMOVED***
      index = this._offset;
      this._offset += 1;
      callback.call(context, buffer[index]);
    ***REMOVED***
    this._offset = 0;
    this._queue.shift();
  ***REMOVED***
***REMOVED***;

StreamReader.prototype._concat = function(buffers, length) ***REMOVED***
  if (Buffer.concat) return Buffer.concat(buffers, length);

  var buffer = new Buffer(length),
      offset = 0;

  for (var i = 0, n = buffers.length; i < n; i++) ***REMOVED***
    buffers[i].copy(buffer, offset);
    offset += buffers[i].length;
  ***REMOVED***
  return buffer;
***REMOVED***;

module.exports = StreamReader;
