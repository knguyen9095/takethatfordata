'use strict';

var Cell   = require('./cell'),
    Pledge = require('./pledge');

var Pipeline = function(sessions) ***REMOVED***
  this._cells   = sessions.map(function(session) ***REMOVED*** return new Cell(session) ***REMOVED***);
  this._stopped = ***REMOVED***incoming: false, outgoing: false***REMOVED***;
***REMOVED***;

Pipeline.prototype.processIncomingMessage = function(message, callback, context) ***REMOVED***
  if (this._stopped.incoming) return;
  this._loop('incoming', this._cells.length - 1, -1, -1, message, callback, context);
***REMOVED***;

Pipeline.prototype.processOutgoingMessage = function(message, callback, context) ***REMOVED***
  if (this._stopped.outgoing) return;
  this._loop('outgoing', 0, this._cells.length, 1, message, callback, context);
***REMOVED***;

Pipeline.prototype.close = function(callback, context) ***REMOVED***
  this._stopped = ***REMOVED***incoming: true, outgoing: true***REMOVED***;

  var closed = this._cells.map(function(a) ***REMOVED*** return a.close() ***REMOVED***);
  if (callback)
    Pledge.all(closed).then(function() ***REMOVED*** callback.call(context) ***REMOVED***);
***REMOVED***;

Pipeline.prototype._loop = function(direction, start, end, step, message, callback, context) ***REMOVED***
  var cells = this._cells,
      n     = cells.length,
      self  = this;

  while (n--) cells[n].pending(direction);

  var pipe = function(index, error, msg) ***REMOVED***
    if (index === end) return callback.call(context, error, msg);

    cells[index][direction](error, msg, function(err, m) ***REMOVED***
      if (err) self._stopped[direction] = true;
      pipe(index + step, err, m);
    ***REMOVED***);
  ***REMOVED***;
  pipe(start, null, message);
***REMOVED***;

module.exports = Pipeline;
