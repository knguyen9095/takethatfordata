/*
 *
 * Copyright 2015 gRPC authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

#include "src/core/lib/iomgr/port.h"

#ifdef GRPC_POSIX_SOCKET

#include "src/core/lib/iomgr/ev_posix.h"

#include <string.h>

#include <grpc/support/alloc.h>
#include <grpc/support/log.h>
#include <grpc/support/string_util.h>
#include <grpc/support/useful.h>

#include "src/core/lib/debug/trace.h"
#include "src/core/lib/iomgr/ev_epoll1_linux.h"
#include "src/core/lib/iomgr/ev_epollex_linux.h"
#include "src/core/lib/iomgr/ev_epollsig_linux.h"
#include "src/core/lib/iomgr/ev_poll_posix.h"
#include "src/core/lib/support/env.h"

grpc_core::TraceFlag grpc_polling_trace(false,
                                        "polling"); /* Disabled by default */
grpc_core::DebugOnlyTraceFlag grpc_trace_fd_refcount(false, "fd_refcount");

/** Default poll() function - a pointer so that it can be overridden by some
 *  tests */
grpc_poll_function_type grpc_poll_function = poll;

grpc_wakeup_fd grpc_global_wakeup_fd;

static const grpc_event_engine_vtable* g_event_engine;
static const char* g_poll_strategy_name = nullptr;

typedef const grpc_event_engine_vtable* (*event_engine_factory_fn)(
    bool explicit_request);

typedef struct ***REMOVED***
  const char* name;
  event_engine_factory_fn factory;
***REMOVED*** event_engine_factory;

namespace ***REMOVED***

extern "C" ***REMOVED***

grpc_poll_function_type real_poll_function;

int dummy_poll(struct pollfd fds[], nfds_t nfds, int timeout) ***REMOVED***
  if (timeout == 0) ***REMOVED***
    return real_poll_function(fds, nfds, 0);
  ***REMOVED*** else ***REMOVED***
    gpr_log(GPR_ERROR, "Attempted a blocking poll when declared non-polling.");
    GPR_ASSERT(false);
    return -1;
  ***REMOVED***
***REMOVED***
***REMOVED***  // extern "C"

const grpc_event_engine_vtable* init_non_polling(bool explicit_request) ***REMOVED***
  if (!explicit_request) ***REMOVED***
    return nullptr;
  ***REMOVED***
  // return the simplest engine as a dummy but also override the poller
  auto ret = grpc_init_poll_posix(explicit_request);
  real_poll_function = grpc_poll_function;
  grpc_poll_function = dummy_poll;

  return ret;
***REMOVED***
***REMOVED***  // namespace

static const event_engine_factory g_factories[] = ***REMOVED***
    ***REMOVED***"epollex", grpc_init_epollex_linux***REMOVED***,   ***REMOVED***"epoll1", grpc_init_epoll1_linux***REMOVED***,
    ***REMOVED***"epollsig", grpc_init_epollsig_linux***REMOVED***, ***REMOVED***"poll", grpc_init_poll_posix***REMOVED***,
    ***REMOVED***"poll-cv", grpc_init_poll_cv_posix***REMOVED***,   ***REMOVED***"none", init_non_polling***REMOVED***,
***REMOVED***;

static void add(const char* beg, const char* end, char*** ss, size_t* ns) ***REMOVED***
  size_t n = *ns;
  size_t np = n + 1;
  char* s;
  size_t len;
  GPR_ASSERT(end >= beg);
  len = (size_t)(end - beg);
  s = (char*)gpr_malloc(len + 1);
  memcpy(s, beg, len);
  s[len] = 0;
  *ss = (char**)gpr_realloc(*ss, sizeof(char**) * np);
  (*ss)[n] = s;
  *ns = np;
***REMOVED***

static void split(const char* s, char*** ss, size_t* ns) ***REMOVED***
  const char* c = strchr(s, ',');
  if (c == nullptr) ***REMOVED***
    add(s, s + strlen(s), ss, ns);
  ***REMOVED*** else ***REMOVED***
    add(s, c, ss, ns);
    split(c + 1, ss, ns);
  ***REMOVED***
***REMOVED***

static bool is(const char* want, const char* have) ***REMOVED***
  return 0 == strcmp(want, "all") || 0 == strcmp(want, have);
***REMOVED***

static void try_engine(const char* engine) ***REMOVED***
  for (size_t i = 0; i < GPR_ARRAY_SIZE(g_factories); i++) ***REMOVED***
    if (is(engine, g_factories[i].name)) ***REMOVED***
      if ((g_event_engine = g_factories[i].factory(
               0 == strcmp(engine, g_factories[i].name)))) ***REMOVED***
        g_poll_strategy_name = g_factories[i].name;
        gpr_log(GPR_DEBUG, "Using polling engine: %s", g_factories[i].name);
        return;
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***

/* This should be used for testing purposes ONLY */
void grpc_set_event_engine_test_only(
    const grpc_event_engine_vtable* ev_engine) ***REMOVED***
  g_event_engine = ev_engine;
***REMOVED***

const grpc_event_engine_vtable* grpc_get_event_engine_test_only() ***REMOVED***
  return g_event_engine;
***REMOVED***

/* Call this only after calling grpc_event_engine_init() */
const char* grpc_get_poll_strategy_name() ***REMOVED*** return g_poll_strategy_name; ***REMOVED***

void grpc_event_engine_init(void) ***REMOVED***
  char* s = gpr_getenv("GRPC_POLL_STRATEGY");
  if (s == nullptr) ***REMOVED***
    s = gpr_strdup("all");
  ***REMOVED***

  char** strings = nullptr;
  size_t nstrings = 0;
  split(s, &strings, &nstrings);

  for (size_t i = 0; g_event_engine == nullptr && i < nstrings; i++) ***REMOVED***
    try_engine(strings[i]);
  ***REMOVED***

  for (size_t i = 0; i < nstrings; i++) ***REMOVED***
    gpr_free(strings[i]);
  ***REMOVED***
  gpr_free(strings);

  if (g_event_engine == nullptr) ***REMOVED***
    gpr_log(GPR_ERROR, "No event engine could be initialized from %s", s);
    abort();
  ***REMOVED***
  gpr_free(s);
***REMOVED***

void grpc_event_engine_shutdown(void) ***REMOVED***
  g_event_engine->shutdown_engine();
  g_event_engine = nullptr;
***REMOVED***

grpc_fd* grpc_fd_create(int fd, const char* name) ***REMOVED***
  return g_event_engine->fd_create(fd, name);
***REMOVED***

int grpc_fd_wrapped_fd(grpc_fd* fd) ***REMOVED***
  return g_event_engine->fd_wrapped_fd(fd);
***REMOVED***

void grpc_fd_orphan(grpc_exec_ctx* exec_ctx, grpc_fd* fd, grpc_closure* on_done,
                    int* release_fd, bool already_closed, const char* reason) ***REMOVED***
  g_event_engine->fd_orphan(exec_ctx, fd, on_done, release_fd, already_closed,
                            reason);
***REMOVED***

void grpc_fd_shutdown(grpc_exec_ctx* exec_ctx, grpc_fd* fd, grpc_error* why) ***REMOVED***
  g_event_engine->fd_shutdown(exec_ctx, fd, why);
***REMOVED***

bool grpc_fd_is_shutdown(grpc_fd* fd) ***REMOVED***
  return g_event_engine->fd_is_shutdown(fd);
***REMOVED***

void grpc_fd_notify_on_read(grpc_exec_ctx* exec_ctx, grpc_fd* fd,
                            grpc_closure* closure) ***REMOVED***
  g_event_engine->fd_notify_on_read(exec_ctx, fd, closure);
***REMOVED***

void grpc_fd_notify_on_write(grpc_exec_ctx* exec_ctx, grpc_fd* fd,
                             grpc_closure* closure) ***REMOVED***
  g_event_engine->fd_notify_on_write(exec_ctx, fd, closure);
***REMOVED***

size_t grpc_pollset_size(void) ***REMOVED*** return g_event_engine->pollset_size; ***REMOVED***

void grpc_pollset_init(grpc_pollset* pollset, gpr_mu** mu) ***REMOVED***
  g_event_engine->pollset_init(pollset, mu);
***REMOVED***

void grpc_pollset_shutdown(grpc_exec_ctx* exec_ctx, grpc_pollset* pollset,
                           grpc_closure* closure) ***REMOVED***
  g_event_engine->pollset_shutdown(exec_ctx, pollset, closure);
***REMOVED***

void grpc_pollset_destroy(grpc_exec_ctx* exec_ctx, grpc_pollset* pollset) ***REMOVED***
  g_event_engine->pollset_destroy(exec_ctx, pollset);
***REMOVED***

grpc_error* grpc_pollset_work(grpc_exec_ctx* exec_ctx, grpc_pollset* pollset,
                              grpc_pollset_worker** worker,
                              grpc_millis deadline) ***REMOVED***
  return g_event_engine->pollset_work(exec_ctx, pollset, worker, deadline);
***REMOVED***

grpc_error* grpc_pollset_kick(grpc_exec_ctx* exec_ctx, grpc_pollset* pollset,
                              grpc_pollset_worker* specific_worker) ***REMOVED***
  return g_event_engine->pollset_kick(exec_ctx, pollset, specific_worker);
***REMOVED***

void grpc_pollset_add_fd(grpc_exec_ctx* exec_ctx, grpc_pollset* pollset,
                         struct grpc_fd* fd) ***REMOVED***
  g_event_engine->pollset_add_fd(exec_ctx, pollset, fd);
***REMOVED***

grpc_pollset_set* grpc_pollset_set_create(void) ***REMOVED***
  return g_event_engine->pollset_set_create();
***REMOVED***

void grpc_pollset_set_destroy(grpc_exec_ctx* exec_ctx,
                              grpc_pollset_set* pollset_set) ***REMOVED***
  g_event_engine->pollset_set_destroy(exec_ctx, pollset_set);
***REMOVED***

void grpc_pollset_set_add_pollset(grpc_exec_ctx* exec_ctx,
                                  grpc_pollset_set* pollset_set,
                                  grpc_pollset* pollset) ***REMOVED***
  g_event_engine->pollset_set_add_pollset(exec_ctx, pollset_set, pollset);
***REMOVED***

void grpc_pollset_set_del_pollset(grpc_exec_ctx* exec_ctx,
                                  grpc_pollset_set* pollset_set,
                                  grpc_pollset* pollset) ***REMOVED***
  g_event_engine->pollset_set_del_pollset(exec_ctx, pollset_set, pollset);
***REMOVED***

void grpc_pollset_set_add_pollset_set(grpc_exec_ctx* exec_ctx,
                                      grpc_pollset_set* bag,
                                      grpc_pollset_set* item) ***REMOVED***
  g_event_engine->pollset_set_add_pollset_set(exec_ctx, bag, item);
***REMOVED***

void grpc_pollset_set_del_pollset_set(grpc_exec_ctx* exec_ctx,
                                      grpc_pollset_set* bag,
                                      grpc_pollset_set* item) ***REMOVED***
  g_event_engine->pollset_set_del_pollset_set(exec_ctx, bag, item);
***REMOVED***

void grpc_pollset_set_add_fd(grpc_exec_ctx* exec_ctx,
                             grpc_pollset_set* pollset_set, grpc_fd* fd) ***REMOVED***
  g_event_engine->pollset_set_add_fd(exec_ctx, pollset_set, fd);
***REMOVED***

void grpc_pollset_set_del_fd(grpc_exec_ctx* exec_ctx,
                             grpc_pollset_set* pollset_set, grpc_fd* fd) ***REMOVED***
  g_event_engine->pollset_set_del_fd(exec_ctx, pollset_set, fd);
***REMOVED***

#endif  // GRPC_POSIX_SOCKET
