// Basically just a wrapper around an fs.readlink
//
// XXX: Enhance this to support the Link type, by keeping
// a lookup table of ***REMOVED***<dev+inode>:<path>***REMOVED***, so that hardlinks
// can be preserved in tarballs.

module.exports = LinkReader

var fs = require('graceful-fs')
var inherits = require('inherits')
var Reader = require('./reader.js')

inherits(LinkReader, Reader)

function LinkReader (props) ***REMOVED***
  var self = this
  if (!(self instanceof LinkReader)) ***REMOVED***
    throw new Error('LinkReader must be called as constructor.')
  ***REMOVED***

  if (!((props.type === 'Link' && props.Link) ||
    (props.type === 'SymbolicLink' && props.SymbolicLink))) ***REMOVED***
    throw new Error('Non-link type ' + props.type)
  ***REMOVED***

  Reader.call(self, props)
***REMOVED***

// When piping a LinkReader into a LinkWriter, we have to
// already have the linkpath property set, so that has to
// happen *before* the "ready" event, which means we need to
// override the _stat method.
LinkReader.prototype._stat = function (currentStat) ***REMOVED***
  var self = this
  fs.readlink(self._path, function (er, linkpath) ***REMOVED***
    if (er) return self.error(er)
    self.linkpath = self.props.linkpath = linkpath
    self.emit('linkpath', linkpath)
    Reader.prototype._stat.call(self, currentStat)
  ***REMOVED***)
***REMOVED***

LinkReader.prototype._read = function () ***REMOVED***
  var self = this
  if (self._paused) return
  // basically just a no-op, since we got all the info we need
  // from the _stat method
  if (!self._ended) ***REMOVED***
    self.emit('end')
    self.emit('close')
    self._ended = true
  ***REMOVED***
***REMOVED***
