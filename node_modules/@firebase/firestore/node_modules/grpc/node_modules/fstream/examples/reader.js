var fstream = require('../fstream.js')
var tap = require('tap')
var fs = require('fs')
var path = require('path')
var dir = path.dirname(__dirname)

tap.test('reader test', function (t) ***REMOVED***
  var children = -1
  var gotReady = false
  var ended = false

  var r = fstream.Reader(***REMOVED***
    path: dir,
    filter: function () ***REMOVED***
      // return this.parent === r
      return this.parent === r || this === r
    ***REMOVED***
  ***REMOVED***)

  r.on('ready', function () ***REMOVED***
    gotReady = true
    children = fs.readdirSync(dir).length
    console.error('Setting expected children to ' + children)
    t.equal(r.type, 'Directory', 'should be a directory')
  ***REMOVED***)

  r.on('entry', function (entry) ***REMOVED***
    children--
    if (!gotReady) ***REMOVED***
      t.fail('children before ready!')
    ***REMOVED***
    t.equal(entry.dirname, r.path, 'basename is parent dir')
  ***REMOVED***)

  r.on('error', function (er) ***REMOVED***
    t.fail(er)
    t.end()
    process.exit(1)
  ***REMOVED***)

  r.on('end', function () ***REMOVED***
    t.equal(children, 0, 'should have seen all children')
    ended = true
  ***REMOVED***)

  var closed = false
  r.on('close', function () ***REMOVED***
    t.ok(ended, 'saw end before close')
    t.notOk(closed, 'close should only happen once')
    closed = true
    t.end()
  ***REMOVED***)
***REMOVED***)

tap.test('reader error test', function (t) ***REMOVED***
  // assumes non-root on a *nix system
  var r = fstream.Reader(***REMOVED*** path: '/etc/shadow' ***REMOVED***)

  r.once('error', function (er) ***REMOVED***
    t.ok(true)
    t.end()
  ***REMOVED***)

  r.on('end', function () ***REMOVED***
    t.fail('reader ended without error')
    t.end()
  ***REMOVED***)
***REMOVED***)
