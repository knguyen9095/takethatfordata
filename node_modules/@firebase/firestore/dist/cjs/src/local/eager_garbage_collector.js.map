***REMOVED***"version":3,"sources":["../src/local/eager_garbage_collector.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;GAcG;;AAEH,oDAAsE;AAMtE,6DAA2D;AAE3D;;;;;;;;GAQG;AACH;IAAA;QACW,YAAO,GAAG,IAAI,CAAC;QAExB;;WAEG;QACK,YAAO,GAAoB,EAAE,CAAC;QAEtC;;;WAGG;QACK,qBAAgB,GAAmB,4BAAc,EAAE,CAAC;IAyD9D,CAAC;IAvDC,gDAAgB,GAAhB,UAAiB,aAA4B;QAC3C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;QACjC,aAAa,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;IAC1C,CAAC;IAED,mDAAmB,GAAnB,UAAoB,aAA4B;QAC9C,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,aAAa,CAAC,EAAE,CAAC,CAAC,CAAC;QAC5D,aAAa,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;IAC1C,CAAC;IAED,sDAAsB,GAAtB,UAAuB,GAAgB;QACrC,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IACzD,CAAC;IAED,8CAAc,GAAd,UACE,GAAkC;QADpC,iBAsBC;QAnBC,IAAM,QAAQ,GAAoC,EAAE,CAAC;QACrD,IAAI,WAAW,GAAG,4BAAc,EAAE,CAAC;QAEnC,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAAC,UAAA,GAAG;YAC/B,IAAM,cAAc,GAAG,KAAI,CAAC,wBAAwB,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;YAC/D,QAAQ,CAAC,IAAI,CACX,cAAc,CAAC,IAAI,CAAC,UAAA,OAAO;gBACzB,2CAA2C;gBAC3C,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;oBACb,WAAW,GAAG,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBACrC,CAAC;gBACD,MAAM,CAAC,wCAAkB,CAAC,OAAO,EAAE,CAAC;YACtC,CAAC,CAAC,CACH,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,wEAAwE;QACxE,IAAI,CAAC,gBAAgB,GAAG,4BAAc,EAAE,CAAC;QACzC,MAAM,CAAC,wCAAkB,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,cAAM,OAAA,WAAW,EAAX,CAAW,CAAC,CAAC;IACtE,CAAC;IAED,wDAAwB,GAAxB,UACE,GAAkC,EAClC,GAAgB;QAEhB,IAAM,OAAO,GAAG,wCAAkB,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAClD,MAAM,CAAC,IAAI,CAAC,OAAO;aAChB,GAAG,CAAC,UAAA,MAAM,IAAI,OAAA,cAAM,OAAA,MAAM,CAAC,WAAW,CAAC,GAAG,EAAE,GAAG,CAAC,EAA5B,CAA4B,EAAlC,CAAkC,CAAC;aACjD,MAAM,CAA8B,UAAC,OAAO,EAAE,WAAW;YACxD,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,UAAA,MAAM;gBACxB,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;oBACX,MAAM,CAAC,wCAAkB,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;gBAC1C,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACN,MAAM,CAAC,WAAW,EAAE,CAAC;gBACvB,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC,EAAE,OAAO,CAAC,CAAC;IAChB,CAAC;IACH,4BAAC;AAAD,CArEA,AAqEC,IAAA;AArEY,sDAAqB","file":"eager_garbage_collector.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport ***REMOVED*** DocumentKeySet, documentKeySet ***REMOVED*** from '../model/collections';\nimport ***REMOVED*** DocumentKey ***REMOVED*** from '../model/document_key';\n\nimport ***REMOVED*** GarbageCollector ***REMOVED*** from './garbage_collector';\nimport ***REMOVED*** GarbageSource ***REMOVED*** from './garbage_source';\nimport ***REMOVED*** PersistenceTransaction ***REMOVED*** from './persistence';\nimport ***REMOVED*** PersistencePromise ***REMOVED*** from './persistence_promise';\n\n/**\n * A garbage collector implementation that eagerly collects documents as soon as\n * they're no longer referenced in any of its registered GarbageSources.\n *\n * This implementation keeps track of a set of keys that are potentially garbage\n * without keeping an exact reference count. During collectGarbage, the\n * collector verifies that all potential garbage keys actually have no\n * references by consulting its list of garbage sources.\n */\nexport class EagerGarbageCollector implements GarbageCollector ***REMOVED***\n  readonly isEager = true;\n\n  /**\n   * The garbage collectible sources to double-check during garbage collection.\n   */\n  private sources: GarbageSource[] = [];\n\n  /**\n   * A set of potentially garbage keys.\n   * PORTING NOTE: This would be a mutable set if Javascript had one.\n   */\n  private potentialGarbage: DocumentKeySet = documentKeySet();\n\n  addGarbageSource(garbageSource: GarbageSource): void ***REMOVED***\n    this.sources.push(garbageSource);\n    garbageSource.setGarbageCollector(this);\n  ***REMOVED***\n\n  removeGarbageSource(garbageSource: GarbageSource): void ***REMOVED***\n    this.sources.splice(this.sources.indexOf(garbageSource), 1);\n    garbageSource.setGarbageCollector(null);\n  ***REMOVED***\n\n  addPotentialGarbageKey(key: DocumentKey): void ***REMOVED***\n    this.potentialGarbage = this.potentialGarbage.add(key);\n  ***REMOVED***\n\n  collectGarbage(\n    txn: PersistenceTransaction | null\n  ): PersistencePromise<DocumentKeySet> ***REMOVED***\n    const promises: Array<PersistencePromise<void>> = [];\n    let garbageKeys = documentKeySet();\n\n    this.potentialGarbage.forEach(key => ***REMOVED***\n      const hasRefsPromise = this.documentHasAnyReferences(txn, key);\n      promises.push(\n        hasRefsPromise.next(hasRefs => ***REMOVED***\n          // If there are no references, get the key.\n          if (!hasRefs) ***REMOVED***\n            garbageKeys = garbageKeys.add(key);\n          ***REMOVED***\n          return PersistencePromise.resolve();\n        ***REMOVED***)\n      );\n    ***REMOVED***);\n\n    // Clear locally retained potential keys and returned confirmed garbage.\n    this.potentialGarbage = documentKeySet();\n    return PersistencePromise.waitFor(promises).next(() => garbageKeys);\n  ***REMOVED***\n\n  documentHasAnyReferences(\n    txn: PersistenceTransaction | null,\n    key: DocumentKey\n  ): PersistencePromise<boolean> ***REMOVED***\n    const initial = PersistencePromise.resolve(false);\n    return this.sources\n      .map(source => () => source.containsKey(txn, key))\n      .reduce<PersistencePromise<boolean>>((promise, nextPromise) => ***REMOVED***\n        return promise.next(result => ***REMOVED***\n          if (result) ***REMOVED***\n            return PersistencePromise.resolve(true);\n          ***REMOVED*** else ***REMOVED***\n            return nextPromise();\n          ***REMOVED***\n        ***REMOVED***);\n      ***REMOVED***, initial);\n  ***REMOVED***\n***REMOVED***\n"]***REMOVED***