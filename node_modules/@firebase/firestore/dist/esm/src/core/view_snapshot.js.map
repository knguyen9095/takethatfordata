***REMOVED***"version":3,"sources":["../src/core/view_snapshot.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;GAcG;AAGH,OAAO,EAAE,WAAW,EAAE,MAAM,uBAAuB,CAAC;AAEpD,OAAO,EAAE,IAAI,EAAE,MAAM,gBAAgB,CAAC;AACtC,OAAO,EAAE,SAAS,EAAE,MAAM,oBAAoB,CAAC;AAI/C,MAAM,CAAN,IAAY,UAKX;AALD,WAAY,UAAU;IACpB,6CAAK,CAAA;IACL,iDAAO,CAAA;IACP,mDAAQ,CAAA;IACR,mDAAQ,CAAA;AACV,CAAC,EALW,UAAU,KAAV,UAAU,QAKrB;AAOD,MAAM,CAAN,IAAY,SAGX;AAHD,WAAY,SAAS;IACnB,2CAAK,CAAA;IACL,6CAAM,CAAA;AACR,CAAC,EAHW,SAAS,KAAT,SAAS,QAGpB;AAED;;;GAGG;AACH;IAKE;QAJQ,cAAS,GAAG,IAAI,SAAS,CAC/B,WAAW,CAAC,UAAU,CACvB,CAAC;IAEa,CAAC;IAEhB,iCAAK,GAAL,UAAM,MAA0B;QAC9B,IAAM,GAAG,GAAG,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC;QAC3B,IAAM,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC1C,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;YACf,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;YACpD,MAAM,CAAC;QACT,CAAC;QAED,iDAAiD;QACjD,EAAE,CAAC,CACD,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,KAAK;YAChC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,QAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QACtD,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CACR,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,QAAQ;YACnC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,OAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE;gBAC1C,IAAI,EAAE,SAAS,CAAC,IAAI;gBACpB,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB,CAAC,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CACR,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,QAAQ;YACnC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,QAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE;gBAC1C,IAAI,EAAE,UAAU,CAAC,QAAQ;gBACzB,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB,CAAC,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CACR,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,QAAQ;YACnC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,KAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE;gBAC1C,IAAI,EAAE,UAAU,CAAC,KAAK;gBACtB,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB,CAAC,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CACR,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,OAAO;YAClC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,KAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC9C,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CACR,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,OAAO;YAClC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,QAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE;gBAC1C,IAAI,EAAE,UAAU,CAAC,OAAO;gBACxB,GAAG,EAAE,SAAS,CAAC,GAAG;aACnB,CAAC,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CACR,MAAM,CAAC,IAAI,KAAK,UAAU,CAAC,KAAK;YAChC,SAAS,CAAC,IAAI,KAAK,UAAU,CAAC,OAChC,CAAC,CAAC,CAAC;YACD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,GAAG,EAAE;gBAC1C,IAAI,EAAE,UAAU,CAAC,QAAQ;gBACzB,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB,CAAC,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,CAAC;YACN,qDAAqD;YACrD,eAAe;YACf,mBAAmB;YACnB,kBAAkB;YAClB,oBAAoB;YACpB,kBAAkB;YAClB,oBAAoB;YACpB,IAAI,CACF,sCAAsC;gBACpC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;gBACtB,SAAS;gBACT,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAC5B,CAAC;QACJ,CAAC;IACH,CAAC;IAED,sCAAU,GAAV;QACE,IAAM,OAAO,GAAyB,EAAE,CAAC;QACzC,IAAI,CAAC,SAAS,CAAC,gBAAgB,CAC7B,UAAC,GAAgB,EAAE,MAA0B;YAC3C,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACvB,CAAC,CACF,CAAC;QACF,MAAM,CAAC,OAAO,CAAC;IACjB,CAAC;IACH,wBAAC;AAAD,CA5FA,AA4FC,IAAA;;AAED;IACE,sBACW,KAAY,EACZ,IAAiB,EACjB,OAAoB,EACpB,UAAgC,EAChC,SAAkB,EAClB,gBAAyB,EACzB,gBAAyB;QANzB,UAAK,GAAL,KAAK,CAAO;QACZ,SAAI,GAAJ,IAAI,CAAa;QACjB,YAAO,GAAP,OAAO,CAAa;QACpB,eAAU,GAAV,UAAU,CAAsB;QAChC,cAAS,GAAT,SAAS,CAAS;QAClB,qBAAgB,GAAhB,gBAAgB,CAAS;QACzB,qBAAgB,GAAhB,gBAAgB,CAAS;IACjC,CAAC;IAEJ,8BAAO,GAAP,UAAQ,KAAmB;QACzB,EAAE,CAAC,CACD,IAAI,CAAC,SAAS,KAAK,KAAK,CAAC,SAAS;YAClC,IAAI,CAAC,gBAAgB,KAAK,KAAK,CAAC,gBAAgB;YAChD,IAAI,CAAC,gBAAgB,KAAK,KAAK,CAAC,gBAAgB;YAChD,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC;YAChC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC;YAC9B,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,OAAO,CACrC,CAAC,CAAC,CAAC;YACD,MAAM,CAAC,KAAK,CAAC;QACf,CAAC;QACD,IAAM,OAAO,GAAyB,IAAI,CAAC,UAAU,CAAC;QACtD,IAAM,YAAY,GAAyB,KAAK,CAAC,UAAU,CAAC;QAC5D,EAAE,CAAC,CAAC,OAAO,CAAC,MAAM,KAAK,YAAY,CAAC,MAAM,CAAC,CAAC,CAAC;YAC3C,MAAM,CAAC,KAAK,CAAC;QACf,CAAC;QACD,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACxC,EAAE,CAAC,CACD,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,KAAK,YAAY,CAAC,CAAC,CAAC,CAAC,IAAI;gBACxC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,GAAG,CAC7C,CAAC,CAAC,CAAC;gBACD,MAAM,CAAC,KAAK,CAAC;YACf,CAAC;QACH,CAAC;QACD,MAAM,CAAC,IAAI,CAAC;IACd,CAAC;IACH,mBAAC;AAAD,CArCA,AAqCC,IAAA","file":"view_snapshot.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport ***REMOVED*** Document ***REMOVED*** from '../model/document';\nimport ***REMOVED*** DocumentKey ***REMOVED*** from '../model/document_key';\nimport ***REMOVED*** DocumentSet ***REMOVED*** from '../model/document_set';\nimport ***REMOVED*** fail ***REMOVED*** from '../util/assert';\nimport ***REMOVED*** SortedMap ***REMOVED*** from '../util/sorted_map';\n\nimport ***REMOVED*** Query ***REMOVED*** from './query';\n\nexport enum ChangeType ***REMOVED***\n  Added,\n  Removed,\n  Modified,\n  Metadata\n***REMOVED***\n\nexport interface DocumentViewChange ***REMOVED***\n  type: ChangeType;\n  doc: Document;\n***REMOVED***\n\nexport enum SyncState ***REMOVED***\n  Local,\n  Synced\n***REMOVED***\n\n/**\n * DocumentChangeSet keeps track of a set of changes to docs in a query, merging\n * duplicate events for the same doc.\n */\nexport class DocumentChangeSet ***REMOVED***\n  private changeMap = new SortedMap<DocumentKey, DocumentViewChange>(\n    DocumentKey.comparator\n  );\n\n  constructor() ***REMOVED******REMOVED***\n\n  track(change: DocumentViewChange) ***REMOVED***\n    const key = change.doc.key;\n    const oldChange = this.changeMap.get(key);\n    if (!oldChange) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, change);\n      return;\n    ***REMOVED***\n\n    // Merge the new change with the existing change.\n    if (\n      change.type !== ChangeType.Added &&\n      oldChange.type === ChangeType.Metadata\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, change);\n    ***REMOVED*** else if (\n      change.type === ChangeType.Metadata &&\n      oldChange.type !== ChangeType.Removed\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, ***REMOVED***\n        type: oldChange.type,\n        doc: change.doc\n      ***REMOVED***);\n    ***REMOVED*** else if (\n      change.type === ChangeType.Modified &&\n      oldChange.type === ChangeType.Modified\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, ***REMOVED***\n        type: ChangeType.Modified,\n        doc: change.doc\n      ***REMOVED***);\n    ***REMOVED*** else if (\n      change.type === ChangeType.Modified &&\n      oldChange.type === ChangeType.Added\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, ***REMOVED***\n        type: ChangeType.Added,\n        doc: change.doc\n      ***REMOVED***);\n    ***REMOVED*** else if (\n      change.type === ChangeType.Removed &&\n      oldChange.type === ChangeType.Added\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.remove(key);\n    ***REMOVED*** else if (\n      change.type === ChangeType.Removed &&\n      oldChange.type === ChangeType.Modified\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, ***REMOVED***\n        type: ChangeType.Removed,\n        doc: oldChange.doc\n      ***REMOVED***);\n    ***REMOVED*** else if (\n      change.type === ChangeType.Added &&\n      oldChange.type === ChangeType.Removed\n    ) ***REMOVED***\n      this.changeMap = this.changeMap.insert(key, ***REMOVED***\n        type: ChangeType.Modified,\n        doc: change.doc\n      ***REMOVED***);\n    ***REMOVED*** else ***REMOVED***\n      // This includes these cases, which don't make sense:\n      // Added->Added\n      // Removed->Removed\n      // Modified->Added\n      // Removed->Modified\n      // Metadata->Added\n      // Removed->Metadata\n      fail(\n        'unsupported combination of changes: ' +\n          JSON.stringify(change) +\n          ' after ' +\n          JSON.stringify(oldChange)\n      );\n    ***REMOVED***\n  ***REMOVED***\n\n  getChanges(): DocumentViewChange[] ***REMOVED***\n    const changes: DocumentViewChange[] = [];\n    this.changeMap.inorderTraversal(\n      (key: DocumentKey, change: DocumentViewChange) => ***REMOVED***\n        changes.push(change);\n      ***REMOVED***\n    );\n    return changes;\n  ***REMOVED***\n***REMOVED***\n\nexport class ViewSnapshot ***REMOVED***\n  constructor(\n    readonly query: Query,\n    readonly docs: DocumentSet,\n    readonly oldDocs: DocumentSet,\n    readonly docChanges: DocumentViewChange[],\n    readonly fromCache: boolean,\n    readonly hasPendingWrites: boolean,\n    readonly syncStateChanged: boolean\n  ) ***REMOVED******REMOVED***\n\n  isEqual(other: ViewSnapshot): boolean ***REMOVED***\n    if (\n      this.fromCache !== other.fromCache ||\n      this.hasPendingWrites !== other.hasPendingWrites ||\n      this.syncStateChanged !== other.syncStateChanged ||\n      !this.query.isEqual(other.query) ||\n      !this.docs.isEqual(other.docs) ||\n      !this.oldDocs.isEqual(other.oldDocs)\n    ) ***REMOVED***\n      return false;\n    ***REMOVED***\n    const changes: DocumentViewChange[] = this.docChanges;\n    const otherChanges: DocumentViewChange[] = other.docChanges;\n    if (changes.length !== otherChanges.length) ***REMOVED***\n      return false;\n    ***REMOVED***\n    for (let i = 0; i < changes.length; i++) ***REMOVED***\n      if (\n        changes[i].type !== otherChanges[i].type ||\n        !changes[i].doc.isEqual(otherChanges[i].doc)\n      ) ***REMOVED***\n        return false;\n      ***REMOVED***\n    ***REMOVED***\n    return true;\n  ***REMOVED***\n***REMOVED***\n"]***REMOVED***