***REMOVED***"version":3,"sources":["../src/core/view/EventRegistration.ts"],"names":[],"mappings":"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","file":"EventRegistration.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport ***REMOVED*** DataSnapshot ***REMOVED*** from '../../api/DataSnapshot';\nimport ***REMOVED*** DataEvent, CancelEvent, Event ***REMOVED*** from './Event';\nimport ***REMOVED*** contains, getCount, getAnyKey, every ***REMOVED*** from '@firebase/util';\nimport ***REMOVED*** assert ***REMOVED*** from '@firebase/util';\nimport ***REMOVED*** Path ***REMOVED*** from '../util/Path';\nimport ***REMOVED*** Change ***REMOVED*** from './Change';\nimport ***REMOVED*** Query ***REMOVED*** from '../../api/Query';\n\n/**\n * An EventRegistration is basically an event type ('value', 'child_added', etc.) and a callback\n * to be notified of that type of event.\n *\n * That said, it can also contain a cancel callback to be notified if the event is canceled.  And\n * currently, this code is organized around the idea that you would register multiple child_ callbacks\n * together, as a single EventRegistration.  Though currently we don't do that.\n */\nexport interface EventRegistration ***REMOVED***\n  /**\n   * True if this container has a callback to trigger for this event type\n   * @param ***REMOVED***!string***REMOVED*** eventType\n   * @return ***REMOVED***boolean***REMOVED***\n   */\n  respondsTo(eventType: string): boolean;\n\n  /**\n   * @param ***REMOVED***!Change***REMOVED*** change\n   * @param ***REMOVED***!Query***REMOVED*** query\n   * @return ***REMOVED***!Event***REMOVED***\n   */\n  createEvent(change: Change, query: Query): Event;\n\n  /**\n   * Given event data, return a function to trigger the user's callback\n   * @param ***REMOVED***!Event***REMOVED*** eventData\n   * @return ***REMOVED***function()***REMOVED***\n   */\n  getEventRunner(eventData: Event): () => void;\n\n  /**\n   * @param ***REMOVED***!Error***REMOVED*** error\n   * @param ***REMOVED***!Path***REMOVED*** path\n   * @return ***REMOVED***?CancelEvent***REMOVED***\n   */\n  createCancelEvent(error: Error, path: Path): CancelEvent | null;\n\n  /**\n   * @param ***REMOVED***!EventRegistration***REMOVED*** other\n   * @return ***REMOVED***boolean***REMOVED***\n   */\n  matches(other: EventRegistration): boolean;\n\n  /**\n   * False basically means this is a \"dummy\" callback container being used as a sentinel\n   * to remove all callback containers of a particular type.  (e.g. if the user does\n   * ref.off('value') without specifying a specific callback).\n   *\n   * (TODO: Rework this, since it's hacky)\n   *\n   * @return ***REMOVED***boolean***REMOVED***\n   */\n  hasAnyCallback(): boolean;\n***REMOVED***\n\n/**\n * Represents registration for 'value' events.\n */\nexport class ValueEventRegistration implements EventRegistration ***REMOVED***\n  /**\n   * @param ***REMOVED***?function(!DataSnapshot)***REMOVED*** callback_\n   * @param ***REMOVED***?function(Error)***REMOVED*** cancelCallback_\n   * @param ***REMOVED***?Object***REMOVED*** context_\n   */\n  constructor(\n    private callback_: ((d: DataSnapshot) => void) | null,\n    private cancelCallback_: ((e: Error) => void) | null,\n    private context_: Object | null\n  ) ***REMOVED******REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  respondsTo(eventType: string): boolean ***REMOVED***\n    return eventType === 'value';\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  createEvent(change: Change, query: Query): DataEvent ***REMOVED***\n    const index = query.getQueryParams().getIndex();\n    return new DataEvent(\n      'value',\n      this,\n      new DataSnapshot(change.snapshotNode, query.getRef(), index)\n    );\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  getEventRunner(eventData: CancelEvent | DataEvent): () => void ***REMOVED***\n    const ctx = this.context_;\n    if (eventData.getEventType() === 'cancel') ***REMOVED***\n      assert(\n        this.cancelCallback_,\n        'Raising a cancel event on a listener with no cancel callback'\n      );\n      const cancelCB = this.cancelCallback_;\n      return function() ***REMOVED***\n        // We know that error exists, we checked above that this is a cancel event\n        cancelCB.call(ctx, (eventData as CancelEvent).error);\n      ***REMOVED***;\n    ***REMOVED*** else ***REMOVED***\n      const cb = this.callback_;\n      return function() ***REMOVED***\n        cb.call(ctx, (eventData as DataEvent).snapshot);\n      ***REMOVED***;\n    ***REMOVED***\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  createCancelEvent(error: Error, path: Path): CancelEvent | null ***REMOVED***\n    if (this.cancelCallback_) ***REMOVED***\n      return new CancelEvent(this, error, path);\n    ***REMOVED*** else ***REMOVED***\n      return null;\n    ***REMOVED***\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  matches(other: EventRegistration): boolean ***REMOVED***\n    if (!(other instanceof ValueEventRegistration)) ***REMOVED***\n      return false;\n    ***REMOVED*** else if (!other.callback_ || !this.callback_) ***REMOVED***\n      // If no callback specified, we consider it to match any callback.\n      return true;\n    ***REMOVED*** else ***REMOVED***\n      return (\n        other.callback_ === this.callback_ && other.context_ === this.context_\n      );\n    ***REMOVED***\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  hasAnyCallback(): boolean ***REMOVED***\n    return this.callback_ !== null;\n  ***REMOVED***\n***REMOVED***\n\n/**\n * Represents the registration of 1 or more child_xxx events.\n *\n * Currently, it is always exactly 1 child_xxx event, but the idea is we might let you\n * register a group of callbacks together in the future.\n *\n * @constructor\n * @implements ***REMOVED***EventRegistration***REMOVED***\n */\nexport class ChildEventRegistration implements EventRegistration ***REMOVED***\n  /**\n   * @param ***REMOVED***?Object.<string, function(!DataSnapshot, ?string=)>***REMOVED*** callbacks_\n   * @param ***REMOVED***?function(Error)***REMOVED*** cancelCallback_\n   * @param ***REMOVED***Object=***REMOVED*** context_\n   */\n  constructor(\n    private callbacks_:\n      | (***REMOVED*** [k: string]: (d: DataSnapshot, s?: string | null) => void ***REMOVED***)\n      | null,\n    private cancelCallback_: ((e: Error) => void) | null,\n    private context_?: Object\n  ) ***REMOVED******REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  respondsTo(eventType: string): boolean ***REMOVED***\n    let eventToCheck =\n      eventType === 'children_added' ? 'child_added' : eventType;\n    eventToCheck =\n      eventToCheck === 'children_removed' ? 'child_removed' : eventToCheck;\n    return contains(this.callbacks_, eventToCheck);\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  createCancelEvent(error: Error, path: Path): CancelEvent | null ***REMOVED***\n    if (this.cancelCallback_) ***REMOVED***\n      return new CancelEvent(this, error, path);\n    ***REMOVED*** else ***REMOVED***\n      return null;\n    ***REMOVED***\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  createEvent(change: Change, query: Query): DataEvent ***REMOVED***\n    assert(change.childName != null, 'Child events should have a childName.');\n    const ref = query.getRef().child(/** @type ***REMOVED***!string***REMOVED*** */ (change.childName));\n    const index = query.getQueryParams().getIndex();\n    return new DataEvent(\n      change.type as any,\n      this,\n      new DataSnapshot(change.snapshotNode, ref, index as any),\n      change.prevName\n    );\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  getEventRunner(eventData: CancelEvent | DataEvent): () => void ***REMOVED***\n    const ctx = this.context_;\n    if (eventData.getEventType() === 'cancel') ***REMOVED***\n      assert(\n        this.cancelCallback_,\n        'Raising a cancel event on a listener with no cancel callback'\n      );\n      const cancelCB = this.cancelCallback_;\n      return function() ***REMOVED***\n        // We know that error exists, we checked above that this is a cancel event\n        cancelCB.call(ctx, (eventData as CancelEvent).error);\n      ***REMOVED***;\n    ***REMOVED*** else ***REMOVED***\n      const cb = this.callbacks_[(eventData as DataEvent).eventType];\n      return function() ***REMOVED***\n        cb.call(\n          ctx,\n          (eventData as DataEvent).snapshot,\n          (eventData as DataEvent).prevName\n        );\n      ***REMOVED***;\n    ***REMOVED***\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  matches(other: EventRegistration): boolean ***REMOVED***\n    if (other instanceof ChildEventRegistration) ***REMOVED***\n      if (!this.callbacks_ || !other.callbacks_) ***REMOVED***\n        return true;\n      ***REMOVED*** else if (this.context_ === other.context_) ***REMOVED***\n        const otherCount = getCount(other.callbacks_);\n        const thisCount = getCount(this.callbacks_);\n        if (otherCount === thisCount) ***REMOVED***\n          // If count is 1, do an exact match on eventType, if either is defined but null, it's a match.\n          //  If event types don't match, not a match\n          // If count is not 1, exact match across all\n\n          if (otherCount === 1) ***REMOVED***\n            const otherKey /** @type ***REMOVED***!string***REMOVED*** */ = getAnyKey(other.callbacks_);\n            const thisKey /** @type ***REMOVED***!string***REMOVED*** */ = getAnyKey(this.callbacks_);\n            return (\n              thisKey === otherKey &&\n              (!other.callbacks_[otherKey] ||\n                !this.callbacks_[thisKey] ||\n                other.callbacks_[otherKey] === this.callbacks_[thisKey])\n            );\n          ***REMOVED*** else ***REMOVED***\n            // Exact match on each key.\n            return every(\n              this.callbacks_,\n              (eventType, cb) => other.callbacks_[eventType] === cb\n            );\n          ***REMOVED***\n        ***REMOVED***\n      ***REMOVED***\n    ***REMOVED***\n\n    return false;\n  ***REMOVED***\n\n  /**\n   * @inheritDoc\n   */\n  hasAnyCallback(): boolean ***REMOVED***\n    return this.callbacks_ !== null;\n  ***REMOVED***\n***REMOVED***\n"]***REMOVED***