/**
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import ***REMOVED*** assert ***REMOVED*** from '@firebase/util';
import ***REMOVED*** Path ***REMOVED*** from './Path';
import ***REMOVED*** SparseSnapshotTree ***REMOVED*** from '../SparseSnapshotTree';
import ***REMOVED*** LeafNode ***REMOVED*** from '../snap/LeafNode';
import ***REMOVED*** nodeFromJSON ***REMOVED*** from '../snap/nodeFromJSON';
import ***REMOVED*** PRIORITY_INDEX ***REMOVED*** from '../snap/indexes/PriorityIndex';
/**
 * Generate placeholders for deferred values.
 * @param ***REMOVED***?Object***REMOVED*** values
 * @return ***REMOVED***!Object***REMOVED***
 */
export var generateWithValues = function (values) ***REMOVED***
    values = values || ***REMOVED******REMOVED***;
    values['timestamp'] = values['timestamp'] || new Date().getTime();
    return values;
***REMOVED***;
/**
 * Value to use when firing local events. When writing server values, fire
 * local events with an approximate value, otherwise return value as-is.
 * @param ***REMOVED***(Object|string|number|boolean)***REMOVED*** value
 * @param ***REMOVED***!Object***REMOVED*** serverValues
 * @return ***REMOVED***!(string|number|boolean)***REMOVED***
 */
export var resolveDeferredValue = function (value, serverValues) ***REMOVED***
    if (!value || typeof value !== 'object') ***REMOVED***
        return value;
    ***REMOVED***
    else ***REMOVED***
        assert('.sv' in value, 'Unexpected leaf node or priority contents');
        return serverValues[value['.sv']];
    ***REMOVED***
***REMOVED***;
/**
 * Recursively replace all deferred values and priorities in the tree with the
 * specified generated replacement values.
 * @param ***REMOVED***!SparseSnapshotTree***REMOVED*** tree
 * @param ***REMOVED***!Object***REMOVED*** serverValues
 * @return ***REMOVED***!SparseSnapshotTree***REMOVED***
 */
export var resolveDeferredValueTree = function (tree, serverValues) ***REMOVED***
    var resolvedTree = new SparseSnapshotTree();
    tree.forEachTree(new Path(''), function (path, node) ***REMOVED***
        resolvedTree.remember(path, resolveDeferredValueSnapshot(node, serverValues));
    ***REMOVED***);
    return resolvedTree;
***REMOVED***;
/**
 * Recursively replace all deferred values and priorities in the node with the
 * specified generated replacement values.  If there are no server values in the node,
 * it'll be returned as-is.
 * @param ***REMOVED***!Node***REMOVED*** node
 * @param ***REMOVED***!Object***REMOVED*** serverValues
 * @return ***REMOVED***!Node***REMOVED***
 */
export var resolveDeferredValueSnapshot = function (node, serverValues) ***REMOVED***
    var rawPri = node.getPriority().val();
    var priority = resolveDeferredValue(rawPri, serverValues);
    var newNode;
    if (node.isLeafNode()) ***REMOVED***
        var leafNode = node;
        var value = resolveDeferredValue(leafNode.getValue(), serverValues);
        if (value !== leafNode.getValue() ||
            priority !== leafNode.getPriority().val()) ***REMOVED***
            return new LeafNode(value, nodeFromJSON(priority));
        ***REMOVED***
        else ***REMOVED***
            return node;
        ***REMOVED***
    ***REMOVED***
    else ***REMOVED***
        var childrenNode = node;
        newNode = childrenNode;
        if (priority !== childrenNode.getPriority().val()) ***REMOVED***
            newNode = newNode.updatePriority(new LeafNode(priority));
        ***REMOVED***
        childrenNode.forEachChild(PRIORITY_INDEX, function (childName, childNode) ***REMOVED***
            var newChildNode = resolveDeferredValueSnapshot(childNode, serverValues);
            if (newChildNode !== childNode) ***REMOVED***
                newNode = newNode.updateImmediateChild(childName, newChildNode);
            ***REMOVED***
        ***REMOVED***);
        return newNode;
    ***REMOVED***
***REMOVED***;

//# sourceMappingURL=ServerValues.js.map
