'use strict';
var stringWidth = require('string-width');
var stripAnsi = require('strip-ansi');

var ESCAPES = [
	'\u001b',
	'\u009b'
];

var END_CODE = 39;

var ESCAPE_CODES = ***REMOVED***
	0: 0,
	1: 22,
	2: 22,
	3: 23,
	4: 24,
	7: 27,
	8: 28,
	9: 29,
	30: 39,
	31: 39,
	32: 39,
	33: 39,
	34: 39,
	35: 39,
	36: 39,
	37: 39,
	90: 39,
	40: 49,
	41: 49,
	42: 49,
	43: 49,
	44: 49,
	45: 49,
	46: 49,
	47: 49
***REMOVED***;

function wrapAnsi(code) ***REMOVED***
	return ESCAPES[0] + '[' + code + 'm';
***REMOVED***

// calculate the length of words split on ' ', ignoring
// the extra characters added by ansi escape codes.
function wordLengths(str) ***REMOVED***
	return str.split(' ').map(function (s) ***REMOVED***
		return stringWidth(s);
	***REMOVED***);
***REMOVED***

// wrap a long word across multiple rows.
// ansi escape codes do not count towards length.
function wrapWord(rows, word, cols) ***REMOVED***
	var insideEscape = false;
	var visible = stripAnsi(rows[rows.length - 1]).length;

	for (var i = 0; i < word.length; i++) ***REMOVED***
		var x = word[i];

		rows[rows.length - 1] += x;

		if (ESCAPES.indexOf(x) !== -1) ***REMOVED***
			insideEscape = true;
		***REMOVED*** else if (insideEscape && x === 'm') ***REMOVED***
			insideEscape = false;
			continue;
		***REMOVED***

		if (insideEscape) ***REMOVED***
			continue;
		***REMOVED***

		visible++;

		if (visible >= cols && i < word.length - 1) ***REMOVED***
			rows.push('');
			visible = 0;
		***REMOVED***
	***REMOVED***

	// it's possible that the last row we copy over is only
	// ansi escape characters, handle this edge-case.
	if (!visible && rows[rows.length - 1].length > 0 && rows.length > 1) ***REMOVED***
		rows[rows.length - 2] += rows.pop();
	***REMOVED***
***REMOVED***

// the wrap-ansi module can be invoked
// in either 'hard' or 'soft' wrap mode.
//
// 'hard' will never allow a string to take up more
// than cols characters.
//
// 'soft' allows long words to expand past the column length.
function exec(str, cols, opts) ***REMOVED***
	var options = opts || ***REMOVED******REMOVED***;

	var pre = '';
	var ret = '';
	var escapeCode;

	var lengths = wordLengths(str);
	var words = str.split(' ');
	var rows = [''];

	for (var i = 0, word; (word = words[i]) !== undefined; i++) ***REMOVED***
		var rowLength = stringWidth(rows[rows.length - 1]);

		if (rowLength) ***REMOVED***
			rows[rows.length - 1] += ' ';
			rowLength++;
		***REMOVED***

		// in 'hard' wrap mode, the length of a line is
		// never allowed to extend past 'cols'.
		if (lengths[i] > cols && options.hard) ***REMOVED***
			if (rowLength) ***REMOVED***
				rows.push('');
			***REMOVED***
			wrapWord(rows, word, cols);
			continue;
		***REMOVED***

		if (rowLength + lengths[i] > cols && rowLength > 0) ***REMOVED***
			if (options.wordWrap === false && rowLength < cols) ***REMOVED***
				wrapWord(rows, word, cols);
				continue;
			***REMOVED***

			rows.push('');
		***REMOVED***

		rows[rows.length - 1] += word;
	***REMOVED***

	pre = rows.map(function (r) ***REMOVED***
		return r.trim();
	***REMOVED***).join('\n');

	for (var j = 0; j < pre.length; j++) ***REMOVED***
		var y = pre[j];

		ret += y;

		if (ESCAPES.indexOf(y) !== -1) ***REMOVED***
			var code = parseFloat(/[0-9][^m]*/.exec(pre.slice(j, j + 4)));
			escapeCode = code === END_CODE ? null : code;
		***REMOVED***

		if (escapeCode && ESCAPE_CODES[escapeCode]) ***REMOVED***
			if (pre[j + 1] === '\n') ***REMOVED***
				ret += wrapAnsi(ESCAPE_CODES[escapeCode]);
			***REMOVED*** else if (y === '\n') ***REMOVED***
				ret += wrapAnsi(escapeCode);
			***REMOVED***
		***REMOVED***
	***REMOVED***

	return ret;
***REMOVED***

// for each line break, invoke the method separately.
module.exports = function (str, cols, opts) ***REMOVED***
	return String(str).split('\n').map(function (substr) ***REMOVED***
		return exec(substr, cols, opts);
	***REMOVED***).join('\n');
***REMOVED***;
