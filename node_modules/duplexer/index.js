var Stream = require("stream")
var writeMethods = ["write", "end", "destroy"]
var readMethods = ["resume", "pause"]
var readEvents = ["data", "close"]
var slice = Array.prototype.slice

module.exports = duplex

function forEach (arr, fn) ***REMOVED***
    if (arr.forEach) ***REMOVED***
        return arr.forEach(fn)
    ***REMOVED***

    for (var i = 0; i < arr.length; i++) ***REMOVED***
        fn(arr[i], i)
    ***REMOVED***
***REMOVED***

function duplex(writer, reader) ***REMOVED***
    var stream = new Stream()
    var ended = false

    forEach(writeMethods, proxyWriter)

    forEach(readMethods, proxyReader)

    forEach(readEvents, proxyStream)

    reader.on("end", handleEnd)

    writer.on("drain", function() ***REMOVED***
      stream.emit("drain")
    ***REMOVED***)

    writer.on("error", reemit)
    reader.on("error", reemit)

    stream.writable = writer.writable
    stream.readable = reader.readable

    return stream

    function proxyWriter(methodName) ***REMOVED***
        stream[methodName] = method

        function method() ***REMOVED***
            return writer[methodName].apply(writer, arguments)
        ***REMOVED***
    ***REMOVED***

    function proxyReader(methodName) ***REMOVED***
        stream[methodName] = method

        function method() ***REMOVED***
            stream.emit(methodName)
            var func = reader[methodName]
            if (func) ***REMOVED***
                return func.apply(reader, arguments)
            ***REMOVED***
            reader.emit(methodName)
        ***REMOVED***
    ***REMOVED***

    function proxyStream(methodName) ***REMOVED***
        reader.on(methodName, reemit)

        function reemit() ***REMOVED***
            var args = slice.call(arguments)
            args.unshift(methodName)
            stream.emit.apply(stream, args)
        ***REMOVED***
    ***REMOVED***

    function handleEnd() ***REMOVED***
        if (ended) ***REMOVED***
            return
        ***REMOVED***
        ended = true
        var args = slice.call(arguments)
        args.unshift("end")
        stream.emit.apply(stream, args)
    ***REMOVED***

    function reemit(err) ***REMOVED***
        stream.emit("error", err)
    ***REMOVED***
***REMOVED***
