var randomBytes = require('randombytes');
module.exports = findPrime;
findPrime.simpleSieve = simpleSieve;
findPrime.fermatTest = fermatTest;
var BN = require('bn.js');
var TWENTYFOUR = new BN(24);
var MillerRabin = require('miller-rabin');
var millerRabin = new MillerRabin();
var ONE = new BN(1);
var TWO = new BN(2);
var FIVE = new BN(5);
var SIXTEEN = new BN(16);
var EIGHT = new BN(8);
var TEN = new BN(10);
var THREE = new BN(3);
var SEVEN = new BN(7);
var ELEVEN = new BN(11);
var FOUR = new BN(4);
var TWELVE = new BN(12);
var primes = null;

function _getPrimes() ***REMOVED***
  if (primes !== null)
    return primes;

  var limit = 0x100000;
  var res = [];
  res[0] = 2;
  for (var i = 1, k = 3; k < limit; k += 2) ***REMOVED***
    var sqrt = Math.ceil(Math.sqrt(k));
    for (var j = 0; j < i && res[j] <= sqrt; j++)
      if (k % res[j] === 0)
        break;

    if (i !== j && res[j] <= sqrt)
      continue;

    res[i++] = k;
  ***REMOVED***
  primes = res;
  return res;
***REMOVED***

function simpleSieve(p) ***REMOVED***
  var primes = _getPrimes();

  for (var i = 0; i < primes.length; i++)
    if (p.modn(primes[i]) === 0) ***REMOVED***
      if (p.cmpn(primes[i]) === 0) ***REMOVED***
        return true;
      ***REMOVED*** else ***REMOVED***
        return false;
      ***REMOVED***
    ***REMOVED***

  return true;
***REMOVED***

function fermatTest(p) ***REMOVED***
  var red = BN.mont(p);
  return TWO.toRed(red).redPow(p.subn(1)).fromRed().cmpn(1) === 0;
***REMOVED***

function findPrime(bits, gen) ***REMOVED***
  if (bits < 16) ***REMOVED***
    // this is what openssl does
    if (gen === 2 || gen === 5) ***REMOVED***
      return new BN([0x8c, 0x7b]);
    ***REMOVED*** else ***REMOVED***
      return new BN([0x8c, 0x27]);
    ***REMOVED***
  ***REMOVED***
  gen = new BN(gen);

  var num, n2;

  while (true) ***REMOVED***
    num = new BN(randomBytes(Math.ceil(bits / 8)));
    while (num.bitLength() > bits) ***REMOVED***
      num.ishrn(1);
    ***REMOVED***
    if (num.isEven()) ***REMOVED***
      num.iadd(ONE);
    ***REMOVED***
    if (!num.testn(1)) ***REMOVED***
      num.iadd(TWO);
    ***REMOVED***
    if (!gen.cmp(TWO)) ***REMOVED***
      while (num.mod(TWENTYFOUR).cmp(ELEVEN)) ***REMOVED***
        num.iadd(FOUR);
      ***REMOVED***
    ***REMOVED*** else if (!gen.cmp(FIVE)) ***REMOVED***
      while (num.mod(TEN).cmp(THREE)) ***REMOVED***
        num.iadd(FOUR);
      ***REMOVED***
    ***REMOVED***
    n2 = num.shrn(1);
    if (simpleSieve(n2) && simpleSieve(num) &&
      fermatTest(n2) && fermatTest(num) &&
      millerRabin.test(n2) && millerRabin.test(num)) ***REMOVED***
      return num;
    ***REMOVED***
  ***REMOVED***

***REMOVED***
