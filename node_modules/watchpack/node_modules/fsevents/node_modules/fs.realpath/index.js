module.exports = realpath
realpath.realpath = realpath
realpath.sync = realpathSync
realpath.realpathSync = realpathSync
realpath.monkeypatch = monkeypatch
realpath.unmonkeypatch = unmonkeypatch

var fs = require('fs')
var origRealpath = fs.realpath
var origRealpathSync = fs.realpathSync

var version = process.version
var ok = /^v[0-5]\./.test(version)
var old = require('./old.js')

function newError (er) ***REMOVED***
  return er && er.syscall === 'realpath' && (
    er.code === 'ELOOP' ||
    er.code === 'ENOMEM' ||
    er.code === 'ENAMETOOLONG'
  )
***REMOVED***

function realpath (p, cache, cb) ***REMOVED***
  if (ok) ***REMOVED***
    return origRealpath(p, cache, cb)
  ***REMOVED***

  if (typeof cache === 'function') ***REMOVED***
    cb = cache
    cache = null
  ***REMOVED***
  origRealpath(p, cache, function (er, result) ***REMOVED***
    if (newError(er)) ***REMOVED***
      old.realpath(p, cache, cb)
    ***REMOVED*** else ***REMOVED***
      cb(er, result)
    ***REMOVED***
  ***REMOVED***)
***REMOVED***

function realpathSync (p, cache) ***REMOVED***
  if (ok) ***REMOVED***
    return origRealpathSync(p, cache)
  ***REMOVED***

  try ***REMOVED***
    return origRealpathSync(p, cache)
  ***REMOVED*** catch (er) ***REMOVED***
    if (newError(er)) ***REMOVED***
      return old.realpathSync(p, cache)
    ***REMOVED*** else ***REMOVED***
      throw er
    ***REMOVED***
  ***REMOVED***
***REMOVED***

function monkeypatch () ***REMOVED***
  fs.realpath = realpath
  fs.realpathSync = realpathSync
***REMOVED***

function unmonkeypatch () ***REMOVED***
  fs.realpath = origRealpath
  fs.realpathSync = origRealpathSync
***REMOVED***
