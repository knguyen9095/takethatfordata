var fstream = require('../fstream.js')
var path = require('path')

var r = fstream.Reader(***REMOVED***
  path: path.dirname(__dirname),
  filter: function () ***REMOVED***
    return !this.basename.match(/^\./) &&
      !this.basename.match(/^node_modules$/) &&
      !this.basename.match(/^deep-copy$/) &&
      !this.basename.match(/^filter-copy$/)
  ***REMOVED***
***REMOVED***)

// this writer will only write directories
var w = fstream.Writer(***REMOVED***
  path: path.resolve(__dirname, 'filter-copy'),
  type: 'Directory',
  filter: function () ***REMOVED***
    return this.type === 'Directory'
  ***REMOVED***
***REMOVED***)

var indent = ''

r.on('entry', appears)
r.on('ready', function () ***REMOVED***
  console.error('ready to begin!', r.path)
***REMOVED***)

function appears (entry) ***REMOVED***
  console.error(indent + 'a %s appears!', entry.type, entry.basename, typeof entry.basename)
  if (foggy) ***REMOVED***
    console.error('FOGGY!')
    var p = entry
    do ***REMOVED***
      console.error(p.depth, p.path, p._paused)
      p = p.parent
    ***REMOVED*** while (p)

    throw new Error('\u001b[mshould not have entries while foggy')
  ***REMOVED***
  indent += '\t'
  entry.on('data', missile(entry))
  entry.on('end', runaway(entry))
  entry.on('entry', appears)
***REMOVED***

var foggy
function missile (entry) ***REMOVED***
  function liftFog (who) ***REMOVED***
    if (!foggy) return
    if (who) ***REMOVED***
      console.error('%s breaks the spell!', who && who.path)
    ***REMOVED*** else ***REMOVED***
      console.error('the spell expires!')
    ***REMOVED***
    console.error('\u001b[mthe fog lifts!\n')
    clearTimeout(foggy)
    foggy = null
    if (entry._paused) entry.resume()
  ***REMOVED***

  if (entry.type === 'Directory') ***REMOVED***
    var ended = false
    entry.once('end', function () ***REMOVED*** ended = true ***REMOVED***)
    return function (c) ***REMOVED***
      // throw in some pathological pause()/resume() behavior
      // just for extra fun.
      process.nextTick(function () ***REMOVED***
        if (!foggy && !ended) ***REMOVED*** // && Math.random() < 0.3) ***REMOVED***
          console.error(indent + '%s casts a spell', entry.basename)
          console.error('\na slowing fog comes over the battlefield...\n\u001b[32m')
          entry.pause()
          entry.once('resume', liftFog)
          foggy = setTimeout(liftFog, 1000)
        ***REMOVED***
      ***REMOVED***)
    ***REMOVED***
  ***REMOVED***

  return function (c) ***REMOVED***
    var e = Math.random() < 0.5
    console.error(indent + '%s %s for %d damage!',
      entry.basename,
      e ? 'is struck' : 'fires a chunk',
      c.length)
  ***REMOVED***
***REMOVED***

function runaway (entry) ***REMOVED***
  return function () ***REMOVED***
    var e = Math.random() < 0.5
    console.error(indent + '%s %s',
      entry.basename,
      e ? 'turns to flee' : 'is vanquished!')
    indent = indent.slice(0, -1)
  ***REMOVED***
***REMOVED***

w.on('entry', attacks)
// w.on('ready', function () ***REMOVED*** attacks(w) ***REMOVED***)
function attacks (entry) ***REMOVED***
  console.error(indent + '%s %s!', entry.basename,
    entry.type === 'Directory' ? 'calls for backup' : 'attacks')
  entry.on('entry', attacks)
***REMOVED***

var ended = false
var i = 1
r.on('end', function () ***REMOVED***
  if (foggy) clearTimeout(foggy)
  console.error("\u001b[mIT'S OVER!!")
  console.error('A WINNAR IS YOU!')

  console.log('ok ' + (i++) + ' A WINNAR IS YOU')
  ended = true
  // now go through and verify that everything in there is a dir.
  var p = path.resolve(__dirname, 'filter-copy')
  var checker = fstream.Reader(***REMOVED*** path: p ***REMOVED***)
  checker.checker = true
  checker.on('child', function (e) ***REMOVED***
    var ok = e.type === 'Directory'
    console.log((ok ? '' : 'not ') + 'ok ' + (i++) +
      ' should be a dir: ' +
      e.path.substr(checker.path.length + 1))
  ***REMOVED***)
***REMOVED***)

process.on('exit', function () ***REMOVED***
  console.log((ended ? '' : 'not ') + 'ok ' + (i) + ' ended')
  console.log('1..' + i)
***REMOVED***)

r.pipe(w)
