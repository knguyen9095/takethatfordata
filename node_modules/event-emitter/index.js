'use strict';

var d        = require('d')
  , callable = require('es5-ext/object/valid-callable')

  , apply = Function.prototype.apply, call = Function.prototype.call
  , create = Object.create, defineProperty = Object.defineProperty
  , defineProperties = Object.defineProperties
  , hasOwnProperty = Object.prototype.hasOwnProperty
  , descriptor = ***REMOVED*** configurable: true, enumerable: false, writable: true ***REMOVED***

  , on, once, off, emit, methods, descriptors, base;

on = function (type, listener) ***REMOVED***
	var data;

	callable(listener);

	if (!hasOwnProperty.call(this, '__ee__')) ***REMOVED***
		data = descriptor.value = create(null);
		defineProperty(this, '__ee__', descriptor);
		descriptor.value = null;
	***REMOVED*** else ***REMOVED***
		data = this.__ee__;
	***REMOVED***
	if (!data[type]) data[type] = listener;
	else if (typeof data[type] === 'object') data[type].push(listener);
	else data[type] = [data[type], listener];

	return this;
***REMOVED***;

once = function (type, listener) ***REMOVED***
	var once, self;

	callable(listener);
	self = this;
	on.call(this, type, once = function () ***REMOVED***
		off.call(self, type, once);
		apply.call(listener, this, arguments);
	***REMOVED***);

	once.__eeOnceListener__ = listener;
	return this;
***REMOVED***;

off = function (type, listener) ***REMOVED***
	var data, listeners, candidate, i;

	callable(listener);

	if (!hasOwnProperty.call(this, '__ee__')) return this;
	data = this.__ee__;
	if (!data[type]) return this;
	listeners = data[type];

	if (typeof listeners === 'object') ***REMOVED***
		for (i = 0; (candidate = listeners[i]); ++i) ***REMOVED***
			if ((candidate === listener) ||
					(candidate.__eeOnceListener__ === listener)) ***REMOVED***
				if (listeners.length === 2) data[type] = listeners[i ? 0 : 1];
				else listeners.splice(i, 1);
			***REMOVED***
		***REMOVED***
	***REMOVED*** else ***REMOVED***
		if ((listeners === listener) ||
				(listeners.__eeOnceListener__ === listener)) ***REMOVED***
			delete data[type];
		***REMOVED***
	***REMOVED***

	return this;
***REMOVED***;

emit = function (type) ***REMOVED***
	var i, l, listener, listeners, args;

	if (!hasOwnProperty.call(this, '__ee__')) return;
	listeners = this.__ee__[type];
	if (!listeners) return;

	if (typeof listeners === 'object') ***REMOVED***
		l = arguments.length;
		args = new Array(l - 1);
		for (i = 1; i < l; ++i) args[i - 1] = arguments[i];

		listeners = listeners.slice();
		for (i = 0; (listener = listeners[i]); ++i) ***REMOVED***
			apply.call(listener, this, args);
		***REMOVED***
	***REMOVED*** else ***REMOVED***
		switch (arguments.length) ***REMOVED***
		case 1:
			call.call(listeners, this);
			break;
		case 2:
			call.call(listeners, this, arguments[1]);
			break;
		case 3:
			call.call(listeners, this, arguments[1], arguments[2]);
			break;
		default:
			l = arguments.length;
			args = new Array(l - 1);
			for (i = 1; i < l; ++i) ***REMOVED***
				args[i - 1] = arguments[i];
			***REMOVED***
			apply.call(listeners, this, args);
		***REMOVED***
	***REMOVED***
***REMOVED***;

methods = ***REMOVED***
	on: on,
	once: once,
	off: off,
	emit: emit
***REMOVED***;

descriptors = ***REMOVED***
	on: d(on),
	once: d(once),
	off: d(off),
	emit: d(emit)
***REMOVED***;

base = defineProperties(***REMOVED******REMOVED***, descriptors);

module.exports = exports = function (o) ***REMOVED***
	return (o == null) ? create(base) : defineProperties(Object(o), descriptors);
***REMOVED***;
exports.methods = methods;
