/**
 * Copyright 2015 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

'use strict';

var Auth2Client = require('./oauth2client.js');
var util = require('util');

/**
 * User Refresh Token credentials.
 *
 * @param ***REMOVED***string***REMOVED*** clientId The authentication client ID.
 * @param ***REMOVED***string***REMOVED*** clientSecret The authentication client secret.
 * @param ***REMOVED***string***REMOVED*** refreshToken The authentication refresh token.
 * @constructor
 */
function UserRefreshClient(clientId, clientSecret, refreshToken) ***REMOVED***
  UserRefreshClient.super_.call(this, clientId, clientSecret);
  // Named to avoid collision with the method refreshToken_
  this._refreshToken = refreshToken;
***REMOVED***

util.inherits(UserRefreshClient, Auth2Client);

// Executes the given callback if it is not null.
function callback(c, err, res) ***REMOVED***
  if (c) ***REMOVED***
    c(err, res);
  ***REMOVED***
***REMOVED***

/**
 * Refreshes the access token.
 * @param ***REMOVED***object=***REMOVED*** ignored_
 * @param ***REMOVED***function=***REMOVED*** opt_callback Optional callback.
 * @private
 */
UserRefreshClient.prototype.refreshToken_ = function(ignored_, opt_callback) ***REMOVED***
  UserRefreshClient.super_.prototype.refreshToken_.call(
      this, this._refreshToken, opt_callback);
***REMOVED***;

/**
 * Create a UserRefreshClient credentials instance using the given input options.
 * @param ***REMOVED***object=***REMOVED*** json The input object.
 * @param ***REMOVED***function=***REMOVED*** opt_callback Optional callback.
 */
UserRefreshClient.prototype.fromJSON = function(json, opt_callback) ***REMOVED***
  var that = this;
  if (!json) ***REMOVED***
    callback(opt_callback, new Error(
        'Must pass in a JSON object containing the user refresh token'));
    return;
  ***REMOVED***
  if (json.type !== 'authorized_user') ***REMOVED***
    callback(opt_callback, new Error(
        'The incoming JSON object does not have the "authorized_user" type'));
    return;
  ***REMOVED***
  if (!json.client_id) ***REMOVED***
    callback(opt_callback, new Error(
        'The incoming JSON object does not contain a client_id field'));
    return;
  ***REMOVED***
  if (!json.client_secret) ***REMOVED***
    callback(opt_callback, new Error(
        'The incoming JSON object does not contain a client_secret field'));
    return;
  ***REMOVED***
  if (!json.refresh_token) ***REMOVED***
    callback(opt_callback, new Error(
        'The incoming JSON object does not contain a refresh_token field'));
    return;
  ***REMOVED***
  that.clientId_ = json.client_id;
  that.clientSecret_ = json.client_secret;
  that._refreshToken = json.refresh_token;
  that.credentials.refresh_token = json.refresh_token;
  callback(opt_callback);
***REMOVED***;

/**
 * Create a UserRefreshClient credentials instance using the given input stream.
 * @param ***REMOVED***object=***REMOVED*** stream The input stream.
 * @param ***REMOVED***function=***REMOVED*** opt_callback Optional callback.
 */
UserRefreshClient.prototype.fromStream = function(stream, opt_callback) ***REMOVED***
  var that = this;
  if (!stream) ***REMOVED***
    process.nextTick(function() ***REMOVED***
      callback(
        opt_callback,
        new Error('Must pass in a stream containing the user refresh token.'));
    ***REMOVED***);
    return;
  ***REMOVED***
  var s = '';
  stream.setEncoding('utf8');
  stream.on('data', function (chunk) ***REMOVED***
    s += chunk;
  ***REMOVED***);
  stream.on('end', function () ***REMOVED***
    try ***REMOVED***
      var data = JSON.parse(s);
      that.fromJSON(data, opt_callback);
    ***REMOVED*** catch (err) ***REMOVED***
      callback(opt_callback, err);
    ***REMOVED***
  ***REMOVED***);
***REMOVED***;

/**
 * Export UserRefreshClient
 */
module.exports = UserRefreshClient;
