/**
 * Copyright 2012 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

'use strict';

var request = require('request'),
  pkg = require('../package.json');

/**
 * Default transporter constructor.
 * Wraps request and callback functions.
 */
function DefaultTransporter() ***REMOVED******REMOVED***

/**
 * Default user agent.
 */
DefaultTransporter.prototype.USER_AGENT =
  'google-api-nodejs-client/' + pkg.version;

/**
 * Configures request options before making a request.
 * @param ***REMOVED***object***REMOVED*** opts Options to configure.
 * @return ***REMOVED***object***REMOVED*** Configured options.
 */
DefaultTransporter.prototype.configure = function(opts) ***REMOVED***
  // set transporter user agent
  opts.headers = opts.headers || ***REMOVED******REMOVED***;
  if (!opts.headers['User-Agent']) ***REMOVED***
    opts.headers['User-Agent'] = this.USER_AGENT;
  ***REMOVED*** else if (opts.headers['User-Agent'].indexOf(this.USER_AGENT) === -1) ***REMOVED***
    opts.headers['User-Agent'] = opts.headers['User-Agent'] + ' ' + this.USER_AGENT;
  ***REMOVED***
  return opts;
***REMOVED***;

/**
 * Makes a request with given options and invokes callback.
 * @param ***REMOVED***object***REMOVED*** opts Options.
 * @param ***REMOVED***Function=***REMOVED*** opt_callback Optional callback.
 * @return ***REMOVED***Request***REMOVED*** Request object
 */
DefaultTransporter.prototype.request = function(opts, opt_callback) ***REMOVED***
  opts = this.configure(opts);
  return request(opts.uri || opts.url, opts, this.wrapCallback_(opt_callback));
***REMOVED***;

/**
 * Wraps the response callback.
 * @param ***REMOVED***Function=***REMOVED*** opt_callback Optional callback.
 * @return ***REMOVED***Function***REMOVED*** Wrapped callback function.
 * @private
 */
DefaultTransporter.prototype.wrapCallback_ = function(opt_callback) ***REMOVED***
  return function(err, res, body) ***REMOVED***
    if (err || !body) ***REMOVED***
      return opt_callback && opt_callback(err, body, res);
    ***REMOVED***
    // Only and only application/json responses should
    // be decoded back to JSON, but there are cases API back-ends
    // responds without proper content-type.
    try ***REMOVED***
      body = JSON.parse(body);
    ***REMOVED*** catch (err) ***REMOVED*** /* no op */ ***REMOVED***

    if (body && body.error && res.statusCode !== 200) ***REMOVED***
      if (typeof body.error === 'string') ***REMOVED***
        err = new Error(body.error);
        err.code = res.statusCode;

      ***REMOVED*** else if (Array.isArray(body.error.errors)) ***REMOVED***
        err = new Error(body.error.errors.map(
                         function(err) ***REMOVED*** return err.message; ***REMOVED***
                       ).join('\n'));
        err.code = body.error.code;
        err.errors = body.error.errors;

      ***REMOVED*** else ***REMOVED***
        err = new Error(body.error.message);
        err.code = body.error.code || res.statusCode;
      ***REMOVED***

      body = null;

    ***REMOVED*** else if (res.statusCode >= 500) ***REMOVED***
      // Consider all '500 responses' errors.
      err = new Error(body);
      err.code = res.statusCode;
      body = null;
    ***REMOVED***

    if (opt_callback) ***REMOVED***
      opt_callback(err, body, res);
    ***REMOVED***
  ***REMOVED***;
***REMOVED***;

/**
 * Exports DefaultTransporter.
 */
module.exports = DefaultTransporter;
