'use strict';

var setPrototypeOf    = require('es5-ext/object/set-prototype-of')
  , object            = require('es5-ext/object/valid-object')
  , value             = require('es5-ext/object/valid-value')
  , randomUniq        = require('es5-ext/string/random-uniq')
  , d                 = require('d')
  , getIterator       = require('es6-iterator/get')
  , forOf             = require('es6-iterator/for-of')
  , toStringTagSymbol = require('es6-symbol').toStringTag
  , isNative          = require('./is-native-implemented')

  , isArray = Array.isArray, defineProperty = Object.defineProperty
  , hasOwnProperty = Object.prototype.hasOwnProperty, getPrototypeOf = Object.getPrototypeOf
  , WeakMapPoly;

module.exports = WeakMapPoly = function (/*iterable*/) ***REMOVED***
	var iterable = arguments[0], self;
	if (!(this instanceof WeakMapPoly)) throw new TypeError('Constructor requires \'new\'');
	if (isNative && setPrototypeOf && (WeakMap !== WeakMapPoly)) ***REMOVED***
		self = setPrototypeOf(new WeakMap(), getPrototypeOf(this));
	***REMOVED*** else ***REMOVED***
		self = this;
	***REMOVED***
	if (iterable != null) ***REMOVED***
		if (!isArray(iterable)) iterable = getIterator(iterable);
	***REMOVED***
	defineProperty(self, '__weakMapData__', d('c', '$weakMap$' + randomUniq()));
	if (!iterable) return self;
	forOf(iterable, function (val) ***REMOVED***
		value(val);
		self.set(val[0], val[1]);
	***REMOVED***);
	return self;
***REMOVED***;

if (isNative) ***REMOVED***
	if (setPrototypeOf) setPrototypeOf(WeakMapPoly, WeakMap);
	WeakMapPoly.prototype = Object.create(WeakMap.prototype, ***REMOVED***
		constructor: d(WeakMapPoly)
	***REMOVED***);
***REMOVED***

Object.defineProperties(WeakMapPoly.prototype, ***REMOVED***
	delete: d(function (key) ***REMOVED***
		if (hasOwnProperty.call(object(key), this.__weakMapData__)) ***REMOVED***
			delete key[this.__weakMapData__];
			return true;
		***REMOVED***
		return false;
	***REMOVED***),
	get: d(function (key) ***REMOVED***
		if (hasOwnProperty.call(object(key), this.__weakMapData__)) ***REMOVED***
			return key[this.__weakMapData__];
		***REMOVED***
	***REMOVED***),
	has: d(function (key) ***REMOVED***
		return hasOwnProperty.call(object(key), this.__weakMapData__);
	***REMOVED***),
	set: d(function (key, value) ***REMOVED***
		defineProperty(object(key), this.__weakMapData__, d('c', value));
		return this;
	***REMOVED***),
	toString: d(function () ***REMOVED*** return '[object WeakMap]'; ***REMOVED***)
***REMOVED***);
defineProperty(WeakMapPoly.prototype, toStringTagSymbol, d('c', 'WeakMap'));
