var pump = require('pump')
var inherits = require('inherits')
var Duplexify = require('duplexify')

var toArray = function(args) ***REMOVED***
  if (!args.length) return []
  return Array.isArray(args[0]) ? args[0] : Array.prototype.slice.call(args)
***REMOVED***

var define = function(opts) ***REMOVED***
  var Pumpify = function() ***REMOVED***
    var streams = toArray(arguments)
    if (!(this instanceof Pumpify)) return new Pumpify(streams)
    Duplexify.call(this, null, null, opts)
    if (streams.length) this.setPipeline(streams)
  ***REMOVED***

  inherits(Pumpify, Duplexify)

  Pumpify.prototype.setPipeline = function() ***REMOVED***
    var streams = toArray(arguments)
    var self = this
    var ended = false
    var w = streams[0]
    var r = streams[streams.length-1]

    r = r.readable ? r : null
    w = w.writable ? w : null

    var onclose = function() ***REMOVED***
      streams[0].emit('error', new Error('stream was destroyed'))
    ***REMOVED***

    this.on('close', onclose)
    this.on('prefinish', function() ***REMOVED***
      if (!ended) self.cork()
    ***REMOVED***)

    pump(streams, function(err) ***REMOVED***
      self.removeListener('close', onclose)
      if (err) return self.destroy(err)
      ended = true
      self.uncork()
    ***REMOVED***)

    if (this.destroyed) return onclose()
    this.setWritable(w)
    this.setReadable(r)
  ***REMOVED***

  return Pumpify
***REMOVED***

module.exports = define(***REMOVED***destroy:false***REMOVED***)
module.exports.obj = define(***REMOVED***destroy:false, objectMode:true, highWaterMark:16***REMOVED***)
module.exports.ctor = define
