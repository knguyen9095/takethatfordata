'use strict';

var define = require('define-property');
var extend = require('extend-shallow');
var not = require('regex-not');
var MAX_LENGTH = 1024 * 64;

/**
 * Session cache
 */

var cache = ***REMOVED******REMOVED***;

/**
 * Create a regular expression from the given `pattern` string.
 *
 * @param ***REMOVED***String|RegExp***REMOVED*** `pattern` Pattern can be a string or regular expression.
 * @param ***REMOVED***Object***REMOVED*** `options`
 * @return ***REMOVED***RegExp***REMOVED***
 * @api public
 */

module.exports = function(patterns, options) ***REMOVED***
  if (!Array.isArray(patterns)) ***REMOVED***
    return makeRe(patterns, options);
  ***REMOVED***
  return makeRe(patterns.join('|'), options);
***REMOVED***;

/**
 * Create a regular expression from the given `pattern` string.
 *
 * @param ***REMOVED***String|RegExp***REMOVED*** `pattern` Pattern can be a string or regular expression.
 * @param ***REMOVED***Object***REMOVED*** `options`
 * @return ***REMOVED***RegExp***REMOVED***
 * @api public
 */

function makeRe(pattern, options) ***REMOVED***
  if (pattern instanceof RegExp) ***REMOVED***
    return pattern;
  ***REMOVED***

  if (typeof pattern !== 'string') ***REMOVED***
    throw new TypeError('expected a string');
  ***REMOVED***

  if (pattern.length > MAX_LENGTH) ***REMOVED***
    throw new Error('expected pattern to be less than ' + MAX_LENGTH + ' characters');
  ***REMOVED***

  var key = pattern;
  // do this before shallow cloning options, it's a lot faster
  if (!options || (options && options.cache !== false)) ***REMOVED***
    key = createKey(pattern, options);

    if (cache.hasOwnProperty(key)) ***REMOVED***
      return cache[key];
    ***REMOVED***
  ***REMOVED***

  var opts = extend(***REMOVED******REMOVED***, options);
  if (opts.contains === true) ***REMOVED***
    if (opts.negate === true) ***REMOVED***
      opts.strictNegate = false;
    ***REMOVED*** else ***REMOVED***
      opts.strict = false;
    ***REMOVED***
  ***REMOVED***

  if (opts.strict === false) ***REMOVED***
    opts.strictOpen = false;
    opts.strictClose = false;
  ***REMOVED***

  var open = opts.strictOpen !== false ? '^' : '';
  var close = opts.strictClose !== false ? '$' : '';
  var flags = opts.flags || '';
  var regex;

  if (opts.nocase === true && !/i/.test(flags)) ***REMOVED***
    flags += 'i';
  ***REMOVED***

  try ***REMOVED***
    if (opts.negate || typeof opts.strictNegate === 'boolean') ***REMOVED***
      pattern = not.create(pattern, opts);
    ***REMOVED***
    var str = open + '(?:' + pattern + ')' + close;
    regex = new RegExp(str, flags);
  ***REMOVED*** catch (err) ***REMOVED***
    if (opts.strictErrors === true) ***REMOVED***
      err.key = key;
      err.pattern = pattern;
      err.originalOptions = options;
      err.createdOptions = opts;
      throw err;
    ***REMOVED***

    try ***REMOVED***
      regex = new RegExp('^' + pattern.replace(/(\W)/g, '\\$1') + '$');
    ***REMOVED*** catch (err) ***REMOVED***
      regex = /.^/; //<= match nothing
    ***REMOVED***
  ***REMOVED***

  if (opts.cache !== false) ***REMOVED***
    cacheRegex(regex, key, pattern, opts);
  ***REMOVED***
  return regex;
***REMOVED***

/**
 * Cache generated regex. This can result in dramatic speed improvements
 * and simplify debugging by adding options and pattern to the regex. It can be
 * disabled by passing setting `options.cache` to false.
 */

function cacheRegex(regex, key, pattern, options) ***REMOVED***
  define(regex, 'cached', true);
  define(regex, 'pattern', pattern);
  define(regex, 'options', options);
  define(regex, 'key', key);
  cache[key] = regex;
***REMOVED***

/**
 * Create the key to use for memoization. The key is generated
 * by iterating over the options and concatenating key-value pairs
 * to the pattern string.
 */

function createKey(pattern, options) ***REMOVED***
  if (!options) return pattern;
  var key = pattern;
  for (var prop in options) ***REMOVED***
    if (options.hasOwnProperty(prop)) ***REMOVED***
      key += ';' + prop + '=' + String(options[prop]);
    ***REMOVED***
  ***REMOVED***
  return key;
***REMOVED***

/**
 * Expose `makeRe`
 */

module.exports.makeRe = makeRe;
