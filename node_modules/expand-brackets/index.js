'use strict';

/**
 * Local dependencies
 */

var compilers = require('./lib/compilers');
var parsers = require('./lib/parsers');

/**
 * Module dependencies
 */

var debug = require('debug')('expand-brackets');
var extend = require('extend-shallow');
var Snapdragon = require('snapdragon');
var toRegex = require('to-regex');

/**
 * Parses the given POSIX character class `pattern` and returns a
 * string that can be used for creating regular expressions for matching.
 *
 * @param ***REMOVED***String***REMOVED*** `pattern`
 * @param ***REMOVED***Object***REMOVED*** `options`
 * @return ***REMOVED***Object***REMOVED***
 * @api public
 */

function brackets(pattern, options) ***REMOVED***
  debug('initializing from <%s>', __filename);
  var res = brackets.create(pattern, options);
  return res.output;
***REMOVED***

/**
 * Takes an array of strings and a POSIX character class pattern, and returns a new
 * array with only the strings that matched the pattern.
 *
 * ```js
 * var brackets = require('expand-brackets');
 * console.log(brackets.match(['1', 'a', 'ab'], '[[:alpha:]]'));
 * //=> ['a']
 *
 * console.log(brackets.match(['1', 'a', 'ab'], '[[:alpha:]]+'));
 * //=> ['a', 'ab']
 * ```
 * @param ***REMOVED***Array***REMOVED*** `arr` Array of strings to match
 * @param ***REMOVED***String***REMOVED*** `pattern` POSIX character class pattern(s)
 * @param ***REMOVED***Object***REMOVED*** `options`
 * @return ***REMOVED***Array***REMOVED***
 * @api public
 */

brackets.match = function(arr, pattern, options) ***REMOVED***
  arr = [].concat(arr);
  var opts = extend(***REMOVED******REMOVED***, options);
  var isMatch = brackets.matcher(pattern, opts);
  var len = arr.length;
  var idx = -1;
  var res = [];

  while (++idx < len) ***REMOVED***
    var ele = arr[idx];
    if (isMatch(ele)) ***REMOVED***
      res.push(ele);
    ***REMOVED***
  ***REMOVED***

  if (res.length === 0) ***REMOVED***
    if (opts.failglob === true) ***REMOVED***
      throw new Error('no matches found for "' + pattern + '"');
    ***REMOVED***

    if (opts.nonull === true || opts.nullglob === true) ***REMOVED***
      return [pattern.split('\\').join('')];
    ***REMOVED***
  ***REMOVED***
  return res;
***REMOVED***;

/**
 * Returns true if the specified `string` matches the given
 * brackets `pattern`.
 *
 * ```js
 * var brackets = require('expand-brackets');
 *
 * console.log(brackets.isMatch('a.a', '[[:alpha:]].[[:alpha:]]'));
 * //=> true
 * console.log(brackets.isMatch('1.2', '[[:alpha:]].[[:alpha:]]'));
 * //=> false
 * ```
 * @param ***REMOVED***String***REMOVED*** `string` String to match
 * @param ***REMOVED***String***REMOVED*** `pattern` Poxis pattern
 * @param ***REMOVED***String***REMOVED*** `options`
 * @return ***REMOVED***Boolean***REMOVED***
 * @api public
 */

brackets.isMatch = function(str, pattern, options) ***REMOVED***
  return brackets.matcher(pattern, options)(str);
***REMOVED***;

/**
 * Takes a POSIX character class pattern and returns a matcher function. The returned
 * function takes the string to match as its only argument.
 *
 * ```js
 * var brackets = require('expand-brackets');
 * var isMatch = brackets.matcher('[[:lower:]].[[:upper:]]');
 *
 * console.log(isMatch('a.a'));
 * //=> false
 * console.log(isMatch('a.A'));
 * //=> true
 * ```
 * @param ***REMOVED***String***REMOVED*** `pattern` Poxis pattern
 * @param ***REMOVED***String***REMOVED*** `options`
 * @return ***REMOVED***Boolean***REMOVED***
 * @api public
 */

brackets.matcher = function(pattern, options) ***REMOVED***
  var re = brackets.makeRe(pattern, options);
  return function(str) ***REMOVED***
    return re.test(str);
  ***REMOVED***;
***REMOVED***;

/**
 * Create a regular expression from the given `pattern`.
 *
 * ```js
 * var brackets = require('expand-brackets');
 * var re = brackets.makeRe('[[:alpha:]]');
 * console.log(re);
 * //=> /^(?:[a-zA-Z])$/
 * ```
 * @param ***REMOVED***String***REMOVED*** `pattern` The pattern to convert to regex.
 * @param ***REMOVED***Object***REMOVED*** `options`
 * @return ***REMOVED***RegExp***REMOVED***
 * @api public
 */

brackets.makeRe = function(pattern, options) ***REMOVED***
  var res = brackets.create(pattern, options);
  var opts = extend(***REMOVED***strictErrors: false***REMOVED***, options);
  return toRegex(res.output, opts);
***REMOVED***;

/**
 * Parses the given POSIX character class `pattern` and returns an object
 * with the compiled `output` and optional source `map`.
 *
 * ```js
 * var brackets = require('expand-brackets');
 * console.log(brackets('[[:alpha:]]'));
 * // ***REMOVED*** options: ***REMOVED*** source: 'string' ***REMOVED***,
 * //   input: '[[:alpha:]]',
 * //   state: ***REMOVED******REMOVED***,
 * //   compilers:
 * //    ***REMOVED*** eos: [Function],
 * //      noop: [Function],
 * //      bos: [Function],
 * //      not: [Function],
 * //      escape: [Function],
 * //      text: [Function],
 * //      posix: [Function],
 * //      bracket: [Function],
 * //      'bracket.open': [Function],
 * //      'bracket.inner': [Function],
 * //      'bracket.literal': [Function],
 * //      'bracket.close': [Function] ***REMOVED***,
 * //   output: '[a-zA-Z]',
 * //   ast:
 * //    ***REMOVED*** type: 'root',
 * //      errors: [],
 * //      nodes: [ [Object], [Object], [Object] ] ***REMOVED***,
 * //   parsingErrors: [] ***REMOVED***
 * ```
 * @param ***REMOVED***String***REMOVED*** `pattern`
 * @param ***REMOVED***Object***REMOVED*** `options`
 * @return ***REMOVED***Object***REMOVED***
 * @api public
 */

brackets.create = function(pattern, options) ***REMOVED***
  var snapdragon = (options && options.snapdragon) || new Snapdragon(options);
  compilers(snapdragon);
  parsers(snapdragon);

  var ast = snapdragon.parse(pattern, options);
  ast.input = pattern;
  var res = snapdragon.compile(ast, options);
  res.input = pattern;
  return res;
***REMOVED***;

/**
 * Expose `brackets` constructor, parsers and compilers
 */

brackets.compilers = compilers;
brackets.parsers = parsers;

/**
 * Expose `brackets`
 * @type ***REMOVED***Function***REMOVED***
 */

module.exports = brackets;
