'use strict';

var posix = require('posix-character-classes');

module.exports = function(brackets) ***REMOVED***
  brackets.compiler

    /**
     * Escaped characters
     */

    .set('escape', function(node) ***REMOVED***
      return this.emit('\\' + node.val.replace(/^\\/, ''), node);
    ***REMOVED***)

    /**
     * Text
     */

    .set('text', function(node) ***REMOVED***
      return this.emit(node.val.replace(/([***REMOVED******REMOVED***])/g, '\\$1'), node);
    ***REMOVED***)

    /**
     * POSIX character classes
     */

    .set('posix', function(node) ***REMOVED***
      if (node.val === '[::]') ***REMOVED***
        return this.emit('\\[::\\]', node);
      ***REMOVED***

      var val = posix[node.inner];
      if (typeof val === 'undefined') ***REMOVED***
        val = '[' + node.inner + ']';
      ***REMOVED***
      return this.emit(val, node);
    ***REMOVED***)

    /**
     * Non-posix brackets
     */

    .set('bracket', function(node) ***REMOVED***
      return this.mapVisit(node.nodes);
    ***REMOVED***)
    .set('bracket.open', function(node) ***REMOVED***
      return this.emit(node.val, node);
    ***REMOVED***)
    .set('bracket.inner', function(node) ***REMOVED***
      var inner = node.val;

      if (inner === '[' || inner === ']') ***REMOVED***
        return this.emit('\\' + node.val, node);
      ***REMOVED***
      if (inner === '^]') ***REMOVED***
        return this.emit('^\\]', node);
      ***REMOVED***
      if (inner === '^') ***REMOVED***
        return this.emit('^', node);
      ***REMOVED***

      if (/-/.test(inner) && !/(\d-\d|\w-\w)/.test(inner)) ***REMOVED***
        inner = inner.split('-').join('\\-');
      ***REMOVED***

      var isNegated = inner.charAt(0) === '^';
      // add slashes to negated brackets, per spec
      if (isNegated && inner.indexOf('/') === -1) ***REMOVED***
        inner += '/';
      ***REMOVED***
      if (isNegated && inner.indexOf('.') === -1) ***REMOVED***
        inner += '.';
      ***REMOVED***

      // don't unescape `0` (octal literal)
      inner = inner.replace(/\\([1-9])/g, '$1');
      return this.emit(inner, node);
    ***REMOVED***)
    .set('bracket.close', function(node) ***REMOVED***
      var val = node.val.replace(/^\\/, '');
      if (node.parent.escaped === true) ***REMOVED***
        return this.emit('\\' + val, node);
      ***REMOVED***
      return this.emit(val, node);
    ***REMOVED***);
***REMOVED***;
