'use strict';

var assign = require('core-js/library/fn/object/assign');
var ContextTraversal = require('power-assert-context-traversal');
var LegacyContextTraversal = require('./legacy-context-traversal');
var StringWriter = require('./string-writer');
var defaultOptions = require('./default-options');
var reduce = require('core-js/library/fn/array/reduce');

/**
 * options.reducers [array]
 * options.renderers [array]
 * options.outputOffset [number]
 * options.lineSeparator [string]
 * options.legacy [boolean]
 */
function createFormatter (options) ***REMOVED***
    var formatterConfig = assign(***REMOVED******REMOVED***, defaultOptions(), options);
    var reducers = formatterConfig.reducers || [];
    var rendererConfigs = formatterConfig.renderers;
    var len = rendererConfigs.length;

    return function (powerAssertContext) ***REMOVED***
        var context = reduce(reducers, function (prevContext, reducer) ***REMOVED***
            return reducer(prevContext);
        ***REMOVED***, powerAssertContext);
        var writer = new StringWriter(formatterConfig);
        var traversal;
        if (formatterConfig.legacy) ***REMOVED***
            traversal = new LegacyContextTraversal(context);
            traversal.setWritable(writer);
        ***REMOVED*** else ***REMOVED***
            traversal = new ContextTraversal(context);
        ***REMOVED***
        for (var i = 0; i < len; i += 1) ***REMOVED***
            var RendererClass;
            var renderer;
            var config = rendererConfigs[i];
            if (typeof config === 'object') ***REMOVED***
                RendererClass = config.ctor;
                renderer = new RendererClass(config.options);
            ***REMOVED*** else if (typeof config === 'function') ***REMOVED***
                RendererClass = config;
                renderer = new RendererClass();
            ***REMOVED***
            renderer.init(traversal);
            if (typeof renderer.setWritable === 'function') ***REMOVED***
                renderer.setWritable(writer);
            ***REMOVED***
        ***REMOVED***
        traversal.traverse();
        writer.write('');
        return writer.toString();
    ***REMOVED***;
***REMOVED***

createFormatter.StringWriter = StringWriter;
module.exports = createFormatter;
