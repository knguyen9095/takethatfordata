var once = require('once');

var noop = function() ***REMOVED******REMOVED***;

var isRequest = function(stream) ***REMOVED***
	return stream.setHeader && typeof stream.abort === 'function';
***REMOVED***;

var isChildProcess = function(stream) ***REMOVED***
	return stream.stdio && Array.isArray(stream.stdio) && stream.stdio.length === 3
***REMOVED***;

var eos = function(stream, opts, callback) ***REMOVED***
	if (typeof opts === 'function') return eos(stream, null, opts);
	if (!opts) opts = ***REMOVED******REMOVED***;

	callback = once(callback || noop);

	var ws = stream._writableState;
	var rs = stream._readableState;
	var readable = opts.readable || (opts.readable !== false && stream.readable);
	var writable = opts.writable || (opts.writable !== false && stream.writable);

	var onlegacyfinish = function() ***REMOVED***
		if (!stream.writable) onfinish();
	***REMOVED***;

	var onfinish = function() ***REMOVED***
		writable = false;
		if (!readable) callback.call(stream);
	***REMOVED***;

	var onend = function() ***REMOVED***
		readable = false;
		if (!writable) callback.call(stream);
	***REMOVED***;

	var onexit = function(exitCode) ***REMOVED***
		callback.call(stream, exitCode ? new Error('exited with error code: ' + exitCode) : null);
	***REMOVED***;

	var onerror = function(err) ***REMOVED***
		callback.call(stream, err);
	***REMOVED***;

	var onclose = function() ***REMOVED***
		if (readable && !(rs && rs.ended)) return callback.call(stream, new Error('premature close'));
		if (writable && !(ws && ws.ended)) return callback.call(stream, new Error('premature close'));
	***REMOVED***;

	var onrequest = function() ***REMOVED***
		stream.req.on('finish', onfinish);
	***REMOVED***;

	if (isRequest(stream)) ***REMOVED***
		stream.on('complete', onfinish);
		stream.on('abort', onclose);
		if (stream.req) onrequest();
		else stream.on('request', onrequest);
	***REMOVED*** else if (writable && !ws) ***REMOVED*** // legacy streams
		stream.on('end', onlegacyfinish);
		stream.on('close', onlegacyfinish);
	***REMOVED***

	if (isChildProcess(stream)) stream.on('exit', onexit);

	stream.on('end', onend);
	stream.on('finish', onfinish);
	if (opts.error !== false) stream.on('error', onerror);
	stream.on('close', onclose);

	return function() ***REMOVED***
		stream.removeListener('complete', onfinish);
		stream.removeListener('abort', onclose);
		stream.removeListener('request', onrequest);
		if (stream.req) stream.req.removeListener('finish', onfinish);
		stream.removeListener('end', onlegacyfinish);
		stream.removeListener('close', onlegacyfinish);
		stream.removeListener('finish', onfinish);
		stream.removeListener('exit', onexit);
		stream.removeListener('end', onend);
		stream.removeListener('error', onerror);
		stream.removeListener('close', onclose);
	***REMOVED***;
***REMOVED***;

module.exports = eos;
