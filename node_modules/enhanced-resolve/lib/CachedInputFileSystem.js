/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
function Storage(duration) ***REMOVED***
	this.duration = duration;
	this.running = new Map();
	this.data = new Map();
	this.levels = [];
	if(duration > 0) ***REMOVED***
		this.levels.push(new Set(), new Set(), new Set(), new Set(), new Set(), new Set(), new Set(), new Set(), new Set());
		for(var i = 8000; i < duration; i += 500)
			this.levels.push(new Set());
	***REMOVED***
	this.count = 0;
	this.interval = null;
	this.needTickCheck = false;
	this.nextTick = null;
	this.passive = true;
	this.tick = this.tick.bind(this);
***REMOVED***

Storage.prototype.ensureTick = function() ***REMOVED***
	if(!this.interval && this.duration > 0 && !this.nextTick)
		this.interval = setInterval(this.tick, Math.floor(this.duration / this.levels.length));
***REMOVED***;

Storage.prototype.finished = function(name, err, result) ***REMOVED***
	var callbacks = this.running.get(name);
	this.running.delete(name);
	if(this.duration > 0) ***REMOVED***
		this.data.set(name, [err, result]);
		var levelData = this.levels[0];
		this.count -= levelData.size;
		levelData.add(name);
		this.count += levelData.size;
		this.ensureTick();
	***REMOVED***
	for(var i = 0; i < callbacks.length; i++) ***REMOVED***
		callbacks[i](err, result);
	***REMOVED***
***REMOVED***;

Storage.prototype.finishedSync = function(name, err, result) ***REMOVED***
	if(this.duration > 0) ***REMOVED***
		this.data.set(name, [err, result]);
		var levelData = this.levels[0];
		this.count -= levelData.size;
		levelData.add(name);
		this.count += levelData.size;
		this.ensureTick();
	***REMOVED***
***REMOVED***;

Storage.prototype.provide = function(name, provider, callback) ***REMOVED***
	if(typeof name !== "string") ***REMOVED***
		callback(new TypeError("path must be a string"));
		return;
	***REMOVED***
	var running = this.running.get(name);
	if(running) ***REMOVED***
		running.push(callback);
		return;
	***REMOVED***
	if(this.duration > 0) ***REMOVED***
		this.checkTicks();
		var data = this.data.get(name);
		if(data) ***REMOVED***
			return process.nextTick(function() ***REMOVED***
				callback.apply(null, data);
			***REMOVED***);
		***REMOVED***
	***REMOVED***
	this.running.set(name, running = [callback]);
	var _this = this;
	provider(name, function(err, result) ***REMOVED***
		_this.finished(name, err, result);
	***REMOVED***);
***REMOVED***;

Storage.prototype.provideSync = function(name, provider) ***REMOVED***
	if(typeof name !== "string") ***REMOVED***
		throw new TypeError("path must be a string");
	***REMOVED***
	if(this.duration > 0) ***REMOVED***
		this.checkTicks();
		var data = this.data.get(name);
		if(data) ***REMOVED***
			if(data[0])
				throw data[0];
			return data[1];
		***REMOVED***
	***REMOVED***
	try ***REMOVED***
		var result = provider(name);
	***REMOVED*** catch(e) ***REMOVED***
		this.finishedSync(name, e);
		throw e;
	***REMOVED***
	this.finishedSync(name, null, result);
	return result;
***REMOVED***;

Storage.prototype.tick = function() ***REMOVED***
	var decay = this.levels.pop();
	for(var item of decay) ***REMOVED***
		this.data.delete(item);
	***REMOVED***
	this.count -= decay.size;
	decay.clear();
	this.levels.unshift(decay);
	if(this.count === 0) ***REMOVED***
		clearInterval(this.interval);
		this.interval = null;
		this.nextTick = null;
		return true;
	***REMOVED*** else if(this.nextTick) ***REMOVED***
		this.nextTick += Math.floor(this.duration / this.levels.length);
		var time = new Date().getTime();
		if(this.nextTick > time) ***REMOVED***
			this.nextTick = null;
			this.interval = setInterval(this.tick, Math.floor(this.duration / this.levels.length));
			return true;
		***REMOVED***
	***REMOVED*** else if(this.passive) ***REMOVED***
		clearInterval(this.interval);
		this.interval = null;
		this.nextTick = new Date().getTime() + Math.floor(this.duration / this.levels.length);
	***REMOVED*** else ***REMOVED***
		this.passive = true;
	***REMOVED***
***REMOVED***;

Storage.prototype.checkTicks = function() ***REMOVED***
	this.passive = false;
	if(this.nextTick) ***REMOVED***
		while(!this.tick());
	***REMOVED***
***REMOVED***;

Storage.prototype.purge = function(what) ***REMOVED***
	if(!what) ***REMOVED***
		this.count = 0;
		clearInterval(this.interval);
		this.nextTick = null;
		this.data.clear();
		this.levels.forEach(function(level) ***REMOVED***
			level.clear();
		***REMOVED***);
	***REMOVED*** else if(typeof what === "string") ***REMOVED***
		for(var key of this.data.keys()) ***REMOVED***
			if(key.startsWith(what))
				this.data.delete(key);
		***REMOVED***
	***REMOVED*** else ***REMOVED***
		for(var i = what.length - 1; i >= 0; i--) ***REMOVED***
			this.purge(what[i]);
		***REMOVED***
	***REMOVED***
***REMOVED***;

function CachedInputFileSystem(fileSystem, duration) ***REMOVED***
	this.fileSystem = fileSystem;
	this._statStorage = new Storage(duration);
	this._readdirStorage = new Storage(duration);
	this._readFileStorage = new Storage(duration);
	this._readJsonStorage = new Storage(duration);
	this._readlinkStorage = new Storage(duration);

	this._stat = this.fileSystem.stat ? this.fileSystem.stat.bind(this.fileSystem) : null;
	if(!this._stat) this.stat = null;

	this._statSync = this.fileSystem.statSync ? this.fileSystem.statSync.bind(this.fileSystem) : null;
	if(!this._statSync) this.statSync = null;

	this._readdir = this.fileSystem.readdir ? this.fileSystem.readdir.bind(this.fileSystem) : null;
	if(!this._readdir) this.readdir = null;

	this._readdirSync = this.fileSystem.readdirSync ? this.fileSystem.readdirSync.bind(this.fileSystem) : null;
	if(!this._readdirSync) this.readdirSync = null;

	this._readFile = this.fileSystem.readFile ? this.fileSystem.readFile.bind(this.fileSystem) : null;
	if(!this._readFile) this.readFile = null;

	this._readFileSync = this.fileSystem.readFileSync ? this.fileSystem.readFileSync.bind(this.fileSystem) : null;
	if(!this._readFileSync) this.readFileSync = null;

	if(this.fileSystem.readJson) ***REMOVED***
		this._readJson = this.fileSystem.readJson.bind(this.fileSystem);
	***REMOVED*** else if(this.readFile) ***REMOVED***
		this._readJson = function(path, callback) ***REMOVED***
			this.readFile(path, function(err, buffer) ***REMOVED***
				if(err) return callback(err);
				try ***REMOVED***
					var data = JSON.parse(buffer.toString("utf-8"));
				***REMOVED*** catch(e) ***REMOVED***
					return callback(e);
				***REMOVED***
				callback(null, data);
			***REMOVED***);
		***REMOVED***.bind(this);
	***REMOVED*** else ***REMOVED***
		this.readJson = null;
	***REMOVED***
	if(this.fileSystem.readJsonSync) ***REMOVED***
		this._readJsonSync = this.fileSystem.readJsonSync.bind(this.fileSystem);
	***REMOVED*** else if(this.readFileSync) ***REMOVED***
		this._readJsonSync = function(path) ***REMOVED***
			var buffer = this.readFileSync(path);
			var data = JSON.parse(buffer.toString("utf-8"));
			return data;
		***REMOVED***.bind(this);
	***REMOVED*** else ***REMOVED***
		this.readJsonSync = null;
	***REMOVED***

	this._readlink = this.fileSystem.readlink ? this.fileSystem.readlink.bind(this.fileSystem) : null;
	if(!this._readlink) this.readlink = null;

	this._readlinkSync = this.fileSystem.readlinkSync ? this.fileSystem.readlinkSync.bind(this.fileSystem) : null;
	if(!this._readlinkSync) this.readlinkSync = null;
***REMOVED***
module.exports = CachedInputFileSystem;

CachedInputFileSystem.prototype.stat = function(path, callback) ***REMOVED***
	this._statStorage.provide(path, this._stat, callback);
***REMOVED***;

CachedInputFileSystem.prototype.readdir = function(path, callback) ***REMOVED***
	this._readdirStorage.provide(path, this._readdir, callback);
***REMOVED***;

CachedInputFileSystem.prototype.readFile = function(path, callback) ***REMOVED***
	this._readFileStorage.provide(path, this._readFile, callback);
***REMOVED***;

CachedInputFileSystem.prototype.readJson = function(path, callback) ***REMOVED***
	this._readJsonStorage.provide(path, this._readJson, callback);
***REMOVED***;

CachedInputFileSystem.prototype.readlink = function(path, callback) ***REMOVED***
	this._readlinkStorage.provide(path, this._readlink, callback);
***REMOVED***;

CachedInputFileSystem.prototype.statSync = function(path) ***REMOVED***
	return this._statStorage.provideSync(path, this._statSync);
***REMOVED***;

CachedInputFileSystem.prototype.readdirSync = function(path) ***REMOVED***
	return this._readdirStorage.provideSync(path, this._readdirSync);
***REMOVED***;

CachedInputFileSystem.prototype.readFileSync = function(path) ***REMOVED***
	return this._readFileStorage.provideSync(path, this._readFileSync);
***REMOVED***;

CachedInputFileSystem.prototype.readJsonSync = function(path) ***REMOVED***
	return this._readJsonStorage.provideSync(path, this._readJsonSync);
***REMOVED***;

CachedInputFileSystem.prototype.readlinkSync = function(path) ***REMOVED***
	return this._readlinkStorage.provideSync(path, this._readlinkSync);
***REMOVED***;

CachedInputFileSystem.prototype.purge = function(what) ***REMOVED***
	this._statStorage.purge(what);
	this._readdirStorage.purge(what);
	this._readFileStorage.purge(what);
	this._readlinkStorage.purge(what);
	this._readJsonStorage.purge(what);
***REMOVED***;
