/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const RawSource = require("webpack-sources").RawSource;
const ModuleFilenameHelpers = require("./ModuleFilenameHelpers");

class EvalSourceMapDevToolModuleTemplatePlugin ***REMOVED***
	constructor(compilation, options) ***REMOVED***
		this.compilation = compilation;
		this.sourceMapComment = options.append || "//# sourceURL=[module]\n//# sourceMappingURL=[url]";
		this.moduleFilenameTemplate = options.moduleFilenameTemplate || "webpack:///[resource-path]?[hash]";
		this.options = options;
	***REMOVED***

	apply(moduleTemplate) ***REMOVED***
		const self = this;
		const options = this.options;
		moduleTemplate.plugin("module", function(source, module) ***REMOVED***
			if(source.__EvalSourceMapDevToolData)
				return source.__EvalSourceMapDevToolData;
			let sourceMap;
			let content;
			if(source.sourceAndMap) ***REMOVED***
				const sourceAndMap = source.sourceAndMap(options);
				sourceMap = sourceAndMap.map;
				content = sourceAndMap.source;
			***REMOVED*** else ***REMOVED***
				sourceMap = source.map(options);
				content = source.source();
			***REMOVED***
			if(!sourceMap) ***REMOVED***
				return source;
			***REMOVED***

			// Clone (flat) the sourcemap to ensure that the mutations below do not persist.
			sourceMap = Object.keys(sourceMap).reduce(function(obj, key) ***REMOVED***
				obj[key] = sourceMap[key];
				return obj;
			***REMOVED***, ***REMOVED******REMOVED***);
			const modules = sourceMap.sources.map(function(source) ***REMOVED***
				const module = self.compilation.findModule(source);
				return module || source;
			***REMOVED***);
			let moduleFilenames = modules.map(function(module) ***REMOVED***
				return ModuleFilenameHelpers.createFilename(module, self.moduleFilenameTemplate, this.requestShortener);
			***REMOVED***, this);
			moduleFilenames = ModuleFilenameHelpers.replaceDuplicates(moduleFilenames, function(filename, i, n) ***REMOVED***
				for(let j = 0; j < n; j++)
					filename += "*";
				return filename;
			***REMOVED***);
			sourceMap.sources = moduleFilenames;
			if(sourceMap.sourcesContent) ***REMOVED***
				sourceMap.sourcesContent = sourceMap.sourcesContent.map(function(content, i) ***REMOVED***
					return typeof content === "string" ? `$***REMOVED***content***REMOVED***\n\n\n$***REMOVED***ModuleFilenameHelpers.createFooter(modules[i], this.requestShortener)***REMOVED***` : null;
				***REMOVED***, this);
			***REMOVED***
			sourceMap.sourceRoot = options.sourceRoot || "";
			sourceMap.file = `$***REMOVED***module.id***REMOVED***.js`;

			const footer = self.sourceMapComment.replace(/\[url\]/g, `data:application/json;charset=utf-8;base64,$***REMOVED***new Buffer(JSON.stringify(sourceMap), "utf8").toString("base64")***REMOVED***`) + //eslint-disable-line
				`\n//# sourceURL=webpack-internal:///$***REMOVED***module.id***REMOVED***\n`; // workaround for chrome bug
			source.__EvalSourceMapDevToolData = new RawSource(`eval($***REMOVED***JSON.stringify(content + footer)***REMOVED***);`);
			return source.__EvalSourceMapDevToolData;
		***REMOVED***);
		moduleTemplate.plugin("hash", function(hash) ***REMOVED***
			hash.update("eval-source-map");
			hash.update("2");
		***REMOVED***);
	***REMOVED***
***REMOVED***
module.exports = EvalSourceMapDevToolModuleTemplatePlugin;
