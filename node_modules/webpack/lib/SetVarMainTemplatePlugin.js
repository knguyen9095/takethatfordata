/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const ConcatSource = require("webpack-sources").ConcatSource;

class SetVarMainTemplatePlugin ***REMOVED***
	constructor(varExpression, copyObject) ***REMOVED***
		this.varExpression = varExpression;
		this.copyObject = copyObject;
	***REMOVED***

	apply(compilation) ***REMOVED***
		const mainTemplate = compilation.mainTemplate;
		compilation.templatesPlugin("render-with-entry", (source, chunk, hash) => ***REMOVED***
			const varExpression = mainTemplate.applyPluginsWaterfall("asset-path", this.varExpression, ***REMOVED***
				hash,
				chunk
			***REMOVED***);
			if(this.copyObject) ***REMOVED***
				return new ConcatSource(`(function(e, a) ***REMOVED*** for(var i in a) e[i] = a[i]; ***REMOVED***($***REMOVED***varExpression***REMOVED***, `, source, "))");
			***REMOVED*** else ***REMOVED***
				const prefix = `$***REMOVED***varExpression***REMOVED*** =\n`;
				return new ConcatSource(prefix, source);
			***REMOVED***
		***REMOVED***);
		mainTemplate.plugin("global-hash-paths", (paths) => ***REMOVED***
			if(this.varExpression) paths.push(this.varExpression);
			return paths;
		***REMOVED***);
		mainTemplate.plugin("hash", hash => ***REMOVED***
			hash.update("set var");
			hash.update(`$***REMOVED***this.varExpression***REMOVED***`);
			hash.update(`$***REMOVED***this.copyObject***REMOVED***`);
		***REMOVED***);
	***REMOVED***
***REMOVED***

module.exports = SetVarMainTemplatePlugin;
