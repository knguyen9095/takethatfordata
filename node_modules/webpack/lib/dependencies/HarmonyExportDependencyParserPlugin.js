/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const HarmonyExportExpressionDependency = require("./HarmonyExportExpressionDependency");
const HarmonyExportHeaderDependency = require("./HarmonyExportHeaderDependency");
const HarmonyExportSpecifierDependency = require("./HarmonyExportSpecifierDependency");
const HarmonyExportImportedSpecifierDependency = require("./HarmonyExportImportedSpecifierDependency");
const HarmonyImportDependency = require("./HarmonyImportDependency");
const HarmonyModulesHelpers = require("./HarmonyModulesHelpers");

module.exports = class HarmonyExportDependencyParserPlugin ***REMOVED***
	apply(parser) ***REMOVED***
		parser.plugin("export", statement => ***REMOVED***
			const dep = new HarmonyExportHeaderDependency(statement.declaration && statement.declaration.range, statement.range);
			dep.loc = Object.create(statement.loc);
			dep.loc.index = -1;
			parser.state.current.addDependency(dep);
			return true;
		***REMOVED***);
		parser.plugin("export import", (statement, source) => ***REMOVED***
			const dep = new HarmonyImportDependency(source, HarmonyModulesHelpers.getNewModuleVar(parser.state, source), statement.range);
			dep.loc = Object.create(statement.loc);
			dep.loc.index = -1;
			parser.state.current.addDependency(dep);
			parser.state.lastHarmonyImport = dep;
			return true;
		***REMOVED***);
		parser.plugin("export expression", (statement, expr) => ***REMOVED***
			const dep = new HarmonyExportExpressionDependency(parser.state.module, expr.range, statement.range);
			dep.loc = Object.create(statement.loc);
			dep.loc.index = -1;
			parser.state.current.addDependency(dep);
			return true;
		***REMOVED***);
		parser.plugin("export declaration", statement => ***REMOVED******REMOVED***);
		parser.plugin("export specifier", (statement, id, name, idx) => ***REMOVED***
			const rename = parser.scope.renames[`$$***REMOVED***id***REMOVED***`];
			let dep;
			const harmonyNamedExports = parser.state.harmonyNamedExports = parser.state.harmonyNamedExports || new Set();
			harmonyNamedExports.add(name);
			if(rename === "imported var") ***REMOVED***
				const settings = parser.state.harmonySpecifier[`$$***REMOVED***id***REMOVED***`];
				dep = new HarmonyExportImportedSpecifierDependency(parser.state.module, settings[0], settings[1], settings[2], name, harmonyNamedExports, null);
			***REMOVED*** else ***REMOVED***
				const immutable = statement.declaration && isImmutableStatement(statement.declaration);
				const hoisted = statement.declaration && isHoistedStatement(statement.declaration);
				dep = new HarmonyExportSpecifierDependency(parser.state.module, id, name, !immutable || hoisted ? -2 : (statement.range[1] + 0.5), immutable);
			***REMOVED***
			dep.loc = Object.create(statement.loc);
			dep.loc.index = idx;
			parser.state.current.addDependency(dep);
			return true;
		***REMOVED***);
		parser.plugin("export import specifier", (statement, source, id, name, idx) => ***REMOVED***
			const harmonyNamedExports = parser.state.harmonyNamedExports = parser.state.harmonyNamedExports || new Set();
			let harmonyStarExports = null;
			if(name) ***REMOVED***
				harmonyNamedExports.add(name);
			***REMOVED*** else ***REMOVED***
				harmonyStarExports = parser.state.harmonyStarExports = parser.state.harmonyStarExports || [];
			***REMOVED***
			const dep = new HarmonyExportImportedSpecifierDependency(parser.state.module, parser.state.lastHarmonyImport, HarmonyModulesHelpers.getModuleVar(parser.state, source), id, name, harmonyNamedExports, harmonyStarExports && harmonyStarExports.slice());
			if(harmonyStarExports) ***REMOVED***
				harmonyStarExports.push(dep);
			***REMOVED***
			dep.loc = Object.create(statement.loc);
			dep.loc.index = idx;
			parser.state.current.addDependency(dep);
			return true;
		***REMOVED***);
	***REMOVED***
***REMOVED***;

function isImmutableStatement(statement) ***REMOVED***
	if(statement.type === "FunctionDeclaration") return true;
	if(statement.type === "ClassDeclaration") return true;
	if(statement.type === "VariableDeclaration" && statement.kind === "const") return true;
	return false;
***REMOVED***

function isHoistedStatement(statement) ***REMOVED***
	if(statement.type === "FunctionDeclaration") return true;
	return false;
***REMOVED***
