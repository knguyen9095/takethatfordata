/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const ImportEagerContextDependency = require("./ImportEagerContextDependency");
const ImportWeakDependency = require("./ImportWeakDependency");
const ImportWeakContextDependency = require("./ImportWeakContextDependency");
const ImportLazyOnceContextDependency = require("./ImportLazyOnceContextDependency");
const ImportLazyContextDependency = require("./ImportLazyContextDependency");
const ImportDependenciesBlock = require("./ImportDependenciesBlock");
const ImportEagerDependency = require("./ImportEagerDependency");
const ContextDependencyHelpers = require("./ContextDependencyHelpers");
const UnsupportedFeatureWarning = require("../UnsupportedFeatureWarning");

class ImportParserPlugin ***REMOVED***
	constructor(options) ***REMOVED***
		this.options = options;
	***REMOVED***

	apply(parser) ***REMOVED***
		const options = this.options;

		parser.plugin(["call System.import", "import-call"], (expr) => ***REMOVED***
			if(expr.arguments.length !== 1)
				throw new Error("Incorrect number of arguments provided to 'import(module: string) -> Promise'.");

			const param = parser.evaluateExpression(expr.arguments[0]);

			let chunkName = null;
			let mode = "lazy";

			const importOptions = parser.getCommentOptions(expr.range);
			if(importOptions) ***REMOVED***
				if(typeof importOptions.webpackChunkName !== "undefined") ***REMOVED***
					if(typeof importOptions.webpackChunkName !== "string")
						parser.state.module.warnings.push(new UnsupportedFeatureWarning(parser.state.module, `\`webpackChunkName\` expected a string, but received: $***REMOVED***importOptions.webpackChunkName***REMOVED***.`));
					else
						chunkName = importOptions.webpackChunkName;
				***REMOVED***
				if(typeof importOptions.webpackMode !== "undefined") ***REMOVED***
					if(typeof importOptions.webpackMode !== "string")
						parser.state.module.warnings.push(new UnsupportedFeatureWarning(parser.state.module, `\`webpackMode\` expected a string, but received: $***REMOVED***importOptions.webpackMode***REMOVED***.`));
					else
						mode = importOptions.webpackMode;
				***REMOVED***
			***REMOVED***

			if(param.isString()) ***REMOVED***
				if(mode !== "lazy" && mode !== "eager" && mode !== "weak") ***REMOVED***
					parser.state.module.warnings.push(new UnsupportedFeatureWarning(parser.state.module, `\`webpackMode\` expected 'lazy', 'eager' or 'weak', but received: $***REMOVED***mode***REMOVED***.`));
				***REMOVED***

				if(mode === "eager") ***REMOVED***
					const dep = new ImportEagerDependency(param.string, expr.range);
					parser.state.current.addDependency(dep);
				***REMOVED*** else if(mode === "weak") ***REMOVED***
					const dep = new ImportWeakDependency(param.string, expr.range);
					parser.state.current.addDependency(dep);
				***REMOVED*** else ***REMOVED***
					const depBlock = new ImportDependenciesBlock(param.string, expr.range, chunkName, parser.state.module, expr.loc);
					parser.state.current.addBlock(depBlock);
				***REMOVED***
				return true;
			***REMOVED*** else ***REMOVED***
				if(mode !== "lazy" && mode !== "lazy-once" && mode !== "eager" && mode !== "weak") ***REMOVED***
					parser.state.module.warnings.push(new UnsupportedFeatureWarning(parser.state.module, `\`webpackMode\` expected 'lazy', 'lazy-once', 'eager' or 'weak', but received: $***REMOVED***mode***REMOVED***.`));
				***REMOVED***

				let Dep = ImportLazyContextDependency;
				if(mode === "eager") ***REMOVED***
					Dep = ImportEagerContextDependency;
				***REMOVED*** else if(mode === "weak") ***REMOVED***
					Dep = ImportWeakContextDependency;
				***REMOVED*** else if(mode === "lazy-once") ***REMOVED***
					Dep = ImportLazyOnceContextDependency;
				***REMOVED***
				const dep = ContextDependencyHelpers.create(Dep, expr.range, param, expr, options, chunkName);
				if(!dep) return;
				dep.loc = expr.loc;
				dep.optional = !!parser.scope.inTry;
				parser.state.current.addDependency(dep);
				return true;
			***REMOVED***
		***REMOVED***);
	***REMOVED***
***REMOVED***
module.exports = ImportParserPlugin;
