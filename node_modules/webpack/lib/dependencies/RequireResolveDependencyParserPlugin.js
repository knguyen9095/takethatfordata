/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const RequireResolveDependency = require("./RequireResolveDependency");
const RequireResolveContextDependency = require("./RequireResolveContextDependency");
const RequireResolveHeaderDependency = require("./RequireResolveHeaderDependency");
const ContextDependencyHelpers = require("./ContextDependencyHelpers");

class RequireResolveDependencyParserPlugin ***REMOVED***
	constructor(options) ***REMOVED***
		this.options = options;
	***REMOVED***

	apply(parser) ***REMOVED***
		const options = this.options;
		parser.plugin("call require.resolve", (expr) => ***REMOVED***
			return parser.applyPluginsBailResult("call require.resolve(Weak)", expr, false);
		***REMOVED***);
		parser.plugin("call require.resolveWeak", (expr) => ***REMOVED***
			return parser.applyPluginsBailResult("call require.resolve(Weak)", expr, true);
		***REMOVED***);
		parser.plugin("call require.resolve(Weak)", (expr, weak) => ***REMOVED***
			if(expr.arguments.length !== 1) return;
			const param = parser.evaluateExpression(expr.arguments[0]);
			if(param.isConditional()) ***REMOVED***
				param.options.forEach((option) => ***REMOVED***
					const result = parser.applyPluginsBailResult("call require.resolve(Weak):item", expr, option, weak);
					if(result === undefined) ***REMOVED***
						parser.applyPluginsBailResult("call require.resolve(Weak):context", expr, option, weak);
					***REMOVED***
				***REMOVED***);
				const dep = new RequireResolveHeaderDependency(expr.callee.range);
				dep.loc = expr.loc;
				parser.state.current.addDependency(dep);
				return true;
			***REMOVED*** else ***REMOVED***
				const result = parser.applyPluginsBailResult("call require.resolve(Weak):item", expr, param, weak);
				if(result === undefined) ***REMOVED***
					parser.applyPluginsBailResult("call require.resolve(Weak):context", expr, param, weak);
				***REMOVED***
				const dep = new RequireResolveHeaderDependency(expr.callee.range);
				dep.loc = expr.loc;
				parser.state.current.addDependency(dep);
				return true;
			***REMOVED***
		***REMOVED***);
		parser.plugin("call require.resolve(Weak):item", (expr, param, weak) => ***REMOVED***
			if(param.isString()) ***REMOVED***
				const dep = new RequireResolveDependency(param.string, param.range);
				dep.loc = expr.loc;
				dep.optional = !!parser.scope.inTry;
				dep.weak = weak;
				parser.state.current.addDependency(dep);
				return true;
			***REMOVED***
		***REMOVED***);
		parser.plugin("call require.resolve(Weak):context", (expr, param, weak) => ***REMOVED***
			const dep = ContextDependencyHelpers.create(RequireResolveContextDependency, param.range, param, expr, options);
			if(!dep) return;
			dep.loc = expr.loc;
			dep.optional = !!parser.scope.inTry;
			dep.async = weak ? "weak" : false;
			parser.state.current.addDependency(dep);
			return true;
		***REMOVED***);
	***REMOVED***
***REMOVED***
module.exports = RequireResolveDependencyParserPlugin;
