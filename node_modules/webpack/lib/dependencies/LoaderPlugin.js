/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const LoaderDependency = require("./LoaderDependency");

class LoaderPlugin ***REMOVED***

	apply(compiler) ***REMOVED***
		compiler.plugin("compilation", (compilation, params) => ***REMOVED***
			const normalModuleFactory = params.normalModuleFactory;

			compilation.dependencyFactories.set(LoaderDependency, normalModuleFactory);
		***REMOVED***);
		compiler.plugin("compilation", (compilation) => ***REMOVED***
			compilation.plugin("normal-module-loader", (loaderContext, module) => ***REMOVED***
				loaderContext.loadModule = function loadModule(request, callback) ***REMOVED***
					const dep = new LoaderDependency(request);
					dep.loc = request;
					compilation.addModuleDependencies(module, [
						[dep]
					], true, "lm", false, (err) => ***REMOVED***
						if(err) return callback(err);

						if(!dep.module) return callback(new Error("Cannot load the module"));
						if(dep.module.building) dep.module.building.push(next);
						else next();

						function next(err) ***REMOVED***
							if(err) return callback(err);

							if(dep.module.error) return callback(dep.module.error);
							if(!dep.module._source) throw new Error("The module created for a LoaderDependency must have a property _source");
							let source, map;
							const moduleSource = dep.module._source;
							if(moduleSource.sourceAndMap) ***REMOVED***
								const sourceAndMap = moduleSource.sourceAndMap();
								map = sourceAndMap.map;
								source = sourceAndMap.source;
							***REMOVED*** else ***REMOVED***
								map = moduleSource.map();
								source = moduleSource.source();
							***REMOVED***
							if(dep.module.fileDependencies) ***REMOVED***
								dep.module.fileDependencies.forEach((dep) => loaderContext.addDependency(dep));
							***REMOVED***
							if(dep.module.contextDependencies) ***REMOVED***
								dep.module.contextDependencies.forEach((dep) => loaderContext.addContextDependency(dep));
							***REMOVED***
							return callback(null, source, map, dep.module);
						***REMOVED***
					***REMOVED***);
				***REMOVED***;
			***REMOVED***);
		***REMOVED***);
	***REMOVED***
***REMOVED***
module.exports = LoaderPlugin;
