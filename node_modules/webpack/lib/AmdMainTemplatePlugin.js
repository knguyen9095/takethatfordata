/*
 MIT License http://www.opensource.org/licenses/mit-license.php
 Author Tobias Koppers @sokra
 */

"use strict";

const ConcatSource = require("webpack-sources").ConcatSource;
const Template = require("./Template");

class AmdMainTemplatePlugin ***REMOVED***
	constructor(name) ***REMOVED***
		this.name = name;
	***REMOVED***

	apply(compilation) ***REMOVED***
		const mainTemplate = compilation.mainTemplate;

		compilation.templatesPlugin("render-with-entry", (source, chunk, hash) => ***REMOVED***
			const externals = chunk.getModules().filter((m) => m.external);
			const externalsDepsArray = JSON.stringify(externals.map((m) =>
				typeof m.request === "object" ? m.request.amd : m.request
			));
			const externalsArguments = externals.map((m) =>
				Template.toIdentifier(`__WEBPACK_EXTERNAL_MODULE_$***REMOVED***m.id***REMOVED***__`)
			).join(", ");

			if(this.name) ***REMOVED***
				const name = mainTemplate.applyPluginsWaterfall("asset-path", this.name, ***REMOVED***
					hash,
					chunk
				***REMOVED***);

				return new ConcatSource(
					`define($***REMOVED***JSON.stringify(name)***REMOVED***, $***REMOVED***externalsDepsArray***REMOVED***, function($***REMOVED***externalsArguments***REMOVED***) ***REMOVED*** return `, source, "***REMOVED***);"
				);
			***REMOVED*** else if(externalsArguments) ***REMOVED***
				return new ConcatSource(`define($***REMOVED***externalsDepsArray***REMOVED***, function($***REMOVED***externalsArguments***REMOVED***) ***REMOVED*** return `, source, "***REMOVED***);");
			***REMOVED*** else ***REMOVED***
				return new ConcatSource("define(function() ***REMOVED*** return ", source, "***REMOVED***);");
			***REMOVED***
		***REMOVED***);

		mainTemplate.plugin("global-hash-paths", (paths) => ***REMOVED***
			if(this.name) paths.push(this.name);
			return paths;
		***REMOVED***);

		mainTemplate.plugin("hash", (hash) => ***REMOVED***
			hash.update("exports amd");
			hash.update(this.name);
		***REMOVED***);
	***REMOVED***
***REMOVED***

module.exports = AmdMainTemplatePlugin;
