/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const ConstDependency = require("./dependencies/ConstDependency");
const ParserHelpers = require("./ParserHelpers");
const NullFactory = require("./NullFactory");

const REPLACEMENTS = ***REMOVED***
	__webpack_hash__: "__webpack_require__.h", // eslint-disable-line camelcase
	__webpack_chunkname__: "__webpack_require__.cn" // eslint-disable-line camelcase
***REMOVED***;
const REPLACEMENT_TYPES = ***REMOVED***
	__webpack_hash__: "string", // eslint-disable-line camelcase
	__webpack_chunkname__: "string" // eslint-disable-line camelcase
***REMOVED***;

class ExtendedAPIPlugin ***REMOVED***
	apply(compiler) ***REMOVED***
		compiler.plugin("compilation", (compilation, params) => ***REMOVED***
			compilation.dependencyFactories.set(ConstDependency, new NullFactory());
			compilation.dependencyTemplates.set(ConstDependency, new ConstDependency.Template());
			compilation.mainTemplate.plugin("require-extensions", function(source, chunk, hash) ***REMOVED***
				const buf = [source];
				buf.push("");
				buf.push("// __webpack_hash__");
				buf.push(`$***REMOVED***this.requireFn***REMOVED***.h = $***REMOVED***JSON.stringify(hash)***REMOVED***;`);
				buf.push("");
				buf.push("// __webpack_chunkname__");
				buf.push(`$***REMOVED***this.requireFn***REMOVED***.cn = $***REMOVED***JSON.stringify(chunk.name)***REMOVED***;`);
				return this.asString(buf);
			***REMOVED***);
			compilation.mainTemplate.plugin("global-hash", () => true);

			params.normalModuleFactory.plugin("parser", (parser, parserOptions) => ***REMOVED***
				Object.keys(REPLACEMENTS).forEach(key => ***REMOVED***
					parser.plugin(`expression $***REMOVED***key***REMOVED***`, ParserHelpers.toConstantDependency(REPLACEMENTS[key]));
					parser.plugin(`evaluate typeof $***REMOVED***key***REMOVED***`, ParserHelpers.evaluateToString(REPLACEMENT_TYPES[key]));
				***REMOVED***);
			***REMOVED***);
		***REMOVED***);
	***REMOVED***
***REMOVED***

module.exports = ExtendedAPIPlugin;
