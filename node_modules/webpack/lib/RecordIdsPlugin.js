/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const identifierUtils = require("./util/identifier");

class RecordIdsPlugin ***REMOVED***

	apply(compiler) ***REMOVED***
		compiler.plugin("compilation", compilation => ***REMOVED***
			compilation.plugin("record-modules", (modules, records) => ***REMOVED***
				if(!records.modules) records.modules = ***REMOVED******REMOVED***;
				if(!records.modules.byIdentifier) records.modules.byIdentifier = ***REMOVED******REMOVED***;
				if(!records.modules.usedIds) records.modules.usedIds = ***REMOVED******REMOVED***;
				modules.forEach(function(module) ***REMOVED***
					if(!module.portableId) module.portableId = identifierUtils.makePathsRelative(compiler.context, module.identifier());
					const identifier = module.portableId;
					records.modules.byIdentifier[identifier] = module.id;
					records.modules.usedIds[module.id] = module.id;
				***REMOVED***);
			***REMOVED***);
			compilation.plugin("revive-modules", (modules, records) => ***REMOVED***
				if(!records.modules) return;
				if(records.modules.byIdentifier) ***REMOVED***
					const usedIds = ***REMOVED******REMOVED***;
					modules.forEach(function(module) ***REMOVED***
						if(module.id !== null) return;
						if(!module.portableId) module.portableId = identifierUtils.makePathsRelative(compiler.context, module.identifier());
						const identifier = module.portableId;
						const id = records.modules.byIdentifier[identifier];
						if(id === undefined) return;
						if(usedIds[id]) return;
						usedIds[id] = true;
						module.id = id;
					***REMOVED***);
				***REMOVED***
				compilation.usedModuleIds = records.modules.usedIds;
			***REMOVED***);

			function getDepBlockIdent(chunk, block) ***REMOVED***
				const ident = [];
				if(block.chunks.length > 1)
					ident.push(block.chunks.indexOf(chunk));
				while(block.parent) ***REMOVED***
					const p = block.parent;
					const idx = p.blocks.indexOf(block);
					const l = p.blocks.length - 1;
					ident.push(`$***REMOVED***idx***REMOVED***/$***REMOVED***l***REMOVED***`);
					block = block.parent;
				***REMOVED***
				if(!block.identifier) return null;
				ident.push(identifierUtils.makePathsRelative(compiler.context, block.identifier()));
				return ident.reverse().join(":");
			***REMOVED***
			compilation.plugin("record-chunks", (chunks, records) => ***REMOVED***
				records.nextFreeChunkId = compilation.nextFreeChunkId;
				if(!records.chunks) records.chunks = ***REMOVED******REMOVED***;
				if(!records.chunks.byName) records.chunks.byName = ***REMOVED******REMOVED***;
				if(!records.chunks.byBlocks) records.chunks.byBlocks = ***REMOVED******REMOVED***;
				records.chunks.usedIds = ***REMOVED******REMOVED***;
				chunks.forEach(chunk => ***REMOVED***
					const name = chunk.name;
					const blockIdents = chunk.blocks.map(getDepBlockIdent.bind(null, chunk)).filter(Boolean);
					if(name) records.chunks.byName[name] = chunk.id;
					blockIdents.forEach((blockIdent) => ***REMOVED***
						records.chunks.byBlocks[blockIdent] = chunk.id;
					***REMOVED***);
					records.chunks.usedIds[chunk.id] = chunk.id;
				***REMOVED***);
			***REMOVED***);
			compilation.plugin("revive-chunks", (chunks, records) => ***REMOVED***
				if(!records.chunks) return;
				const usedIds = ***REMOVED******REMOVED***;
				if(records.chunks.byName) ***REMOVED***
					chunks.forEach(function(chunk) ***REMOVED***
						if(chunk.id !== null) return;
						if(!chunk.name) return;
						const id = records.chunks.byName[chunk.name];
						if(id === undefined) return;
						if(usedIds[id]) return;
						usedIds[id] = true;
						chunk.id = id;
					***REMOVED***);
				***REMOVED***
				if(records.chunks.byBlocks) ***REMOVED***
					const argumentedChunks = chunks.filter(chunk => chunk.id === null).map(chunk => (***REMOVED***
						chunk,
						blockIdents: chunk.blocks.map(getDepBlockIdent.bind(null, chunk)).filter(Boolean)
					***REMOVED***)).filter(arg => arg.blockIdents.length > 0);
					let blockIdentsCount = ***REMOVED******REMOVED***;
					argumentedChunks.forEach((arg, idx) => ***REMOVED***
						arg.blockIdents.forEach(blockIdent => ***REMOVED***
							const id = records.chunks.byBlocks[blockIdent];
							if(typeof id !== "number") return;
							const accessor = `$***REMOVED***id***REMOVED***:$***REMOVED***idx***REMOVED***`;
							blockIdentsCount[accessor] = (blockIdentsCount[accessor] || 0) + 1;
						***REMOVED***);
					***REMOVED***);
					blockIdentsCount = Object.keys(blockIdentsCount).map(accessor => [blockIdentsCount[accessor]].concat(accessor.split(":").map(Number))).sort((a, b) => b[0] - a[0]);
					blockIdentsCount.forEach(function(arg) ***REMOVED***
						const id = arg[1];
						if(usedIds[id]) return;
						const idx = arg[2];
						const chunk = argumentedChunks[idx].chunk;
						if(chunk.id !== null) return;
						usedIds[id] = true;
						chunk.id = id;
					***REMOVED***);
				***REMOVED***
				compilation.usedChunkIds = records.chunks.usedIds;
			***REMOVED***);
		***REMOVED***);
	***REMOVED***
***REMOVED***
module.exports = RecordIdsPlugin;
