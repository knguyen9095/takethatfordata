/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

const path = require("path");
const ParserHelpers = require("./ParserHelpers");
const ConstDependency = require("./dependencies/ConstDependency");

const NullFactory = require("./NullFactory");

class NodeStuffPlugin ***REMOVED***
	constructor(options) ***REMOVED***
		this.options = options;
	***REMOVED***

	apply(compiler) ***REMOVED***
		const options = this.options;
		compiler.plugin("compilation", (compilation, params) => ***REMOVED***
			compilation.dependencyFactories.set(ConstDependency, new NullFactory());
			compilation.dependencyTemplates.set(ConstDependency, new ConstDependency.Template());

			params.normalModuleFactory.plugin("parser", (parser, parserOptions) => ***REMOVED***

				if(parserOptions.node === false)
					return;

				let localOptions = options;
				if(parserOptions.node)
					localOptions = Object.assign(***REMOVED******REMOVED***, localOptions, parserOptions.node);

				function setConstant(expressionName, value) ***REMOVED***
					parser.plugin(`expression $***REMOVED***expressionName***REMOVED***`, function() ***REMOVED***
						this.state.current.addVariable(expressionName, JSON.stringify(value));
						return true;
					***REMOVED***);
				***REMOVED***

				function setModuleConstant(expressionName, fn) ***REMOVED***
					parser.plugin(`expression $***REMOVED***expressionName***REMOVED***`, function() ***REMOVED***
						this.state.current.addVariable(expressionName, JSON.stringify(fn(this.state.module)));
						return true;
					***REMOVED***);
				***REMOVED***
				const context = compiler.context;
				if(localOptions.__filename === "mock") ***REMOVED***
					setConstant("__filename", "/index.js");
				***REMOVED*** else if(localOptions.__filename) ***REMOVED***
					setModuleConstant("__filename", module => path.relative(context, module.resource));
				***REMOVED***
				parser.plugin("evaluate Identifier __filename", function(expr) ***REMOVED***
					if(!this.state.module) return;
					const resource = this.state.module.resource;
					const i = resource.indexOf("?");
					return ParserHelpers.evaluateToString(i < 0 ? resource : resource.substr(0, i))(expr);
				***REMOVED***);
				if(localOptions.__dirname === "mock") ***REMOVED***
					setConstant("__dirname", "/");
				***REMOVED*** else if(localOptions.__dirname) ***REMOVED***
					setModuleConstant("__dirname", module => path.relative(context, module.context));
				***REMOVED***
				parser.plugin("evaluate Identifier __dirname", function(expr) ***REMOVED***
					if(!this.state.module) return;
					return ParserHelpers.evaluateToString(this.state.module.context)(expr);
				***REMOVED***);
				parser.plugin("expression require.main", ParserHelpers.toConstantDependency("__webpack_require__.c[__webpack_require__.s]"));
				parser.plugin(
					"expression require.extensions",
					ParserHelpers.expressionIsUnsupported("require.extensions is not supported by webpack. Use a loader instead.")
				);
				parser.plugin("expression module.loaded", ParserHelpers.toConstantDependency("module.l"));
				parser.plugin("expression module.id", ParserHelpers.toConstantDependency("module.i"));
				parser.plugin("expression module.exports", function() ***REMOVED***
					const module = this.state.module;
					const isHarmony = module.meta && module.meta.harmonyModule;
					if(!isHarmony)
						return true;
				***REMOVED***);
				parser.plugin("evaluate Identifier module.hot", ParserHelpers.evaluateToIdentifier("module.hot", false));
				parser.plugin("expression module", function() ***REMOVED***
					const module = this.state.module;
					const isHarmony = module.meta && module.meta.harmonyModule;
					let moduleJsPath = path.join(__dirname, "..", "buildin", isHarmony ? "harmony-module.js" : "module.js");
					if(module.context) ***REMOVED***
						moduleJsPath = path.relative(this.state.module.context, moduleJsPath);
						if(!/^[A-Z]:/i.test(moduleJsPath)) ***REMOVED***
							moduleJsPath = `./$***REMOVED***moduleJsPath.replace(/\\/g, "/")***REMOVED***`;
						***REMOVED***
					***REMOVED***
					return ParserHelpers.addParsedVariableToModule(this, "module", `require($***REMOVED***JSON.stringify(moduleJsPath)***REMOVED***)(module)`);
				***REMOVED***);
			***REMOVED***);
		***REMOVED***);
	***REMOVED***
***REMOVED***
module.exports = NodeStuffPlugin;
