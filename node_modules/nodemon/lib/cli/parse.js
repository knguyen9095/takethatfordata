/*

nodemon is a utility for node, and replaces the use of the executable
node. So the user calls `nodemon foo.js` instead.

nodemon can be run in a number of ways:

`nodemon` - tries to use package.json#main property to run
`nodemon` - if no package, looks for index.js
`nodemon app.js` - runs app.js
`nodemon --arg app.js --apparg` - eats arg1, and runs app.js with apparg
`nodemon --apparg` - as above, but passes apparg to package.json#main (or
  index.js)
`nodemon --debug app.js

*/

var fs = require('fs');
var path = require('path');
var existsSync = fs.existsSync || path.existsSync;

module.exports = parse;

/**
 * Parses the command line arguments `process.argv` and returns the
 * nodemon options, the user script and the executable script.
 *
 * @param  ***REMOVED***Array***REMOVED*** full process arguments, including `node` leading arg
 * @return ***REMOVED***Object***REMOVED*** ***REMOVED*** options, script, args ***REMOVED***
 */
function parse(argv) ***REMOVED***
  if (typeof argv === 'string') ***REMOVED***
    argv = argv.split(' ');
  ***REMOVED***

  var eat = function (i, args) ***REMOVED***
    if (i <= args.length) ***REMOVED***
      return args.splice(i + 1, 1).pop();
    ***REMOVED***
  ***REMOVED***;

  var args = argv.slice(2);
  var script = null;
  var nodemonOptions = ***REMOVED*** scriptPosition: null ***REMOVED***;

  var nodemonOpt = nodemonOption.bind(null, nodemonOptions);
  var lookForArgs = true;

  // move forward through the arguments
  for (var i = 0; i < args.length; i++) ***REMOVED***
    // if the argument looks like a file, then stop eating
    if (!script) ***REMOVED***
      if (args[i] === '.' || existsSync(args[i])) ***REMOVED***
        script = args.splice(i, 1).pop();

        // we capture the position of the script because we'll reinsert it in
        // the right place in run.js:command (though I'm not sure we should even
        // take it out of the array in the first place, but this solves passing
        // arguments to the exec process for now).
        nodemonOptions.scriptPosition = i;
        i--;
        continue;
      ***REMOVED***
    ***REMOVED***

    if (lookForArgs) ***REMOVED***
      // respect the standard way of saying: hereafter belongs to my script
      if (args[i] === '--') ***REMOVED***
        args.splice(i, 1);
        nodemonOptions.scriptPosition = i;
        // cycle back one argument, as we just ate this one up
        i--;

        // ignore all further nodemon arguments
        lookForArgs = false;

        // move to the next iteration
        continue;
      ***REMOVED***

      if (nodemonOpt(args[i], eat.bind(null, i, args)) !== false) ***REMOVED***
        args.splice(i, 1);
        // cycle back one argument, as we just ate this one up
        i--;
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***

  nodemonOptions.script = script;
  nodemonOptions.args = args;

  return nodemonOptions;
***REMOVED***


/**
 * Given an argument (ie. from process.argv), sets nodemon
 * options and can eat up the argument value
 *
 * @param ***REMOVED***Object***REMOVED*** options object that will be updated
 * @param ***REMOVED***Sting***REMOVED*** current argument from argv
 * @param ***REMOVED***Function***REMOVED*** the callback to eat up the next argument in argv
 * @return ***REMOVED***Boolean***REMOVED*** false if argument was not a nodemon arg
 */
function nodemonOption(options, arg, eatNext) ***REMOVED***
  // line separation on purpose to help legibility
  if (arg === '--help' || arg === '-h' || arg === '-?') ***REMOVED***
    var help = eatNext();
    options.help = help ? help : true;
  ***REMOVED*** else

  if (arg === '--version' || arg === '-v') ***REMOVED***
    options.version = true;
  ***REMOVED*** else

  if (arg === '--no-update-notifier') ***REMOVED***
    options.noUpdateNotifier = true;
  ***REMOVED*** else


  if (arg === '--dump') ***REMOVED***
    options.dump = true;
  ***REMOVED*** else

  if (arg === '--verbose' || arg === '-V') ***REMOVED***
    options.verbose = true;
  ***REMOVED*** else

  if (arg === '--legacy-watch' || arg === '-L') ***REMOVED***
    options.legacyWatch = true;
  ***REMOVED*** else

  if (arg === '--polling-interval' || arg === '-P') ***REMOVED***
    options.pollingInterval = parseInt(eatNext(), 10);
  ***REMOVED*** else

  // Depricated as this is "on" by default
  if (arg === '--js') ***REMOVED***
    options.js = true;
  ***REMOVED*** else

  if (arg === '--quiet' || arg === '-q') ***REMOVED***
    options.quiet = true;
  ***REMOVED*** else

  if (arg === '--config') ***REMOVED***
    options.configFile = eatNext();
  ***REMOVED*** else

  if (arg === '--watch' || arg === '-w') ***REMOVED***
    if (!options.watch) ***REMOVED*** options.watch = []; ***REMOVED***
    options.watch.push(eatNext());
  ***REMOVED*** else

  if (arg === '--ignore' || arg === '-i') ***REMOVED***
    if (!options.ignore) ***REMOVED*** options.ignore = []; ***REMOVED***
    options.ignore.push(eatNext());
  ***REMOVED*** else

  if (arg === '--exitcrash') ***REMOVED***
    options.exitcrash = true;
  ***REMOVED*** else

  if (arg === '--delay' || arg === '-d') ***REMOVED***
    options.delay = parseDelay(eatNext());
  ***REMOVED*** else

  if (arg === '--exec' || arg === '-x') ***REMOVED***
    options.exec = eatNext();
  ***REMOVED*** else

  if (arg === '--no-stdin' || arg === '-I') ***REMOVED***
    options.stdin = false;
  ***REMOVED*** else

  if (arg === '--on-change-only' || arg === '-C') ***REMOVED***
    options.runOnChangeOnly = true;
  ***REMOVED*** else

  if (arg === '--ext' || arg === '-e') ***REMOVED***
    options.ext = eatNext();
  ***REMOVED*** else

  if (arg === '--no-colours' || arg === '--no-colors') ***REMOVED***
    options.colours = false;
  ***REMOVED*** else

  if (arg === '--signal' || arg === '-s') ***REMOVED***
    options.signal = eatNext();
  ***REMOVED*** else

  if (arg === '--cwd') ***REMOVED***
    options.cwd = eatNext();

    // go ahead and change directory. This is primarily for nodemon tools like
    // grunt-nodemon - we're doing this early because it will affect where the
    // user script is searched for.
    process.chdir(path.resolve(options.cwd));
  ***REMOVED*** else ***REMOVED***

    // this means we didn't match
    return false;
  ***REMOVED***
***REMOVED***

/**
 * Given an argument (ie. from nodemonOption()), will parse and return the
 * equivalent millisecond value or 0 if the argument cannot be parsed
 *
 * @param ***REMOVED***String***REMOVED*** argument value given to the --delay option
 * @return ***REMOVED***Number***REMOVED*** millisecond equivalent of the argument
 */
function parseDelay(value) ***REMOVED***
  var millisPerSecond = 1000;
  var millis = 0;

  if (value.match(/^\d*ms$/)) ***REMOVED***
    // Explicitly parse for milliseconds when using ms time specifier
    millis = parseInt(value, 10);
  ***REMOVED*** else ***REMOVED***
    // Otherwise, parse for seconds, with or without time specifier then convert
    millis = parseFloat(value) * millisPerSecond;
  ***REMOVED***

  return isNaN(millis) ? 0 : millis;
***REMOVED***

