var events = require('events');
var debug = require('debug')('nodemon');
var util = require('util');

var Bus = function () ***REMOVED***
  events.EventEmitter.call(this);
***REMOVED***;

util.inherits(Bus, events.EventEmitter);

var bus = new Bus();

// /*
var collected = ***REMOVED******REMOVED***;
bus.on('newListener', function (event) ***REMOVED***
  debug('bus new listener: %s (%s)', event, bus.listeners(event).length);
  if (!collected[event]) ***REMOVED***
    collected[event] = true;
    bus.on(event, function () ***REMOVED***
      debug('bus emit: %s', event);
    ***REMOVED***);
  ***REMOVED***
***REMOVED***);

// */

// proxy process messages (if forked) to the bus
process.on('message', function (event) ***REMOVED***
  debug('process.message(%s)', event);
  bus.emit(event);
***REMOVED***);

var emit = bus.emit;

// if nodemon was spawned via a fork, allow upstream communication
// via process.send
if (process.send) ***REMOVED***
  bus.emit = function (event, data) ***REMOVED***
    process.send(***REMOVED*** type: event, data: data ***REMOVED***);
    emit.apply(bus, arguments);
  ***REMOVED***;
***REMOVED***

module.exports = bus;
