exports.alphasort = alphasort
exports.alphasorti = alphasorti
exports.setopts = setopts
exports.ownProp = ownProp
exports.makeAbs = makeAbs
exports.finish = finish
exports.mark = mark
exports.isIgnored = isIgnored
exports.childrenIgnored = childrenIgnored

function ownProp (obj, field) ***REMOVED***
  return Object.prototype.hasOwnProperty.call(obj, field)
***REMOVED***

var path = require("path")
var minimatch = require("minimatch")
var isAbsolute = require("path-is-absolute")
var Minimatch = minimatch.Minimatch

function alphasorti (a, b) ***REMOVED***
  return a.toLowerCase().localeCompare(b.toLowerCase())
***REMOVED***

function alphasort (a, b) ***REMOVED***
  return a.localeCompare(b)
***REMOVED***

function setupIgnores (self, options) ***REMOVED***
  self.ignore = options.ignore || []

  if (!Array.isArray(self.ignore))
    self.ignore = [self.ignore]

  if (self.ignore.length) ***REMOVED***
    self.ignore = self.ignore.map(ignoreMap)
  ***REMOVED***
***REMOVED***

// ignore patterns are always in dot:true mode.
function ignoreMap (pattern) ***REMOVED***
  var gmatcher = null
  if (pattern.slice(-3) === '/**') ***REMOVED***
    var gpattern = pattern.replace(/(\/\*\*)+$/, '')
    gmatcher = new Minimatch(gpattern, ***REMOVED*** dot: true ***REMOVED***)
  ***REMOVED***

  return ***REMOVED***
    matcher: new Minimatch(pattern, ***REMOVED*** dot: true ***REMOVED***),
    gmatcher: gmatcher
  ***REMOVED***
***REMOVED***

function setopts (self, pattern, options) ***REMOVED***
  if (!options)
    options = ***REMOVED******REMOVED***

  // base-matching: just use globstar for that.
  if (options.matchBase && -1 === pattern.indexOf("/")) ***REMOVED***
    if (options.noglobstar) ***REMOVED***
      throw new Error("base matching requires globstar")
    ***REMOVED***
    pattern = "**/" + pattern
  ***REMOVED***

  self.silent = !!options.silent
  self.pattern = pattern
  self.strict = options.strict !== false
  self.realpath = !!options.realpath
  self.realpathCache = options.realpathCache || Object.create(null)
  self.follow = !!options.follow
  self.dot = !!options.dot
  self.mark = !!options.mark
  self.nodir = !!options.nodir
  if (self.nodir)
    self.mark = true
  self.sync = !!options.sync
  self.nounique = !!options.nounique
  self.nonull = !!options.nonull
  self.nosort = !!options.nosort
  self.nocase = !!options.nocase
  self.stat = !!options.stat
  self.noprocess = !!options.noprocess
  self.absolute = !!options.absolute

  self.maxLength = options.maxLength || Infinity
  self.cache = options.cache || Object.create(null)
  self.statCache = options.statCache || Object.create(null)
  self.symlinks = options.symlinks || Object.create(null)

  setupIgnores(self, options)

  self.changedCwd = false
  var cwd = process.cwd()
  if (!ownProp(options, "cwd"))
    self.cwd = cwd
  else ***REMOVED***
    self.cwd = path.resolve(options.cwd)
    self.changedCwd = self.cwd !== cwd
  ***REMOVED***

  self.root = options.root || path.resolve(self.cwd, "/")
  self.root = path.resolve(self.root)
  if (process.platform === "win32")
    self.root = self.root.replace(/\\/g, "/")

  // TODO: is an absolute `cwd` supposed to be resolved against `root`?
  // e.g. ***REMOVED*** cwd: '/test', root: __dirname ***REMOVED*** === path.join(__dirname, '/test')
  self.cwdAbs = isAbsolute(self.cwd) ? self.cwd : makeAbs(self, self.cwd)
  if (process.platform === "win32")
    self.cwdAbs = self.cwdAbs.replace(/\\/g, "/")
  self.nomount = !!options.nomount

  // disable comments and negation in Minimatch.
  // Note that they are not supported in Glob itself anyway.
  options.nonegate = true
  options.nocomment = true

  self.minimatch = new Minimatch(pattern, options)
  self.options = self.minimatch.options
***REMOVED***

function finish (self) ***REMOVED***
  var nou = self.nounique
  var all = nou ? [] : Object.create(null)

  for (var i = 0, l = self.matches.length; i < l; i ++) ***REMOVED***
    var matches = self.matches[i]
    if (!matches || Object.keys(matches).length === 0) ***REMOVED***
      if (self.nonull) ***REMOVED***
        // do like the shell, and spit out the literal glob
        var literal = self.minimatch.globSet[i]
        if (nou)
          all.push(literal)
        else
          all[literal] = true
      ***REMOVED***
    ***REMOVED*** else ***REMOVED***
      // had matches
      var m = Object.keys(matches)
      if (nou)
        all.push.apply(all, m)
      else
        m.forEach(function (m) ***REMOVED***
          all[m] = true
        ***REMOVED***)
    ***REMOVED***
  ***REMOVED***

  if (!nou)
    all = Object.keys(all)

  if (!self.nosort)
    all = all.sort(self.nocase ? alphasorti : alphasort)

  // at *some* point we statted all of these
  if (self.mark) ***REMOVED***
    for (var i = 0; i < all.length; i++) ***REMOVED***
      all[i] = self._mark(all[i])
    ***REMOVED***
    if (self.nodir) ***REMOVED***
      all = all.filter(function (e) ***REMOVED***
        var notDir = !(/\/$/.test(e))
        var c = self.cache[e] || self.cache[makeAbs(self, e)]
        if (notDir && c)
          notDir = c !== 'DIR' && !Array.isArray(c)
        return notDir
      ***REMOVED***)
    ***REMOVED***
  ***REMOVED***

  if (self.ignore.length)
    all = all.filter(function(m) ***REMOVED***
      return !isIgnored(self, m)
    ***REMOVED***)

  self.found = all
***REMOVED***

function mark (self, p) ***REMOVED***
  var abs = makeAbs(self, p)
  var c = self.cache[abs]
  var m = p
  if (c) ***REMOVED***
    var isDir = c === 'DIR' || Array.isArray(c)
    var slash = p.slice(-1) === '/'

    if (isDir && !slash)
      m += '/'
    else if (!isDir && slash)
      m = m.slice(0, -1)

    if (m !== p) ***REMOVED***
      var mabs = makeAbs(self, m)
      self.statCache[mabs] = self.statCache[abs]
      self.cache[mabs] = self.cache[abs]
    ***REMOVED***
  ***REMOVED***

  return m
***REMOVED***

// lotta situps...
function makeAbs (self, f) ***REMOVED***
  var abs = f
  if (f.charAt(0) === '/') ***REMOVED***
    abs = path.join(self.root, f)
  ***REMOVED*** else if (isAbsolute(f) || f === '') ***REMOVED***
    abs = f
  ***REMOVED*** else if (self.changedCwd) ***REMOVED***
    abs = path.resolve(self.cwd, f)
  ***REMOVED*** else ***REMOVED***
    abs = path.resolve(f)
  ***REMOVED***

  if (process.platform === 'win32')
    abs = abs.replace(/\\/g, '/')

  return abs
***REMOVED***


// Return true, if pattern ends with globstar '**', for the accompanying parent directory.
// Ex:- If node_modules/** is the pattern, add 'node_modules' to ignore list along with it's contents
function isIgnored (self, path) ***REMOVED***
  if (!self.ignore.length)
    return false

  return self.ignore.some(function(item) ***REMOVED***
    return item.matcher.match(path) || !!(item.gmatcher && item.gmatcher.match(path))
  ***REMOVED***)
***REMOVED***

function childrenIgnored (self, path) ***REMOVED***
  if (!self.ignore.length)
    return false

  return self.ignore.some(function(item) ***REMOVED***
    return !!(item.gmatcher && item.gmatcher.match(path))
  ***REMOVED***)
***REMOVED***
