// Set up: npm install
var http = require("http"),
    fs = require("fs"),
    path = require("path"),
    ws = require("ws"),
    open = require("open"),
    ProtoBuf = require("protobufjs");

// Copy dependencies to "www/" (example specific, you usually don't have to care
var deps = [
      ["Long.min.js", "./node_modules/long/dist/Long.min.js"],
      ["ByteBufferAB.min.js", "./node_modules/bytebuffer/dist/ByteBufferAB.min.js"],
      ["ProtoBuf.min.js", "./node_modules/protobufjs/dist/ProtoBuf.min.js"]
];
for (var i=0, dep, data; i<deps.length; i++) ***REMOVED***
    dep = deps[i];
    if (!fs.existsSync(path.join(__dirname, "www", dep[0]))) ***REMOVED***
        console.log("Copying "+dep[0]+" from "+dep[1]);
        try ***REMOVED***
            fs.writeFileSync(path.join(__dirname, "www", dep[0]), fs.readFileSync(path.join(__dirname, dep[1])));
        ***REMOVED*** catch (err) ***REMOVED***
            console.log("Copying failed: "+err.message);
            console.log("\nDid you run `npm install` ?");
            process.exit(1);
        ***REMOVED***
    ***REMOVED***
***REMOVED***

// Initialize from .proto file
var builder = ProtoBuf.loadProtoFile(path.join(__dirname, "www", "example.proto")),
    Message = builder.build("Message");

// HTTP server
var server = http.createServer(function(req, res) ***REMOVED***
        var file = null,
            type = "text/html";
        if (req.url == "/") ***REMOVED***
            file = "index.html";
        ***REMOVED*** else if (/^\/(\w+(?:\.min)?\.(?:js|html|proto))$/.test(req.url)) ***REMOVED***
            file = req.url.substring(1);
            if (/\.js$/.test(file)) ***REMOVED***
                type = "text/javascript";
            ***REMOVED***
        ***REMOVED***
        if (file) ***REMOVED***
            fs.readFile(path.join(__dirname, "www", file), function(err, data) ***REMOVED***
                if (err) ***REMOVED***
                    res.writeHead(500, ***REMOVED***"Content-Type": type***REMOVED***);
                    res.end("Internal Server Error: "+err);
                ***REMOVED*** else ***REMOVED***
                    res.writeHead(200, ***REMOVED***"Content-Type": type***REMOVED***);
                    res.write(data);
                    res.end();
                    console.log("Served www/"+file);
                ***REMOVED***
            ***REMOVED***);
        ***REMOVED*** else ***REMOVED***
            res.writeHead(404, ***REMOVED***"Content-Type": "text/html"***REMOVED***);
            res.end("Not Found");
        ***REMOVED***
    ***REMOVED***);
server.listen(8080);
server.on("listening", function() ***REMOVED***
    console.log("Server started");
    open("http://localhost:8080/");
***REMOVED***);
server.on("error", function(err) ***REMOVED***
    console.log("Failed to start server:", err);
    process.exit(1);
***REMOVED***);

// WebSocket adapter
var wss = new ws.Server(***REMOVED***server: server***REMOVED***);
wss.on("connection", function(socket) ***REMOVED***
    console.log("New WebSocket connection");
    socket.on("close", function() ***REMOVED***
        console.log("WebSocket disconnected");
    ***REMOVED***);
    socket.on("message", function(data, flags) ***REMOVED***
        if (flags.binary) ***REMOVED***
            try ***REMOVED***
                // Decode the Message
                var msg = Message.decode(data);
                console.log("Received: "+msg.text);
                // Transform the text to upper case
                msg.text = msg.text.toUpperCase();
                // Re-encode it and send it back
                socket.send(msg.toBuffer());
                console.log("Sent: "+msg.text);
            ***REMOVED*** catch (err) ***REMOVED***
                console.log("Processing failed:", err);
            ***REMOVED***
        ***REMOVED*** else ***REMOVED***
            console.log("Not binary data");
        ***REMOVED***
    ***REMOVED***);
***REMOVED***);
