'use strict';
var childProcess = require('child_process');
var execFileSync = childProcess.execFileSync;
var lcid = require('lcid');
var defaultOpts = ***REMOVED***spawn: true***REMOVED***;
var cache;

function fallback() ***REMOVED***
	cache = 'en_US';
	return cache;
***REMOVED***

function getEnvLocale(env) ***REMOVED***
	env = env || process.env;
	var ret = env.LC_ALL || env.LC_MESSAGES || env.LANG || env.LANGUAGE;
	cache = getLocale(ret);
	return ret;
***REMOVED***

function parseLocale(x) ***REMOVED***
	var env = x.split('\n').reduce(function (env, def) ***REMOVED***
		def = def.split('=');
		env[def[0]] = def[1];
		return env;
	***REMOVED***, ***REMOVED******REMOVED***);
	return getEnvLocale(env);
***REMOVED***

function getLocale(str) ***REMOVED***
	return (str && str.replace(/[.:].*/, '')) || fallback();
***REMOVED***

module.exports = function (opts, cb) ***REMOVED***
	if (typeof opts === 'function') ***REMOVED***
		cb = opts;
		opts = defaultOpts;
	***REMOVED*** else ***REMOVED***
		opts = opts || defaultOpts;
	***REMOVED***

	if (cache || getEnvLocale() || opts.spawn === false) ***REMOVED***
		setImmediate(cb, null, cache);
		return;
	***REMOVED***

	var getAppleLocale = function () ***REMOVED***
		childProcess.execFile('defaults', ['read', '-g', 'AppleLocale'], function (err, stdout) ***REMOVED***
			if (err) ***REMOVED***
				fallback();
				return;
			***REMOVED***

			cache = stdout.trim() || fallback();
			cb(null, cache);
		***REMOVED***);
	***REMOVED***;

	if (process.platform === 'win32') ***REMOVED***
		childProcess.execFile('wmic', ['os', 'get', 'locale'], function (err, stdout) ***REMOVED***
			if (err) ***REMOVED***
				fallback();
				return;
			***REMOVED***

			var lcidCode = parseInt(stdout.replace('Locale', ''), 16);
			cache = lcid.from(lcidCode) || fallback();
			cb(null, cache);
		***REMOVED***);
	***REMOVED*** else ***REMOVED***
		childProcess.execFile('locale', function (err, stdout) ***REMOVED***
			if (err) ***REMOVED***
				fallback();
				return;
			***REMOVED***

			var res = parseLocale(stdout);

			if (!res && process.platform === 'darwin') ***REMOVED***
				getAppleLocale();
				return;
			***REMOVED***

			cache = getLocale(res);
			cb(null, cache);
		***REMOVED***);
	***REMOVED***
***REMOVED***;

module.exports.sync = function (opts) ***REMOVED***
	opts = opts || defaultOpts;

	if (cache || getEnvLocale() || !execFileSync || opts.spawn === false) ***REMOVED***
		return cache;
	***REMOVED***

	if (process.platform === 'win32') ***REMOVED***
		var stdout;

		try ***REMOVED***
			stdout = execFileSync('wmic', ['os', 'get', 'locale'], ***REMOVED***encoding: 'utf8'***REMOVED***);
		***REMOVED*** catch (err) ***REMOVED***
			return fallback();
		***REMOVED***

		var lcidCode = parseInt(stdout.replace('Locale', ''), 16);
		cache = lcid.from(lcidCode) || fallback();
		return cache;
	***REMOVED***

	var res;

	try ***REMOVED***
		res = parseLocale(execFileSync('locale', ***REMOVED***encoding: 'utf8'***REMOVED***));
	***REMOVED*** catch (err) ***REMOVED******REMOVED***

	if (!res && process.platform === 'darwin') ***REMOVED***
		try ***REMOVED***
			cache = execFileSync('defaults', ['read', '-g', 'AppleLocale'], ***REMOVED***encoding: 'utf8'***REMOVED***).trim() || fallback();
			return cache;
		***REMOVED*** catch (err) ***REMOVED***
			return fallback();
		***REMOVED***
	***REMOVED***

	cache = getLocale(res);
	return cache;
***REMOVED***;
