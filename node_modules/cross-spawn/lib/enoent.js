'use strict';

var isWin = process.platform === 'win32';
var resolveCommand = require('./util/resolveCommand');

var isNode10 = process.version.indexOf('v0.10.') === 0;

function notFoundError(command, syscall) ***REMOVED***
    var err;

    err = new Error(syscall + ' ' + command + ' ENOENT');
    err.code = err.errno = 'ENOENT';
    err.syscall = syscall + ' ' + command;

    return err;
***REMOVED***

function hookChildProcess(cp, parsed) ***REMOVED***
    var originalEmit;

    if (!isWin) ***REMOVED***
        return;
    ***REMOVED***

    originalEmit = cp.emit;
    cp.emit = function (name, arg1) ***REMOVED***
        var err;

        // If emitting "exit" event and exit code is 1, we need to check if
        // the command exists and emit an "error" instead
        // See: https://github.com/IndigoUnited/node-cross-spawn/issues/16
        if (name === 'exit') ***REMOVED***
            err = verifyENOENT(arg1, parsed, 'spawn');

            if (err) ***REMOVED***
                return originalEmit.call(cp, 'error', err);
            ***REMOVED***
        ***REMOVED***

        return originalEmit.apply(cp, arguments);
    ***REMOVED***;
***REMOVED***

function verifyENOENT(status, parsed) ***REMOVED***
    if (isWin && status === 1 && !parsed.file) ***REMOVED***
        return notFoundError(parsed.original, 'spawn');
    ***REMOVED***

    return null;
***REMOVED***

function verifyENOENTSync(status, parsed) ***REMOVED***
    if (isWin && status === 1 && !parsed.file) ***REMOVED***
        return notFoundError(parsed.original, 'spawnSync');
    ***REMOVED***

    // If we are in node 10, then we are using spawn-sync; if it exited
    // with -1 it probably means that the command does not exist
    if (isNode10 && status === -1) ***REMOVED***
        parsed.file = isWin ? parsed.file : resolveCommand(parsed.original);

        if (!parsed.file) ***REMOVED***
            return notFoundError(parsed.original, 'spawnSync');
        ***REMOVED***
    ***REMOVED***

    return null;
***REMOVED***

module.exports.hookChildProcess = hookChildProcess;
module.exports.verifyENOENT = verifyENOENT;
module.exports.verifyENOENTSync = verifyENOENTSync;
module.exports.notFoundError = notFoundError;
